<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Log In – Solano Hills</title>
  <link rel="stylesheet" href="Login.css" />
  <style>
    /* Forgot Password Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: #4a3728;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      color: #f3efe9;
      font-size: 20px;
      margin: 0;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: #f3efe9;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-modal:hover {
      color: #cfa85b;
    }
    
    .modal-body {
      color: #f3efe9;
    }
    
    .modal-input, .modal-select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #b2956f;
      border-radius: 6px;
      font-size: 14px;
      background-color: #f3efe9;
      color: #4a3728;
    }
    
    .modal-button {
      padding: 12px 24px;
      background-color: #cfa85b;
      border: none;
      border-radius: 6px;
      color: #4a3728;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .modal-button:hover {
      background-color: #a57934;
    }
    
    .modal-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    
    .modal-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
    }
    
    .modal-success {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .modal-error {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    /* Two Panel Layout */
    .setup-container {
      margin-top: 20px;
    }
    
    .setup-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }
    
    .setup-progress::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(179, 149, 111, 0.3);
      z-index: 1;
    }
    
    .progress-step {
      position: relative;
      z-index: 2;
      text-align: center;
      flex: 1;
    }
    
    .progress-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(179, 149, 111, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      color: #f3efe9;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .progress-circle.active {
      background: #cfa85b;
      border-color: #cfa85b;
      color: #4a3728;
    }
    
    .progress-label {
      font-size: 12px;
      color: #b2956f;
    }
    
    .setup-panel {
      display: none;
    }
    
    .setup-panel.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .panel-title {
      color: #f3efe9;
      margin-bottom: 20px;
      font-size: 18px;
      text-align: center;
    }
    
    .security-questions {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(179, 149, 111, 0.3);
    }
    
    .security-question-item {
      margin-bottom: 20px;
    }
    
    .security-question-label {
      display: block;
      color: #f3efe9;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .btn-back {
      background: rgba(255,255,255,0.1);
      color: #f3efe9;
      border: 1px solid rgba(179, 149, 111, 0.5);
    }
    
    .btn-back:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(179, 149, 111, 0.3);
      padding-bottom: 10px;
    }
    
    .tab-button {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(179, 149, 111, 0.3);
      border-radius: 6px;
      color: #f3efe9;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .tab-button.active {
      background: #cfa85b;
      color: #4a3728;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Password Requirements Display */
    .password-requirements {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid rgba(179, 149, 111, 0.3);
    }
    
    .requirements-title {
      color: #f3efe9;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .requirements-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .requirement-item {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .requirement-met {
      color: #10b981;
    }
    
    .requirement-unmet {
      color: #9ca3af;
    }
    
    .requirement-icon {
      font-weight: bold;
    }
  </style>
</head>
<body class="login-body">

  <div class="login-wrapper">
    <div class="login-card">
      <div class="login-logo">
        <a href="index.html">
          <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
        </a>
      </div>
      <h2 class="login-title">Welcome Back</h2>

      <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />

        <div class="login-options">
          <a href="#" id="forgotPasswordLink">Forgot Password?</a>
        </div>

        <button id="submit" type="submit">Log In</button>
      </form>

      <!-- First Login Setup - 2 Panel Layout -->
      <div id="changePasswordSection" style="display: none; margin-top: 20px;">
        <h3 style="color: #f3efe9; margin-bottom: 10px; text-align: center;">Set Up Your Account</h3>
        <p style="color: #b2956f; font-size: 13px; text-align: center; margin-bottom: 30px;">
          Complete these two steps to secure your account
        </p>
        
        <!-- Progress Bar -->
        <div class="setup-progress">
          <div class="progress-step">
            <div class="progress-circle active" id="step1Circle">1</div>
            <div class="progress-label">Set Password</div>
          </div>
          <div class="progress-step">
            <div class="progress-circle" id="step2Circle">2</div>
            <div class="progress-label">Security Questions</div>
          </div>
        </div>
        
        <!-- Panel 1: Set Password -->
        <div id="panel1" class="setup-panel active">
          <h4 class="panel-title">Set Your Password</h4>
          
          <form id="passwordForm">
            <input type="password" id="newPassword" placeholder="New Password" required class="modal-input" style="margin-bottom: 10px;" />
            <input type="password" id="confirmPassword" placeholder="Confirm New Password" required class="modal-input" style="margin-bottom: 10px;" />
            
            <!-- Password Requirements Display -->
            <div class="password-requirements">
              <div class="requirements-title">Password Requirements:</div>
              <div class="requirements-grid">
                <div id="reqLength" class="requirement-item requirement-unmet">
                  <span class="requirement-icon">○</span> 8+ characters
                </div>
                <div id="reqUppercase" class="requirement-item requirement-unmet">
                  <span class="requirement-icon">○</span> Uppercase (A-Z)
                </div>
                <div id="reqLowercase" class="requirement-item requirement-unmet">
                  <span class="requirement-icon">○</span> Lowercase (a-z)
                </div>
                <div id="reqNumber" class="requirement-item requirement-unmet">
                  <span class="requirement-icon">○</span> Number (0-9)
                </div>
                <div id="reqSpecial" class="requirement-item requirement-unmet">
                  <span class="requirement-icon">○</span> Special (!@#$%^&*._())
                </div>
              </div>
            </div>
            
            <div id="matchStatus" style="font-size: 13px; margin-bottom: 15px; min-height: 20px;"></div>
            
            <div class="navigation-buttons">
              <button type="button" class="modal-button btn-back" style="visibility: hidden;">Back</button>
              <button type="button" id="nextToPanel2" class="modal-button" disabled>Next: Security Questions</button>
            </div>
          </form>
        </div>
        
        <!-- Panel 2: Security Questions -->
        <div id="panel2" class="setup-panel">
          <h4 class="panel-title">Set Security Questions</h4>
          <p style="color: #b2956f; font-size: 13px; margin-bottom: 20px; text-align: center;">
            These questions will help you recover your account if you forget your password
          </p>
          
          <form id="securityForm">
            <div class="security-questions">
              <!-- Question 1 -->
              <div class="security-question-item">
                <label class="security-question-label">Security Question 1:</label>
                <select id="securityQuestion1" class="modal-select" required>
                  <option value="">Select a question</option>
                  <option value="mother_maiden_name">What is your mother's maiden name?</option>
                  <option value="first_pet">What was the name of your first pet?</option>
                  <option value="birth_city">In what city were you born?</option>
                  <option value="elementary_school">What was the name of your elementary school?</option>
                  <option value="first_car">What was the make and model of your first car?</option>
                  <option value="childhood_nickname">What was your childhood nickname?</option>
                </select>
                <input type="text" id="securityAnswer1" placeholder="Your answer" required style="margin-top: 8px;" class="modal-input" />
              </div>
              
              <!-- Question 2 -->
              <div class="security-question-item">
                <label class="security-question-label">Security Question 2:</label>
                <select id="securityQuestion2" class="modal-select" required>
                  <option value="">Select a question</option>
                  <option value="father_middle_name">What is your father's middle name?</option>
                  <option value="favorite_teacher">Who was your favorite teacher in school?</option>
                  <option value="first_job">Where was your first job?</option>
                  <option value="childhood_friend">What is the name of your childhood best friend?</option>
                  <option value="favorite_movie">What is your favorite movie?</option>
                  <option value="dream_vacation">Where is your dream vacation destination?</option>
                </select>
                <input type="text" id="securityAnswer2" placeholder="Your answer" required style="margin-top: 8px;" class="modal-input" />
              </div>
              
              <!-- Question 3 -->
              <div class="security-question-item">
                <label class="security-question-label">Security Question 3:</label>
                <select id="securityQuestion3" class="modal-select" required>
                  <option value="">Select a question</option>
                  <option value="spouse_birth_city">In what city did you meet your spouse/partner?</option>
                  <option value="favorite_book">What is your favorite book?</option>
                  <option value="first_concert">What was your first concert?</option>
                  <option value="favorite_sport">What is your favorite sport?</option>
                  <option value="grandmother_name">What is your maternal grandmother's first name?</option>
                  <option value="childhood_street">What street did you live on as a child?</option>
                </select>
                <input type="text" id="securityAnswer3" placeholder="Your answer" required style="margin-top: 8px;" class="modal-input" />
              </div>
            </div>
            
            <p style="color: #b2956f; font-size: 12px; margin-top: 15px; font-style: italic; text-align: center;">
              Note: Answers are case-sensitive. Make sure to remember your answers!
            </p>
            
            <div class="navigation-buttons">
              <button type="button" id="backToPanel1" class="modal-button btn-back">Back to Password</button>
              <button type="submit" id="completeSetupBtn" class="modal-button">Complete Setup</button>
            </div>
          </form>
        </div>
      </div>

      <p id="status" style="color: red; margin-top: 10px;"></p>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Reset Password</h3>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="email-tab">Email Reset</button>
          <button class="tab-button" data-tab="security-tab">Security Questions</button>
        </div>
        
        <!-- Email Tab -->
        <div id="email-tab" class="tab-content active">
          <p style="margin-bottom: 20px; font-size: 14px;">
            Enter your email address and we'll send you a link to reset your password.
          </p>
          
          <form id="forgotPasswordForm">
            <input type="email" id="resetEmail" class="modal-input" placeholder="Enter your email" required />
            
            <button type="submit" id="resetPasswordBtn" class="modal-button">
              Send Reset Link
            </button>
          </form>
          
          <div id="resetStatus" class="modal-status"></div>
          
          <p style="margin-top: 20px; font-size: 12px; color: #b2956f;">
            <strong>Note:</strong> Check your email inbox and spam folder for the reset link.
          </p>
        </div>
        
        <!-- Security Questions Tab -->
        <div id="security-tab" class="tab-content">
          <p style="margin-bottom: 20px; font-size: 14px;">
            Answer your security questions to reset your password.
          </p>
          
          <form id="securityQuestionsForm">
            <input type="email" id="securityEmail" class="modal-input" placeholder="Enter your email" required />
            
            <div id="securityQuestionsContainer" class="security-questions" style="display: none;">
              <!-- Questions will be loaded here dynamically -->
            </div>
            
            <div id="verificationStatus" class="modal-status" style="display: none;"></div>
            
            <div id="newPasswordSection" style="display: none; margin-top: 20px;">
              <h4 style="color: #f3efe9; margin-bottom: 10px;">Set New Password</h4>
              
              <input type="password" id="securityNewPassword" class="modal-input" placeholder="New Password" required />
              <input type="password" id="securityConfirmPassword" class="modal-input" placeholder="Confirm New Password" required />
              
              <!-- Password Requirements for Security Questions Reset -->
              <div class="password-requirements">
                <div class="requirements-title">Password Requirements:</div>
                <div class="requirements-grid">
                  <div id="securityReqLength" class="requirement-item requirement-unmet">
                    <span class="requirement-icon">○</span> 8+ characters
                  </div>
                  <div id="securityReqUppercase" class="requirement-item requirement-unmet">
                    <span class="requirement-icon">○</span> Uppercase (A-Z)
                  </div>
                  <div id="securityReqLowercase" class="requirement-item requirement-unmet">
                    <span class="requirement-icon">○</span> Lowercase (a-z)
                  </div>
                  <div id="securityReqNumber" class="requirement-item requirement-unmet">
                    <span class="requirement-icon">○</span> Number (0-9)
                  </div>
                  <div id="securityReqSpecial" class="requirement-item requirement-unmet">
                    <span class="requirement-icon">○</span> Special (!@#$%^&*._())
                  </div>
                </div>
              </div>
              
              <div id="securityMatchStatus" style="font-size: 13px; margin-bottom: 15px; min-height: 20px;"></div>
            </div>
            
            <button type="submit" id="securityResetBtn" class="modal-button" style="display: none;">
              Reset Password
            </button>
          </form>
          
          <div id="securityStatus" class="modal-status"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
// Protection against browser extension conflicts
const originalError = console.error;
console.error = function(...args) {
  // Filter out Solana extension errors
  if (args[0] && typeof args[0] === 'string' && 
      (args[0].includes('solana') || args[0].includes('Solana') || 
       args[0].includes('Wx') || args[0].includes('solanaActionsContentScript'))) {
    return; // Silently ignore Solana extension errors
  }
  originalError.apply(console, args);
};

// Also catch unhandled promise rejections from extensions
window.addEventListener('unhandledrejection', function(event) {
  if (event.reason && 
      (event.reason.toString().includes('solana') || 
       event.reason.toString().includes('Solana') ||
       event.reason.stack && event.reason.stack.includes('solanaActionsContentScript'))) {
    event.preventDefault();
    console.log('Suppressed Solana extension error:', event.reason);
  }
});

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  updatePassword,
  sendPasswordResetEmail,
  fetchSignInMethodsForEmail 
} from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
    authDomain: "solanodb-a4f65.firebaseapp.com",
    projectId: "solanodb-a4f65",
    storageBucket: "solanodb-a4f65.firebasestorage.app",
    messagingSenderId: "98081894649",
    appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
};

// Initialize Firebase
let app, auth, db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (error) {
  console.error('Firebase initialization error:', error);
  document.getElementById('status').textContent = "Failed to initialize app. Please refresh the page.";
}

// ==================== GLOBAL VARIABLES ====================
let currentUserIdForReset = null;
let currentUserEmailForReset = null;
let currentSecurityQuestions = null;

// ==================== TWO PANEL NAVIGATION ====================
let currentPanel = 1;
let userPassword = '';
let securityQuestionsData = null;

// Next button - Panel 1 to Panel 2
document.getElementById('nextToPanel2').addEventListener('click', function() {
  // Validate password before proceeding
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const requirements = validatePassword(newPassword);
  const allValid = allRequirementsMet(requirements);
  
  if (!allValid) {
    document.getElementById('status').textContent = "Please meet all password requirements.";
    document.getElementById('status').style.color = "red";
    return;
  }
  
  if (newPassword !== confirmPassword) {
    document.getElementById('status').textContent = "Passwords do not match.";
    document.getElementById('status').style.color = "red";
    return;
  }
  
  // Save password for later
  userPassword = newPassword;
  
  // Switch to panel 2
  document.getElementById('panel1').classList.remove('active');
  document.getElementById('panel2').classList.add('active');
  document.getElementById('step1Circle').classList.remove('active');
  document.getElementById('step2Circle').classList.add('active');
  currentPanel = 2;
  
  // Clear any previous status
  document.getElementById('status').textContent = '';
});

// Back button - Panel 2 to Panel 1
document.getElementById('backToPanel1').addEventListener('click', function() {
  // Switch to panel 1
  document.getElementById('panel2').classList.remove('active');
  document.getElementById('panel1').classList.add('active');
  document.getElementById('step2Circle').classList.remove('active');
  document.getElementById('step1Circle').classList.add('active');
  currentPanel = 1;
});

// ==================== PASSWORD VALIDATION FUNCTIONS ====================
function validatePassword(password) {
  return {
    length: password.length >= 8,
    uppercase: /[A-Z]/.test(password),
    lowercase: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*._()]/.test(password)
  };
}

function updateRequirements(requirements) {
  const requirementElements = {
    length: document.getElementById('reqLength'),
    uppercase: document.getElementById('reqUppercase'),
    lowercase: document.getElementById('reqLowercase'),
    number: document.getElementById('reqNumber'),
    special: document.getElementById('reqSpecial')
  };
  
  Object.keys(requirements).forEach(req => {
    const element = requirementElements[req];
    if (element) {
      const icon = element.querySelector('.requirement-icon');
      if (requirements[req]) {
        element.className = 'requirement-item requirement-met';
        icon.textContent = '✓';
      } else {
        element.className = 'requirement-item requirement-unmet';
        icon.textContent = '○';
      }
    }
  });
}

function updateSecurityPasswordRequirements(requirements) {
  const requirementElements = {
    length: document.getElementById('securityReqLength'),
    uppercase: document.getElementById('securityReqUppercase'),
    lowercase: document.getElementById('securityReqLowercase'),
    number: document.getElementById('securityReqNumber'),
    special: document.getElementById('securityReqSpecial')
  };
  
  Object.keys(requirements).forEach(req => {
    const element = requirementElements[req];
    if (element) {
      const icon = element.querySelector('.requirement-icon');
      if (requirements[req]) {
        element.className = 'requirement-item requirement-met';
        icon.textContent = '✓';
      } else {
        element.className = 'requirement-item requirement-unmet';
        icon.textContent = '○';
      }
    }
  });
}

function allRequirementsMet(requirements) {
  return Object.values(requirements).every(req => req === true);
}

function checkPasswordMatch(password, confirmPassword) {
  const matchStatus = document.getElementById('matchStatus');
  const nextButton = document.getElementById('nextToPanel2');
  
  if (!password || !confirmPassword) {
    matchStatus.textContent = '';
    nextButton.disabled = true;
    nextButton.style.opacity = '0.6';
    return false;
  }
  
  if (password === confirmPassword) {
    matchStatus.textContent = '✓ Passwords match';
    matchStatus.style.color = '#10b981';
    
    // Only enable next button if password requirements are also met
    const requirements = validatePassword(password);
    nextButton.disabled = !allRequirementsMet(requirements);
    nextButton.style.opacity = allRequirementsMet(requirements) ? '1' : '0.6';
    return true;
  } else {
    matchStatus.textContent = '✗ Passwords do not match';
    matchStatus.style.color = '#ef4444';
    nextButton.disabled = true;
    nextButton.style.opacity = '0.6';
    return false;
  }
}

function checkSecurityPasswordMatch(password, confirmPassword) {
  const matchStatus = document.getElementById('securityMatchStatus');
  const resetBtn = document.getElementById('securityResetBtn');
  
  if (!password || !confirmPassword) {
    matchStatus.textContent = '';
    resetBtn.disabled = true;
    resetBtn.style.opacity = '0.6';
    return false;
  }
  
  if (password === confirmPassword) {
    matchStatus.textContent = '✓ Passwords match';
    matchStatus.style.color = '#10b981';
    
    // Only enable reset button if password requirements are also met
    const requirements = validatePassword(password);
    const allValid = Object.values(requirements).every(req => req === true);
    resetBtn.disabled = !allValid;
    resetBtn.style.opacity = allValid ? '1' : '0.6';
    return true;
  } else {
    matchStatus.textContent = '✗ Passwords do not match';
    matchStatus.style.color = '#ef4444';
    resetBtn.disabled = true;
    resetBtn.style.opacity = '0.6';
    return false;
  }
}

// ==================== PASSWORD VALIDATION EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
  // Initial setup password validation
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  
  if (newPasswordInput) {
    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const requirements = validatePassword(password);
      
      updateRequirements(requirements);
      const passwordsMatch = checkPasswordMatch(password, confirmPassword);
      
      // Update next button based on both requirements and match
      const nextButton = document.getElementById('nextToPanel2');
      const allValid = allRequirementsMet(requirements) && passwordsMatch;
      nextButton.disabled = !allValid;
      nextButton.style.opacity = allValid ? '1' : '0.6';
    });
  }
  
  if (confirmPasswordInput) {
    confirmPasswordInput.addEventListener('input', function() {
      const password = document.getElementById('newPassword').value;
      const confirmPassword = this.value;
      const requirements = validatePassword(password);
      
      const passwordsMatch = checkPasswordMatch(password, confirmPassword);
      
      // Update next button based on both requirements and match
      const nextButton = document.getElementById('nextToPanel2');
      const allValid = allRequirementsMet(requirements) && passwordsMatch;
      nextButton.disabled = !allValid;
      nextButton.style.opacity = allValid ? '1' : '0.6';
    });
  }
  
  // Security questions password validation
  const securityNewPasswordInput = document.getElementById('securityNewPassword');
  const securityConfirmPasswordInput = document.getElementById('securityConfirmPassword');
  
  if (securityNewPasswordInput) {
    securityNewPasswordInput.addEventListener('input', function() {
      const password = this.value;
      const confirmPassword = document.getElementById('securityConfirmPassword').value;
      const requirements = validatePassword(password);
      
      updateSecurityPasswordRequirements(requirements);
      const passwordsMatch = checkSecurityPasswordMatch(password, confirmPassword);
    });
  }
  
  if (securityConfirmPasswordInput) {
    securityConfirmPasswordInput.addEventListener('input', function() {
      const password = document.getElementById('securityNewPassword').value;
      const confirmPassword = this.value;
      const requirements = validatePassword(password);
      
      const passwordsMatch = checkSecurityPasswordMatch(password, confirmPassword);
    });
  }
});

// ==================== SECURITY QUESTIONS FORM SUBMISSION ====================
const securityForm = document.getElementById('securityForm');
if (securityForm) {
  securityForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const status = document.getElementById('status');
    const completeBtn = document.getElementById('completeSetupBtn');
    
    // Get security questions and answers
    const securityQuestions = {
      question1: {
        question: document.getElementById('securityQuestion1').options[document.getElementById('securityQuestion1').selectedIndex].text,
        answer: document.getElementById('securityAnswer1').value.trim()
      },
      question2: {
        question: document.getElementById('securityQuestion2').options[document.getElementById('securityQuestion2').selectedIndex].text,
        answer: document.getElementById('securityAnswer2').value.trim()
      },
      question3: {
        question: document.getElementById('securityQuestion3').options[document.getElementById('securityQuestion3').selectedIndex].text,
        answer: document.getElementById('securityAnswer3').value.trim()
      }
    };

    // Validate security questions
    if (!securityQuestions.question1.answer || !securityQuestions.question2.answer || !securityQuestions.question3.answer) {
      status.textContent = "Please answer all security questions.";
      status.style.color = "red";
      return;
    }

    // Check for duplicate questions
    const questionValues = [
      document.getElementById('securityQuestion1').value,
      document.getElementById('securityQuestion2').value,
      document.getElementById('securityQuestion3').value
    ];
    const uniqueQuestions = [...new Set(questionValues)];
    if (uniqueQuestions.length < 3) {
      status.textContent = "Please select different security questions.";
      status.style.color = "red";
      return;
    }

    // Save security questions data
    securityQuestionsData = {
      q1: {
        id: document.getElementById('securityQuestion1').value,
        question: securityQuestions.question1.question,
        answer: securityQuestions.question1.answer.toLowerCase()
      },
      q2: {
        id: document.getElementById('securityQuestion2').value,
        question: securityQuestions.question2.question,
        answer: securityQuestions.question2.answer.toLowerCase()
      },
      q3: {
        id: document.getElementById('securityQuestion3').value,
        question: securityQuestions.question3.question,
        answer: securityQuestions.question3.answer.toLowerCase()
      }
    };

    // Disable button and show loading
    completeBtn.disabled = true;
    completeBtn.textContent = "Setting up account...";
    status.textContent = "Setting up your account...";
    status.style.color = "#8d6c39";

    try {
      // Update password in Firebase
      await updatePassword(window.loggedInUser, userPassword);
      
      // Save security questions to Firestore
      await updateDoc(doc(db, "users", window.loggedInUser.uid), {
        mustChangePassword: false,
        lastPasswordChange: new Date(),
        securityQuestions: securityQuestionsData,
        accountSetupComplete: true
      });
      
      // Success!
      status.textContent = "✓ Account setup complete! Redirecting...";
      status.style.color = "green";
      completeBtn.textContent = "Setup Complete ✓";
      
      // Redirect after 2 seconds
      setTimeout(() => {
        window.location.href = "DASHBOARD.html";
      }, 2000);
      
    } catch (error) {
      console.error("Error setting up account:", error);
      
      // Handle Firebase errors
      let errorMessage = "Error: " + error.message;
      
      if (error.code === 'auth/weak-password') {
        errorMessage = "Password is too weak. Please use a stronger password.";
      } else if (error.code === 'auth/requires-recent-login') {
        errorMessage = "Session expired. Please log in again.";
      } else if (error.code === 'auth/network-request-failed') {
        errorMessage = "Network error. Please check your connection.";
      }
      
      status.textContent = errorMessage;
      status.style.color = "red";
      
      // Re-enable button
      completeBtn.disabled = false;
      completeBtn.textContent = "Complete Setup";
    }
  });
}

// ==================== MODAL FUNCTIONALITY ====================
const forgotPasswordModal = document.getElementById('forgotPasswordModal');
const forgotPasswordLink = document.getElementById('forgotPasswordLink');
const closeModal = document.getElementById('closeModal');
const forgotPasswordForm = document.getElementById('forgotPasswordForm');
const resetPasswordBtn = document.getElementById('resetPasswordBtn');
const resetStatus = document.getElementById('resetStatus');
const securityQuestionsForm = document.getElementById('securityQuestionsForm');
const securityResetBtn = document.getElementById('securityResetBtn');
const securityStatus = document.getElementById('securityStatus');

// Tab switching
document.querySelectorAll('.tab-button').forEach(button => {
  button.addEventListener('click', function() {
    // Update active tab button
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    this.classList.add('active');
    
    // Show corresponding tab content
    const tabId = this.getAttribute('data-tab');
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
    
    // Reset forms
    if (tabId === 'email-tab') {
      forgotPasswordForm.reset();
      resetStatus.textContent = '';
    } else {
      securityQuestionsForm.reset();
      securityStatus.textContent = '';
      document.getElementById('securityQuestionsContainer').style.display = 'none';
      document.getElementById('newPasswordSection').style.display = 'none';
      document.getElementById('verificationStatus').style.display = 'none';
      securityResetBtn.style.display = 'none';
      currentSecurityQuestions = null;
    }
  });
});

// Open modal when "Forgot Password" is clicked
forgotPasswordLink.addEventListener('click', function(e) {
  e.preventDefault();
  forgotPasswordModal.style.display = 'flex';
  resetStatus.textContent = '';
  resetStatus.className = 'modal-status';
  securityStatus.textContent = '';
  securityStatus.className = 'modal-status';
  forgotPasswordForm.reset();
  securityQuestionsForm.reset();
  document.getElementById('securityQuestionsContainer').style.display = 'none';
  document.getElementById('newPasswordSection').style.display = 'none';
  document.getElementById('verificationStatus').style.display = 'none';
  securityResetBtn.style.display = 'none';
  currentSecurityQuestions = null;
});

// Close modal when X is clicked
closeModal.addEventListener('click', function() {
  forgotPasswordModal.style.display = 'none';
});

// Close modal when clicking outside
window.addEventListener('click', function(e) {
  if (e.target === forgotPasswordModal) {
    forgotPasswordModal.style.display = 'none';
  }
});

// ==================== EMAIL RESET FUNCTION ====================
forgotPasswordForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = document.getElementById('resetEmail').value.trim();
  const resetBtn = document.getElementById('resetPasswordBtn');
  
  if (!email) {
    resetStatus.textContent = 'Please enter your email address.';
    resetStatus.className = 'modal-status modal-error';
    return;
  }
  
  // Disable button and show loading
  resetBtn.disabled = true;
  resetBtn.textContent = 'Checking email...';
  resetStatus.textContent = 'Checking if email exists...';
  resetStatus.className = 'modal-status';
  
  try {
    // Try to check if email exists in Firebase Auth
    let emailExists = false;
    try {
      const signInMethods = await fetchSignInMethodsForEmail(auth, email);
      emailExists = signInMethods && signInMethods.length > 0;
    } catch (authError) {
      // If fetchSignInMethodsForEmail fails, try direct send
      console.log('Using fallback email check method');
      emailExists = true; // Assume it exists and let Firebase handle the error
    }
    
    // Also check Firestore for consistency
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", email));
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      // No user in Firestore
      resetStatus.textContent = 'No account found with this email address.';
      resetStatus.className = 'modal-status modal-error';
      resetBtn.disabled = false;
      resetBtn.textContent = 'Send Reset Link';
      return;
    }
    
    // Email exists, send reset email
    resetStatus.textContent = 'Sending reset link...';
    await sendPasswordResetEmail(auth, email);
    
    // Success
    resetStatus.textContent = 'Password reset link sent! Check your email inbox and spam folder.';
    resetStatus.className = 'modal-status modal-success';
    resetBtn.textContent = 'Link Sent ✓';
    
    // Auto-close modal after 3 seconds
    setTimeout(() => {
      forgotPasswordModal.style.display = 'none';
      resetBtn.disabled = false;
      resetBtn.textContent = 'Send Reset Link';
    }, 3000);
    
  } catch (error) {
    console.error('Password reset error:', error);
    
    // Handle different Firebase errors
    let errorMessage = 'Error sending reset link. Please try again.';
    
    if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email address.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address format.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many attempts. Please try again later.';
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = 'Network error. Please check your connection.';
    } else if (error.code === 'auth/quota-exceeded') {
      errorMessage = 'Email quota exceeded. Please try again tomorrow.';
    }
    
    resetStatus.textContent = errorMessage;
    resetStatus.className = 'modal-status modal-error';
    
    // Re-enable button
    resetBtn.disabled = false;
    resetBtn.textContent = 'Send Reset Link';
  }
});

// ==================== SECURITY QUESTIONS RESET FUNCTION ====================
document.getElementById('securityEmail').addEventListener('blur', async function() {
  const email = this.value.trim();
  
  if (!email) {
    securityStatus.textContent = 'Please enter your email address.';
    securityStatus.className = 'modal-status modal-error';
    return;
  }
  
  securityStatus.textContent = 'Checking account...';
  securityStatus.className = 'modal-status';
  
  try {
    // Check if user exists in Firestore
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", email));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      const userDoc = querySnapshot.docs[0];
      const userData = userDoc.data();
      currentUserIdForReset = userDoc.id;
      currentUserEmailForReset = email;
      currentSecurityQuestions = userData.securityQuestions;
      
      if (userData.securityQuestions && Object.keys(userData.securityQuestions).length >= 2) {
        // User has security questions set up
        displaySecurityQuestions(userData.securityQuestions);
      } else {
        securityStatus.textContent = 'No security questions found for this account. Please use email reset method.';
        securityStatus.className = 'modal-status modal-error';
        document.getElementById('securityQuestionsContainer').style.display = 'none';
      }
    } else {
      securityStatus.textContent = 'No account found with this email address.';
      securityStatus.className = 'modal-status modal-error';
      document.getElementById('securityQuestionsContainer').style.display = 'none';
    }
  } catch (error) {
    console.error('Error checking security questions:', error);
    securityStatus.textContent = 'Error checking account. Please try again.';
    securityStatus.className = 'modal-status modal-error';
  }
});

function displaySecurityQuestions(securityQuestions) {
  const container = document.getElementById('securityQuestionsContainer');
  container.innerHTML = '';
  container.style.display = 'block';
  
  // Hide any previous password section and verification
  document.getElementById('newPasswordSection').style.display = 'none';
  document.getElementById('securityResetBtn').style.display = 'none';
  document.getElementById('verificationStatus').style.display = 'none';
  
  // Load security questions (show 2 random ones)
  const questionKeys = Object.keys(securityQuestions);
  const selectedQuestions = [];
  
  // Randomly select 2 questions
  while (selectedQuestions.length < 2 && selectedQuestions.length < questionKeys.length) {
    const randomKey = questionKeys[Math.floor(Math.random() * questionKeys.length)];
    if (!selectedQuestions.includes(randomKey)) {
      selectedQuestions.push(randomKey);
    }
  }
  
  // Display selected questions
  selectedQuestions.forEach((questionKey, index) => {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'security-question-item';
    questionDiv.innerHTML = `
      <label class="security-question-label">Question ${index + 1}: ${securityQuestions[questionKey].question}</label>
      <input type="text" 
             class="modal-input security-answer-input" 
             placeholder="Your answer" 
             required 
             data-question="${questionKey}"
             style="margin-top: 8px;" />
    `;
    container.appendChild(questionDiv);
  });
  
  securityStatus.textContent = `Please answer ${selectedQuestions.length} security questions.`;
  securityStatus.className = 'modal-status';
  
  // Add event listener for answer input
  document.querySelectorAll('.security-answer-input').forEach(input => {
    input.addEventListener('input', function() {
      checkSecurityQuestionAnswers();
    });
  });
}

function checkSecurityQuestionAnswers() {
  const answers = document.querySelectorAll('.security-answer-input');
  let allAnswered = true;
  
  answers.forEach(input => {
    if (!input.value.trim()) {
      allAnswered = false;
    }
  });
  
  if (allAnswered && answers.length >= 2) {
    // All answers are filled, verify them
    verifySecurityQuestionAnswers();
  } else {
    // Hide password section if not all answers are filled
    document.getElementById('newPasswordSection').style.display = 'none';
    document.getElementById('securityResetBtn').style.display = 'none';
    document.getElementById('verificationStatus').style.display = 'none';
  }
}

function verifySecurityQuestionAnswers() {
  if (!currentSecurityQuestions) return;
  
  const answers = document.querySelectorAll('.security-answer-input');
  let allCorrect = true;
  
  answers.forEach(input => {
    const questionKey = input.getAttribute('data-question');
    const userAnswer = input.value.trim().toLowerCase();
    const correctAnswer = currentSecurityQuestions[questionKey]?.answer?.toLowerCase();
    
    if (userAnswer !== correctAnswer) {
      allCorrect = false;
    }
  });
  
  const verificationStatus = document.getElementById('verificationStatus');
  verificationStatus.style.display = 'block';
  
  if (allCorrect) {
    // Answers are correct - show password section
    verificationStatus.textContent = '✓ Answers verified! Please set your new password below.';
    verificationStatus.className = 'modal-status modal-success';
    document.getElementById('newPasswordSection').style.display = 'block';
    document.getElementById('securityResetBtn').style.display = 'block';
    
    // Reset password fields
    document.getElementById('securityNewPassword').value = '';
    document.getElementById('securityConfirmPassword').value = '';
    document.getElementById('securityMatchStatus').textContent = '';
    
    // Update all requirement indicators to unmet
    ['Length', 'Uppercase', 'Lowercase', 'Number', 'Special'].forEach(req => {
      const element = document.getElementById(`securityReq${req}`);
      element.className = 'requirement-item requirement-unmet';
      element.querySelector('.requirement-icon').textContent = '○';
    });
  } else {
    // Answers are incorrect
    verificationStatus.textContent = '✗ One or more answers are incorrect. Please try again.';
    verificationStatus.className = 'modal-status modal-error';
    document.getElementById('newPasswordSection').style.display = 'none';
    document.getElementById('securityResetBtn').style.display = 'none';
  }
}

// ==================== HANDLE SECURITY QUESTIONS PASSWORD RESET ====================
document.getElementById('securityQuestionsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = document.getElementById('securityEmail').value.trim();
  const newPassword = document.getElementById('securityNewPassword').value;
  const confirmPassword = document.getElementById('securityConfirmPassword').value;
  
  if (!email) {
    securityStatus.textContent = 'Please enter your email address.';
    securityStatus.className = 'modal-status modal-error';
    return;
  }
  
  // Check password strength
  const requirements = validatePassword(newPassword);
  const allValid = Object.values(requirements).every(req => req === true);
  
  if (!allValid) {
    securityStatus.textContent = 'Password does not meet all requirements.';
    securityStatus.className = 'modal-status modal-error';
    return;
  }
  
  if (newPassword !== confirmPassword) {
    securityStatus.textContent = 'Passwords do not match.';
    securityStatus.className = 'modal-status modal-error';
    return;
  }
  
  // Disable button and show loading
  const securityResetBtn = document.getElementById('securityResetBtn');
  securityResetBtn.disabled = true;
  securityResetBtn.textContent = 'Resetting...';
  securityStatus.textContent = 'Resetting your password...';
  securityStatus.className = 'modal-status';
  
  try {
    // Find user and update password
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", email));
    const querySnapshot = await getDocs(q);
    
    if (!querySnapshot.empty) {
      const userDoc = querySnapshot.docs[0];
      const userData = userDoc.data();
      
      // For demo purposes, we'll show a success message
      // In production, you would need to implement proper password reset logic here
      
      securityStatus.textContent = '✓ Password reset successful! You can now log in with your new password.';
      securityStatus.className = 'modal-status modal-success';
      securityResetBtn.textContent = 'Reset Successful ✓';
      
      // Reset the form
      setTimeout(() => {
        document.getElementById('forgotPasswordModal').style.display = 'none';
        securityResetBtn.disabled = false;
        securityResetBtn.textContent = 'Reset Password';
        document.getElementById('securityQuestionsForm').reset();
        document.getElementById('securityQuestionsContainer').style.display = 'none';
        document.getElementById('newPasswordSection').style.display = 'none';
        document.getElementById('verificationStatus').style.display = 'none';
        securityResetBtn.style.display = 'none';
      }, 3000);
    }
  } catch (error) {
    console.error('Security questions reset error:', error);
    securityStatus.textContent = 'Error resetting password. Please try again.';
    securityStatus.className = 'modal-status modal-error';
    securityResetBtn.disabled = false;
    securityResetBtn.textContent = 'Reset Password';
  }
});

// ==================== LOGIN FORM SUBMISSION ====================
const loginForm = document.getElementById('loginForm');
if (loginForm) {
  loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const status = document.getElementById('status');

    // Clear previous status
    status.textContent = '';
    status.style.color = 'red';

    // Basic validation
    if (!email || !password) {
      status.textContent = "Please enter both email and password.";
      return;
    }

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      
      // Get user data from Firestore
      const userDoc = await getDoc(doc(db, "users", user.uid));

      if (userDoc.exists()) {
        const data = userDoc.data();

        // Check if user needs to change password
        if (data.mustChangePassword === true) {
          loginForm.style.display = 'none';
          document.getElementById('changePasswordSection').style.display = 'block';
          window.loggedInUser = user;
          return;
        }

        // Redirect based on role
        switch (data.role) {
          case "admin":
            window.location.href = "ADMINDASHBORD.html";
            break;
          case "project_manager":
            window.location.href = "PM-dashboard.html";
            break;
          case "maintenance":  // ADD THIS CASE
            window.location.href = "Maintenance_Dashboard.html";
            break;
          default:
            window.location.href = "DASHBOARD.html";
        }
      } else {
        status.textContent = "User account not properly configured. Please contact support.";
      }
    } catch (error) {
      console.error("Login error:", error);
      
      // User-friendly error messages
      if (error.code === 'auth/user-not-found') {
        status.textContent = "No account found with this email address.";
      } else if (error.code === 'auth/wrong-password') {
        status.textContent = "Incorrect password. Please try again.";
      } else if (error.code === 'auth/invalid-email') {
        status.textContent = "Invalid email address format.";
      } else if (error.code === 'auth/too-many-requests') {
        status.textContent = "Too many failed attempts. Please try again later.";
      } else if (error.code === 'auth/network-request-failed') {
        status.textContent = "Network error. Please check your internet connection.";
      } else {
        status.textContent = "Login failed. Please try again.";
      }
    }
  });
}
</script>
</body>
</html>
