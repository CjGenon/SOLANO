<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact Our Team â€“ Solano Hills</title>
  <link rel="stylesheet" href="CONTACT.css" />
  <!-- Add EmailJS script -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
  <!-- ======================== NAVBAR ======================== -->
  <div class="navbar" id="navbar">
    <div class="nav-inner">
      <div class="logo-container">
        <img class="logo" src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
      </div>
      <nav class="nav-content">
        <ul>
          <li><a href="index.html#home">Home</a></li>
          <li><a href="index.html#about">About</a></li>
          <li><a href="index.html#apartments">Apartments</a></li>
          <li><a href="index.html#amenities">Amenities</a></li>
          <li><a href="index.html#contact">Contact</a></li>
          <li><a href="LogIn.html">Log In</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- ======================== CONTACT HEADER ======================== -->
  <header class="contact-header">
    <h1>Get in Touch</h1>
    <p>Our team is here to help you with your questions about getting your new home.</p>
  </header>

  <!-- ======================== CONTACT FORM ======================== -->
  <section class="inquiry-form-section">
    <h2>Contact Us</h2>

    <form id="contactForm">
      <input type="text" id="name" placeholder="Your Name" required />
      <input type="email" id="email" placeholder="Your Email" required />
      <input type="text" id="number" placeholder="917 123 4567" 
             maxlength="11" inputmode="numeric" 
             oninput="this.value = this.value.replace(/[^0-9]/g, '')" 
             required />

      <select id="Employement_Type" name="Employement_Type" required>
        <option value="" disabled selected>Select Employment Type</option>
        <option value="Employed">Employed</option>
        <option value="Self-Employed">Self-Employed</option>
        <option value="Business Owner">Business Owner</option>
      </select>

      <label class="small" for="inquiry_topic">What are you inquiring about?</label>
      <select id="inquiry_topic" name="inquiry_topic" required>
        <option value="" disabled selected>Select an option</option>
        <option value="payment">Payment / Price</option>
        <option value="interested_1b">I'm interested in 1 Bedroom unit</option>
        <option value="interested_2b">I'm interested in 2 Bedroom unit</option>
        <option value="interested_both">I'm interested in both bedroom unit</option>
        <option value="other">Other (explain in message)</option>
      </select>

      <div id="paymentSection" class="inquiry-section hidden">
        <label class="small" for="payment_info">Which payment detail do you want to know?</label>
        <select id="payment_info" name="payment_info">
          <option value="" disabled selected>Select payment info</option>
          <option value="downpayment">Downpayment</option>
          <option value="monthly_amortization">Monthly Amortization</option>
          <option value="total_price">Total Price</option>
          <option value="payment_terms">Payment Terms</option>
          <option value="other_payment">Other (explain in message)</option>
        </select>
      </div>

      <textarea id="message" placeholder="Your Question or details (use this to clarify what you need)" required></textarea>

      <button type="submit" id="submitBtn">Send Message</button>
    </form>
  </section>

  <!-- POPUP -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <p>Form Submitted.<br>Wait for our PM to reach you out please standby.</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>

  <div id="status" style="color:red; margin-top:10px;"></div>

  <!-- ======================== CHAT TOGGLE BUTTON & CHAT BOX ======================== -->
  <button id="chatToggleBtn">
    <span style="font-size: 18px;">ðŸ’¬</span> Live Chat
  </button>
  <div id="chatBox" aria-hidden="true">
    <div id="chatHeader">
      Solano Hills Support
      <button id="chatCloseBtn" aria-label="Close chat">Ã—</button>
    </div>
    <div id="messagesContainerChat">
      Loading chat messages...
    </div>
    <div id="chatInputContainer">
      <textarea id="chatMessageInput" placeholder="Type your message..." rows="2"></textarea>
      <button id="sendChatBtn" disabled>Send</button>
    </div>
  </div>

  <!-- ======================== FIREBASE & SCRIPT ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      where,
      getDocs,
      orderBy,
      updateDoc,
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Initialize EmailJS with your public key
    // Replace 'YOUR_PUBLIC_KEY' with your actual EmailJS public key
    (function() {
      emailjs.init("JOQqxoCLq72v5huex"); // Get this from EmailJS dashboard
    })();

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.appspot.com",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Mortgage Calculator Link
    const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";

    // ======================= PERSISTENT GUEST ID ==========================
    function getGuestId() {
      let guestId = localStorage.getItem("guestId");

      if (!guestId) {
        guestId = crypto.randomUUID();
        localStorage.setItem("guestId", guestId);
      }

      return guestId;
    }

    // ======================= EMAILJS FUNCTION ==========================
    async function sendEmailNotification(formData) {
      try {
        // Map inquiry topic to readable text
        const inquiryTopicMap = {
          payment: "Payment / Price Inquiry",
          interested_1b: "Interested in 1 Bedroom Unit",
          interested_2b: "Interested in 2 Bedroom Unit",
          interested_both: "Interested in Both Unit Types",
          other: "Other Inquiry"
        };

        // Map employment type to readable text
        const employmentMap = {
          "Employed": "Employed",
          "Self-Employed": "Self-Employed", 
          "Business Owner": "Business Owner"
        };

        // Prepare email parameters
        const templateParams = {
          to_name: "Solano Hills Team",
          from_name: formData.name,
          from_email: formData.email,
          phone_number: formData.number,
          employment_type: employmentMap[formData.Employement_Type] || formData.Employement_Type,
          inquiry_topic: inquiryTopicMap[formData.inquiry_topic] || formData.inquiry_topic,
          payment_info: formData.payment_info || "Not applicable",
          message: formData.message || formData.firstMessageContent,
          inquiry_id: formData.inquiryId,
          date: new Date().toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          }),
          time: new Date().toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
          }),
          subject: `New Inquiry from ${formData.name} - ${inquiryTopicMap[formData.inquiry_topic] || formData.inquiry_topic}`
        };

        // Send email using EmailJS
        // Replace 'YOUR_SERVICE_ID' and 'YOUR_TEMPLATE_ID' with your actual IDs
        const response = await emailjs.send(
          'service_hehhqyt',      // Replace with your EmailJS Service ID
          'template_dc67lup',     // Replace with your EmailJS Template ID
          templateParams
        );
        
        console.log('Email sent successfully:', response.status, response.text);
        return response;
      } catch (error) {
        console.error('Failed to send email:', error);
        // Don't throw error to prevent form submission failure
        // Email failure shouldn't stop form submission
        return null;
      }
    }

    // UI elements
    const inquiryTopic = document.getElementById('inquiry_topic');
    const paymentSection = document.getElementById('paymentSection');
    const paymentSelect = document.getElementById('payment_info');
    const messageTextarea = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');

    function hideAllConditionalSections() {
      paymentSection.classList.add('hidden');
      paymentSelect.removeAttribute('required');

      messageTextarea.style.display = 'none';
      messageTextarea.required = false;
      messageTextarea.value = '';
    }
    hideAllConditionalSections();

    inquiryTopic.addEventListener('change', () => {
      const val = inquiryTopic.value;
      hideAllConditionalSections();

      if (val === 'payment') {
        paymentSection.classList.remove('hidden');
        paymentSelect.setAttribute('required', 'required');
      }

      if (val === 'other') {
        messageTextarea.style.display = 'block';
        messageTextarea.required = true;
      }
    });

    paymentSelect.addEventListener('change', () => {
      const val = paymentSelect.value;

      if (val === 'other_payment') {
        messageTextarea.style.display = 'block';
        messageTextarea.required = true;
      } else {
        if (inquiryTopic.value !== 'other') {
          messageTextarea.style.display = 'none';
          messageTextarea.required = false;
          messageTextarea.value = '';
        }
      }
    });

    // ========================= FORM SUBMIT ==========================
    document.getElementById('contactForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Disable submit button to prevent multiple submissions
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const number = document.getElementById('number').value.trim();
      const Employement_Type = document.getElementById('Employement_Type').value;
      const inquiry_topic = document.getElementById('inquiry_topic').value;
      const payment_info = paymentSelect.value || null;
      const message = messageTextarea.value.trim();

      const anonId = getGuestId();

      // Map inquiry topic to readable text for first message
      const inquiryTopicMap = {
        payment: "Payment / Price",
        interested_1b: "I'm interested in 1 Bedroom unit",
        interested_2b: "I'm interested in 2 Bedroom unit",
        interested_both: "I'm interested in both bedroom unit",
        other: "Other (explain in message)"
      };

      const firstMessageContent = message || `${inquiryTopicMap[inquiry_topic] || inquiry_topic}`;

      const payload = {
        name,
        email,
        number,
        Employement_Type,
        inquiry_topic,
        payment_info: inquiry_topic === 'payment' ? payment_info : null,
        ownerId: anonId,
        status: "new",
        createdAt: serverTimestamp()
      };

      try {
        // Save to Firestore
        const inquiryRef = await addDoc(collection(db, "inquiries"), payload);
        
        // Save first message
        await addDoc(collection(db, "inquiries", inquiryRef.id, "messages"), {
          sender: "user",
          senderName: name,
          senderId: anonId,
          content: firstMessageContent,
          timestamp: serverTimestamp(),
          readByPM: false,
          readByUser: true
        });

        // Prepare data for email
        const emailData = {
          name,
          email,
          number,
          Employement_Type,
          inquiry_topic,
          payment_info: inquiry_topic === 'payment' ? payment_info : null,
          message,
          firstMessageContent,
          inquiryId: inquiryRef.id
        };

        // Send email notification
        await sendEmailNotification(emailData);

        // Show success popup
        document.getElementById("popup").classList.remove("hidden");
        
        // Reset form
        e.target.reset();
        hideAllConditionalSections();

        // Re-enable submit button
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send Message';
        }, 2000);

      } catch (error) {
        document.getElementById("status").innerText = "Error: " + error.message;
        console.error("Form submission error:", error);
        
        // Re-enable submit button on error
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
      }
    });

    window.closePopup = function () {
      document.getElementById("popup").classList.add("hidden");
    };

    // ========================= CHAT SYSTEM ==========================
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatBox = document.getElementById('chatBox');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const messagesContainerChat = document.getElementById('messagesContainerChat');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatBtn = document.getElementById('sendChatBtn');

    let unsubscribeMessages = null;
    let currentInquiryId = null;

    // Function to format message content with proper formatting
    function formatMessageContent(content) {
      // Universal URL detection â€” make ALL links clickable
      const urlRegex = /(https?:\/\/[^\s]+)/g;

      content = content.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank">${url}</a>`;
      });

      // Convert new lines
      return content.replace(/\n/g, '<br>');
    }

    async function startListeningToMessages() {
      const anonId = getGuestId();

      const inquiriesQuery = query(
        collection(db, "inquiries"),
        where("ownerId", "==", anonId),
        orderBy("createdAt", "desc")
      );

      const inquiriesSnapshot = await getDocs(inquiriesQuery);
      if (inquiriesSnapshot.empty) {
        messagesContainerChat.innerHTML = "<div class='system-message'>No inquiries found. Use the contact form above to send a message first.</div>";
        chatMessageInput.disabled = true;
        sendChatBtn.disabled = true;
        currentInquiryId = null;
        return;
      }

      const latestInquiryDoc = inquiriesSnapshot.docs[0];
      currentInquiryId = latestInquiryDoc.id;
      const inquiryData = latestInquiryDoc.data();

      const inquiryTopicMap = {
        payment: "Payment / Price",
        interested_1b: "1-Bedroom Unit",
        interested_2b: "2-Bedroom Unit",
        interested_both: "Both Unit Types",
        other: "Other"
      };

      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || inquiryData.inquiry_topic || "General Inquiry";

      if (unsubscribeMessages) unsubscribeMessages();

      const messagesQuery = query(
        collection(db, "inquiries", currentInquiryId, "messages"),
        orderBy("timestamp", "asc")
      );

      unsubscribeMessages = onSnapshot(messagesQuery, (messagesSnapshot) => {
        let html = `<div class="system-message"><strong>Your Inquiry:</strong> ${inquiryTopicText}</div>`;
        
        if (messagesSnapshot.empty) {
          html += "<div class='system-message'>No messages yet. Send a message to start the conversation.</div>";
        } else {
          messagesSnapshot.forEach(msgDoc => {
            const msg = msgDoc.data();
            const senderClass = msg.sender === "user" ? "sender-user" : "sender-pm";
            const senderName = msg.sender === "user" ? "You" : "Project Manager";
            const messageTime = msg.timestamp?.toDate 
              ? msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
              : "";
            
            html += `
              <div class="message-block ${senderClass}">
                <strong>${senderName}</strong>
                <div>${formatMessageContent(msg.content)}</div>
                <small>${messageTime}</small>
              </div>
            `;
          });
        }
        
        messagesContainerChat.innerHTML = html;
        chatMessageInput.disabled = false;
        sendChatBtn.disabled = true;
        
        // Auto-scroll to bottom
        setTimeout(() => {
          messagesContainerChat.scrollTop = messagesContainerChat.scrollHeight;
        }, 100);
      });
    }

    chatToggleBtn.addEventListener('click', () => {
      chatBox.classList.add('open');
      chatBox.setAttribute('aria-hidden', 'false');
      chatToggleBtn.style.opacity = '0';
      chatToggleBtn.style.pointerEvents = 'none';
      startListeningToMessages();
      setTimeout(() => chatMessageInput.focus(), 100);
    });

    chatCloseBtn.addEventListener('click', () => {
      chatBox.classList.remove('open');
      chatBox.setAttribute('aria-hidden', 'true');
      chatToggleBtn.style.opacity = '1';
      chatToggleBtn.style.pointerEvents = 'auto';

      if (unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = null;
      currentInquiryId = null;
    });

    chatMessageInput.addEventListener('input', () => {
      sendChatBtn.disabled = chatMessageInput.value.trim() === '';
      // Auto-resize textarea
      chatMessageInput.style.height = 'auto';
      chatMessageInput.style.height = Math.min(chatMessageInput.scrollHeight, 120) + 'px';
    });

    // Allow Enter to send (Shift+Enter for new line)
    chatMessageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendChatBtn.disabled) {
          sendChatBtn.click();
        }
      }
    });

    sendChatBtn.addEventListener('click', async () => {
      const content = chatMessageInput.value.trim();
      if (!content) return;

      if (!currentInquiryId) {
        alert("No inquiry found. Please submit the contact form first.");
        return;
      }

      sendChatBtn.disabled = true;

      chatMessageInput.value = '';
      chatMessageInput.style.height = 'auto';
      chatMessageInput.dispatchEvent(new Event('input', { bubbles: true }));

      const anonId = getGuestId();

      try {
        await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
          sender: "user",
          senderName: "Anonymous",
          senderId: anonId,
          content,
          timestamp: serverTimestamp(),
          readByPM: false,
          readByUser: true
        });

        await updateDoc(doc(db, "inquiries", currentInquiryId), { 
          status: "user replied",
          lastUpdated: serverTimestamp()
        });

      } catch (error) {
        console.error("Error sending message:", error.message);
        sendChatBtn.disabled = false;
        
        // Show error in chat
        const errorMsg = document.createElement('div');
        errorMsg.className = 'message-block sender-pm';
        errorMsg.innerHTML = '<strong>System</strong><div>Failed to send message. Please try again.</div>';
        messagesContainerChat.appendChild(errorMsg);
      }
    });

    // Initialize chat with welcome message if no inquiry exists
    window.addEventListener('DOMContentLoaded', () => {
      const anonId = getGuestId();
      const inquiriesQuery = query(
        collection(db, "inquiries"),
        where("ownerId", "==", anonId),
        orderBy("createdAt", "desc")
      );

      getDocs(inquiriesQuery).then(snapshot => {
        if (snapshot.empty) {
          // Show welcome message in chat preview
          messagesContainerChat.innerHTML = `
            <div class="system-message">
              <strong>Welcome to Solano Hills!</strong><br>
              Start by submitting the contact form above, then you can chat with our Project Manager here.
            </div>
          `;
        }
      });
    });

  </script>
</body>
</html>
