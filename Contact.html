<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact Our Team â€“ Solano Hills</title>
  <link rel="stylesheet" href="contact.css" />
  <style>
    /* Hide message textarea by default */
    #message {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ======================== NAVBAR ======================== -->
  <div class="navbar" id="navbar">
    <div class="nav-inner">
      <div class="logo-container">
        <img class="logo" src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
      </div>
      <nav class="nav-content">
        <ul>
          <li><a href="index.html#home">Home</a></li>
          <li><a href="index.html#about">About</a></li>
          <li><a href="index.html#apartments">Apartments</a></li>
          <li><a href="index.html#amenities">Amenities</a></li>
          <li><a href="index.html#contact">Contact</a></li>
          <li><a href="LogIn.html">Log In</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- ======================== CONTACT HEADER ======================== -->
  <header class="contact-header">
    <h1>Get in Touch</h1>
    <p>Our team is here to help you with your questions about getting your new home.</p>
  </header>

  <!-- ======================== CONTACT FORM ======================== -->
  <section class="inquiry-form-section">
    <h2>Contact Us</h2>

    <form id="contactForm">
      <input type="text" id="name" placeholder="Your Name" required />
      <input type="email" id="email" placeholder="Your Email" required />
      <input type="tel" id="number" placeholder="Your Number" required />

      <select id="Employement_Type" name="Employement_Type" required>
        <option value="" disabled selected>Select Employment Type</option>
        <option value="Employed">Employed</option>
        <option value="Self-Employed">Self-Employed</option>
        <option value="Business Owner">Business Owner</option>
      </select>

      <label class="small" for="inquiry_topic">What are you inquiring about?</label>
      <select id="inquiry_topic" name="inquiry_topic" required>
        <option value="" disabled selected>Select an option</option>
        <option value="payment">Payment / Price</option>
        <option value="interested_1b">I'm interested in 1 Bedroom unit</option>
        <option value="interested_2b">I'm interested in 2 Bedroom unit</option>
        <option value="interested_both">I'm interested in both bedroom unit</option>
        <option value="other">Other (explain in message)</option>
      </select>

      <div id="paymentSection" class="inquiry-section hidden">
        <label class="small" for="payment_info">Which payment detail do you want to know?</label>
        <select id="payment_info" name="payment_info">
          <option value="" disabled selected>Select payment info</option>
          <option value="downpayment">Downpayment</option>
          <option value="monthly_amortization">Monthly Amortization</option>
          <option value="total_price">Total Price</option>
          <option value="payment_terms">Payment Terms</option>
          <option value="other_payment">Other (explain in message)</option>
        </select>
      </div>

      <textarea id="message" placeholder="Your Question or details (use this to clarify what you need)" required></textarea>

      <button type="submit">Send Message</button>
    </form>
  </section>

  <!-- POPUP -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <p>Form Submitted.<br>Wait for our PM to reach you out please standby.</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>

  <div id="status" style="color:red; margin-top:10px;"></div>

  <!-- ======================== CHAT TOGGLE BUTTON & CHAT BOX ======================== -->
  <div id="chatToggleBtn">Chat</div>
  <div id="chatBox" aria-hidden="true">
    <div id="chatHeader">
      Live Chat
      <button id="chatCloseBtn" aria-label="Close chat">&times;</button>
    </div>
    <div id="messagesContainerChat">
      Loading chat messages...
    </div>
    <div id="chatInputContainer">
      <textarea id="chatMessageInput" placeholder="Type your message..." rows="2"></textarea>
      <button id="sendChatBtn" disabled>Send</button>
    </div>
  </div>

  <!-- ======================== FIREBASE & SCRIPT ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      where,
      getDocs,
      orderBy,
      updateDoc,
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.appspot.com",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI elements
    const inquiryTopic = document.getElementById('inquiry_topic');
    const paymentSection = document.getElementById('paymentSection');
    const paymentSelect = document.getElementById('payment_info');
    const messageTextarea = document.getElementById('message');

    // Hide payment section and textarea initially
    function hideAllConditionalSections() {
      paymentSection.classList.add('hidden');
      paymentSelect.removeAttribute('required');

      messageTextarea.style.display = 'none';
      messageTextarea.required = false;
      messageTextarea.value = '';
    }
    hideAllConditionalSections();

    inquiryTopic.addEventListener('change', () => {
      const val = inquiryTopic.value;
      hideAllConditionalSections();

      if (val === 'payment') {
        paymentSection.classList.remove('hidden');
        paymentSelect.setAttribute('required', 'required');
      }

      if (val === 'other') {
        messageTextarea.style.display = 'block';
        messageTextarea.required = true;
      }
    });

    paymentSelect.addEventListener('change', () => {
      const val = paymentSelect.value;

      if (val === 'other_payment') {
        messageTextarea.style.display = 'block';
        messageTextarea.required = true;
      } else {
        // Only hide if inquiry topic isn't 'other'
        if (inquiryTopic.value !== 'other') {
          messageTextarea.style.display = 'none';
          messageTextarea.required = false;
          messageTextarea.value = '';
        }
      }
    });

    // Get or create anonymous ID for session
    function getAnonymousId() {
      let anonId = sessionStorage.getItem('anonId');
      if (!anonId) {
        anonId = crypto.randomUUID();
        sessionStorage.setItem('anonId', anonId);
      }
      return anonId;
    }

    // Form submit for new inquiry
    document.getElementById('contactForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const number = document.getElementById('number').value.trim();
      const Employement_Type = document.getElementById('Employement_Type').value;
      const inquiry_topic = document.getElementById('inquiry_topic').value;
      const payment_info = paymentSelect.value || null;
      const message = messageTextarea.value.trim();

      const anonId = getAnonymousId();

      const payload = {
        name,
        email,
        number,
        Employement_Type,
        inquiry_topic,
        payment_info: inquiry_topic === 'payment' ? payment_info : null,
        anonymousId: anonId,
        status: "new",
        createdAt: serverTimestamp()
      };

      try {
        // Create inquiry document
        const inquiryRef = await addDoc(collection(db, "inquiries"), payload);

        // Add first message inside subcollection "messages"
        await addDoc(collection(db, "inquiries", inquiryRef.id, "messages"), {
          sender: "user",
          senderName: name,
          content: message,
          timestamp: serverTimestamp(),
          readByPM: false,
          readByUser: true
        });

        document.getElementById("popup").classList.remove("hidden");
        e.target.reset();
        hideAllConditionalSections();

      } catch (error) {
        document.getElementById("status").innerText = "Error: " + error.message;
      }
    });

    window.closePopup = function () {
      document.getElementById("popup").classList.add("hidden");
    };

    // The chat and real-time message listener code (unchanged from your original script) below:

    // UI elements for chat
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatBox = document.getElementById('chatBox');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const messagesContainerChat = document.getElementById('messagesContainerChat');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatBtn = document.getElementById('sendChatBtn');

    // Real-time listener unsubscribe handle
    let unsubscribeMessages = null;
    let currentInquiryId = null;

    // Real-time listener function for chat messages
    async function startListeningToMessages() {
      const anonId = getAnonymousId();

      // Query inquiries by anonymousId, get the latest one (by createdAt desc)
      const inquiriesQuery = query(
        collection(db, "inquiries"),
        where("anonymousId", "==", anonId),
        orderBy("createdAt", "desc")
      );

      const inquiriesSnapshot = await getDocs(inquiriesQuery);
      if (inquiriesSnapshot.empty) {
        messagesContainerChat.innerHTML = "<p>No inquiries found. Use the contact form above to send a message first.</p>";
        chatMessageInput.disabled = true;
        sendChatBtn.disabled = true;
        currentInquiryId = null;
        return;
      }

      // Take the latest inquiry
      const latestInquiryDoc = inquiriesSnapshot.docs[0];
      currentInquiryId = latestInquiryDoc.id;
      const inquiryData = latestInquiryDoc.data();

      // Map inquiry topic codes to readable text
      const inquiryTopicMap = {
        payment: "Payment / Price",
        interested_1b: "I'm interested in 1 Bedroom unit",
        interested_2b: "I'm interested in 2 Bedroom unit",
        interested_both: "I'm interested in both bedroom unit",
        other: "Other (explain in message)"
      };

      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || inquiryData.inquiry_topic || "N/A";

      // Unsubscribe previous listener if any
      if (unsubscribeMessages) unsubscribeMessages();

      // Query messages subcollection ordered by timestamp asc
      const messagesQuery = query(
        collection(db, "inquiries", currentInquiryId, "messages"),
        orderBy("timestamp", "asc")
      );

      unsubscribeMessages = onSnapshot(messagesQuery, (messagesSnapshot) => {
        let html = `<div class="system-message"><strong>Your Inquiry Topic:</strong> ${inquiryTopicText}</div>`;
        if (messagesSnapshot.empty) {
          html += "<p>No messages yet.</p>";
        } else {
          messagesSnapshot.forEach(msgDoc => {
            const msg = msgDoc.data();
            const senderClass = msg.sender === "user" ? "sender-user" : "sender-pm";
            html += `
              <div class="message-block ${senderClass}">
                <strong>${msg.sender === "user" ? "You" : "Project Manager"}:</strong><br />
                <span>${msg.content}</span><br />
                <small>${msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleString() : ""}</small>
              </div>
            `;
          });
        }
        messagesContainerChat.innerHTML = html;
        chatMessageInput.disabled = false;
        sendChatBtn.disabled = true; // disable send initially until input
      });
    }

    // Toggle chat box open/close
    chatToggleBtn.addEventListener('click', () => {
      chatBox.classList.add('open');
      chatBox.setAttribute('aria-hidden', 'false');
      chatToggleBtn.style.opacity = '0';
      chatToggleBtn.style.pointerEvents = 'none';
      startListeningToMessages();
      chatMessageInput.focus();
    });

    chatCloseBtn.addEventListener('click', () => {
      chatBox.classList.remove('open');
      chatBox.setAttribute('aria-hidden', 'true');
      chatToggleBtn.style.opacity = '1';
      chatToggleBtn.style.pointerEvents = 'auto';

      if (unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = null;
      currentInquiryId = null;
    });

    // Enable send button only when input has text
    chatMessageInput.addEventListener('input', () => {
      sendChatBtn.disabled = chatMessageInput.value.trim() === '';
    });

    // Send a chat message to the latest inquiry
    sendChatBtn.addEventListener('click', async () => {
      const content = chatMessageInput.value.trim();
      if (!content) return;

      if (!currentInquiryId) {
        alert("No inquiry found. Please submit the contact form first.");
        return;
      }

      sendChatBtn.disabled = true;

      // Clear the input immediately
      chatMessageInput.value = '';
      chatMessageInput.dispatchEvent(new Event('input', { bubbles: true }));

      try {
        // Add message in messages subcollection
        await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
          sender: "user",
          senderName: "Anonymous",
          content,
          timestamp: serverTimestamp(),
          readByPM: false,
          readByUser: true
        });

        // Try to update inquiry status (may fail if no permission)
        await updateDoc(doc(db, "inquiries", currentInquiryId), { status: "user replied" });

      } catch (error) {
        console.error("Error sending message:", error.message);
        sendChatBtn.disabled = false;
      }
    });

  </script>
</body>
</html>
