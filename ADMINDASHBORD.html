<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard ‚Äì Solano Hills</title>
  <link rel="stylesheet" href="Admin_Dashboard.css" />
</head>
<body>
  <!-- ======================== LOADING OVERLAY ======================== -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img
        src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp"
        alt="Solano Logo"
      />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')" class="active">Dashboard</a></li>
        <li><a href="#" onclick="loadContent(event, 'Payment Received')">Payment Received</a></li>
        <li><a href="#" onclick="loadContent(event, 'Maintenance Requests')">Maintenance Requests</a></li>
        <li>
          <a href="#" onclick="loadContent(event, 'Unit Owner Account Creation')">
            Unit Owner Account Creation
          </a>
        </li>
        <li><a href="#" onclick="loadContent(event, 'Feedback Received')">Feedback Received</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p>Loading overview‚Ä¶</p>
      </div>
    </div>
  </main>

  <!-- ======================== EXTERNAL LIBRARIES ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init("lqyGatNXQhoDJsu2B");
  </script>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ======================== MAIN DASHBOARD SCRIPT ======================== -->
  <script>
    // ==================== TAB PERSISTENCE ====================
    const TAB_STORAGE_KEY = 'admin_dashboard_active_tab';

    function saveActiveTab(tabName) {
      localStorage.setItem(TAB_STORAGE_KEY, tabName);
    }

    function getSavedTab() {
      return localStorage.getItem(TAB_STORAGE_KEY) || 'dashboard';
    }

    function updateActiveTabStyle(tabName) {
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => {
        link.classList.remove("active");
        const onclickVal = link.getAttribute("onclick") || "";
        if (onclickVal.includes(`'${tabName}'`)) {
          link.classList.add("active");
        }
      });
    }

    // ==================== SIMPLE LOADING FUNCTIONS ====================
    window.showLoading = function () {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('hidden');
      }
    };

    window.hideLoading = function () {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.add('hidden');
      }
    };

    window.setButtonLoading = function (button, isLoading) {
      if (!button) return;

      if (isLoading) {
        button.disabled = true;
        button.classList.add('button-loading');
        const originalText = button.textContent;
        button.setAttribute('data-original-text', originalText);
        button.textContent = 'Loading...';
      } else {
        button.disabled = false;
        button.classList.remove('button-loading');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
          button.textContent = originalText;
        }
      }
    };

    // ======================== FIREBASE INIT ========================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.appspot.com",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged((user) => {
      if (!user) {
        // Use the same casing as your actual login file
        window.location.href = "LogIn.html";
      } else {
        console.log("Admin logged in:", user.email);
      }
    });

    // Global drill-down state from KPI cards
    window.adminDashboardDrilldown = null;

    function formatCurrency(amount) {
      const num = Number(amount) || 0;
      return (
        "‚Ç±" +
        num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })
      );
    }

    // ======================== ROUTER ========================
    function loadContent(event, section) {
      if (event) event.preventDefault();

      showLoading();

      saveActiveTab(section);
      updateActiveTabStyle(section);

      const area = document.getElementById("mainContent");

      switch (section) {
        case "dashboard":
          area.innerHTML = `
            <div class="admin-header">
              <h1>Admin Dashboard</h1>
              <p>High-level overview for Solano Hills management.</p>
            </div>

            <div class="kpi-row">
              <div class="stat-card clickable" id="card-maintenance">
                <div class="stat-label">Maintenance Requests</div>
                <div class="stat-main" id="stat-maint-total">--</div>
                <div class="stat-sub" id="stat-maint-pending">Loading‚Ä¶</div>
                <div class="stat-sub" id="stat-maint-recent"></div>
              </div>

              <div class="stat-card clickable" id="card-payments">
                <div class="stat-label">Payments (This Month)</div>
                <div class="stat-main" id="stat-payments-amount">--</div>
                <div class="stat-sub" id="stat-payments-count">Loading‚Ä¶</div>
              </div>

              <div class="stat-card clickable" id="card-feedback">
                <div class="stat-label">Feedback</div>
                <div class="stat-main" id="stat-feedback-total">--</div>
                <div class="stat-sub" id="stat-feedback-recent">Loading‚Ä¶</div>
              </div>
            </div>

            <div class="dashboard-grid">
              <div class="dashboard-main-col">
                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Payments (Last 6 Months)</div>
                    <div class="chart-subtitle">Total collected per month</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="paymentsChart"></canvas>
                  </div>
                </div>

                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Feedback Rating Mix</div>
                    <div class="chart-subtitle">Distribution of 1‚Äì5 star feedback</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="feedbackChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="dashboard-side-col">
                <div class="chart-card small">
                  <div class="chart-header">
                    <div class="chart-title">Maintenance Status</div>
                    <div class="chart-subtitle">Open vs completed</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="maintenanceChart"></canvas>
                  </div>
                </div>

                <div class="calendar-card">
                  <h3><span>üìÖ</span> Calendar</h3>
                  <div id="adminCalendar"></div>
                </div>

                <div class="recent-card">
                  <h3>Recent Payments</h3>
                  <p class="recent-sub">Last 5 payments recorded in the system.</p>
                  <div id="recentPaymentsList"></div>
                </div>
              </div>
            </div>
          `;
          initAdminDashboard();
          break;

        case "Payment Received":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Payments Received</h2>
              <p>Real-time list of unit owner PayPal payments.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="paymentSearch">Search</label>
                <input
                  type="text"
                  id="paymentSearch"
                  placeholder="Search by unit owner or payer email‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="email-asc">Email (A to Z)</option>
                  <option value="email-desc">Email (Z to A)</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterBy">Quick range</label>
                <select id="filterBy">
                  <option value="all">All Payments</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="thisMonth">This Month</option>
                  <option value="lastMonth">Last Month</option>
                  <option value="thisYear">This Year</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="dateFrom">Date from</label>
                <input type="date" id="dateFrom" />
              </div>

              <div class="filter-group">
                <label for="dateTo">Date to</label>
                <input type="date" id="dateTo" />
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
            </div>

            <div id="stats" class="stats-strip">
              <span id="paymentCount">0</span> payments |
              <span>Total:</span> ‚Ç±<span id="totalAmount">0.00</span>
            </div>

            <div id="paypalSection" class="list-card">
              <h3 style="margin:0 0 10px;font-size:15px;">PayPal Payments</h3>
              <div id="paypalList">
                <p>Loading PayPal payments...</p>
              </div>
            </div>
          `;
          initPaymentReceived();
          break;

        case "Maintenance Requests":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Maintenance Requests</h2>
              <p>Maintenance requests submitted by unit owners.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="statusFilter">Filter by Status</label>
                <select id="statusFilter">
                  <option value="all">All Statuses</option>
                  <option value="Pending">Pending</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Complete">Complete</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="personnelFilter">Filter by Personnel</label>
                <select id="personnelFilter">
                  <option value="all">All Personnel</option>
                  <option value="unassigned">Unassigned</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="maintenanceSearch">Search</label>
                <input
                  type="text"
                  id="maintenanceSearch"
                  placeholder="Search by unit, email, or issue‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="unit-asc">Unit Number (A‚ÄìZ)</option>
                  <option value="unit-desc">Unit Number (Z‚ÄìA)</option>
                  <option value="email-asc">Email (A to Z)</option>
                  <option value="email-desc">Email (Z to A)</option>
                </select>
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
            </div>

            <div id="maintenanceStats" class="stats-strip">
              <span id="requestCount">0</span> requests |
              <span id="pendingCount">0</span> pending |
              <span id="inProgressCount">0</span> in progress |
              <span id="completeCount">0</span> complete
            </div>

            <div id="maintenanceList" class="list-card">
              <p>Loading maintenance requests...</p>
            </div>
          `;
          initMaintenanceRequests();
          break;

 case "Unit Owner Account Creation":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Account Creation</h2>
              <p>Create Solano accounts for unit owners or maintenance crew.</p>
            </div>

            <div class="list-card" style="margin-bottom: 20px;">
              <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Account Type</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="accountType" value="tenant" checked onclick="toggleAccountType(this)">
                    Unit Owner Account
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="accountType" value="maintenance" onclick="toggleAccountType(this)">
                    Maintenance Crew Account
                  </label>
                </div>
              </div>
            </div>

            <div class="list-card" id="tenantFormContainer">
              <h3 style="margin-top: 0;">Create New Unit Owner Account</h3>
              <p style="color: var(--solano-text-muted); margin-bottom: 15px;">Create Solano accounts for unit owners and assign units.</p>
              
              <form id="createTenantForm">
                <div class="filter-group" style="margin-bottom:10px;">
                  <label for="tenantEmail">Unit Owner Solano Email</label>
                  <input type="email" id="tenantEmail" required />
                </div>

                <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                  <div class="filter-group" style="flex:1; min-width:220px;">
                    <label for="tenantPassword">Temporary Password</label>
                    <input
                      type="text"
                      id="tenantPassword"
                      required
                      readonly
                      style="background:#222;border-color:rgba(255,255,255,0.18);"
                    />
                  </div>
                  <button type="button" id="generatePasswordBtn" class="btn-primary">
                    Generate Password
                  </button>
                </div>

                <div id="unitContainer" style="margin-bottom:10px;">
                  <div class="unit-row" style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                    <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
                      <option value="">-- Select Type --</option>
                      <option value="1B">1B (1 Bedroom)</option>
                      <option value="2B">2B (2 Bedroom)</option>
                    </select>
                    <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
                      <option value="">-- Select Unit Number --</option>
                    </select>
                    <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">
                      X
                    </button>
                  </div>
                </div>

                <button type="button" id="addUnitBtn" class="btn-secondary" style="margin-bottom:16px;">
                  + Add Another Unit
                </button>

                <div>
                  <button type="submit" class="btn-primary">
                    Create Unit Owner
                  </button>
                </div>
              </form>
            </div>

            <div class="list-card" id="maintenanceFormContainer" style="display: none;">
              <h3 style="margin-top: 0;">Create New Maintenance Crew Account</h3>
              <p style="color: var(--solano-text-muted); margin-bottom: 15px;">Create accounts for maintenance personnel with specialized roles.</p>
              
              <form id="createMaintenanceForm">
                <div class="filter-group" style="margin-bottom:10px;">
                  <label for="maintenanceEmail">Maintenance Crew Email</label>
                  <input type="email" id="maintenanceEmail" required />
                </div>

                <div class="filter-group" style="margin-bottom:10px;">
                  <label for="maintenanceName">Full Name</label>
                  <input type="text" id="maintenanceName" required 
                         placeholder="Enter full name" 
                         oninput="this.value = this.value.replace(/[^a-zA-Z\\s]/g, '')" />
                </div>

                <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                  <div class="filter-group" style="flex:1; min-width:220px;">
                    <label for="maintenancePassword">Temporary Password</label>
                    <input
                      type="text"
                      id="maintenancePassword"
                      required
                      readonly
                      style="background:#222;border-color:rgba(255,255,255,0.18);"
                    />
                  </div>
                  <button type="button" id="generateMaintenancePasswordBtn" class="btn-primary">
                    Generate Password
                  </button>
                </div>

                <div class="filter-group" style="margin-bottom:10px;">
                  <label for="maintenanceRole">Specialization / Role</label>
                  <select id="maintenanceRole" required style="padding:8px; width:100%;">
                    <option value="">-- Select Specialization --</option>
                    <option value="Electrician">Electrician</option>
                    <option value="Plumber">Plumber</option>
                    <option value="Carpenter">Carpenter</option>
                    <option value="HVAC / Aircon">HVAC / Aircon Technician</option>
                    <option value="General Maintenance">General Maintenance</option>
                    <option value="Painter">Painter</option>
                    <option value="Landscaper">Landscaper</option>
                    <option value="Supervisor">Maintenance Supervisor</option>
                  </select>
                </div>

                <div class="filter-group" style="margin-bottom:15px;">
                  <label for="maintenancePhone">Contact Number (Optional)</label>
                  <input type="tel" id="maintenancePhone" 
                         placeholder="09171234567" 
                         maxlength="11"
                         pattern="09[0-9]{9}"
                         title="Please enter a valid PH mobile number starting with 09 (11 digits)"
                         oninput="this.value = this.value.replace(/\\D/g, '').slice(0, 11)" />
                </div>

                <div>
                  <button type="submit" class="btn-primary" style="background: #8d6c39;">
                    Create Maintenance Account
                  </button>
                </div>
              </form>
            </div>

            <div class="list-card" style="margin-top: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Created Accounts</h3>
                <div style="display: flex; gap: 10px;">
                  <button id="showTenantsBtn" class="btn-secondary active" style="font-size: 12px; padding: 6px 12px;" onclick="toggleUserList('tenant')">
                    Unit Owners
                  </button>
                  <button id="showMaintenanceBtn" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="toggleUserList('maintenance')">
                    Maintenance Crew
                  </button>
                </div>
              </div>
              
              <div id="unitOwnersList" style="display: block;">
                <ul id="unitOwnersUl" style="list-style-type:none; padding-left:0; max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px;">
                  <li>Loading unit owners...</li>
                </ul>
              </div>
              
              <div id="maintenanceCrewList" style="display: none;">
                <ul id="maintenanceCrewUl" style="list-style-type:none; padding-left:0; max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px;">
                  <li>Loading maintenance crew...</li>
                </ul>
              </div>
            </div>
          `;
          initAccountCreation();
          break;
        case "Feedback Received":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Feedback from Unit Owners</h2>
              <p>View ratings and qualitative feedback submitted through the tenant portal.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="ratingFilter">Filter by Rating</label>
                <select id="ratingFilter">
                  <option value="all">All Ratings</option>
                  <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 Stars)</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 Stars)</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê (3 Stars)</option>
                  <option value="2">‚≠ê‚≠ê (2 Stars)</option>
                  <option value="1">‚≠ê (1 Star)</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="feedbackSearch">Search</label>
                <input
                  type="text"
                  id="feedbackSearch"
                  placeholder="Search by email or comments‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="rating-desc">Rating (High to Low)</option>
                  <option value="rating-asc">Rating (Low to High)</option>
                  <option value="email-asc">Email (A to Z)</option>
                  <option value="email-desc">Email (Z to A)</option>
                </select>
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
              <button id="refreshFeedbackBtn" class="btn-primary">Refresh</button>
            </div>

            <div id="feedbackStats" class="stats-strip">
              <span id="feedbackCount">0</span> feedback entries |
              <span>Average Rating:</span> <span id="averageRating">0.0</span>
            </div>

            <div id="feedback-list" class="list-card">
              <p>Loading feedback...</p>
            </div>
          `;
          initFeedbackReceived();
          break;

        default:
          area.innerHTML =
            "<h1>Welcome</h1><p>Select a menu option from the sidebar.</p>";
      }

      setTimeout(() => {
        hideLoading();
      }, 300);
    }

    // ======================== DASHBOARD LOGIC ========================
 // ======================== DASHBOARD LOGIC ========================
async function initAdminDashboard() {
  const maintTotalEl = document.getElementById("stat-maint-total");
  const maintPendingEl = document.getElementById("stat-maint-pending");
  const maintRecentEl = document.getElementById("stat-maint-recent");
  const payAmountEl = document.getElementById("stat-payments-amount");
  const payCountEl = document.getElementById("stat-payments-count");
  const fbTotalEl = document.getElementById("stat-feedback-total");
  const fbRecentEl = document.getElementById("stat-feedback-recent");
  const recentListEl = document.getElementById("recentPaymentsList");

  const now = new Date();
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();

  // ==== ADD: Function to update red dots globally ====
  function updateGlobalNotificationDots(newRequestsCount) {
    // 1. Update red dot on dashboard maintenance card
    const maintCard = document.getElementById("card-maintenance");
    if (maintCard) {
      // Remove existing red dot if any
      const existingDot = maintCard.querySelector('.dashboard-notification-dot');
      if (existingDot) {
        existingDot.remove();
      }
      
      // Create red dot notification
      if (newRequestsCount > 0) {
        const redDot = document.createElement('span');
        redDot.className = 'dashboard-notification-dot';
        redDot.style.cssText = `
          position: absolute;
          top: 12px;
          right: 12px;
          width: 12px;
          height: 12px;
          background-color: #ff4757;
          border-radius: 50%;
          animation: pulse 2s infinite;
          z-index: 10;
          border: 2px solid #2a2a2a;
        `;
        
        // Add count badge for multiple new requests
        if (newRequestsCount > 1) {
          const badge = document.createElement('span');
          badge.className = 'dashboard-notification-count';
          badge.style.cssText = `
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 20px;
            height: 20px;
            background-color: #ff4757;
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid #2a2a2a;
          `;
          badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
          redDot.appendChild(badge);
        }
        
        maintCard.style.position = 'relative';
        maintCard.appendChild(redDot);
        
        // Update the card text to show new requests
        if (maintRecentEl) {
          const recentText = maintRecentEl.textContent.split('(')[0].trim();
          maintRecentEl.innerHTML = `${recentText} <span style="color:#ff4757; font-weight:bold; margin-left:5px;">(${newRequestsCount} new)</span>`;
        }
      } else if (maintRecentEl) {
        // Remove new count from text
        const recentText = maintRecentEl.textContent.split('(')[0].trim();
        maintRecentEl.textContent = recentText;
      }
      
      // Update tooltip
      maintCard.title = newRequestsCount > 0 
        ? `Click to view ${newRequestsCount} new maintenance request${newRequestsCount > 1 ? 's' : ''}`
        : 'Click to view maintenance requests';
    }

    // 2. Update red dot on sidebar dashboard tab
    const dashboardNavItem = document.querySelector('a[onclick*="dashboard" i]');
    if (dashboardNavItem) {
      let dashDot = dashboardNavItem.querySelector('.sidebar-notification-dot');
      
      if (newRequestsCount > 0) {
        if (!dashDot) {
          dashDot = document.createElement('span');
          dashDot.className = 'sidebar-notification-dot';
          dashDot.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            background-color: #ff4757;
            border-radius: 50%;
            animation: pulse 2s infinite;
            z-index: 10;
          `;
          
          // Add count badge for multiple new requests
          if (newRequestsCount > 1) {
            const badge = document.createElement('span');
            badge.className = 'sidebar-notification-count';
            badge.style.cssText = `
              position: absolute;
              top: -8px;
              right: -8px;
              min-width: 18px;
              height: 18px;
              background-color: #ff4757;
              color: white;
              border-radius: 9px;
              font-size: 9px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 0 2px;
              border: 2px solid #1a1a1a;
            `;
            badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
            dashDot.appendChild(badge);
          }
          
          dashboardNavItem.style.position = 'relative';
          dashboardNavItem.appendChild(dashDot);
        } else {
          // Update existing dot
          const badge = dashDot.querySelector('.sidebar-notification-count');
          if (newRequestsCount > 1) {
            if (!badge) {
              const newBadge = document.createElement('span');
              newBadge.className = 'sidebar-notification-count';
              newBadge.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                min-width: 18px;
                height: 18px;
                background-color: #ff4757;
                color: white;
                border-radius: 9px;
                font-size: 9px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0 2px;
                border: 2px solid #1a1a1a;
              `;
              newBadge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
              dashDot.appendChild(newBadge);
            } else {
              badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
            }
          } else if (badge) {
            dashDot.removeChild(badge);
          }
        }
      } else if (dashDot) {
        // Remove red dot if no new requests
        dashDot.remove();
      }
    }

    // 3. Update red dot on sidebar maintenance tab
    const maintenanceNavItem = document.querySelector('a[onclick*="Maintenance Requests"]');
    if (maintenanceNavItem) {
      let maintDot = maintenanceNavItem.querySelector('.sidebar-notification-dot');
      
      if (newRequestsCount > 0) {
        if (!maintDot) {
          maintDot = document.createElement('span');
          maintDot.className = 'sidebar-notification-dot';
          maintDot.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            background-color: #ff4757;
            border-radius: 50%;
            animation: pulse 2s infinite;
            z-index: 10;
          `;
          
          // Add count badge for multiple new requests
          if (newRequestsCount > 1) {
            const badge = document.createElement('span');
            badge.className = 'sidebar-notification-count';
            badge.style.cssText = `
              position: absolute;
              top: -8px;
              right: -8px;
              min-width: 18px;
              height: 18px;
              background-color: #ff4757;
              color: white;
              border-radius: 9px;
              font-size: 9px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 0 2px;
              border: 2px solid #1a1a1a;
            `;
            badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
            maintDot.appendChild(badge);
          }
          
          maintenanceNavItem.style.position = 'relative';
          maintenanceNavItem.appendChild(maintDot);
        } else {
          // Update existing dot
          const badge = maintDot.querySelector('.sidebar-notification-count');
          if (newRequestsCount > 1) {
            if (!badge) {
              const newBadge = document.createElement('span');
              newBadge.className = 'sidebar-notification-count';
              newBadge.style.cssText = `
                position: absolute;
                top: -8px;
                right: -8px;
                min-width: 18px;
                height: 18px;
                background-color: #ff4757;
                color: white;
                border-radius: 9px;
                font-size: 9px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0 2px;
                border: 2px solid #1a1a1a;
              `;
              newBadge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
              maintDot.appendChild(newBadge);
            } else {
              badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
            }
          } else if (badge) {
            maintDot.removeChild(badge);
          }
        }
      } else if (maintDot) {
        // Remove red dot if no new requests
        maintDot.remove();
      }
    }
  }

  // Load seen requests from localStorage
  let seenRequestIds = new Set();
  const savedSeenRequests = localStorage.getItem('maintenanceSeenRequests');
  if (savedSeenRequests) {
    seenRequestIds = new Set(JSON.parse(savedSeenRequests));
  }

  // Function to check if request is new
  function isRequestNew(request) {
    // Check if request ID is in seen set
    if (seenRequestIds.has(request.id)) return false;
    
    // Consider new if not seen before
    return true;
  }

  // ----- Maintenance stats -----
  let totalRequests = 0;
  let pendingCount = 0;
  let recentMaint = 0;
  const statusCounts = { pending: 0, complete: 0, other: 0 };
  let newRequestsCount = 0;

  try {
    const maintSnap = await db
      .collection("maintenanceRequests")
      .orderBy("timestamp", "desc")
      .get();

    totalRequests = maintSnap.size;

    maintSnap.forEach((docSnap) => {
      const data = docSnap.data();
      const id = docSnap.id;
      const status = data.status || "Pending";

      // Count new requests (not seen and not complete)
      if (!seenRequestIds.has(id) && status !== 'Complete') {
        newRequestsCount++;
      }

      if (status === "Pending") {
        pendingCount++;
        statusCounts.pending++;
      } else if (status === "Complete") {
        statusCounts.complete++;
      } else {
        statusCounts.other++;
      }

      const ts = data.timestamp?.toDate
        ? data.timestamp.toDate()
        : null;
      if (ts && ts >= sevenDaysAgo) {
        recentMaint++;
      }
    });
  } catch (err) {
    console.error("Error loading maintenance stats:", err);
  }

  if (maintTotalEl) maintTotalEl.textContent = totalRequests;
  if (maintPendingEl)
    maintPendingEl.textContent = `${pendingCount} pending`;
  if (maintRecentEl)
    maintRecentEl.textContent = `${recentMaint} in last 7 days`;

  // ==== ADD: Real-time listener for maintenance requests ====
  // This will update red dots even when on other tabs
  const maintenanceUnsubscribe = db.collection("maintenanceRequests")
    .orderBy("timestamp", "desc")
    .onSnapshot((snapshot) => {
      let newCount = 0;
      
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const id = docSnap.id;
        const status = data.status || "Pending";
        
        if (!seenRequestIds.has(id) && status !== 'Complete') {
          newCount++;
        }
      });
      
      // Update all notification dots with the new count
      updateGlobalNotificationDots(newCount);
    });

  // Store unsubscribe function for cleanup (optional)
  window.maintenanceListener = maintenanceUnsubscribe;

  // Initial update of notification dots
  updateGlobalNotificationDots(newRequestsCount);

  const maintCard = document.getElementById("card-maintenance");
  if (maintCard) {
    maintCard.addEventListener("click", () => {
      // Mark all requests as seen when clicking the card
      if (newRequestsCount > 0) {
        // Get all current new request IDs
        const allRequestIds = [];
        db.collection("maintenanceRequests").get().then(snapshot => {
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const status = data.status || "Pending";
            
            if (!seenRequestIds.has(id) && status !== 'Complete') {
              allRequestIds.push(id);
            }
          });
          
          // Mark all as seen
          if (allRequestIds.length > 0) {
            allRequestIds.forEach(id => seenRequestIds.add(id));
            localStorage.setItem('maintenanceSeenRequests', JSON.stringify(Array.from(seenRequestIds)));
            updateGlobalNotificationDots(0);
          }
        });
      }
      
      window.adminDashboardDrilldown = { maintenanceStatus: "Pending" };
      loadContent(null, "Maintenance Requests");
    });
  }

  // ----- Payments stats -----
  const monthLabels = [];
  const monthlyTotals = {};
  for (let i = 5; i >= 0; i--) {
    const d = new Date(thisYear, thisMonth - i, 1);
    const label = d.toLocaleString("default", { month: "short" });
    monthLabels.push(label);
    monthlyTotals[label] = 0;
  }

  let totalThisMonth = 0;
  let countThisMonth = 0;
  const recentPayments = [];

  try {
    const paySnap = await db
      .collection("payments")
      .orderBy("timestamp", "desc")
      .get();

    paySnap.forEach((docSnap, index) => {
      const data = docSnap.data();
      const ts = data.timestamp?.toDate
        ? data.timestamp.toDate()
        : null;
      if (!ts) return;

      const amount = Number(data.amount) || 0;
      const status = data.status || "Paid";
      const isPaid =
        status === "Paid" ||
        status === "Approved" ||
        status === "Completed";

      if (
        isPaid &&
        ts.getFullYear() === thisYear &&
        ts.getMonth() === thisMonth
      ) {
        totalThisMonth += amount;
        countThisMonth++;
      }

      const monthsDiff =
        (thisYear - ts.getFullYear()) * 12 +
        (thisMonth - ts.getMonth());
      if (monthsDiff >= 0 && monthsDiff <= 5) {
        const label = ts.toLocaleString("default", { month: "short" });
        if (monthlyTotals[label] != null) {
          monthlyTotals[label] += amount;
        }
      }

      if (index < 5) {
        recentPayments.push({ ...data, timestamp: ts });
      }
    });
  } catch (err) {
    console.error("Error loading payment stats:", err);
  }

  if (payAmountEl) payAmountEl.textContent = formatCurrency(totalThisMonth);
  if (payCountEl) {
    payCountEl.textContent =
      countThisMonth === 1
        ? "1 payment this month"
        : `${countThisMonth} payments this month`;
  }

  if (recentListEl) {
    if (!recentPayments.length) {
      recentListEl.innerHTML =
        '<p class="muted">No payments recorded yet.</p>';
    } else {
      recentListEl.innerHTML = "";
      recentPayments.forEach((p) => {
        const row = document.createElement("div");
        row.className = "recent-payment-row";
        const tenantEmail = p.tenantEmail || "Unknown";
        const method = p.method || "Unknown";
        const amount = formatCurrency(p.amount);
        const dateStr = p.timestamp
          ? p.timestamp.toLocaleString()
          : "";

        row.innerHTML = `
          <div class="recent-main">
            <div class="recent-email">${tenantEmail}</div>
            <div class="recent-method">${method}</div>
          </div>
          <div class="recent-meta">
            <div class="recent-amount">${amount}</div>
            <div class="recent-date">${dateStr}</div>
          </div>
        `;
        recentListEl.appendChild(row);
      });
    }
  }

  // ----- Feedback stats -----
  let totalFeedback = 0;
  let feedbackLast7 = 0;
  const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

  try {
    const fbSnap = await db
      .collection("feedback")
      .orderBy("timestamp", "desc")
      .get();

    totalFeedback = fbSnap.size;

    fbSnap.forEach((docSnap) => {
      const data = docSnap.data();
      const rating = Number(data.rating) || 0;
      if (rating >= 1 && rating <= 5) {
        ratingCounts[rating] += 1;
      }
      const ts = data.timestamp?.toDate
        ? data.timestamp.toDate()
        : null;
      if (ts && ts >= sevenDaysAgo) {
        feedbackLast7++;
      }
    });
  } catch (err) {
    console.error("Error loading feedback stats:", err);
  }

  if (fbTotalEl) fbTotalEl.textContent = totalFeedback;
  if (fbRecentEl)
    fbRecentEl.textContent = `${feedbackLast7} in last 7 days`;

  // ----- Charts -----
  const payCanvas = document.getElementById("paymentsChart");
  if (payCanvas) {
    const payCtx = payCanvas.getContext("2d");
    const payGradient = payCtx.createLinearGradient(0, 0, 0, 220);
    payGradient.addColorStop(0, "rgba(255, 213, 122, 1)");
    payGradient.addColorStop(1, "rgba(192, 147, 60, 1)");

    new Chart(payCtx, {
      type: "bar",
      data: {
        labels: monthLabels,
        datasets: [
          {
            label: "Total Paid (‚Ç±)",
            data: monthLabels.map((m) => monthlyTotals[m]),
            backgroundColor: payGradient,
            borderRadius: 4,
            maxBarThickness: 32,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.4,
        animation: {
          duration: 900,
          easing: "easeOutCubic",
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) =>
                "‚Ç±" +
                (ctx.parsed.y || 0).toLocaleString(undefined, {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                }),
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: "#cccccc" },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(255,255,255,0.06)" },
            ticks: {
              color: "#cccccc",
              callback: (value) => "‚Ç±" + value,
            },
          },
        },
      },
    });
  }

  const maintCanvas = document.getElementById("maintenanceChart");
  if (maintCanvas) {
    const maintCtx = maintCanvas.getContext("2d");
    new Chart(maintCtx, {
      type: "doughnut",
      data: {
        labels: ["Pending", "Complete", "Other"],
        datasets: [
          {
            data: [
              statusCounts.pending,
              statusCounts.complete,
              statusCounts.other,
            ],
            backgroundColor: ["#ffb347", "#66bb6a", "#90a4ae"],
            borderWidth: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: "60%",
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1100,
          easing: "easeOutExpo",
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#f3efe9" },
          },
        },
      },
    });
  }

  const fbCanvas = document.getElementById("feedbackChart");
  if (fbCanvas) {
    const fbCtx = fbCanvas.getContext("2d");
    new Chart(fbCtx, {
      type: "doughnut",
      data: {
        labels: ["5‚òÖ", "4‚òÖ", "3‚òÖ", "2‚òÖ", "1‚òÖ"],
        datasets: [
          {
            data: [
              ratingCounts[5],
              ratingCounts[4],
              ratingCounts[3],
              ratingCounts[2],
              ratingCounts[1],
            ],
            backgroundColor: [
              "#66bb6a",
              "#9ccc65",
              "#ffeb3b",
              "#ffb74d",
              "#ef5350",
            ],
            borderWidth: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: "40%",
        animation: {
          animateRotate: true,
          animateScale: true,
          duration: 1100,
          easing: "easeOutExpo",
        },
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#f3efe9" },
          },
        },
      },
    });
  }

  renderAdminCalendar();

  const payCard = document.getElementById("card-payments");
  const fbCard = document.getElementById("card-feedback");

  if (payCard) {
    payCard.addEventListener("click", () => {
      window.adminDashboardDrilldown = { paymentsFilter: "thisMonth" };
      loadContent(null, "Payment Received");
    });
  }
  if (fbCard) {
    fbCard.addEventListener("click", () => {
      window.adminDashboardDrilldown = { feedbackTab: true };
      loadContent(null, "Feedback Received");
    });
  }
}

function renderAdminCalendar() {
  const calendarEl = document.getElementById("adminCalendar");
  if (!calendarEl) return;

  const today = new Date();
  const monthName = today.toLocaleString("default", { month: "long" });
  const year = today.getFullYear();
  const firstDay = new Date(year, today.getMonth(), 1);
  const lastDay = new Date(year, today.getMonth() + 1, 0);
  const startDay = firstDay.getDay();

  let html = "<table class='cal-table'>";
  html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
  html +=
    "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

  for (let i = 0; i < startDay; i++) {
    html += "<td class='cal-empty'></td>";
  }

  for (let day = 1; day <= lastDay.getDate(); day++) {
    const isToday = day === today.getDate();
    html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
    if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) {
      html += "</tr><tr>";
    }
  }

  html += "</tr></table>";
  calendarEl.innerHTML = html;
}

    // ======================== PAYMENTS RECEIVED LOGIC ========================
  function initPaymentReceived() {
  const paypalList = document.getElementById("paypalList");
  const searchInput = document.getElementById("paymentSearch");
  const sortBy = document.getElementById("sortBy");
  const filterBy = document.getElementById("filterBy");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const resetFilters = document.getElementById("resetFilters");
  const paymentCount = document.getElementById("paymentCount");
  const totalAmount = document.getElementById("totalAmount");
  const statsDiv = document.getElementById("stats");

  let allPayments = [];
  let filteredPayments = [];

  const drill = window.adminDashboardDrilldown || {};
  if (drill.paymentsFilter) {
    filterBy.value = drill.paymentsFilter;
  }
  window.adminDashboardDrilldown = null;

  // Add Pricing Management Section
  const pricingCard = document.createElement("div");
  pricingCard.className = "card";
  pricingCard.innerHTML = `
    <div class="section-header">
      <h2 class="section-title">Unit Pricing Management</h2>
    </div>
    <div class="pricing-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
      <div>
        <label for="oneBedPrice">1-Bedroom Monthly Dues (‚Ç±)</label>
        <input type="number" id="oneBedPrice" class="input" min="0" step="0.01" placeholder="Enter price">
      </div>
      <div>
        <label for="twoBedPrice">2-Bedroom Monthly Dues (‚Ç±)</label>
        <input type="number" id="twoBedPrice" class="input" min="0" step="0.01" placeholder="Enter price">
      </div>
      <div style="grid-column: span 2;">
        <button id="savePricing" class="btn btn-primary" style="margin-top: 10px;">
          Save Pricing Changes
        </button>
        <button id="resetPricing" class="btn btn-secondary" style="margin-top: 10px; margin-left: 10px;">
          Reset to Default
        </button>
        <span id="pricingStatus" style="margin-left: 15px;"></span>
      </div>
    </div>
  `;
  
  // Insert pricing card at the top of the content
  const contentContainer = document.querySelector('.card-layout') || document.getElementById('paypalList').parentElement;
  contentContainer.insertBefore(pricingCard, contentContainer.firstChild);

  // Pricing management logic
  const oneBedPriceInput = document.getElementById('oneBedPrice');
  const twoBedPriceInput = document.getElementById('twoBedPrice');
  const savePricingBtn = document.getElementById('savePricing');
  const resetPricingBtn = document.getElementById('resetPricing');
  const pricingStatus = document.getElementById('pricingStatus');

  // Load current pricing - USING OLD FIREBASE SYNTAX
  function loadCurrentPricing() {
    // Using old Firebase syntax (compatible with your db.collection() calls)
    const pricingRef = db.collection("settings").doc("unitPricing");
    
    pricingRef.get().then((pricingDoc) => {
      if (pricingDoc.exists) {
        const data = pricingDoc.data();
        oneBedPriceInput.value = data["1B"] || 10;
        twoBedPriceInput.value = data["2B"] || 20;
        console.log("Loaded pricing: 1B =", data["1B"], "2B =", data["2B"]);
      } else {
        // Set defaults if no pricing exists
        oneBedPriceInput.value = 10;
        twoBedPriceInput.value = 20;
        console.log("No pricing found, using defaults");
      }
    }).catch((error) => {
      console.error("Error loading pricing:", error);
      // Set defaults
      oneBedPriceInput.value = 10;
      twoBedPriceInput.value = 20;
      pricingStatus.textContent = "‚ö†Ô∏è Using default prices";
      pricingStatus.style.color = "#FF9800";
    });
  }

  // Save pricing to Firestore - USING OLD FIREBASE SYNTAX
  function savePricing() {
    const oneBedPrice = parseFloat(oneBedPriceInput.value);
    const twoBedPrice = parseFloat(twoBedPriceInput.value);

    if (isNaN(oneBedPrice) || isNaN(twoBedPrice) || oneBedPrice < 0 || twoBedPrice < 0) {
      pricingStatus.textContent = "‚ùå Please enter valid positive numbers";
      pricingStatus.style.color = "#f44336";
      return;
    }

    savePricingBtn.disabled = true;
    pricingStatus.textContent = "Saving...";
    pricingStatus.style.color = "#666";

    // Using old Firebase syntax - THIS IS THE CORRECT WAY
    db.collection("settings").doc("unitPricing").set({
      "1B": oneBedPrice,
      "2B": twoBedPrice,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: firebase.auth().currentUser.email
    })
    .then(() => {
      pricingStatus.textContent = "‚úÖ Pricing saved successfully!";
      pricingStatus.style.color = "#4CAF50";
      console.log("Pricing saved: 1B =", oneBedPrice, "2B =", twoBedPrice);

      // Reset status after 3 seconds
      setTimeout(() => {
        pricingStatus.textContent = "";
      }, 3000);
    })
    .catch((error) => {
      console.error("Error saving pricing:", error);
      pricingStatus.textContent = "‚ùå Error saving pricing: " + error.message;
      pricingStatus.style.color = "#f44336";
    })
    .finally(() => {
      savePricingBtn.disabled = false;
    });
  }

  // Reset to default pricing - USING OLD FIREBASE SYNTAX
  function resetToDefault() {
    oneBedPriceInput.value = 10;
    twoBedPriceInput.value = 20;
    
    resetPricingBtn.disabled = true;
    pricingStatus.textContent = "Resetting...";
    pricingStatus.style.color = "#666";

    // Using old Firebase syntax
    db.collection("settings").doc("unitPricing").set({
      "1B": 10,
      "2B": 20,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: firebase.auth().currentUser.email,
      resetToDefault: true
    })
    .then(() => {
      pricingStatus.textContent = "‚úÖ Reset to default pricing!";
      pricingStatus.style.color = "#4CAF50";
      console.log("Pricing reset to defaults");

      setTimeout(() => {
        pricingStatus.textContent = "";
      }, 3000);
    })
    .catch((error) => {
      console.error("Error resetting pricing:", error);
      pricingStatus.textContent = "‚ùå Error resetting pricing: " + error.message;
      pricingStatus.style.color = "#f44336";
    })
    .finally(() => {
      resetPricingBtn.disabled = false;
    });
  }

  // Load pricing when page loads
  loadCurrentPricing();

  // Add event listeners for pricing buttons
  savePricingBtn.addEventListener("click", savePricing);
  resetPricingBtn.addEventListener("click", resetToDefault);

  function applyFiltersAndSort() {
    const searchValue = searchInput.value.toLowerCase();
    const filterValue = filterBy.value;
    const sortValue = sortBy.value;
    const startVal = dateFrom.value;
    const endVal = dateTo.value;

    filteredPayments = allPayments.filter(
      (p) => p.method === "PayPal"
    );

    if (searchValue) {
      filteredPayments = filteredPayments.filter((p) => {
        const tEmail = (p.tenantEmail || "").toLowerCase();
        const pEmail = (p.payerEmail || "").toLowerCase();
        return (
          tEmail.includes(searchValue) || pEmail.includes(searchValue)
        );
      });
    }

    const now = new Date();
    let startDate = null;
    let endDate = null;

    if (startVal) startDate = new Date(startVal + "T00:00:00");
    if (endVal) endDate = new Date(endVal + "T23:59:59.999");

    if (startDate || endDate) {
      filteredPayments = filteredPayments.filter((p) => {
        const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
        if (!ts) return false;
        if (startDate && ts < startDate) return false;
        if (endDate && ts > endDate) return false;
        return true;
      });
    } else if (filterValue !== "all") {
      filteredPayments = filteredPayments.filter((p) => {
        const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
        if (!ts) return false;
        const diffMs = now - ts;
        const diffDays = diffMs / (1000 * 60 * 60 * 24);
        switch (filterValue) {
          case "last7":
            return diffDays <= 7;
          case "last30":
            return diffDays <= 30;
          case "thisMonth":
            return (
              ts.getFullYear() === now.getFullYear() &&
              ts.getMonth() === now.getMonth()
            );
          case "lastMonth": {
            const lastMonthDate = new Date(
              now.getFullYear(),
              now.getMonth() - 1,
              1
            );
            const start = lastMonthDate;
            const end = new Date(
              now.getFullYear(),
              now.getMonth(),
              0,
              23,
              59,
              59,
              999
            );
            return ts >= start && ts <= end;
          }
          case "thisYear":
            return ts.getFullYear() === now.getFullYear();
          default:
            return true;
        }
      });
    }

    filteredPayments.sort((a, b) => {
      const aDate = a.timestamp?.toDate
        ? a.timestamp.toDate()
        : null;
      const bDate = b.timestamp?.toDate
        ? b.timestamp.toDate()
        : null;

      switch (sortValue) {
        case "date-asc":
          return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
        case "date-desc":
          return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
        case "amount-asc":
          return (Number(a.amount) || 0) - (Number(b.amount) || 0);
        case "amount-desc":
          return (Number(b.amount) || 0) - (Number(a.amount) || 0);
        case "email-asc":
          return (a.tenantEmail || "").localeCompare(
            b.tenantEmail || ""
          );
        case "email-desc":
          return (b.tenantEmail || "").localeCompare(
            a.tenantEmail || ""
          );
        default:
          return 0;
      }
    });

    renderPayments();
  }

  function renderPayments() {
    paypalList.innerHTML = "";

    if (!filteredPayments.length) {
      paypalList.innerHTML =
        "<p>No PayPal payments found matching your criteria.</p>";
      statsDiv.style.display = "none";
      return;
    }

    let total = 0;

    filteredPayments.forEach((p) => {
      const row = document.createElement("div");
      row.className = "payment-row";

      const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
      const dateStr = ts ? ts.toLocaleString() : "Unknown date";
      const status = p.status || "Completed";
      const amountNum = Number(p.amount) || 0;

      let statusClass = "badge-muted";
      if (
        status === "Paid" ||
        status === "Approved" ||
        status === "Completed"
      ) {
        statusClass = "badge-success";
        total += amountNum;
      } else if (status === "Pending Verification") {
        statusClass = "badge-warning";
      } else if (status === "Rejected") {
        statusClass = "badge-danger";
      }

      row.innerHTML = `
        <div class="payment-main">
          <div class="payment-email">${p.tenantEmail || "Unknown unit owner"}</div>
          <div class="payment-sub">${p.payerEmail || ""}</div>
        </div>
        <div class="payment-meta">
          <div class="payment-amount">${formatCurrency(p.amount)}</div>
          <div class="payment-meta-row">
            <span class="badge ${statusClass}">${status}</span>
            <span class="payment-method">${p.method || ""}</span>
            <span class="payment-date">${dateStr}</span>
          </div>
        </div>
      `;
           paypalList.appendChild(row);
    });

    paymentCount.textContent = filteredPayments.length;
    totalAmount.textContent = total.toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
    statsDiv.style.display = "block";
  }

  db.collection("payments")
    .orderBy("timestamp", "desc")
    .onSnapshot(
      (snapshot) => {
        allPayments = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
        applyFiltersAndSort();
      },
      (error) => {
        paypalList.innerHTML = `<p style="color:red;">Error loading payments: ${error.message}</p>`;
        statsDiv.style.display = "none";
      }
    );

  searchInput.addEventListener("input", applyFiltersAndSort);
  sortBy.addEventListener("change", applyFiltersAndSort);
  filterBy.addEventListener("change", applyFiltersAndSort);
  dateFrom.addEventListener("change", applyFiltersAndSort);
  dateTo.addEventListener("change", applyFiltersAndSort);

  resetFilters.addEventListener("click", () => {
    searchInput.value = "";
    sortBy.value = "date-desc";
    filterBy.value = "all";
    dateFrom.value = "";
    dateTo.value = "";
    applyFiltersAndSort();
  });
}
    // ======================== MAINTENANCE REQUESTS LOGIC ========================
function initMaintenanceRequests() {
  const maintenanceList = document.getElementById("maintenanceList");
  const statusFilter = document.getElementById("statusFilter");
  const personnelFilter = document.getElementById("personnelFilter");
  const maintenanceSearch = document.getElementById("maintenanceSearch");
  const sortBy = document.getElementById("sortBy");
  const resetFilters = document.getElementById("resetFilters");
  const maintenanceStats = document.getElementById("maintenanceStats");
  const requestCount = document.getElementById("requestCount");
  const pendingCountEl = document.getElementById("pendingCount");
  const inProgressCountEl = document.getElementById("inProgressCount");
  const completeCountEl = document.getElementById("completeCount");

  // ==== ADD: Red dot notification element for sidebar tab ====
  let redDotNotification = null;
  
  // Find the Maintenance Requests tab in the sidebar
  const maintenanceNavItem = document.querySelector('a[onclick*="Maintenance Requests"]');
  if (maintenanceNavItem) {
    // Check if red dot already exists
    redDotNotification = maintenanceNavItem.querySelector('.notification-dot');
    
    if (!redDotNotification) {
      // Create new red dot notification
      redDotNotification = document.createElement('span');
      redDotNotification.className = 'notification-dot';
      redDotNotification.style.cssText = `
        position: absolute;
        top: 8px;
        right: 8px;
        width: 10px;
        height: 10px;
        background-color: #ff4757;
        border-radius: 50%;
        display: none;
        animation: pulse 2s infinite;
      `;
      
      // Add pulse animation
      if (!document.querySelector('#pulse-animation')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation';
        style.textContent = `
          @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
          }
        `;
        document.head.appendChild(style);
      }
      
      maintenanceNavItem.style.position = 'relative';
      maintenanceNavItem.appendChild(redDotNotification);
    }
  }

  let allRequests = [];
  let filteredRequests = [];
  let personnelAssignments = new Map();
  let maintenanceCrew = []; // Array to store maintenance crew from database
  let personnelGroups = []; // Array to store personnel grouped by specialization
  
  // NEW: Add seen requests tracking
  let seenRequestIds = new Set();
  let lastVisitTime = localStorage.getItem('maintenanceLastVisit') || null;

  // Load previously seen requests
  const savedSeenRequests = localStorage.getItem('maintenanceSeenRequests');
  if (savedSeenRequests) {
    seenRequestIds = new Set(JSON.parse(savedSeenRequests));
  }

  // Update last visit time when loading the page
  localStorage.setItem('maintenanceLastVisit', new Date().toISOString());

  // Function to mark requests as seen
  function markRequestsAsSeen(ids) {
    ids.forEach(id => seenRequestIds.add(id));
    localStorage.setItem('maintenanceSeenRequests', JSON.stringify(Array.from(seenRequestIds)));
  }

  // Function to check if request is new
  function isRequestNew(request) {
    // Check if request ID is in seen set
    if (seenRequestIds.has(request.id)) return false;
    
    // If we have last visit time, check if request is newer
    if (lastVisitTime && request.timestamp) {
      const requestTime = request.timestamp?.toDate ? request.timestamp.toDate() : new Date(request.timestamp);
      const lastVisit = new Date(lastVisitTime);
      return requestTime > lastVisit;
    }
    
    // Default: consider new if not seen before
    return true;
  }

  // Function to update notification dot in sidebar
  function updateNotificationDot() {
    if (!redDotNotification) return;
    
    const newRequestsCount = allRequests.filter(request => 
      isRequestNew(request) && request.status !== 'Complete'
    ).length;
    
    if (newRequestsCount > 0) {
      redDotNotification.style.display = 'block';
      // Optional: Add count badge
      if (!redDotNotification.dataset.badgeAdded && newRequestsCount > 1) {
        const badge = document.createElement('span');
        badge.className = 'notification-count';
        badge.style.cssText = `
          position: absolute;
          top: -8px;
          right: -8px;
          min-width: 18px;
          height: 18px;
          background-color: #ff4757;
          color: white;
          border-radius: 9px;
          font-size: 10px;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 2px;
          border: 2px solid #1a1a1a;
        `;
        badge.textContent = newRequestsCount > 99 ? '99+' : newRequestsCount;
        redDotNotification.appendChild(badge);
        redDotNotification.dataset.badgeAdded = true;
      } else if (redDotNotification.dataset.badgeAdded && newRequestsCount <= 1) {
        // Remove badge if only 1 new request
        const badge = redDotNotification.querySelector('.notification-count');
        if (badge) {
          redDotNotification.removeChild(badge);
          delete redDotNotification.dataset.badgeAdded;
        }
      }
    } else {
      redDotNotification.style.display = 'none';
      if (redDotNotification.querySelector('.notification-count')) {
        redDotNotification.removeChild(redDotNotification.querySelector('.notification-count'));
        delete redDotNotification.dataset.badgeAdded;
      }
    }
  }

  // Function to load maintenance crew from database
  async function loadMaintenanceCrew() {
    try {
      const snapshot = await db.collection("users")
        .where("role", "==", "maintenance")
        .get();
      
      maintenanceCrew = [];
      personnelGroups = [];
      
      if (!snapshot.empty) {
        snapshot.forEach(doc => {
          const data = doc.data();
          maintenanceCrew.push({
            id: doc.id,
            name: data.name || data.email.split('@')[0],
            email: data.email,
            specialization: data.specialization || "General Maintenance",
            phone: data.phone || ""
          });
        });
        
        // Group by specialization
        const groupedByRole = {};
        maintenanceCrew.forEach(person => {
          if (!groupedByRole[person.specialization]) {
            groupedByRole[person.specialization] = [];
          }
          groupedByRole[person.specialization].push(person.name);
        });
        
        // Convert to personnelGroups format
        Object.entries(groupedByRole).forEach(([role, names]) => {
          personnelGroups.push({
            role: role,
            names: names
          });
        });
        
        // Update personnel filter dropdown
        updatePersonnelFilter();
      } else {
        // If no maintenance crew found, show default options
        personnelGroups = [
          {
            role: "General Maintenance",
            names: ["No crew available"]
          }
        ];
        updatePersonnelFilter();
      }
    } catch (error) {
      console.error("Error loading maintenance crew:", error);
      // Fallback to default options
      personnelGroups = [
        {
          role: "General Maintenance",
          names: ["Error loading crew"]
        }
      ];
      updatePersonnelFilter();
    }
  }

  // Function to update personnel filter dropdown
  function updatePersonnelFilter() {
    if (!personnelFilter) return;
    
    // Store current value
    const currentValue = personnelFilter.value;
    
    // Clear existing options except the first one
    personnelFilter.innerHTML = '<option value="all">All Personnel</option>';
    
    // Add unassigned option
    const unassignedOption = document.createElement('option');
    unassignedOption.value = "unassigned";
    unassignedOption.textContent = "Unassigned";
    personnelFilter.appendChild(unassignedOption);
    
    // Add all maintenance crew names as options
    maintenanceCrew.forEach(person => {
      const option = document.createElement('option');
      option.value = person.name;
      option.textContent = `${person.name} (${person.specialization})`;
      personnelFilter.appendChild(option);
    });
    
    // Restore previous selection if possible
    if (currentValue && Array.from(personnelFilter.options).some(opt => opt.value === currentValue)) {
      personnelFilter.value = currentValue;
    }
  }

  // Flat list of all personnel names
  const allPersonnelNames = maintenanceCrew.flatMap(person => person.name);

  const drill = window.adminDashboardDrilldown || {};
  if (drill.maintenanceStatus) {
    statusFilter.value = drill.maintenanceStatus;
  }
  window.adminDashboardDrilldown = null;

  function formatDateTimeAMPM(date) {
    if (!date) return "N/A";
    const d = date.toDate ? date.toDate() : date;
    let hours = d.getHours();
    const minutes = d.getMinutes().toString().padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    const month = (d.getMonth() + 1).toString().padStart(2, "0");
    const day = d.getDate().toString().padStart(2, "0");
    const year = d.getFullYear();
    return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
  }

  // ===== MAINTENANCE MESSAGES POPUP BINDINGS =====
  const chatPanel = document.getElementById("maintenanceMessagesPanel");
  const chatTitleEl = document.getElementById("maintenanceMessagesTitle");
  const chatMessagesContainer = document.getElementById("maintenanceMessagesContainer");
  const chatReplyTextarea = document.getElementById("maintenanceReplyMessage");
  const chatReplyStatus = document.getElementById("maintenanceReplyStatus");
  const chatSendBtn = document.getElementById("maintenanceSendReplyBtn");
  const chatClearBtn = document.getElementById("maintenanceClearReplyBtn");
  const chatCloseBtn = document.getElementById("closeMaintenanceMessagesBtn");
  const chatQuickReplyBtns = document.querySelectorAll(".maintenanceQuickReplyBtn");

  if (chatPanel && !chatPanel.dataset.bound) {
    chatPanel.dataset.bound = "true";

    chatCloseBtn.addEventListener("click", () => {
      chatPanel.style.display = "none";
      chatReplyTextarea.value = "";
      chatReplyStatus.textContent = "";
    });

    chatPanel.addEventListener("click", (e) => {
      if (e.target === chatPanel) {
        chatPanel.style.display = "none";
        chatReplyTextarea.value = "";
        chatReplyStatus.textContent = "";
      }
    });

    chatClearBtn.addEventListener("click", () => {
      chatReplyTextarea.value = "";
      chatReplyStatus.textContent = "";
    });

    chatQuickReplyBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const template = btn.dataset.template;
        let msg = "";
        switch (template) {
          case "on_the_way":
            msg = "Our maintenance team is on the way.";
            break;
          case "technician_assigned":
            msg = "A technician has been assigned and will be there soon.";
            break;
          case "scheduled":
            msg = "We have scheduled your maintenance as per your requested date and time.";
            break;
          case "resolved":
            msg = "Thank you for your patience. This maintenance concern has been resolved.";
            break;
        }
        chatReplyTextarea.value = msg;
        chatReplyTextarea.focus();
      });
    });

    chatSendBtn.addEventListener("click", async () => {
      const msg = chatReplyTextarea.value.trim();
      if (!msg) {
        showPopup("Response message cannot be empty.");
        return;
      }

      const requestId = chatPanel.dataset.requestId;
      if (!requestId) return;

      try {
        setButtonLoading(chatSendBtn, true);

        const requestDocRef = db.collection("maintenanceRequests").doc(requestId);
        await requestDocRef.collection("responses").add({
          sender: "admin",
          adminEmail: auth.currentUser ? auth.currentUser.email : null,
          message: msg,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

        await requestDocRef.update({
          responseTime: firebase.firestore.FieldValue.serverTimestamp(),
        });

        chatReplyTextarea.value = "";
        await loadMaintenanceChatMessages(requestId);

        chatReplyStatus.textContent = "‚úì Reply sent successfully.";
        chatReplyStatus.style.color = "#4caf50";
      } catch (error) {
        console.error(error);
        chatReplyStatus.textContent = "‚úó Failed to send reply.";
        chatReplyStatus.style.color = "#f44336";
        showPopup("Failed to send response: " + error.message);
      } finally {
        setButtonLoading(chatSendBtn, false);
      }
    });
  }

  window.openMaintenanceChat = async function (requestId) {
    if (!chatPanel) return;

    try {
      chatMessagesContainer.innerHTML =
        "<div style='text-align:center;padding:30px;color:#b0b0b0;'>Loading conversation‚Ä¶</div>";

      const docSnap = await db.collection("maintenanceRequests").doc(requestId).get();
      if (!docSnap.exists) {
        showPopup("Maintenance request not found.");
        return;
      }
      const data = docSnap.data();

      chatTitleEl.textContent = `Maintenance ‚Äì ${data.unitNumber || "Unknown unit"}`;
      chatPanel.dataset.requestId = requestId;
      chatPanel.style.display = "flex";

      await loadMaintenanceChatMessages(requestId, data);
    } catch (error) {
      console.error(error);
      showPopup("Failed to load conversation: " + error.message);
    }
  };

  async function loadMaintenanceChatMessages(requestId, requestData) {
    const container = chatMessagesContainer;
    container.innerHTML = "";

    let data = requestData;
    if (!data) {
      const docSnap = await db.collection("maintenanceRequests").doc(requestId).get();
      data = docSnap.data();
    }

    const header = document.createElement("div");
    header.className = "message-bubble client";
    header.innerHTML = `
      <div class="message-header">
        <div class="message-sender">${data.tenantEmail || "Unit Owner"}</div>
        <div class="message-time">${formatDateTimeAMPM(data.timestamp)}</div>
      </div>
      <div style="font-size:13px;">
        <strong>Unit:</strong> ${data.unitNumber || "N/A"}<br/>
        <strong>Issue:</strong> ${data.problem || "N/A"}<br/>
        <strong>Status:</strong> ${data.status || "Pending"}<br/>
        <strong>Preferred visit:</strong> ${formatDateTimeAMPM(data.preferredVisitTime)}<br/>
        ${data.maintenanceName ? `<strong>Personnel:</strong> ${data.maintenanceName}<br/>` : ""}
        ${data.tenantMarkedComplete ? `<strong style="color:#f39c12;">‚è≥ Unit Owner marked as complete - waiting for admin finalization</strong><br/>` : ""}
      </div>
    `;
    container.appendChild(header);

    const respSnap = await db
      .collection("maintenanceRequests")
      .doc(requestId)
      .collection("responses")
      .orderBy("timestamp", "asc")
      .get();

    if (respSnap.empty) {
      const empty = document.createElement("div");
      empty.style.cssText =
        "padding:18px;text-align:center;font-size:13px;color:#b0b0b0;";
      empty.textContent =
        "No chat history yet. Use the reply form below to send the first message.";
      container.appendChild(empty);
    } else {
      respSnap.forEach((doc) => {
        const msg = doc.data();
        const isAdmin = msg.sender === "admin" || !!msg.adminEmail;
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${isAdmin ? "admin" : "client"}`;

        const ts = msg.timestamp?.toDate
          ? msg.timestamp.toDate()
          : null;

        bubble.innerHTML = `
          <div class="message-header">
            <div class="message-sender">${
              isAdmin
                ? (msg.adminEmail || "Admin")
                : (data.tenantEmail || "Unit Owner")
            }</div>
            <div class="message-time">${
              ts ? formatDateTimeAMPM(ts) : "N/A"
            }</div>
          </div>
          <div class="message-content" style="white-space:pre-wrap;">${
            msg.message || msg.content || ""
          }</div>
        `;
        container.appendChild(bubble);
      });
    }

    setTimeout(() => {
      container.scrollTop = container.scrollHeight;
    }, 100);
  }

  function updatePersonnelAssignments() {
    personnelAssignments.clear();
    allRequests.forEach(request => {
      if (request.maintenanceName &&
        request.maintenanceName.trim() !== "" &&
        request.status === "In Progress") {
        personnelAssignments.set(request.maintenanceName, request.id);
      }
    });
  }

  function isPersonnelAvailable(personnelName) {
    if (!personnelAssignments.has(personnelName)) return true;

    const assignedRequestId = personnelAssignments.get(personnelName);
    const assignedRequest = allRequests.find(r => r.id === assignedRequestId);

    return !(assignedRequest && assignedRequest.status === "In Progress");
  }

  function getPersonnelStatus(personnelName) {
    if (!personnelAssignments.has(personnelName)) {
      return { available: true, status: "Available", workingOn: null };
    }

    const assignedRequestId = personnelAssignments.get(personnelName);
    const assignedRequest = allRequests.find(r => r.id === assignedRequestId);

    if (!assignedRequest || assignedRequest.status !== "In Progress") {
      personnelAssignments.delete(personnelName);
      return { available: true, status: "Available", workingOn: null };
    }

    return {
      available: false,
      status: "Currently Working",
      workingOn: assignedRequest.problem || "a task",
      unitNumber: assignedRequest.unitNumber || "Unknown unit"
    };
  }

  function applyFiltersAndSort() {
    const statusValue = statusFilter.value;
    const personnelValue = personnelFilter.value;
    const searchValue = maintenanceSearch.value.toLowerCase();
    const sortValue = sortBy.value;

    filteredRequests = [...allRequests];

    if (statusValue !== "all") {
      filteredRequests = filteredRequests.filter(
        (r) => r.status === statusValue
      );
    }

    if (personnelValue !== "all") {
      if (personnelValue === "unassigned") {
        filteredRequests = filteredRequests.filter(
          (r) => !r.maintenanceName || !r.maintenanceName.trim()
        );
      } else {
        filteredRequests = filteredRequests.filter(
          (r) => r.maintenanceName === personnelValue
        );
      }
    }

    if (searchValue) {
      filteredRequests = filteredRequests.filter((r) => {
        const emailMatch = r.tenantEmail && r.tenantEmail.toLowerCase().includes(searchValue);
        const unitMatch = r.unitNumber && r.unitNumber.toLowerCase().includes(searchValue);
        const problemMatch = r.problem && r.problem.toLowerCase().includes(searchValue);
        const commentMatch = r.comment && r.comment.toLowerCase().includes(searchValue);
        return emailMatch || unitMatch || problemMatch || commentMatch;
      });
    }

    filteredRequests.sort((a, b) => {
      const aDate = a.timestamp?.toDate ? a.timestamp.toDate() : null;
      const bDate = b.timestamp?.toDate ? b.timestamp.toDate() : null;
      switch (sortValue) {
        case "date-desc": return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
        case "date-asc": return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
        case "unit-asc": return (a.unitNumber || "").localeCompare(b.unitNumber || "");
        case "unit-desc": return (b.unitNumber || "").localeCompare(a.unitNumber || "");
        case "email-asc": return (a.tenantEmail || "").localeCompare(b.tenantEmail || "");
        case "email-desc": return (b.tenantEmail || "").localeCompare(a.tenantEmail || "");
        default: return 0;
      }
    });

    renderMaintenanceRequests();
    updateNotificationDot();
  }

  // Function to load proof images for a request
  async function loadProofImages(requestId) {
    try {
      const proofsSnapshot = await db.collection("maintenanceRequests").doc(requestId)
        .collection("proofs")
        .orderBy("timestamp", "desc")
        .get();

      if (proofsSnapshot.empty) {
        return [];
      }

      const proofs = [];
      proofsSnapshot.forEach((doc) => {
        proofs.push({
          id: doc.id,
          ...doc.data()
        });
      });

      return proofs;
    } catch (error) {
      console.error("Error loading proof images:", error);
      return [];
    }
  }

  function renderMaintenanceRequests() {
    if (!filteredRequests.length) {
      maintenanceList.innerHTML = "<p>No maintenance requests found matching your criteria.</p>";
      maintenanceStats.style.display = "none";
      updateNotificationDot();
      return;
    }

    maintenanceList.innerHTML = "";
    updatePersonnelAssignments();

    let pending = 0;
    let inProgress = 0;
    let complete = 0;
    let newRequestsCount = 0;
    let tenantMarkedCompleteCount = 0;

    // Collect new request IDs to mark as seen
    const newRequestIds = [];

    filteredRequests.forEach(async (request) => {
      const data = request;
      const id = data.id;

      // Check if request is new
      const isNew = isRequestNew(data) && data.status !== 'Complete';
      if (isNew) {
        newRequestsCount++;
        newRequestIds.push(id);
      }

      // Count tenant marked complete requests
      if (data.tenantMarkedComplete && data.status !== "Complete") {
        tenantMarkedCompleteCount++;
      }

      if (data.status === "Pending") pending++;
      if (data.status === "In Progress") inProgress++;
      if (data.status === "Complete") complete++;

      const card = document.createElement("div");
      card.className = "maintenance-card";
      card.dataset.requestId = id;

      let statusColor = "#f39c12";
      if (data.status === "In Progress") statusColor = "#3498db";
      if (data.status === "Complete") statusColor = "#27ae60";

      // Add special color for tenant marked complete
      if (data.tenantMarkedComplete && data.status !== "Complete") {
        statusColor = "#f39c12"; // Orange for waiting admin finalization
      }

      card.style.borderLeft = `4px solid ${statusColor}`;

      // ==== ADD: "NEW" tag for new requests ====
      const newTagHTML = isNew ? `
        <div class="new-request-tag" style="
          position: absolute;
          top: 10px;
          right: 10px;
          background-color: #ff4757;
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: bold;
          animation: fadeInOut 2s infinite;
          z-index: 10;
        ">NEW</div>
      ` : '';

      // Add tenant marked complete tag
      const tenantMarkedTagHTML = (data.tenantMarkedComplete && data.status !== "Complete") ? `
        <div class="tenant-marked-tag" style="
          position: absolute;
          top: 40px;
          right: 10px;
          background-color: #f39c12;
          color: #000;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: bold;
          animation: pulse 2s infinite;
          z-index: 10;
        ">‚úÖ Unit Owner Marked Complete</div>
      ` : '';

      // Add fade animation for NEW tag
      if (!document.querySelector('#fade-animation')) {
        const fadeStyle = document.createElement('style');
        fadeStyle.id = 'fade-animation';
        fadeStyle.textContent = `
          @keyframes fadeInOut {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
          }
        `;
        document.head.appendChild(fadeStyle);
      }

      // ==== ADD: Highlight border for new requests ====
      if (isNew) {
        card.style.boxShadow = '0 0 0 2px rgba(255, 71, 87, 0.3)';
        card.style.animation = 'pulseBorder 2s infinite';
        
        // Add pulse border animation
        if (!document.querySelector('#pulse-border-animation')) {
          const borderStyle = document.createElement('style');
          borderStyle.id = 'pulse-border-animation';
          borderStyle.textContent = `
            @keyframes pulseBorder {
              0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
              70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
              100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
            }
          `;
          document.head.appendChild(borderStyle);
        }
      }

      // Load proof images
      const proofImages = await loadProofImages(id);
      
      // Create photo sections container with side-by-side layout
      let photosContainerHTML = '';
      
      if ((data.imageUrls && Array.isArray(data.imageUrls) && data.imageUrls.length > 0) || proofImages.length > 0) {
        // Create unit owner photos column
        let unitOwnerColumnHTML = '';
        if (data.imageUrls && Array.isArray(data.imageUrls) && data.imageUrls.length > 0) {
          unitOwnerColumnHTML = `
            <div style="flex: 1; min-width: 200px; margin-right: 15px;">
              <div style="font-weight:bold; color:#8d6c39; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-user"></i> Unit Owner Photos:
              </div>
              <div class="image-slider" style="position:relative; max-width:200px; margin-top:5px;">
                  <img src="${data.imageUrls[0]}" alt="Unit Owner Photo" style="width:100%; border-radius:6px; border:2px solid #8d6c39;" id="owner-img-${id}" />
                  ${data.imageUrls.length > 1 ? `
                    <button class="owner-prev-btn" style="position:absolute; top:50%; left:0; transform:translateY(-50%); background:#8d6c39; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10094;</button>
                    <button class="owner-next-btn" style="position:absolute; top:50%; right:0; transform:translateY(-50%); background:#8d6c39; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10095;</button>
                  ` : ""}
                  <div style="text-align:center; margin-top:5px; font-size:12px; color:#666;">
                    ${data.imageUrls.length} photo(s) submitted by unit owner
                  </div>
              </div>
            </div>
          `;
        } else {
          unitOwnerColumnHTML = `
            <div style="flex: 1; min-width: 200px; margin-right: 15px;">
              <div style="font-weight:bold; color:#999; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-user"></i> Unit Owner Photos:
              </div>
              <div style="background:#f8f9fa; padding:10px; border-radius:6px; text-align:center; border:1px dashed #ddd; height:150px; display:flex; align-items:center; justify-content:center;">
                <div>
                  <i class="fas fa-camera" style="font-size:24px; color:#ccc; margin-bottom:5px;"></i><br>
                  <span style="font-size:12px; color:#888;">No photos submitted</span>
                </div>
              </div>
            </div>
          `;
        }
        
        // Create maintenance crew proofs column
        let maintenanceColumnHTML = '';
        if (proofImages.length > 0) {
          maintenanceColumnHTML = `
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight:bold; color:#3498db; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-hard-hat"></i> Maintenance Crew Proofs:
              </div>
              <div class="image-slider" style="position:relative; max-width:200px; margin-top:5px;">
                  <img src="${proofImages[0].url}" alt="Maintenance Proof" style="width:100%; border-radius:6px; border:2px solid #3498db;" id="proof-img-${id}" />
                  ${proofImages.length > 1 ? `
                    <button class="proof-prev-btn" style="position:absolute; top:50%; left:0; transform:translateY(-50%); background:#3498db; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10094;</button>
                    <button class="proof-next-btn" style="position:absolute; top:50%; right:0; transform:translateY(-50%); background:#3498db; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10095;</button>
                  ` : ""}
                  <div style="text-align:center; margin-top:5px; font-size:12px; color:#666;">
                    ${proofImages.length} proof photo(s)<br>
                    <small>By: ${proofImages[0].uploadedBy || "Unknown"}</small><br>
                    <small>${proofImages[0].timestamp ? formatDateTimeAMPM(proofImages[0].timestamp) : ""}</small>
                  </div>
              </div>
            </div>
          `;
        } else if (data.status === "In Progress" || data.status === "Work Finished" || data.status === "Complete") {
          maintenanceColumnHTML = `
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight:bold; color:#999; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-hard-hat"></i> Maintenance Crew Proofs:
              </div>
              <div style="background:#f8f9fa; padding:10px; border-radius:6px; text-align:center; border:1px dashed #ddd; height:150px; display:flex; align-items:center; justify-content:center;">
                <div>
                  <i class="fas fa-images" style="font-size:24px; color:#ccc; margin-bottom:5px;"></i><br>
                  <span style="font-size:12px; color:#888;">No proof photos yet</span>
                  ${data.status === "In Progress" ? `
                    <br><small style="font-size:11px; color:#aaa;">Maintenance crew can upload proof photos</small>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          maintenanceColumnHTML = `
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight:bold; color:#999; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-hard-hat"></i> Maintenance Crew Proofs:
              </div>
              <div style="background:#f8f9fa; padding:10px; border-radius:6px; text-align:center; border:1px dashed #ddd; height:150px; display:flex; align-items:center; justify-content:center;">
                <div>
                  <i class="fas fa-hard-hat" style="font-size:24px; color:#ccc; margin-bottom:5px;"></i><br>
                  <span style="font-size:12px; color:#888;">Will appear when work starts</span>
                </div>
              </div>
            </div>
          `;
        }
        
        photosContainerHTML = `
          <div style="min-width:450px;">
            <div style="display:flex; flex-wrap:nowrap; gap:15px; margin-top:15px;">
              ${unitOwnerColumnHTML}
              ${maintenanceColumnHTML}
            </div>
          </div>
        `;
      } else {
        // No photos at all
        photosContainerHTML = `
          <div style="min-width:220px;">
            <div style="margin-top:15px;">
              <div style="font-weight:bold; color:#999; margin-bottom:8px; font-size:14px;">
                <i class="fas fa-images"></i> Photos:
              </div>
              <div style="background:#f8f9fa; padding:20px; border-radius:6px; text-align:center; border:1px dashed #ddd;">
                <i class="fas fa-camera" style="font-size:32px; color:#ccc; margin-bottom:10px;"></i><br>
                <span style="font-size:13px; color:#888;">No photos submitted yet</span>
              </div>
            </div>
          </div>
        `;
      }

      // Add tenant marked info
      const tenantMarkedInfoHTML = data.tenantMarkedComplete ? `
        <p><strong>Unit Owner Action:</strong> 
          <span style="color: #f39c12; font-weight:bold;">
            ‚úÖ Marked as complete by ${data.tenantMarkedBy || "Unit Owner"}
          </span>
        </p>
        ${data.tenantMarkedAt ? `<p><strong>Marked at:</strong> ${formatDateTimeAMPM(data.tenantMarkedAt)}</p>` : ''}
      ` : '';

      card.innerHTML = `
            <div style="position: relative;">
                ${newTagHTML}
                ${tenantMarkedTagHTML}
                <h3>${data.problem || "Unknown Issue"}</h3>
                <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
                    <div style="flex:1; min-width:220px;">
                        <p><strong>Unit Owner:</strong> ${data.tenantEmail || "Unknown"}</p>
                        <p><strong>Unit Number:</strong> ${data.unitNumber || "N/A"}</p>
                        <p><strong>Details:</strong> ${data.comment || "No additional details."}</p>
                        <p><strong>Preferred Visit Time:</strong> ${formatDateTimeAMPM(data.preferredVisitTime)}</p>
                        <p><strong>Status:</strong> <span style="color:${statusColor}; font-weight:bold;">${data.status || "Pending"}</span></p>
                        <p><strong>Maintenance Personnel:</strong> <span style="color:#b08d35; font-weight:700;">${data.maintenanceName || "Not assigned"}</span></p>
                        <p><strong>Submitted:</strong> ${formatDateTimeAMPM(data.timestamp)}</p>
                        ${data.startTime ? `<p><strong>Work Started:</strong> ${formatDateTimeAMPM(data.startTime)}</p>` : ""}
                        ${data.completionTime ? `<p><strong>Completed:</strong> ${formatDateTimeAMPM(data.completionTime)}</p>` : ""}
                        ${tenantMarkedInfoHTML}
                    </div>
                    ${photosContainerHTML}
                </div>
            </div>
      `;

      // ==== ADD: Click handler to mark as seen ====
      card.addEventListener('click', (e) => {
        // Don't mark as seen if clicking on interactive elements
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT' || 
            e.target.tagName === 'OPTION' || e.target.tagName === 'IMG' ||
            e.target.closest('button') || e.target.closest('select')) {
          return;
        }
        
        if (isNew) {
          markRequestsAsSeen([id]);
          // Remove visual indicators
          card.style.boxShadow = '';
          card.style.animation = '';
          const newTag = card.querySelector('.new-request-tag');
          if (newTag) newTag.remove();
          updateNotificationDot();
        }
      });

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "maintenance-card-actions";

      // ==== ASSIGNMENT SECTION ====
      const assignmentSection = document.createElement("div");
      assignmentSection.style.marginBottom = "10px";
      assignmentSection.innerHTML = `<strong style="color: #b3b3b3; font-size: 14px;">Assignment:</strong>`;

      const assignmentContainer = document.createElement("div");
      assignmentContainer.style.display = "flex";
      assignmentContainer.style.gap = "10px";
      assignmentContainer.style.alignItems = "center";
      assignmentContainer.style.marginTop = "5px";

      const personnelSelect = document.createElement("select");
      personnelSelect.style.minWidth = "220px";

      const emptyOption = document.createElement("option");
      emptyOption.value = "";
      emptyOption.textContent = data.maintenanceName
        ? `Assigned: ${data.maintenanceName}`
        : "Assign personnel‚Ä¶";
      personnelSelect.appendChild(emptyOption);

      // Populate dropdown with real maintenance crew
      if (personnelGroups.length > 0) {
        personnelGroups.forEach((group) => {
          const optgroup = document.createElement("optgroup");
          optgroup.label = group.role;

          group.names.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;

            const personnelStatus = getPersonnelStatus(name);

            if (data.maintenanceName === name) {
              opt.selected = true;
              opt.textContent = `${name} ‚úì (Assigned)`;
              opt.style.color = "#27ae60";
            } else if (!personnelStatus.available) {
              opt.disabled = true;
              opt.textContent = `${name} ‚úó (Working on ${personnelStatus.unitNumber})`;
              opt.style.color = "#e74c3c";
              opt.title = `Currently working on: ${personnelStatus.workingOn}`;
            } else {
              opt.textContent = `${name} ‚úì (Available)`;
              opt.style.color = "#27ae60";
            }

            optgroup.appendChild(opt);
          });

          personnelSelect.appendChild(optgroup);
        });
      } else {
        // Fallback if no maintenance crew is loaded
        const noCrewOption = document.createElement("option");
        noCrewOption.value = "";
        noCrewOption.textContent = "No maintenance crew available";
        noCrewOption.disabled = true;
        personnelSelect.appendChild(noCrewOption);
      }

      // Disable assignment dropdown for all statuses except Pending (when not assigned) and In Progress (when assigned)
      if (data.status !== "Pending" || (data.status === "Pending" && data.maintenanceName)) {
        personnelSelect.disabled = true;
        if (data.status === "Complete") {
          personnelSelect.title = "Request is already completed";
        } else if (data.status === "In Progress") {
          personnelSelect.title = "Cannot change personnel while work is in progress";
        } else if (data.status === "Pending" && data.maintenanceName) {
          personnelSelect.title = "Personnel already assigned";
        }
      }

      assignmentContainer.appendChild(personnelSelect);

      // Only show "Assign" button when status is "Pending" AND there is NO personnel yet
      if (data.status === "Pending" && !data.maintenanceName) {
        const assignBtn = document.createElement("button");
        assignBtn.textContent = "Assign";
        assignBtn.className = "btn-primary";
        assignBtn.style.padding = "6px 12px";
        assignBtn.style.fontSize = "13px";
        assignBtn.style.background = "#8d6c39";

        assignmentContainer.appendChild(assignBtn);

        assignBtn.addEventListener("click", async () => {
          const selectedPersonnel = personnelSelect.value;

          if (!selectedPersonnel) {
            showPopup("Please select a personnel to assign.");
            return;
          }

          const personnelStatus = getPersonnelStatus(selectedPersonnel);
          if (!personnelStatus.available) {
            showPopup(
              `Cannot assign ${selectedPersonnel}. They are currently working on ${personnelStatus.unitNumber}.`
            );
            return;
          }

          try {
            setButtonLoading(assignBtn, true);

            const updateData = {
              maintenanceName: selectedPersonnel,
              status: "Pending", // ‚úÖ Keep as Pending when assigned
              startTime: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            };

            personnelAssignments.set(selectedPersonnel, id);

            await db.collection("maintenanceRequests").doc(id).update(updateData);

            showPopup(
              `Personnel assigned successfully! ${selectedPersonnel} will start working on this request.`
            );

            setTimeout(() => {
              applyFiltersAndSort();
            }, 500);
          } catch (error) {
            showPopup("Error assigning personnel: " + error.message);
          } finally {
            setButtonLoading(assignBtn, false);
          }
        });
      }

      assignmentSection.appendChild(assignmentContainer);
      actionsDiv.appendChild(assignmentSection);

      // ==== COMPLETE WORK SECTION ====
      // Show complete button whenever tenant has marked it as complete AND request isn't already Complete
      if (data.tenantMarkedComplete && data.status !== "Complete") {
        const completeSection = document.createElement("div");
        completeSection.style.marginBottom = "10px";
        completeSection.innerHTML = `<strong style="color: #b3b3b3; font-size: 14px;">Complete Work:</strong>`;

        const completeBtn = document.createElement("button");
        completeBtn.textContent = "Finalize Completion";
        completeBtn.className = "btn-primary";
        completeBtn.style.padding = "8px 16px";
        completeBtn.style.fontSize = "14px";
        completeBtn.style.background = "#27ae60";
        completeBtn.style.color = "white";
        completeBtn.style.border = "none";
        completeBtn.style.borderRadius = "6px";
        completeBtn.style.cursor = "pointer";
        completeBtn.style.transition = "background-color 0.3s";
        completeBtn.style.marginTop = "5px";

        completeBtn.addEventListener("mouseenter", () => {
          completeBtn.style.background = "#219653";
        });

        completeBtn.addEventListener("mouseleave", () => {
          completeBtn.style.background = "#27ae60";
        });

        completeBtn.addEventListener("click", async () => {
          if (confirm(`${data.tenantMarkedBy || "Unit Owner"} has marked this as complete. Finalize the request?`)) {
            try {
              setButtonLoading(completeBtn, true);

              await db.collection("maintenanceRequests").doc(id).update({
                status: "Complete",
                completionTime: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });

              if (data.maintenanceName) {
                personnelAssignments.delete(data.maintenanceName);
              }

              showPopup("Maintenance request finalized as complete!");

              setTimeout(() => {
                applyFiltersAndSort();
              }, 500);

            } catch (error) {
              showPopup("Error finalizing completion: " + error.message);
            } finally {
              setButtonLoading(completeBtn, false);
            }
          }
        });

        completeSection.appendChild(completeBtn);
        actionsDiv.appendChild(completeSection);
      } else if (data.status === "In Progress" && !data.tenantMarkedComplete) {
        // Show waiting message
        const waitingSection = document.createElement("div");
        waitingSection.style.marginBottom = "10px";
        waitingSection.innerHTML = `
          <strong style="color: #b3b3b3; font-size: 14px;">Complete Work:</strong>
          <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 13px;">
            <i class="fas fa-clock"></i> 
            <strong>Status:</strong> Waiting for unit owner to mark as complete<br>
            <small>Unit owner must confirm completion in their dashboard first.</small>
          </div>
        `;
        actionsDiv.appendChild(waitingSection);
      }

      // ==== TENANT MARKED COMPLETE SECTION ====
      if (data.tenantMarkedComplete && data.status !== "Complete") {
        const tenantActionSection = document.createElement("div");
        tenantActionSection.style.marginBottom = "10px";
        tenantActionSection.innerHTML = `
          <strong style="color: #27ae60; font-size: 14px;">
            <i class="fas fa-user-check"></i> Unit Owner Action:
          </strong>
          <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 13px;">
            <i class="fas fa-check-circle"></i> 
            <strong>Unit owner marked this as complete</strong><br>
            <small>${data.tenantMarkedBy || "Unit Owner"} confirmed completion on 
            ${data.tenantMarkedAt ? formatDateTimeAMPM(data.tenantMarkedAt) : "recently"}</small>
          </div>
          <p style="font-size: 12px; color: #666; margin-top: 5px;">
            <i class="fas fa-info-circle"></i> Click "Finalize Completion" above to complete the request.
          </p>
        `;
        actionsDiv.appendChild(tenantActionSection);
      }

      // ==== COMMUNICATION SECTION ====
      const respondSection = document.createElement("div");
      respondSection.style.marginTop = "10px";
      respondSection.innerHTML =
        `<strong style="color: #b3b3b3; font-size: 14px;">Communication:</strong>`;

      const openChatBtn = document.createElement("button");
      openChatBtn.textContent = "View Conversation";
      openChatBtn.className = "btn-primary";
      openChatBtn.style.background = "#4a90e2";
      openChatBtn.style.padding = "6px 12px";
      openChatBtn.style.fontSize = "13px";
      openChatBtn.style.marginTop = "5px";

      openChatBtn.addEventListener("click", () => {
        openMaintenanceChat(id);
      });

      respondSection.appendChild(openChatBtn);
      actionsDiv.appendChild(respondSection);

      // ==== DELETE SECTION ====
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete Request";
      deleteBtn.className = "btn-danger";
      deleteBtn.style.marginTop = "10px";
      deleteBtn.style.padding = "6px 12px";
      deleteBtn.style.fontSize = "13px";

      if (data.status === "In Progress") {
        deleteBtn.disabled = true;
        deleteBtn.style.backgroundColor = "#777";
        deleteBtn.style.cursor = "not-allowed";
        deleteBtn.title = "Cannot delete request while work is in progress";
      }

      deleteBtn.addEventListener("click", () => {
        if (data.status === "In Progress") {
          showPopup("Cannot delete request while work is in progress.");
          return;
        }

        showPopup(`
                <strong>Are you sure?</strong><br>
                This maintenance request will be permanently deleted.<br><br>
                <button id="confirmDeleteBtn" style="padding:6px 12px;background:#d9534f;color:white;border:none;border-radius:6px;margin-right:10px;">
                    Delete
                </button>
                <button onclick="closePopup()" style="padding:6px 12px;background:#777;color:white;border:none;border-radius:6px;">
                    Cancel
                </button>
            `);

        setTimeout(() => {
          const confirmBtn = document.getElementById("confirmDeleteBtn");
          if (!confirmBtn) return;
          confirmBtn.addEventListener("click", async () => {
            try {
              setButtonLoading(confirmBtn, true);

              if (data.maintenanceName) {
                personnelAssignments.delete(data.maintenanceName);
              }

              await db.collection("maintenanceRequests").doc(id).delete();
              closePopup();
              showPopup("Maintenance request deleted.");

              setTimeout(() => {
                applyFiltersAndSort();
              }, 500);

            } catch (error) {
              closePopup();
              showPopup("Failed to delete: " + error.message);
            }
          });
        }, 50);
      });

      actionsDiv.appendChild(deleteBtn);

      card.appendChild(actionsDiv);

      maintenanceList.appendChild(card);

      // Add image slider functionality for unit owner photos
      if (data.imageUrls && Array.isArray(data.imageUrls) && data.imageUrls.length > 1) {
        let currentIndex = 0;
        const imgEl = card.querySelector(`#owner-img-${id}`);
        const prevBtn = card.querySelector(".owner-prev-btn");
        const nextBtn = card.querySelector(".owner-next-btn");

        prevBtn.addEventListener("click", () => {
          currentIndex = (currentIndex - 1 + data.imageUrls.length) % data.imageUrls.length;
          imgEl.src = data.imageUrls[currentIndex];
        });

        nextBtn.addEventListener("click", () => {
          currentIndex = (currentIndex + 1) % data.imageUrls.length;
          imgEl.src = data.imageUrls[currentIndex];
        });
      }

      // Add image slider functionality for proof photos
      if (proofImages.length > 1) {
        let proofIndex = 0;
        const proofImgEl = card.querySelector(`#proof-img-${id}`);
        const proofPrevBtn = card.querySelector(".proof-prev-btn");
        const proofNextBtn = card.querySelector(".proof-next-btn");

        proofPrevBtn.addEventListener("click", () => {
          proofIndex = (proofIndex - 1 + proofImages.length) % proofImages.length;
          proofImgEl.src = proofImages[proofIndex].url;
          // Update the info text
          const infoDiv = proofImgEl.parentNode.querySelector('div[style*="text-align:center"]');
          if (infoDiv) {
            infoDiv.innerHTML = `
              ${proofImages.length} proof photo(s)<br>
              <small>By: ${proofImages[proofIndex].uploadedBy || "Unknown"}</small><br>
              <small>${proofImages[proofIndex].timestamp ? formatDateTimeAMPM(proofImages[proofIndex].timestamp) : ""}</small>
            `;
          }
        });

        proofNextBtn.addEventListener("click", () => {
          proofIndex = (proofIndex + 1) % proofImages.length;
          proofImgEl.src = proofImages[proofIndex].url;
          // Update the info text
          const infoDiv = proofImgEl.parentNode.querySelector('div[style*="text-align:center"]');
          if (infoDiv) {
            infoDiv.innerHTML = `
              ${proofImages.length} proof photo(s)<br>
              <small>By: ${proofImages[proofIndex].uploadedBy || "Unknown"}</small><br>
              <small>${proofImages[proofIndex].timestamp ? formatDateTimeAMPM(proofImages[proofIndex].timestamp) : ""}</small>
            `;
          }
        });
      }
    });

    // Mark all visible new requests as seen after a delay
    if (newRequestIds.length > 0) {
      setTimeout(() => {
        markRequestsAsSeen(newRequestIds);
        updateNotificationDot();
      }, 3000);
    }

    // Update statistics
    requestCount.textContent = filteredRequests.length;
    pendingCountEl.textContent = pending;
    if (inProgressCountEl) {
      inProgressCountEl.textContent = inProgress;
    }
    completeCountEl.textContent = complete;
    
    // Add new requests count to stats
    let newCountEl = document.getElementById('newCount');
    if (!newCountEl) {
      newCountEl = document.createElement('span');
      newCountEl.id = 'newCount';
      newCountEl.style.color = '#ff4757';
      newCountEl.style.marginLeft = '10px';
      newCountEl.style.fontWeight = 'bold';
      maintenanceStats.appendChild(newCountEl);
    }
    
    // Add tenant marked complete count
    let tenantMarkedCountEl = document.getElementById('tenantMarkedCount');
    if (!tenantMarkedCountEl && tenantMarkedCompleteCount > 0) {
      tenantMarkedCountEl = document.createElement('span');
      tenantMarkedCountEl.id = 'tenantMarkedCount';
      tenantMarkedCountEl.style.color = '#f39c12';
      tenantMarkedCountEl.style.marginLeft = '10px';
      tenantMarkedCountEl.style.fontWeight = 'bold';
      tenantMarkedCountEl.innerHTML = `(${tenantMarkedCompleteCount} ready to finalize)`;
      maintenanceStats.appendChild(tenantMarkedCountEl);
    } else if (tenantMarkedCountEl) {
      if (tenantMarkedCompleteCount > 0) {
        tenantMarkedCountEl.textContent = `(${tenantMarkedCompleteCount} ready to finalize)`;
        tenantMarkedCountEl.style.display = 'inline';
      } else {
        tenantMarkedCountEl.style.display = 'none';
      }
    }
    
    if (newRequestsCount > 0) {
      newCountEl.textContent = `(${newRequestsCount} new)`;
    } else {
      newCountEl.textContent = '';
    }

    maintenanceStats.style.display = "block";
    updateNotificationDot();
  }

  // Load maintenance crew first
  loadMaintenanceCrew().then(() => {
    // Then load maintenance requests
    db.collection("maintenanceRequests")
      .orderBy("timestamp", "desc")
      .onSnapshot(
        (snapshot) => {
          if (snapshot.empty) {
            allRequests = [];
            filteredRequests = [];
            maintenanceList.innerHTML = "<p>No maintenance requests found.</p>";
            maintenanceStats.style.display = "none";
            updateNotificationDot();
            return;
          }

          allRequests = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));

          // Always update notification dot when data changes
          updateNotificationDot();
          
          // Only apply filters and sort if we're on the maintenance page
          if (document.getElementById("maintenanceList")) {
            applyFiltersAndSort();
          }
        },
        (error) => {
          maintenanceList.innerHTML =
            `<p style="color:red;">Error loading requests: ${error.message}</p>`;
          maintenanceStats.style.display = "none";
        }
      );
  });

  statusFilter.addEventListener("change", applyFiltersAndSort);
  personnelFilter.addEventListener("change", applyFiltersAndSort);
  maintenanceSearch.addEventListener("input", applyFiltersAndSort);
  sortBy.addEventListener("change", applyFiltersAndSort);
  resetFilters.addEventListener("click", () => {
    statusFilter.value = "all";
    personnelFilter.value = "all";
    maintenanceSearch.value = "";
    sortBy.value = "date-desc";
    applyFiltersAndSort();
  });

  // ==== ADD: Clear notification when clicking on the maintenance tab ====
  if (maintenanceNavItem) {
    maintenanceNavItem.addEventListener('click', function() {
      // When user clicks on maintenance tab, mark all requests as seen
      const allNewRequestIds = allRequests
        .filter(request => isRequestNew(request) && request.status !== 'Complete')
        .map(request => request.id);
      
      if (allNewRequestIds.length > 0) {
        markRequestsAsSeen(allNewRequestIds);
        updateNotificationDot();
      }
    });
  }
}
    // ======================== ACCOUNT CREATION LOGIC (UPDATED) ========================
    function initAccountCreation() {
      const adminEmail = "adminaccount@solano.com";
      const adminPassword = "qwerty";

      // Function to toggle between account types
      window.toggleAccountType = function(radio) {
        const isTenant = radio.value === 'tenant';
        document.getElementById('tenantFormContainer').style.display = isTenant ? 'block' : 'none';
        document.getElementById('maintenanceFormContainer').style.display = isTenant ? 'none' : 'block';
      };

      // Function to toggle user list view
      window.toggleUserList = function(type) {
        const isTenant = type === 'tenant';
        document.getElementById('unitOwnersList').style.display = isTenant ? 'block' : 'none';
        document.getElementById('maintenanceCrewList').style.display = isTenant ? 'none' : 'block';
        
        document.getElementById('showTenantsBtn').classList.toggle('active', isTenant);
        document.getElementById('showMaintenanceBtn').classList.toggle('active', !isTenant);
        
        // Load appropriate list if not loaded
        if (isTenant) {
          loadAndDisplayUnitOwners();
        } else {
          loadAndDisplayMaintenanceCrew();
        }
      };

      async function sendAccountEmail(recipient, email, password, additionalData = {}) {
        try {
          const templateParams = {
            to_email: recipient,
            tenant_email: email,
            tenant_password: password,
            login_link: "https://cjgenon.github.io/SOLANO/LogIn.html"
          };

          // Add unit-specific data for tenants
          if (additionalData.units) {
            templateParams.unit_numbers = additionalData.units.join(", ");
          }
          
          // Add maintenance-specific data
          if (additionalData.role) {
            templateParams.role = additionalData.role;
            templateParams.name = additionalData.name || '';
          }

          await emailjs.send("service_izx63bb", "template_p7zetfj", templateParams);
          console.log("Email sent successfully");
        } catch (error) {
          console.error("EmailJS Error:", error);
        }
      }

      function generatePassword() {
        const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const lowercase = "abcdefghijklmnopqrstuvwxyz";
        const numbers = "0123456789";

        let password = "";
        password += uppercase[Math.floor(Math.random() * uppercase.length)];
        password += lowercase[Math.floor(Math.random() * lowercase.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];

        const allChars = uppercase + lowercase + numbers;
        for (let i = 3; i < 8; i++) {
          password += allChars[Math.floor(Math.random() * allChars.length)];
        }

        return password
          .split("")
          .sort(() => Math.random() - 0.5)
          .join("");
      }

      const units = [];
      const unitsPerBuilding = 144;
      const floorsPerBuilding = 8;
      const unitsPerFloor = unitsPerBuilding / floorsPerBuilding;

      for (let i = 1; i <= 288; i++) {
        const building = i <= unitsPerBuilding ? 1 : 2;
        const floor = building === 1
          ? Math.ceil(i / unitsPerFloor)
          : Math.ceil((i - unitsPerBuilding) / unitsPerFloor);

        const type = i % 2 === 1 ? "1B" : "2B";

        units.push({ num: i, building, floor, type });
      }

      function populateUnitNumbers(typeSelect, numberSelect, occupied) {
        numberSelect.innerHTML = '<option value="">-- Select Unit Number --</option>';
        if (!typeSelect.value) return;

        const type = typeSelect.value;
        const currentValue = numberSelect.value;
        let currentStillAvailable = false;

        units.forEach(unit => {
          if (unit.type !== type) return;

          const numStr = unit.num.toString().padStart(3, "0");
          const unitValue = `${type}-${numStr}`;

          if (occupied.includes(unitValue)) return;

          const opt = document.createElement("option");
          opt.value = unitValue;
          opt.textContent = `${numStr} (Bldg ${unit.building} - Floor ${unit.floor})`;
          numberSelect.appendChild(opt);

          if (currentValue === unitValue) {
            currentStillAvailable = true;
          }
        });

        if (currentStillAvailable) {
          numberSelect.value = currentValue;
        }
      }

      async function getOccupiedUnits() {
        try {
          const usersSnapshot = await db
            .collection("users")
            .where("role", "==", "tenant")
            .get();

          const occupiedUnits = [];
          usersSnapshot.forEach((docSnap) => {
            const userData = docSnap.data();
            if (userData.unitNumbers && Array.isArray(userData.unitNumbers)) {
              occupiedUnits.push(...userData.unitNumbers);
            }
          });
          console.log("Occupied units fetched:", occupiedUnits);
          return occupiedUnits;
        } catch (error) {
          console.error("Error fetching occupied units:", error);
          return [];
        }
      }

      async function loadAndDisplayUnitOwners() {
        const ul = document.getElementById("unitOwnersUl");
        ul.innerHTML = "<li style='padding: 20px; text-align: center; color: #D4A76A; background: #3E2723;'>Loading unit owners...</li>";
        
        const colors = {
          darkBg: '#2C1810',
          mediumBg: '#3E2723',
          lightBg: '#4A342E',
          accentBg: '#5D4037',
          goldAccent: '#D4A76A',
          borderLight: '#5D4037',
          textWhite: '#FFFFFF',
          textMuted: '#E0E0E0',
          success: '#9CCC65',
          error: '#EF5350',
        };
        
        ul.style.cssText = `
          list-style-type: none;
          padding-left: 0;
          max-height: 300px;
          overflow-y: auto;
          border: 2px solid ${colors.borderLight};
          padding: 0;
          border-radius: 8px;
          background: ${colors.darkBg};
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        
        try {
          const snapshot = await db.collection("users").where("role", "==", "tenant").get();
          if (snapshot.empty) {
            ul.innerHTML = `
              <li style="padding: 30px 20px; text-align: center; color: ${colors.textMuted}; border-bottom: 1px solid ${colors.borderLight}; background: ${colors.mediumBg};">
                <div style="margin-bottom: 8px; font-weight: 500; color: ${colors.textWhite};">No unit owners found</div>
                <div style="font-size: 13px; color: ${colors.textMuted};">Create your first unit owner account above</div>
              </li>
            `;
            return;
          }

          ul.innerHTML = "";
          
          // Add header
          const headerLi = document.createElement("li");
          headerLi.style.cssText = `
            padding: 16px 20px;
            background: linear-gradient(135deg, ${colors.darkBg} 0%, ${colors.mediumBg} 100%);
            border-bottom: 3px solid ${colors.goldAccent};
            font-weight: 600;
            color: ${colors.textWhite};
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          headerLi.innerHTML = `
            <span style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px; color: ${colors.goldAccent};">üë§</span>
              <span>Unit Owners (${snapshot.size})</span>
            </span>
          `;
          ul.appendChild(headerLi);

          snapshot.forEach((doc, index) => {
            const data = doc.data();
            const email = data.email || "No email";
            const unitNumbers = data.unitNumbers || [];

            const li = document.createElement("li");
            li.style.cssText = `
              padding: 15px 20px;
              border-bottom: 1px solid ${colors.borderLight};
              background: ${index % 2 === 0 ? colors.mediumBg : colors.lightBg};
              cursor: pointer;
              transition: all 0.3s;
            `;
            
            li.onmouseenter = () => {
              li.style.background = colors.accentBg;
            };
            li.onmouseleave = () => {
              li.style.background = index % 2 === 0 ? colors.mediumBg : colors.lightBg;
            };

            // Email section
            const emailSection = document.createElement("div");
            emailSection.style.cssText = `
              display: flex;
              align-items: center;
              margin-bottom: 8px;
            `;
            
            const statusIndicator = document.createElement("span");
            statusIndicator.style.cssText = `
              display: inline-block;
              width: 10px;
              height: 10px;
              background: ${colors.goldAccent};
              border-radius: 50%;
              margin-right: 10px;
              flex-shrink: 0;
            `;
            
            emailSection.appendChild(statusIndicator);
            
            const emailText = document.createElement("span");
            emailText.style.cssText = `
              font-weight: 600;
              color: ${colors.textWhite};
              font-size: 14px;
              flex: 1;
            `;
            emailText.textContent = email;
            emailSection.appendChild(emailText);
            
            // Unit count badge
            if (unitNumbers.length > 0) {
              const unitCountBadge = document.createElement("span");
              unitCountBadge.style.cssText = `
                background: ${colors.accentBg};
                color: ${colors.textWhite};
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                margin-left: 10px;
              `;
              unitCountBadge.textContent = `${unitNumbers.length} unit${unitNumbers.length !== 1 ? 's' : ''}`;
              emailSection.appendChild(unitCountBadge);
            }
            
            li.appendChild(emailSection);

            // Units section
            if (unitNumbers.length > 0) {
              const unitsContainer = document.createElement("div");
              unitsContainer.style.cssText = `
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px dashed ${colors.borderLight};
                display: none;
              `;
              
              const unitsTitle = document.createElement("div");
              unitsTitle.style.cssText = `
                font-size: 12px;
                color: ${colors.textMuted};
                font-weight: 600;
                margin-bottom: 5px;
              `;
              unitsTitle.textContent = "Assigned Units:";
              unitsContainer.appendChild(unitsTitle);
              
              const unitsList = document.createElement("div");
              unitsList.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
              `;
              
              unitNumbers.forEach(unitStr => {
                const unitBadge = document.createElement("span");
                unitBadge.style.cssText = `
                  background: ${colors.accentBg};
                  color: ${colors.textWhite};
                  padding: 3px 8px;
                  border-radius: 4px;
                  font-size: 12px;
                `;
                unitBadge.textContent = unitStr;
                unitsList.appendChild(unitBadge);
              });
              
              unitsContainer.appendChild(unitsList);
              li.appendChild(unitsContainer);
              
              // Click to toggle unit details
              li.addEventListener('click', () => {
                if (unitsContainer.style.display === 'none') {
                  unitsContainer.style.display = 'block';
                } else {
                  unitsContainer.style.display = 'none';
                }
              });
            }

            ul.appendChild(li);
          });

          // Summary footer
          const totalUnits = snapshot.docs.reduce((total, doc) => {
            const data = doc.data();
            return total + (data.unitNumbers ? data.unitNumbers.length : 0);
          }, 0);
          
          const footerLi = document.createElement("li");
          footerLi.style.cssText = `
            padding: 12px 20px;
            background: ${colors.mediumBg};
            border-top: 1px solid ${colors.borderLight};
            font-size: 13px;
            color: ${colors.textWhite};
            text-align: center;
          `;
          footerLi.textContent = `${totalUnits} total units assigned`;
          ul.appendChild(footerLi);

        } catch (error) {
          console.error("Error loading unit owners:", error);
          ul.innerHTML = `
            <li style="padding: 30px 20px; text-align: center; background: ${colors.mediumBg};">
              <div style="color: ${colors.error}; font-weight: 600; margin-bottom: 12px;">
                Error loading unit owners
              </div>
              <div style="color: ${colors.textMuted}; font-size: 14px;">
                ${error.message || 'Please try refreshing the page.'}
              </div>
            </li>
          `;
        }
      }

      async function loadAndDisplayMaintenanceCrew() {
        const ul = document.getElementById("maintenanceCrewUl");
        ul.innerHTML = "<li style='padding: 20px; text-align: center; color: #4a90e2; background: #1a1a2e;'>Loading maintenance crew...</li>";
        
        const colors = {
          darkBg: '#1a1a2e',
          mediumBg: '#16213e',
          lightBg: '#0f3460',
          accentBg: '#4a90e2',
          borderLight: '#2d4059',
          textWhite: '#FFFFFF',
          textMuted: '#E0E0E0',
          success: '#9CCC65',
          error: '#EF5350',
        };
        
        ul.style.cssText = `
          list-style-type: none;
          padding-left: 0;
          max-height: 300px;
          overflow-y: auto;
          border: 2px solid ${colors.borderLight};
          padding: 0;
          border-radius: 8px;
          background: ${colors.darkBg};
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        
        try {
          const snapshot = await db.collection("users").where("role", "==", "maintenance").get();
          if (snapshot.empty) {
            ul.innerHTML = `
              <li style="padding: 30px 20px; text-align: center; color: ${colors.textMuted}; border-bottom: 1px solid ${colors.borderLight}; background: ${colors.mediumBg};">
                <div style="margin-bottom: 8px; font-weight: 500; color: ${colors.textWhite};">No maintenance crew found</div>
                <div style="font-size: 13px; color: ${colors.textMuted};">Create your first maintenance account above</div>
              </li>
            `;
            return;
          }

          ul.innerHTML = "";
          
          // Add header
          const headerLi = document.createElement("li");
          headerLi.style.cssText = `
            padding: 16px 20px;
            background: linear-gradient(135deg, ${colors.darkBg} 0%, ${colors.mediumBg} 100%);
            border-bottom: 3px solid ${colors.accentBg};
            font-weight: 600;
            color: ${colors.textWhite};
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;
          headerLi.innerHTML = `
            <span style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px; color: ${colors.accentBg};">üîß</span>
              <span>Maintenance Crew (${snapshot.size})</span>
            </span>
          `;
          ul.appendChild(headerLi);

          snapshot.forEach((doc, index) => {
            const data = doc.data();
            const email = data.email || "No email";
            const name = data.name || "No name";
            const role = data.role || "No role specified";
            const phone = data.phone || "No contact";

            const li = document.createElement("li");
            li.style.cssText = `
              padding: 15px 20px;
              border-bottom: 1px solid ${colors.borderLight};
              background: ${index % 2 === 0 ? colors.mediumBg : colors.lightBg};
              cursor: pointer;
              transition: all 0.3s;
            `;
            
            li.onmouseenter = () => {
              li.style.background = colors.accentBg + '20';
            };
            li.onmouseleave = () => {
              li.style.background = index % 2 === 0 ? colors.mediumBg : colors.lightBg;
            };

            // Name and email section
            const nameSection = document.createElement("div");
            nameSection.style.cssText = `
              display: flex;
              align-items: center;
              margin-bottom: 8px;
            `;
            
            const statusIndicator = document.createElement("span");
            statusIndicator.style.cssText = `
              display: inline-block;
              width: 10px;
              height: 10px;
              background: ${colors.accentBg};
              border-radius: 50%;
              margin-right: 10px;
              flex-shrink: 0;
            `;
            
            nameSection.appendChild(statusIndicator);
            
            const nameText = document.createElement("span");
            nameText.style.cssText = `
              font-weight: 600;
              color: ${colors.textWhite};
              font-size: 14px;
              flex: 1;
            `;
            nameText.textContent = name;
            nameSection.appendChild(nameText);
            
            li.appendChild(nameSection);

            // Email
            const emailDiv = document.createElement("div");
            emailDiv.style.cssText = `
              font-size: 12px;
              color: ${colors.textMuted};
              margin-bottom: 5px;
            `;
            emailDiv.textContent = email;
            li.appendChild(emailDiv);

            // Role and phone section
            const detailsContainer = document.createElement("div");
            detailsContainer.style.cssText = `
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px dashed ${colors.borderLight};
              display: none;
            `;
            
            // Role badge
            const roleBadge = document.createElement("span");
            roleBadge.style.cssText = `
              display: inline-block;
              background: ${colors.accentBg};
              color: ${colors.textWhite};
              padding: 3px 10px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: 600;
              margin-bottom: 8px;
            `;
            roleBadge.textContent = role;
            detailsContainer.appendChild(roleBadge);

            // Phone
            if (phone !== "No contact") {
              const phoneDiv = document.createElement("div");
              phoneDiv.style.cssText = `
                font-size: 12px;
                color: ${colors.textMuted};
                margin-top: 5px;
                display: flex;
                align-items: center;
                gap: 5px;
              `;
              phoneDiv.innerHTML = `<span style="color: ${colors.accentBg};">üì±</span> ${phone}`;
              detailsContainer.appendChild(phoneDiv);
            }

            // Account status
            const statusDiv = document.createElement("div");
            statusDiv.style.cssText = `
              font-size: 11px;
              color: ${colors.success};
              margin-top: 8px;
              padding: 2px 8px;
              background: ${colors.success}20;
              border-radius: 4px;
              display: inline-block;
            `;
            statusDiv.textContent = "Active Account";
            detailsContainer.appendChild(statusDiv);

            li.appendChild(detailsContainer);
            
            // Click to toggle details
            li.addEventListener('click', () => {
              if (detailsContainer.style.display === 'none') {
                detailsContainer.style.display = 'block';
              } else {
                detailsContainer.style.display = 'none';
              }
            });

            ul.appendChild(li);
          });

          // Summary footer
          const rolesCount = {};
          snapshot.forEach(doc => {
            const role = doc.data().role || "Unspecified";
            rolesCount[role] = (rolesCount[role] || 0) + 1;
          });
          
          const rolesText = Object.entries(rolesCount)
            .map(([role, count]) => `${role}: ${count}`)
            .join(", ");
          
          const footerLi = document.createElement("li");
          footerLi.style.cssText = `
            padding: 12px 20px;
            background: ${colors.mediumBg};
            border-top: 1px solid ${colors.borderLight};
            font-size: 12px;
            color: ${colors.textMuted};
            text-align: center;
          `;
          footerLi.textContent = rolesText;
          ul.appendChild(footerLi);

        } catch (error) {
          console.error("Error loading maintenance crew:", error);
          ul.innerHTML = `
            <li style="padding: 30px 20px; text-align: center; background: ${colors.mediumBg};">
              <div style="color: ${colors.error}; font-weight: 600; margin-bottom: 12px;">
                Error loading maintenance crew
              </div>
              <div style="color: ${colors.textMuted}; font-size: 14px;">
                ${error.message || 'Please try refreshing the page.'}
              </div>
            </li>
          `;
        }
      }

      (async () => {
        let occupiedUnits = await getOccupiedUnits();

        // ============ TENANT FORM LOGIC ============
        const tenantPasswordInput = document.getElementById("tenantPassword");
        const generateTenantBtn = document.getElementById("generatePasswordBtn");
        const tenantForm = document.getElementById("createTenantForm");
        const unitContainer = document.getElementById("unitContainer");
        const addUnitBtn = document.getElementById("addUnitBtn");
        const tenantSubmitBtn = tenantForm ? tenantForm.querySelector('button[type="submit"]') : null;

        // Tenant password generation
        if (generateTenantBtn) {
          generateTenantBtn.addEventListener("click", () => {
            const newPassword = generatePassword();
            tenantPasswordInput.value = newPassword;
            tenantPasswordInput.style.border = "1px solid #4CAF50";
            setTimeout(() => {
              tenantPasswordInput.style.background = "#222";
              tenantPasswordInput.style.border = "1px solid rgba(255,255,255,0.18)";
            }, 3000);
          });
        }

        // Tenant unit selection
        const firstType = document.querySelector(".unitType");
        const firstNumber = document.querySelector(".unitNumber");
        if (firstType && firstNumber) {
          firstType.addEventListener("change", () =>
            populateUnitNumbers(firstType, firstNumber, occupiedUnits)
          );
        }

        // Add unit row
        if (addUnitBtn) {
          addUnitBtn.addEventListener("click", () => {
            const row = document.createElement("div");
            row.classList.add("unit-row");
            row.style = "display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;";
            row.innerHTML = `
              <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
                <option value="">-- Select Type --</option>
                <option value="1B">1B (1 Bedroom)</option>
                <option value="2B">2B (2 Bedroom)</option>
              </select>
              <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
                <option value="">-- Select Unit Number --</option>
              </select>
              <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">X</button>
            `;
            unitContainer.appendChild(row);

            const tSelect = row.querySelector(".unitType");
            const nSelect = row.querySelector(".unitNumber");
            tSelect.addEventListener("change", () =>
              populateUnitNumbers(tSelect, nSelect, occupiedUnits)
            );

            row.querySelector(".removeUnitBtn").addEventListener("click", function () {
              if (document.querySelectorAll(".unit-row").length > 1) {
                row.remove();
              }
            });
          });
        }

        // Remove unit row
        const removeBtns = document.querySelectorAll(".removeUnitBtn");
        removeBtns.forEach(btn => {
          btn.addEventListener("click", function () {
            if (document.querySelectorAll(".unit-row").length > 1) {
              this.parentElement.remove();
            }
          });
        });

        // Tenant form submission
        if (tenantForm) {
          tenantForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("tenantEmail").value;
            const password = tenantPasswordInput.value;
            const unitNumbers = Array.from(document.querySelectorAll(".unitNumber"))
              .map((i) => i.value)
              .filter((v) => v !== "");

            const occupiedSet = new Set(occupiedUnits);
            const occupiedSelections = unitNumbers.filter((u) => occupiedSet.has(u));
            if (occupiedSelections.length > 0) {
              showPopup(
                `Error: The following units are already occupied: ${occupiedSelections.join(
                  ", "
                )}. Please select different units.`
              );
              return;
            }

            try {
              setButtonLoading(tenantSubmitBtn, true);

              const userCredential =
                await auth.createUserWithEmailAndPassword(
                  email,
                  password
                );
              const user = userCredential.user;

              await db.collection("users").doc(user.uid).set({
                email,
                role: "tenant",
                unitNumbers,
                mustChangePassword: true,
                createdAt:
                  firebase.firestore.FieldValue.serverTimestamp(),
              });

              const unitsWithDetails = unitNumbers.map(unitStr => {
                const numPart = parseInt(unitStr.split("-")[1], 10);
                const unitInfo = units.find(u => u.num === numPart);

                if (unitInfo) {
                  return `${unitStr} (Bldg ${unitInfo.building} - Floor ${unitInfo.floor})`;
                } else {
                  return unitStr;
                }
              });

              await sendAccountEmail(email, email, password, { units: unitsWithDetails });

              occupiedUnits.push(...unitNumbers);

              await auth.signInWithEmailAndPassword(
                adminEmail,
                adminPassword
              );

              showPopup(
                "Unit Owner created successfully! Temporary password: " +
                password
              );

              tenantForm.reset();
              tenantPasswordInput.value = "";
              tenantPasswordInput.style.background = "#222";
              tenantPasswordInput.style.border =
                "1px solid rgba(255,255,255,0.18)";

              unitContainer.innerHTML = `
                <div class="unit-row" style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                  <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
                    <option value="">-- Select Type --</option>
                    <option value="1B">1B (1 Bedroom)</option>
                    <option value="2B">2B (2 Bedroom)</option>
                  </select>
                  <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
                    <option value="">-- Select Unit Number --</option>
                  </select>
                  <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">X</button>
                </div>
              `;

              const newFirstType = document.querySelector(".unitType");
              const newFirstNumber = document.querySelector(".unitNumber");
              newFirstType.addEventListener("change", () =>
                populateUnitNumbers(
                  newFirstType,
                  newFirstNumber,
                  occupiedUnits
                )
              );

              document
                .querySelector(".removeUnitBtn")
                .addEventListener("click", function () {
                  if (
                    document.querySelectorAll(".unit-row").length > 1
                  ) {
                    this.parentElement.remove();
                  }
                });

              await loadAndDisplayUnitOwners();

            } catch (error) {
              showPopup("Error creating unit owner: The email is already in use");
            } finally {
              setButtonLoading(tenantSubmitBtn, false);
            }
          });
        }

        // ============ MAINTENANCE FORM LOGIC ============
        const maintenanceForm = document.getElementById("createMaintenanceForm");
        const maintenancePasswordInput = document.getElementById("maintenancePassword");
        const generateMaintenanceBtn = document.getElementById("generateMaintenancePasswordBtn");
        const maintenanceSubmitBtn = maintenanceForm ? maintenanceForm.querySelector('button[type="submit"]') : null;

        // Maintenance password generation
        if (generateMaintenanceBtn) {
          generateMaintenanceBtn.addEventListener("click", () => {
            const newPassword = generatePassword();
            maintenancePasswordInput.value = newPassword;
            maintenancePasswordInput.style.border = "1px solid #4CAF50";
            setTimeout(() => {
              maintenancePasswordInput.style.background = "#222";
              maintenancePasswordInput.style.border = "1px solid rgba(255,255,255,0.18)";
            }, 3000);
          });
        }

        // Maintenance form submission
        if (maintenanceForm) {
          maintenanceForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("maintenanceEmail").value;
            const name = document.getElementById("maintenanceName").value;
            const password = maintenancePasswordInput.value;
            const role = document.getElementById("maintenanceRole").value;
            const phone = document.getElementById("maintenancePhone").value || "";

            try {
              setButtonLoading(maintenanceSubmitBtn, true);

              const userCredential = await auth.createUserWithEmailAndPassword(email, password);
              const user = userCredential.user;

              await db.collection("users").doc(user.uid).set({
                email,
                name,
                role: "maintenance",
                specialization: role,
                phone,
                mustChangePassword: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

              await sendAccountEmail(email, email, password, {
                role: role,
                name: name
              });

              await auth.signInWithEmailAndPassword(adminEmail, adminPassword);

              showPopup(
                `Maintenance crew account created successfully!<br><br>
                <strong>Name:</strong> ${name}<br>
                <strong>Role:</strong> ${role}<br>
                <strong>Temporary Password:</strong> ${password}`
              );

              maintenanceForm.reset();
              maintenancePasswordInput.value = "";
              maintenancePasswordInput.style.background = "#222";
              maintenancePasswordInput.style.border = "1px solid rgba(255,255,255,0.18)";

              // Load maintenance crew list
              await loadAndDisplayMaintenanceCrew();

            } catch (error) {
              showPopup("Error creating maintenance account: The email is already in use.");
            } finally {
              setButtonLoading(maintenanceSubmitBtn, false);
            }
          });
        }

        // Load initial user lists
        await loadAndDisplayUnitOwners();

      })();
    }

    // ======================== FEEDBACK RECEIVED LOGIC ========================
    function initFeedbackReceived() {
      let allFeedback = [];
      let filteredFeedback = [];

      const ratingFilter = document.getElementById("ratingFilter");
      const feedbackSearch = document.getElementById("feedbackSearch");
      const sortBy = document.getElementById("sortBy");
      const resetFilters = document.getElementById("resetFilters");
      const refreshBtn = document.getElementById("refreshFeedbackBtn");
      const feedbackStats = document.getElementById("feedbackStats");
      const feedbackCount = document.getElementById("feedbackCount");
      const averageRating = document.getElementById("averageRating");
      const feedbackList = document.getElementById("feedback-list");

      async function loadFeedbacks() {
        feedbackList.innerHTML = "<p>Loading feedback...</p>";
        try {
          const snapshot = await db
            .collection("feedback")
            .orderBy("timestamp", "desc")
            .get();

          if (snapshot.empty) {
            allFeedback = [];
            filteredFeedback = [];
            feedbackList.innerHTML = "<p>No feedback found.</p>";
            feedbackStats.style.display = "none";
            return;
          }

          allFeedback = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));

          applyFiltersAndSort();
        } catch (error) {
          feedbackList.innerHTML = `<p style="color:red;">Error loading feedback: ${error.message}</p>`;
        }
      }

      function applyFiltersAndSort() {
        const ratingValue = ratingFilter.value;
        const searchValue = feedbackSearch.value.toLowerCase();
        const sortValue = sortBy.value;

        filteredFeedback = [...allFeedback];

        if (ratingValue !== "all") {
          filteredFeedback = filteredFeedback.filter(
            (f) => String(f.rating) === ratingValue
          );
        }

        if (searchValue) {
          filteredFeedback = filteredFeedback.filter((f) => {
            const emailMatch =
              f.tenantEmail &&
              f.tenantEmail.toLowerCase().includes(searchValue);

            const textFields = [
              f.q1,
              f.q2,
              f.q3,
              f.q4,
              f.q5,
              f.q6,
              f.question2,
              f.question3,
            ]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();

            return (
              emailMatch || textFields.includes(searchValue)
            );
          });
        }

        filteredFeedback.sort((a, b) => {
          const aDate = a.timestamp?.toDate ? a.timestamp.toDate() : null;
          const bDate = b.timestamp?.toDate ? b.timestamp.toDate() : null;

          switch (sortValue) {
            case "date-desc":
              return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
            case "date-asc":
              return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
            case "rating-desc":
              return (b.rating || 0) - (a.rating || 0);
            case "rating-asc":
              return (a.rating || 0) - (b.rating || 0);
            case "email-asc":
              return (a.tenantEmail || "").localeCompare(
                b.tenantEmail || ""
              );
            case "email-desc":
              return (b.tenantEmail || "").localeCompare(
                a.tenantEmail || ""
              );
            default:
              return 0;
          }
        });

        renderFeedbacks();
      }

      function renderFeedbacks() {
        if (!filteredFeedback.length) {
          feedbackList.innerHTML =
            "<p>No feedback found matching your criteria.</p>";
          feedbackStats.style.display = "none";
          return;
        }

        feedbackList.innerHTML = "";
        let totalRating = 0;

        filteredFeedback.forEach((f) => {
          const ts = f.timestamp?.toDate
            ? f.timestamp.toDate()
            : f.timestamp?.seconds
              ? new Date(f.timestamp.seconds * 1000)
              : null;
          const timeText = ts ? ts.toLocaleString() : "Unknown time";

          const rating = Number(f.rating) || 0;
          totalRating += rating;
          const stars = "‚≠ê".repeat(rating);
          const empty = "‚òÜ".repeat(5 - rating);

          const wrapper = document.createElement("div");
          wrapper.className = "feedback-item";

          const hasNewSchema =
            f.q1 || f.q2 || f.q3 || f.q4 || f.q5 || f.q6;

          let questionsHtml = "";

          if (hasNewSchema) {
            questionsHtml += `
              <div class="feedback-question">
                <strong>Overall condition and appearance of the property</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q1 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Maintenance services (unit, hallway, garden)</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q2 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Professionalism of property management staff</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q3 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Ease of paying monthly dues / rent</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q4 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Amenities (gym, pool, clubhouse)</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q5 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Additional suggestions</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q6 || "No suggestions provided"
                )}</div>
              </div>
            `;
          } else {
            questionsHtml += `
              <div class="feedback-question">
                <strong>What do you like about our services, unit, and facilities?</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.question2 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>What can we improve in our unit, services, or facilities?</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.question3 || "No answer provided"
                )}</div>
              </div>
            `;
          }

          wrapper.innerHTML = `
            <div class="feedback-item-header">
              <div>
                <div class="feedback-email">${
                  f.tenantEmail || "Unknown User"
                }</div>
                <div class="feedback-rating">
                  ${stars}${empty}
                  <span class="meta">(${rating}/5)</span>
                </div>
              </div>
              <div class="feedback-time">${timeText}</div>
            </div>
            ${questionsHtml}
          `;

          feedbackList.appendChild(wrapper);
        });

        const avg =
          filteredFeedback.length > 0
            ? (totalRating / filteredFeedback.length).toFixed(1)
            : "0.0";
        feedbackCount.textContent = filteredFeedback.length;
        averageRating.textContent = avg;
        feedbackStats.style.display = "block";
      }

      ratingFilter.addEventListener("change", applyFiltersAndSort);
      feedbackSearch.addEventListener("input", applyFiltersAndSort);
      sortBy.addEventListener("change", applyFiltersAndSort);
      resetFilters.addEventListener("click", () => {
        ratingFilter.value = "all";
        feedbackSearch.value = "";
        sortBy.value = "date-desc";
        applyFiltersAndSort();
      });
      refreshBtn.addEventListener("click", async () => {
        setButtonLoading(refreshBtn, true);
        await loadFeedbacks();
        setButtonLoading(refreshBtn, false);
      });

      loadFeedbacks();
    }

    // ======================== HELPERS ========================
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    window.showPopup = function (message) {
      document.getElementById("popupMessage").innerHTML = message;
      document.getElementById("customPopup").classList.remove("hidden");
    };

    window.closePopup = function () {
      document.getElementById("customPopup").classList.add("hidden");
    };

    // ======================== AUTO LOAD SAVED TAB ON PAGE OPEN =================
    window.onload = function () {
      const savedTab = getSavedTab();
      loadContent(null, savedTab);
    };
  </script>

  <!-- ======================== MAINTENANCE CHAT POPUP ======================== -->
  <div id="maintenanceMessagesPanel" class="messages-popup-panel">
    <div class="messages-popup-content">
      <div class="messages-popup-header">
        <h3 id="maintenanceMessagesTitle" class="messages-popup-title">
          Maintenance Conversation
        </h3>
        <button id="closeMaintenanceMessagesBtn" class="messages-popup-close">√ó</button>
      </div>
      <div class="messages-popup-body">
        <div id="maintenanceMessagesContainer"></div>

        <div class="reply-section">
          <h4 style="margin-top:0;">Send Reply</h4>

          <textarea
            id="maintenanceReplyMessage"
            class="reply-textarea"
            placeholder="Type your reply here..."
          ></textarea>

          <div class="quick-replies">
            <p class="quick-replies-label">Quick replies:</p>
            <div class="quick-reply-buttons">
              <button class="maintenanceQuickReplyBtn" data-template="on_the_way">
                On the way
              </button>
              <button class="maintenanceQuickReplyBtn" data-template="technician_assigned">
                Technician assigned
              </button>
              <button class="maintenanceQuickReplyBtn" data-template="scheduled">
                Scheduled per request
              </button>
              <button class="maintenanceQuickReplyBtn" data-template="resolved">
                Issue resolved
              </button>
            </div>
          </div>

          <div class="reply-buttons">
            <button id="maintenanceSendReplyBtn" class="send">Send reply</button>
            <button id="maintenanceClearReplyBtn" class="cancel">Clear</button>
          </div>

          <div id="maintenanceReplyStatus" style="margin-top:8px;font-size:12px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== POPUP ======================== -->
  <div id="customPopup" class="popup hidden">
    <div class="popup-content">
      <p id="popupMessage">Your message goes here</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>
</body>
</html>



