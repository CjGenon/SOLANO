<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard ‚Äì Solano Hills</title>
  <link rel="stylesheet" href="Admin_Dashboard.css" />
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img
        src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp"
        alt="Solano Logo"
      />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent('dashboard')" class="active">Dashboard</a></li>
        <li><a href="#" onclick="loadContent('Payment Received')">Payment Received</a></li>
        <li><a href="#" onclick="loadContent('Maintenance Requests')">Maintenance Requests</a></li>
        <li>
          <a href="#" onclick="loadContent('Unit Owner Account Creation')"
            >Unit Owner Account Creation</a
          >
        </li>
        <li><a href="#" onclick="loadContent('Feedback Received')">Feedback Received</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p>Loading overview‚Ä¶</p>
      </div>
    </div>
  </main>

  <!-- ======================== FIREBASE & CHART.JS ======================== -->
   <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  emailjs.init("lqyGatNXQhoDJsu2B"); 
</script>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ======================== FIREBASE INIT ========================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.appspot.com",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "Login.html";
      } else {
        console.log("Admin logged in:", user.email);
      }
    });

    // Global drill-down state from KPI cards
    window.adminDashboardDrilldown = null;

    function formatCurrency(amount) {
      const num = Number(amount) || 0;
      return (
        "‚Ç±" +
        num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })
      );
    }

    // ======================== ROUTER ========================
    function loadContent(section) {
      const area = document.getElementById("mainContent");

      // sidebar active state
      document
        .querySelectorAll(".sidebar nav ul li a")
        .forEach((link) => link.classList.remove("active"));
      try {
        if (event && event.target) {
          event.target.classList.add("active");
        }
      } catch (e) {
        /* programmatic navigation */
      }

      switch (section) {
        case "dashboard":
          area.innerHTML = `
            <div class="admin-header">
              <h1>Admin Dashboard</h1>
              <p>High-level overview for Solano Hills management.</p>
            </div>

            <div class="kpi-row">
              <div class="stat-card clickable" id="card-maintenance">
                <div class="stat-label">Maintenance Requests</div>
                <div class="stat-main" id="stat-maint-total">--</div>
                <div class="stat-sub" id="stat-maint-pending">Loading‚Ä¶</div>
                <div class="stat-sub" id="stat-maint-recent"></div>
              </div>

              <div class="stat-card clickable" id="card-payments">
                <div class="stat-label">Payments (This Month)</div>
                <div class="stat-main" id="stat-payments-amount">--</div>
                <div class="stat-sub" id="stat-payments-count">Loading‚Ä¶</div>
              </div>

              <div class="stat-card clickable" id="card-feedback">
                <div class="stat-label">Feedback</div>
                <div class="stat-main" id="stat-feedback-total">--</div>
                <div class="stat-sub" id="stat-feedback-recent">Loading‚Ä¶</div>
              </div>
            </div>

            <div class="dashboard-grid">
              <div class="dashboard-main-col">
                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Payments (Last 6 Months)</div>
                    <div class="chart-subtitle">Total collected per month</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="paymentsChart"></canvas>
                  </div>
                </div>

                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Feedback Rating Mix</div>
                    <div class="chart-subtitle">Distribution of 1‚Äì5 star feedback</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="feedbackChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="dashboard-side-col">
                <div class="chart-card small">
                  <div class="chart-header">
                    <div class="chart-title">Maintenance Status</div>
                    <div class="chart-subtitle">Open vs completed</div>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="maintenanceChart"></canvas>
                  </div>
                </div>

                <div class="calendar-card">
                  <h3><span>üìÖ</span> Calendar</h3>
                  <div id="adminCalendar"></div>
                </div>

                <div class="recent-card">
                  <h3>Recent Payments</h3>
                  <p class="recent-sub">Last 5 payments recorded in the system.</p>
                  <div id="recentPaymentsList"></div>
                </div>
              </div>
            </div>
          `;
          initAdminDashboard();
          break;

        case "Payment Received":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Payments Received</h2>
              <p>Real-time list of unit owner PayPal payments.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="paymentSearch">Search</label>
                <input
                  type="text"
                  id="paymentSearch"
                  placeholder="Search by unit owner or payer email‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="amount-desc">Amount (High to Low)</option>
                  <option value="amount-asc">Amount (Low to High)</option>
                  <option value="email-asc">Email (A to Z)</option>
                  <option value="email-desc">Email (Z to A)</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="filterBy">Quick range</label>
                <select id="filterBy">
                  <option value="all">All Payments</option>
                  <option value="last7">Last 7 Days</option>
                  <option value="last30">Last 30 Days</option>
                  <option value="thisMonth">This Month</option>
                  <option value="lastMonth">Last Month</option>
                  <option value="thisYear">This Year</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="dateFrom">Date from</label>
                <input type="date" id="dateFrom" />
              </div>

              <div class="filter-group">
                <label for="dateTo">Date to</label>
                <input type="date" id="dateTo" />
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
            </div>

            <div id="stats" class="stats-strip">
              <span id="paymentCount">0</span> payments |
              <span>Total:</span> ‚Ç±<span id="totalAmount">0.00</span>
            </div>

            <div id="paypalSection" class="list-card">
              <h3 style="margin:0 0 10px;font-size:15px;">PayPal Payments</h3>
              <div id="paypalList">
                <p>Loading PayPal payments...</p>
              </div>
            </div>
          `;
          initPaymentReceived();
          break;

        case "Maintenance Requests":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Maintenance Requests</h2>
              <p>Maintenance requests submitted by unit owners.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="statusFilter">Filter by Status</label>
                <select id="statusFilter">
                  <option value="all">All Statuses</option>
                  <option value="Pending">Pending</option>
                  <option value="Complete">Complete</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="personnelFilter">Filter by Personnel</label>
                <select id="personnelFilter">
                  <option value="all">All Personnel</option>
                  <option value="John Doe">John Doe</option>
                  <option value="Jane Smith">Jane Smith</option>
                  <option value="Mike Johnson">Mike Johnson</option>
                  <option value="unassigned">Unassigned</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="maintenanceSearch">Search</label>
                <input
                  type="text"
                  id="maintenanceSearch"
                  placeholder="Search by unit, email, or issue‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="unit-asc">Unit Number (A‚ÄìZ)</option>
                  <option value="unit-desc">Unit Number (Z‚ÄìA)</option>
                  <option value="email-asc">Email (A‚ÄìZ)</option>
                  <option value="email-desc">Email (Z‚ÄìA)</option>
                </select>
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
            </div>

            <div id="maintenanceStats" class="stats-strip">
              <span id="requestCount">0</span> requests |
              <span id="pendingCount">0</span> pending |
              <span id="completeCount">0</span> complete
            </div>

            <div id="maintenanceList" class="list-card">
              <p>Loading maintenance requests...</p>
            </div>
          `;
          initMaintenanceRequests();
          break;

        case "Unit Owner Account Creation":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Create New Unit Owner Account</h2>
              <p>Create Solano accounts for unit owners and assign units.</p>
            </div>

            <div class="list-card">
              <form id="createTenantForm">
                <div class="filter-group" style="margin-bottom:10px;">
                  <label for="tenantEmail">Unit Owner Solano Email</label>
                  <input type="email" id="tenantEmail" required />
                </div>

                <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
                  <div class="filter-group" style="flex:1; min-width:220px;">
                    <label for="tenantPassword">Temporary Password</label>
                    <input
                      type="text"
                      id="tenantPassword"
                      required
                      readonly
                      style="background:#222;border-color:rgba(255,255,255,0.18);"
                    />
                  </div>
                  <button type="button" id="generatePasswordBtn" class="btn-primary">
                    Generate Password
                  </button>
                </div>

                <div id="unitContainer" style="margin-bottom:10px;">
                  <div class="unit-row" style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                    <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
                      <option value="">-- Select Type --</option>
                      <option value="1B">1B (1 Bedroom)</option>
                      <option value="2B">2B (2 Bedroom)</option>
                    </select>
                    <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
                      <option value="">-- Select Unit Number --</option>
                    </select>
                    <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">
                      X
                    </button>
                  </div>
                </div>

                <button type="button" id="addUnitBtn" class="btn-secondary" style="margin-bottom:16px;">
                  + Add Another Unit
                </button>

                <div>
                  <button type="submit" class="btn-primary">
                    Create Unit Owner
                  </button>
                </div>
              </form>

              <!-- NEW: Container to show the list of created unit owners -->
              <div id="unitOwnersList" style="margin-top: 20px;">
                <h3>Created Unit Owners</h3>
                <ul id="unitOwnersUl" style="list-style-type:none; padding-left:0; max-height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:6px;">
                  <li>Loading...</li>
                </ul>
              </div>
            </div>
          `;
          initUnitOwnerCreation();
          break;


        case "Feedback Received":
          area.innerHTML = `
            <div class="admin-section-header">
              <h2>Feedback from Unit Owners</h2>
              <p>View ratings and qualitative feedback submitted through the tenant portal.</p>
            </div>

            <div class="filter-row">
              <div class="filter-group">
                <label for="ratingFilter">Filter by Rating</label>
                <select id="ratingFilter">
                  <option value="all">All Ratings</option>
                  <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 Stars)</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 Stars)</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê (3 Stars)</option>
                  <option value="2">‚≠ê‚≠ê (2 Stars)</option>
                  <option value="1">‚≠ê (1 Star)</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="feedbackSearch">Search</label>
                <input
                  type="text"
                  id="feedbackSearch"
                  placeholder="Search by email or comments‚Ä¶"
                />
              </div>

              <div class="filter-group">
                <label for="sortBy">Sort by</label>
                <select id="sortBy">
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="rating-desc">Rating (High to Low)</option>
                  <option value="rating-asc">Rating (Low to High)</option>
                  <option value="email-asc">Email (A to Z)</option>
                  <option value="email-desc">Email (Z to A)</option>
                </select>
              </div>

              <button id="resetFilters" class="btn-secondary">Reset Filters</button>
              <button id="refreshFeedbackBtn" class="btn-primary">Refresh</button>
            </div>

            <div id="feedbackStats" class="stats-strip">
              <span id="feedbackCount">0</span> feedback entries |
              <span>Average Rating:</span> <span id="averageRating">0.0</span>
            </div>

            <div id="feedback-list" class="list-card">
              <p>Loading feedback...</p>
            </div>
          `;
          initFeedbackReceived();
          break;

        default:
          area.innerHTML =
            "<h1>Welcome</h1><p>Select a menu option from the sidebar.</p>";
      }
    }

    // ======================== DASHBOARD LOGIC ========================
    async function initAdminDashboard() {
      const maintTotalEl = document.getElementById("stat-maint-total");
      const maintPendingEl = document.getElementById("stat-maint-pending");
      const maintRecentEl = document.getElementById("stat-maint-recent");
      const payAmountEl = document.getElementById("stat-payments-amount");
      const payCountEl = document.getElementById("stat-payments-count");
      const fbTotalEl = document.getElementById("stat-feedback-total");
      const fbRecentEl = document.getElementById("stat-feedback-recent");
      const recentListEl = document.getElementById("recentPaymentsList");

      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      // ----- Maintenance stats -----
      let totalRequests = 0;
      let pendingCount = 0;
      let recentMaint = 0;
      const statusCounts = { pending: 0, complete: 0, other: 0 };

      try {
        const maintSnap = await db
          .collection("maintenanceRequests")
          .orderBy("timestamp", "desc")
          .get();

        totalRequests = maintSnap.size;

        maintSnap.forEach((docSnap) => {
          const data = docSnap.data();
          const status = data.status || "Pending";

          if (status === "Pending") {
            pendingCount++;
            statusCounts.pending++;
          } else if (status === "Complete") {
            statusCounts.complete++;
          } else {
            statusCounts.other++;
          }

          const ts = data.timestamp?.toDate
            ? data.timestamp.toDate()
            : null;
          if (ts && ts >= sevenDaysAgo) {
            recentMaint++;
          }
        });
      } catch (err) {
        console.error("Error loading maintenance stats:", err);
      }

      if (maintTotalEl) maintTotalEl.textContent = totalRequests;
      if (maintPendingEl)
        maintPendingEl.textContent = `${pendingCount} pending`;
      if (maintRecentEl)
        maintRecentEl.textContent = `${recentMaint} in last 7 days`;

      // ----- Payments stats -----
      const monthLabels = [];
      const monthlyTotals = {};
      for (let i = 5; i >= 0; i--) {
        const d = new Date(thisYear, thisMonth - i, 1);
        const label = d.toLocaleString("default", { month: "short" });
        monthLabels.push(label);
        monthlyTotals[label] = 0;
      }

      let totalThisMonth = 0;
      let countThisMonth = 0;
      const recentPayments = [];

      try {
        const paySnap = await db
          .collection("payments")
          .orderBy("timestamp", "desc")
          .get();

        paySnap.forEach((docSnap, index) => {
          const data = docSnap.data();
          const ts = data.timestamp?.toDate
            ? data.timestamp.toDate()
            : null;
          if (!ts) return;

          const amount = Number(data.amount) || 0;
          const status = data.status || "Paid";
          const isPaid =
            status === "Paid" ||
            status === "Approved" ||
            status === "Completed";

          if (
            isPaid &&
            ts.getFullYear() === thisYear &&
            ts.getMonth() === thisMonth
          ) {
            totalThisMonth += amount;
            countThisMonth++;
          }

          const monthsDiff =
            (thisYear - ts.getFullYear()) * 12 +
            (thisMonth - ts.getMonth());
          if (monthsDiff >= 0 && monthsDiff <= 5) {
            const label = ts.toLocaleString("default", { month: "short" });
            if (monthlyTotals[label] != null) {
              monthlyTotals[label] += amount;
            }
          }

          if (index < 5) {
            recentPayments.push({ ...data, timestamp: ts });
          }
        });
      } catch (err) {
        console.error("Error loading payment stats:", err);
      }

      if (payAmountEl) payAmountEl.textContent = formatCurrency(totalThisMonth);
      if (payCountEl) {
        payCountEl.textContent =
          countThisMonth === 1
            ? "1 payment this month"
            : `${countThisMonth} payments this month`;
      }

      if (recentListEl) {
        if (!recentPayments.length) {
          recentListEl.innerHTML =
            '<p class="muted">No payments recorded yet.</p>';
        } else {
          recentListEl.innerHTML = "";
          recentPayments.forEach((p) => {
            const row = document.createElement("div");
            row.className = "recent-payment-row";
            const tenantEmail = p.tenantEmail || "Unknown";
            const method = p.method || "Unknown";
            const amount = formatCurrency(p.amount);
            const dateStr = p.timestamp
              ? p.timestamp.toLocaleString()
              : "";

            row.innerHTML = `
              <div class="recent-main">
                <div class="recent-email">${tenantEmail}</div>
                <div class="recent-method">${method}</div>
              </div>
              <div class="recent-meta">
                <div class="recent-amount">${amount}</div>
                <div class="recent-date">${dateStr}</div>
              </div>
            `;
            recentListEl.appendChild(row);
          });
        }
      }

      // ----- Feedback stats -----
      let totalFeedback = 0;
      let feedbackLast7 = 0;
      const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

      try {
        const fbSnap = await db
          .collection("feedback")
          .orderBy("timestamp", "desc")
          .get();

        totalFeedback = fbSnap.size;

        fbSnap.forEach((docSnap) => {
          const data = docSnap.data();
          const rating = Number(data.rating) || 0;
          if (rating >= 1 && rating <= 5) {
            ratingCounts[rating] += 1;
          }
          const ts = data.timestamp?.toDate
            ? data.timestamp.toDate()
            : null;
          if (ts && ts >= sevenDaysAgo) {
            feedbackLast7++;
          }
        });
      } catch (err) {
        console.error("Error loading feedback stats:", err);
      }

      if (fbTotalEl) fbTotalEl.textContent = totalFeedback;
      if (fbRecentEl)
        fbRecentEl.textContent = `${feedbackLast7} in last 7 days`;

      // ----- Charts -----
      const payCanvas = document.getElementById("paymentsChart");
      if (payCanvas) {
        const payCtx = payCanvas.getContext("2d");
        const payGradient = payCtx.createLinearGradient(0, 0, 0, 220);
        payGradient.addColorStop(0, "rgba(255, 213, 122, 1)");
        payGradient.addColorStop(1, "rgba(192, 147, 60, 1)");

        new Chart(payCtx, {
          type: "bar",
          data: {
            labels: monthLabels,
            datasets: [
              {
                label: "Total Paid (‚Ç±)",
                data: monthLabels.map((m) => monthlyTotals[m]),
                backgroundColor: payGradient,
                borderRadius: 4,
                maxBarThickness: 32,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.4,
            animation: {
              duration: 900,
              easing: "easeOutCubic",
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    "‚Ç±" +
                    (ctx.parsed.y || 0).toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    }),
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#cccccc" },
              },
              y: {
                beginAtZero: true,
                grid: { color: "rgba(255,255,255,0.06)" },
                ticks: {
                  color: "#cccccc",
                  callback: (value) => "‚Ç±" + value,
                },
              },
            },
          },
        });
      }

      const maintCanvas = document.getElementById("maintenanceChart");
      if (maintCanvas) {
        const maintCtx = maintCanvas.getContext("2d");
        new Chart(maintCtx, {
          type: "doughnut",
          data: {
            labels: ["Pending", "Complete", "Other"],
            datasets: [
              {
                data: [
                  statusCounts.pending,
                  statusCounts.complete,
                  statusCounts.other,
                ],
                backgroundColor: ["#ffb347", "#66bb6a", "#90a4ae"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: "60%",
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 1100,
              easing: "easeOutExpo",
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#f3efe9" },
              },
            },
          },
        });
      }

      const fbCanvas = document.getElementById("feedbackChart");
      if (fbCanvas) {
        const fbCtx = fbCanvas.getContext("2d");
        new Chart(fbCtx, {
          type: "doughnut",
          data: {
            labels: ["5‚òÖ", "4‚òÖ", "3‚òÖ", "2‚òÖ", "1‚òÖ"],
            datasets: [
              {
                data: [
                  ratingCounts[5],
                  ratingCounts[4],
                  ratingCounts[3],
                  ratingCounts[2],
                  ratingCounts[1],
                ],
                backgroundColor: [
                  "#66bb6a",
                  "#9ccc65",
                  "#ffeb3b",
                  "#ffb74d",
                  "#ef5350",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: "55%",
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 1100,
              easing: "easeOutExpo",
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#f3efe9" },
              },
            },
          },
        });
      }

      renderAdminCalendar();

      // KPI drilldown
      const maintCard = document.getElementById("card-maintenance");
      const payCard = document.getElementById("card-payments");
      const fbCard = document.getElementById("card-feedback");

      if (maintCard) {
        maintCard.addEventListener("click", () => {
          window.adminDashboardDrilldown = { maintenanceStatus: "Pending" };
          loadContent("Maintenance Requests");
        });
      }
      if (payCard) {
        payCard.addEventListener("click", () => {
          window.adminDashboardDrilldown = { paymentsFilter: "thisMonth" };
          loadContent("Payment Received");
        });
      }
      if (fbCard) {
        fbCard.addEventListener("click", () => {
          window.adminDashboardDrilldown = { feedbackTab: true };
          loadContent("Feedback Received");
        });
      }
    }

    function renderAdminCalendar() {
      const calendarEl = document.getElementById("adminCalendar");
      if (!calendarEl) return;

      const today = new Date();
      const monthName = today.toLocaleString("default", { month: "long" });
      const year = today.getFullYear();
      const firstDay = new Date(year, today.getMonth(), 1);
      const lastDay = new Date(year, today.getMonth() + 1, 0);
      const startDay = firstDay.getDay();

      let html = "<table class='cal-table'>";
      html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
      html +=
        "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

      for (let i = 0; i < startDay; i++) {
        html += "<td class='cal-empty'></td>";
      }

      for (let day = 1; day <= lastDay.getDate(); day++) {
        const isToday = day === today.getDate();
        html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
        if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) {
          html += "</tr><tr>";
        }
      }

      html += "</tr></table>";
      calendarEl.innerHTML = html;
    }

    // ======================== PAYMENTS RECEIVED LOGIC ========================
    function initPaymentReceived() {
      const paypalList = document.getElementById("paypalList");
      const searchInput = document.getElementById("paymentSearch");
      const sortBy = document.getElementById("sortBy");
      const filterBy = document.getElementById("filterBy");
      const dateFrom = document.getElementById("dateFrom");
      const dateTo = document.getElementById("dateTo");
      const resetFilters = document.getElementById("resetFilters");
      const paymentCount = document.getElementById("paymentCount");
      const totalAmount = document.getElementById("totalAmount");
      const statsDiv = document.getElementById("stats");

      let allPayments = [];
      let filteredPayments = [];

      const drill = window.adminDashboardDrilldown || {};
      if (drill.paymentsFilter) {
        filterBy.value = drill.paymentsFilter;
      }
      window.adminDashboardDrilldown = null;

      function applyFiltersAndSort() {
        const searchValue = searchInput.value.toLowerCase();
        const filterValue = filterBy.value;
        const sortValue = sortBy.value;
        const startVal = dateFrom.value;
        const endVal = dateTo.value;

        filteredPayments = allPayments.filter(
          (p) => p.method === "PayPal"
        );

        if (searchValue) {
          filteredPayments = filteredPayments.filter((p) => {
            const tEmail = (p.tenantEmail || "").toLowerCase();
            const pEmail = (p.payerEmail || "").toLowerCase();
            return (
              tEmail.includes(searchValue) || pEmail.includes(searchValue)
            );
          });
        }

        const now = new Date();
        let startDate = null;
        let endDate = null;

        if (startVal) startDate = new Date(startVal + "T00:00:00");
        if (endVal) endDate = new Date(endVal + "T23:59:59.999");

        if (startDate || endDate) {
          filteredPayments = filteredPayments.filter((p) => {
            const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
            if (!ts) return false;
            if (startDate && ts < startDate) return false;
            if (endDate && ts > endDate) return false;
            return true;
          });
        } else if (filterValue !== "all") {
          filteredPayments = filteredPayments.filter((p) => {
            const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
            if (!ts) return false;
            const diffMs = now - ts;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);
            switch (filterValue) {
              case "last7":
                return diffDays <= 7;
              case "last30":
                return diffDays <= 30;
              case "thisMonth":
                return (
                  ts.getFullYear() === now.getFullYear() &&
                  ts.getMonth() === now.getMonth()
                );
              case "lastMonth": {
                const lastMonthDate = new Date(
                  now.getFullYear(),
                  now.getMonth() - 1,
                  1
                );
                const start = lastMonthDate;
                const end = new Date(
                  now.getFullYear(),
                  now.getMonth(),
                  0,
                  23,
                  59,
                  59,
                  999
                );
                return ts >= start && ts <= end;
              }
              case "thisYear":
                return ts.getFullYear() === now.getFullYear();
              default:
                return true;
            }
          });
        }

        filteredPayments.sort((a, b) => {
          const aDate = a.timestamp?.toDate
            ? a.timestamp.toDate()
            : null;
          const bDate = b.timestamp?.toDate
            ? b.timestamp.toDate()
            : null;

          switch (sortValue) {
            case "date-asc":
              return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
            case "date-desc":
              return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
            case "amount-asc":
              return (Number(a.amount) || 0) - (Number(b.amount) || 0);
            case "amount-desc":
              return (Number(b.amount) || 0) - (Number(a.amount) || 0);
            case "email-asc":
              return (a.tenantEmail || "").localeCompare(
                b.tenantEmail || ""
              );
            case "email-desc":
              return (b.tenantEmail || "").localeCompare(
                a.tenantEmail || ""
              );
            default:
              return 0;
          }
        });

        renderPayments();
      }

      function renderPayments() {
        paypalList.innerHTML = "";

        if (!filteredPayments.length) {
          paypalList.innerHTML =
            "<p>No PayPal payments found matching your criteria.</p>";
          statsDiv.style.display = "none";
          return;
        }

        let total = 0;

        filteredPayments.forEach((p) => {
          const row = document.createElement("div");
          row.className = "payment-row";

          const ts = p.timestamp?.toDate ? p.timestamp.toDate() : null;
          const dateStr = ts ? ts.toLocaleString() : "Unknown date";
          const status = p.status || "Completed";
          const amountNum = Number(p.amount) || 0;

          let statusClass = "badge-muted";
          if (
            status === "Paid" ||
            status === "Approved" ||
            status === "Completed"
          ) {
            statusClass = "badge-success";
            total += amountNum;
          } else if (status === "Pending Verification") {
            statusClass = "badge-warning";
          } else if (status === "Rejected") {
            statusClass = "badge-danger";
          }

          row.innerHTML = `
            <div class="payment-main">
              <div class="payment-email">${p.tenantEmail || "Unknown unit owner"}</div>
              <div class="payment-sub">${p.payerEmail || ""}</div>
            </div>
            <div class="payment-meta">
              <div class="payment-amount">${formatCurrency(p.amount)}</div>
              <div class="payment-meta-row">
                <span class="badge ${statusClass}">${status}</span>
                <span class="payment-method">${p.method || ""}</span>
                <span class="payment-date">${dateStr}</span>
              </div>
            </div>
          `;
          paypalList.appendChild(row);
        });

        paymentCount.textContent = filteredPayments.length;
        totalAmount.textContent = total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        statsDiv.style.display = "block";
      }

      db.collection("payments")
        .orderBy("timestamp", "desc")
        .onSnapshot(
          (snapshot) => {
            allPayments = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            applyFiltersAndSort();
          },
          (error) => {
            paypalList.innerHTML = `<p style="color:red;">Error loading payments: ${error.message}</p>`;
            statsDiv.style.display = "none";
          }
        );

      searchInput.addEventListener("input", applyFiltersAndSort);
      sortBy.addEventListener("change", applyFiltersAndSort);
      filterBy.addEventListener("change", applyFiltersAndSort);
      dateFrom.addEventListener("change", applyFiltersAndSort);
      dateTo.addEventListener("change", applyFiltersAndSort);

      resetFilters.addEventListener("click", () => {
        searchInput.value = "";
        sortBy.value = "date-desc";
        filterBy.value = "all";
        dateFrom.value = "";
        dateTo.value = "";
        applyFiltersAndSort();
      });
    }

    // ======================== MAINTENANCE REQUESTS LOGIC ========================
    function initMaintenanceRequests() {
      const maintenanceList = document.getElementById("maintenanceList");
      const statusFilter = document.getElementById("statusFilter");
      const personnelFilter = document.getElementById("personnelFilter");
      const maintenanceSearch = document.getElementById("maintenanceSearch");
      const sortBy = document.getElementById("sortBy");
      const resetFilters = document.getElementById("resetFilters");
      const maintenanceStats = document.getElementById("maintenanceStats");
      const requestCount = document.getElementById("requestCount");
      const pendingCountEl = document.getElementById("pendingCount");
      const completeCountEl = document.getElementById("completeCount");

      let allRequests = [];
      let filteredRequests = [];
      let assignedPersonnel = new Set();

      const drill = window.adminDashboardDrilldown || {};
      if (drill.maintenanceStatus) {
        statusFilter.value = drill.maintenanceStatus;
      }
      window.adminDashboardDrilldown = null;

      function formatDateTimeAMPM(date) {
        if (!date) return "N/A";
        const d = date.toDate ? date.toDate() : date;
        let hours = d.getHours();
        const minutes = d.getMinutes().toString().padStart(2, "0");
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12;
        const month = (d.getMonth() + 1).toString().padStart(2, "0");
        const day = d.getDate().toString().padStart(2, "0");
        const year = d.getFullYear();
        return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
      }

      function applyFiltersAndSort() {
        const statusValue = statusFilter.value;
        const personnelValue = personnelFilter.value;
        const searchValue = maintenanceSearch.value.toLowerCase();
        const sortValue = sortBy.value;

        filteredRequests = [...allRequests];

        if (statusValue !== "all") {
          filteredRequests = filteredRequests.filter(
            (r) => r.status === statusValue
          );
        }

        if (personnelValue !== "all") {
          if (personnelValue === "unassigned") {
            filteredRequests = filteredRequests.filter(
              (r) => !r.maintenanceName || !r.maintenanceName.trim()
            );
          } else {
            filteredRequests = filteredRequests.filter(
              (r) => r.maintenanceName === personnelValue
            );
          }
        }

        if (searchValue) {
          filteredRequests = filteredRequests.filter((r) => {
            const emailMatch =
              r.tenantEmail &&
              r.tenantEmail.toLowerCase().includes(searchValue);
            const unitMatch =
              r.unitNumber &&
              r.unitNumber.toLowerCase().includes(searchValue);
            const problemMatch =
              r.problem &&
              r.problem.toLowerCase().includes(searchValue);
            const commentMatch =
              r.comment &&
              r.comment.toLowerCase().includes(searchValue);
            return emailMatch || unitMatch || problemMatch || commentMatch;
          });
        }

        filteredRequests.sort((a, b) => {
          const aDate = a.timestamp?.toDate ? a.timestamp.toDate() : null;
          const bDate = b.timestamp?.toDate ? b.timestamp.toDate() : null;
          switch (sortValue) {
            case "date-desc":
              return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
            case "date-asc":
              return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
            case "unit-asc":
              return (a.unitNumber || "").localeCompare(
                b.unitNumber || ""
              );
            case "unit-desc":
              return (b.unitNumber || "").localeCompare(
                a.unitNumber || ""
              );
            case "email-asc":
              return (a.tenantEmail || "").localeCompare(
                b.tenantEmail || ""
              );
            case "email-desc":
              return (b.tenantEmail || "").localeCompare(
                a.tenantEmail || ""
              );
            default:
              return 0;
          }
        });

        renderMaintenanceRequests();
      }

      function renderMaintenanceRequests() {
        if (!filteredRequests.length) {
          maintenanceList.innerHTML =
            "<p>No maintenance requests found matching your criteria.</p>";
          maintenanceStats.style.display = "none";
          return;
        }

        maintenanceList.innerHTML = "";
        assignedPersonnel.clear();

        let pending = 0;
        let complete = 0;

        filteredRequests.forEach((request) => {
          const data = request;
          const id = data.id;

          if (data.status === "Pending") pending++;
          if (data.status === "Complete") complete++;

          const card = document.createElement("div");
          card.className = "maintenance-card";

          const attachmentsHTML =
            data.imageUrls &&
            Array.isArray(data.imageUrls) &&
            data.imageUrls.length > 0
              ? `
              <div style="margin-top:6px;">
                <strong>Attachments:</strong><br/>
                <div class="image-slider" style="position:relative; max-width:200px; margin-top:5px;">
                  <img src="${
                    data.imageUrls[0]
                  }" alt="Attachment" style="width:100%; border-radius:6px;" id="img-${id}" />
                  ${
                    data.imageUrls.length > 1
                      ? `<button class="prev-btn" style="position:absolute; top:50%; left:0; transform:translateY(-50%);
                          background:#8d6c39; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10094;</button>
                        <button class="next-btn" style="position:absolute; top:50%; right:0; transform:translateY(-50%);
                          background:#8d6c39; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">&#10095;</button>`
                      : ""
                  }
                </div>
              </div>`
              : "";

          card.innerHTML = `
            <h3>${data.problem || "Unknown Issue"}</h3>
            <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
              <div style="flex:1; min-width:220px;">
                <p><strong>Unit Owner:</strong> ${data.tenantEmail || "Unknown"}</p>
                <p><strong>Unit Number:</strong> ${data.unitNumber|| "N/A"}</p>
                <p><strong>Details:</strong> ${
                  data.comment || "No additional details."
                }</p>
                <p><strong>Preferred Visit Time:</strong> ${formatDateTimeAMPM(
                  data.preferredVisitTime
                )}</p>
                <p><strong>Status:</strong> ${data.status || "Pending"}</p>
                <p><strong>Maintenance Personnel:</strong> ${
                  data.maintenanceName || "Not assigned"
                }</p>
                <p><strong>Submitted:</strong> ${formatDateTimeAMPM(
                  data.timestamp
                )}</p>
              </div>
              <div style="min-width:220px;">
                ${attachmentsHTML}
              </div>
            </div>
          `;

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "maintenance-card-actions";

          const statusSelect = document.createElement("select");
          ["Pending", "Complete"].forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option;
            opt.textContent = option;
            if (data.status === option) opt.selected = true;
            statusSelect.appendChild(opt);
          });

          const personnelSelect = document.createElement("select");
          const personnelNames = ["John Doe", "Jane Smith", "Mike Johnson"];
          personnelNames.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (
              assignedPersonnel.has(name) &&
              data.maintenanceName !== name &&
              data.status !== "Complete"
            ) {
              opt.disabled = true;
              opt.textContent += " (Assigned)";
            }
            if (data.maintenanceName === name) opt.selected = true;
            personnelSelect.appendChild(opt);
          });

          if (
            data.status !== "Complete" &&
            data.maintenanceName &&
            !assignedPersonnel.has(data.maintenanceName)
          ) {
            assignedPersonnel.add(data.maintenanceName);
          }

          const updateBtn = document.createElement("button");
          updateBtn.textContent = "Update";
          updateBtn.className = "btn-primary";

          if (data.status === "Complete") {
            statusSelect.disabled = true;
            personnelSelect.disabled = true;
            updateBtn.disabled = true;
            updateBtn.style.backgroundColor = "#777";
            updateBtn.style.cursor = "not-allowed";
          }

          updateBtn.addEventListener("click", async () => {
            try {
              await db.collection("maintenanceRequests").doc(id).update({
                status: statusSelect.value,
                maintenanceName: personnelSelect.value.trim(),
                updatedAt:
                  firebase.firestore.FieldValue.serverTimestamp(),
              });
              showPopup("Request updated successfully!");
            } catch (error) {
              showPopup("Error updating request: " + error.message);
            }
          });

          const respondBtn = document.createElement("button");
          respondBtn.textContent = "Respond";
          respondBtn.className = "btn-primary";
          respondBtn.style.background = "#4a90e2";

          const responseContainer = document.createElement("div");
          responseContainer.style.marginTop = "8px";
          responseContainer.style.display = "none";

          const responseTextarea = document.createElement("textarea");
          responseTextarea.placeholder =
            "Enter your response message here...";
          responseTextarea.style.width = "100%";
          responseTextarea.style.height = "60px";
          responseTextarea.style.marginBottom = "8px";
          responseTextarea.style.resize = "vertical";

          const sendResponseBtn = document.createElement("button");
          sendResponseBtn.textContent = "Send Response";
          sendResponseBtn.className = "btn-primary";
          sendResponseBtn.style.background = "#4a90e2";

          responseContainer.appendChild(responseTextarea);
          responseContainer.appendChild(sendResponseBtn);

          respondBtn.addEventListener("click", () => {
            responseContainer.style.display =
              responseContainer.style.display === "none"
                ? "block"
                : "none";
            if (responseContainer.style.display === "block") {
              responseTextarea.focus();
            }
          });

          sendResponseBtn.addEventListener("click", async () => {
            const msg = responseTextarea.value.trim();
            if (!msg) {
              showPopup("Response message cannot be empty.");
              return;
            }
            try {
              const requestDocRef = db
                .collection("maintenanceRequests")
                .doc(id);
              await requestDocRef.collection("responses").add({
                adminEmail: auth.currentUser.email,
                message: msg,
                timestamp:
                  firebase.firestore.FieldValue.serverTimestamp(),
              });
              await requestDocRef.update({
                responseTime:
                  firebase.firestore.FieldValue.serverTimestamp(),
              });
              showPopup("Response sent successfully!");
              responseTextarea.value = "";
              responseContainer.style.display = "none";
            } catch (error) {
              showPopup("Failed to send response: " + error.message);
            }
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.className = "btn-danger";

          deleteBtn.addEventListener("click", () => {
            showPopup(`
              <strong>Are you sure?</strong><br>
              This maintenance request will be permanently deleted.<br><br>
              <button id="confirmDeleteBtn" style="padding:6px 12px;background:#d9534f;color:white;border:none;border-radius:6px;margin-right:10px;">
                Delete
              </button>
              <button onclick="closePopup()" style="padding:6px 12px;background:#777;color:white;border:none;border-radius:6px;">
                Cancel
              </button>
            `);

            setTimeout(() => {
              const confirmBtn =
                document.getElementById("confirmDeleteBtn");
              if (!confirmBtn) return;
              confirmBtn.addEventListener("click", async () => {
                try {
                  await db.collection("maintenanceRequests")
                    .doc(id)
                    .delete();
                  closePopup();
                  showPopup("Maintenance request deleted.");
                } catch (error) {
                  closePopup();
                  showPopup("Failed to delete: " + error.message);
                }
              });
            }, 50);
          });

          actionsDiv.appendChild(statusSelect);
          actionsDiv.appendChild(personnelSelect);
          actionsDiv.appendChild(updateBtn);
          actionsDiv.appendChild(respondBtn);
          actionsDiv.appendChild(deleteBtn);

          card.appendChild(actionsDiv);
          card.appendChild(responseContainer);

          const responsesContainer = document.createElement("div");
          responsesContainer.style.marginTop = "10px";
          responsesContainer.style.borderTop = "1px dashed #555";
          responsesContainer.style.paddingTop = "6px";
          responsesContainer.innerHTML =
            "<strong>Response History:</strong><p>Loading...</p>";

          card.appendChild(responsesContainer);

          db.collection("maintenanceRequests")
            .doc(id)
            .collection("responses")
            .orderBy("timestamp", "asc")
            .onSnapshot((snapshotResp) => {
              responsesContainer.innerHTML =
                "<strong>Response History:</strong>";
              if (snapshotResp.empty) {
                responsesContainer.innerHTML +=
                  "<p>No responses yet.</p>";
              } else {
                snapshotResp.forEach((r) => {
                  const rData = r.data();
                  const rEl = document.createElement("div");
                  rEl.style.borderBottom = "1px solid #444";
                  rEl.style.padding = "4px 0";
                  rEl.innerHTML = `
                    <strong>${rData.adminEmail || data.tenantEmail}:</strong> ${
                    rData.message || ""
                  }<br>
                    <small style="color:#bdbdbd;">${formatDateTimeAMPM(
                      rData.timestamp
                    )}</small>
                  `;
                  responsesContainer.appendChild(rEl);
                });
              }
            });

          maintenanceList.appendChild(card);

          // image slider
          if (
            data.imageUrls &&
            Array.isArray(data.imageUrls) &&
            data.imageUrls.length > 1
          ) {
            let currentIndex = 0;
            const imgEl = card.querySelector(`#img-${id}`);
            const prevBtn = card.querySelector(".prev-btn");
            const nextBtn = card.querySelector(".next-btn");

            prevBtn.addEventListener("click", () => {
              currentIndex =
                (currentIndex - 1 + data.imageUrls.length) %
                data.imageUrls.length;
              imgEl.src = data.imageUrls[currentIndex];
            });

            nextBtn.addEventListener("click", () => {
              currentIndex =
                (currentIndex + 1) % data.imageUrls.length;
              imgEl.src = data.imageUrls[currentIndex];
            });
          }
        });

        requestCount.textContent = filteredRequests.length;
        pendingCountEl.textContent = pending;
        completeCountEl.textContent = complete;
        maintenanceStats.style.display = "block";
      }

      db.collection("maintenanceRequests")
        .orderBy("timestamp", "desc")
        .onSnapshot(
          (snapshot) => {
            if (snapshot.empty) {
              allRequests = [];
              filteredRequests = [];
              maintenanceList.innerHTML =
                "<p>No maintenance requests found.</p>";
              maintenanceStats.style.display = "none";
              return;
            }
            allRequests = snapshot.docs.map((docSnap) => ({
              id: docSnap.id,
              ...docSnap.data(),
            }));
            applyFiltersAndSort();
          },
          (error) => {
            maintenanceList.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
          }
        );

      statusFilter.addEventListener("change", applyFiltersAndSort);
      personnelFilter.addEventListener("change", applyFiltersAndSort);
      maintenanceSearch.addEventListener("input", applyFiltersAndSort);
      sortBy.addEventListener("change", applyFiltersAndSort);
      resetFilters.addEventListener("click", () => {
        statusFilter.value = "all";
        personnelFilter.value = "all";
        maintenanceSearch.value = "";
        sortBy.value = "date-desc";
        applyFiltersAndSort();
      });
    }

    // ======================== UNIT OWNER CREATION LOGIC ========================
    function initUnitOwnerCreation() {
    const adminEmail = "adminaccount@solano.com";
    const adminPassword = "123456";

    // ‚≠ê EMAILJS INITIALIZATION
    emailjs.init("lqyGatNXQhoDJsu2B");

    // ‚≠ê SEND EMAIL TO TENANT AFTER ACCOUNT CREATION
    async function sendAccountEmail(recipient, email, password, units) {
      try {
        await emailjs.send("service_izx63bb", "template_p7zetfj", {
          to_email: recipient,
          tenant_email: email,
          tenant_password: password,
          unit_numbers: units.join(", "),
          login_link: "https://cjgenon.github.io/SOLANO/LogIn.html"  // <-- add your real login page URL here
        });
        console.log("Email sent successfully");
      } catch (error) {
        console.error("EmailJS Error:", error);
      }
    }

    function generatePassword() {
      const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const lowercase = "abcdefghijklmnopqrstuvwxyz";
      const numbers = "0123456789";

      let password = "";
      password += uppercase[Math.floor(Math.random() * uppercase.length)];
      password += lowercase[Math.floor(Math.random() * lowercase.length)];
      password += numbers[Math.floor(Math.random() * numbers.length)];

      const allChars = uppercase + lowercase + numbers;
      for (let i = 3; i < 8; i++) {
        password += allChars[Math.floor(Math.random() * allChars.length)];
      }

      return password
        .split("")
        .sort(() => Math.random() - 0.5)
        .join("");
    }

    // Master units array generation
    const units = [];
    const unitsPerBuilding = 144;
    const floorsPerBuilding = 8;
    const unitsPerFloor = unitsPerBuilding / floorsPerBuilding; // 18 units per floor

    for (let i = 1; i <= 288; i++) {
      const building = i <= unitsPerBuilding ? 1 : 2;
      const floor = building === 1
        ? Math.ceil(i / unitsPerFloor)
        : Math.ceil((i - unitsPerBuilding) / unitsPerFloor);

      const type = i % 2 === 1 ? "1B" : "2B";

      units.push({ num: i, building, floor, type });
    }

    // Populate unit numbers dropdown excluding occupied units
    function populateUnitNumbers(typeSelect, numberSelect, occupied) {
      numberSelect.innerHTML = '<option value="">-- Select Unit Number --</option>';
      if (!typeSelect.value) return;

      const type = typeSelect.value;
      const currentValue = numberSelect.value;
      let currentStillAvailable = false;

      units.forEach(unit => {
        if (unit.type !== type) return;

        const numStr = unit.num.toString().padStart(3, "0");
        const unitValue = `${type}-${numStr}`;

        if (occupied.includes(unitValue)) return;

        const opt = document.createElement("option");
        opt.value = unitValue;
        opt.textContent = `${numStr} (Bldg ${unit.building} - Floor ${unit.floor})`;
        numberSelect.appendChild(opt);

        if (currentValue === unitValue) {
          currentStillAvailable = true;
        }
      });

      if (currentStillAvailable) {
        numberSelect.value = currentValue;
      }
    }

    // Fetch occupied units from Firestore
    async function getOccupiedUnits() {
      try {
        const usersSnapshot = await db
          .collection("users")
          .where("role", "==", "tenant")
          .get();

        const occupiedUnits = [];
        usersSnapshot.forEach((docSnap) => {
          const userData = docSnap.data();
          if (userData.unitNumbers && Array.isArray(userData.unitNumbers)) {
            occupiedUnits.push(...userData.unitNumbers);
          }
        });
        console.log("Occupied units fetched:", occupiedUnits);
        return occupiedUnits;
      } catch (error) {
        console.error("Error fetching occupied units:", error);
        return [];
      }
    }

    // Load and display list of created unit owners
    async function loadAndDisplayUnitOwners() {
      const ul = document.getElementById("unitOwnersUl");
      ul.innerHTML = "<li>Loading...</li>";
      try {
        const snapshot = await db.collection("users").where("role", "==", "tenant").get();
        if (snapshot.empty) {
          ul.innerHTML = "<li>No unit owners found.</li>";
          return;
        }

        ul.innerHTML = ""; // clear loading

        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement("li");
          li.style.padding = "6px 0";
          li.style.borderBottom = "1px solid #eee";

          const unitsText = data.unitNumbers ? data.unitNumbers.map(unitStr => {
            const numPart = parseInt(unitStr.split("-")[1], 10);
            const unitInfo = units.find(u => u.num === numPart);

            if (unitInfo) {
              return `${unitStr} (Bldg ${unitInfo.building} - Floor ${unitInfo.floor})`;
            } else {
              return unitStr;
            }
          }).join(", ") : "No units assigned";

          li.textContent = `${data.email} ‚Äî Units: ${unitsText}`;

          ul.appendChild(li);
        });

      } catch (error) {
        console.error("Error loading unit owners:", error);
        ul.innerHTML = `<li style="color:red;">Error loading unit owners.</li>`;
      }
    }

    (async () => {
      let occupiedUnits = await getOccupiedUnits();

      const passwordInput = document.getElementById("tenantPassword");
      const generateBtn = document.getElementById("generatePasswordBtn");
      const form = document.getElementById("createTenantForm");
      const unitContainer = document.getElementById("unitContainer");
      const addUnitBtn = document.getElementById("addUnitBtn");

      generateBtn.addEventListener("click", () => {
        const newPassword = generatePassword();
        passwordInput.value = newPassword;
        passwordInput.style.background = "#e8f5e8";
        passwordInput.style.border = "1px solid #4CAF50";
        setTimeout(() => {
          passwordInput.style.background = "#222";
          passwordInput.style.border = "1px solid rgba(255,255,255,0.18)";
        }, 3000);
      });

      const firstType = document.querySelector(".unitType");
      const firstNumber = document.querySelector(".unitNumber");
      firstType.addEventListener("change", () =>
        populateUnitNumbers(firstType, firstNumber, occupiedUnits)
      );

      addUnitBtn.addEventListener("click", () => {
        const row = document.createElement("div");
        row.classList.add("unit-row");
        row.style = "display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;";
        row.innerHTML = `
          <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
            <option value="">-- Select Type --</option>
            <option value="1B">1B (1 Bedroom)</option>
            <option value="2B">2B (2 Bedroom)</option>
          </select>
          <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
            <option value="">-- Select Unit Number --</option>
          </select>
          <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">X</button>
        `;
        unitContainer.appendChild(row);

        const tSelect = row.querySelector(".unitType");
        const nSelect = row.querySelector(".unitNumber");
        tSelect.addEventListener("change", () =>
          populateUnitNumbers(tSelect, nSelect, occupiedUnits)
        );

        row.querySelector(".removeUnitBtn").addEventListener("click", function () {
          if (document.querySelectorAll(".unit-row").length > 1) {
            row.remove();
          }
        });
      });

      // Initial remove button event for first unit row
      document.querySelector(".removeUnitBtn").addEventListener("click", function () {
        if (document.querySelectorAll(".unit-row").length > 1) {
          this.parentElement.remove();
        }
      });

      // Load and display existing unit owners at startup
      await loadAndDisplayUnitOwners();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("tenantEmail").value;
        const password = passwordInput.value;
        const unitNumbers = Array.from(document.querySelectorAll(".unitNumber"))
          .map((i) => i.value)
          .filter((v) => v !== "");

        const occupiedSet = new Set(occupiedUnits);
        const occupiedSelections = unitNumbers.filter((u) => occupiedSet.has(u));
        if (occupiedSelections.length > 0) {
          showPopup(
            `Error: The following units are already occupied: ${occupiedSelections.join(
              ", "
            )}. Please select different units.`
          );
          return;
        }

        try {
          const userCredential =
            await auth.createUserWithEmailAndPassword(
              email,
              password
            );
          const user = userCredential.user;

          await db.collection("users").doc(user.uid).set({
            email,
            role: "tenant",
            unitNumbers,
            mustChangePassword: true,
            createdAt:
              firebase.firestore.FieldValue.serverTimestamp(),
          });

          // Build detailed unit numbers with building and floor info for email
          const unitsWithDetails = unitNumbers.map(unitStr => {
            const numPart = parseInt(unitStr.split("-")[1], 10);
            const unitInfo = units.find(u => u.num === numPart);

            if (unitInfo) {
              return `${unitStr} (Bldg ${unitInfo.building} - Floor ${unitInfo.floor})`;
            } else {
              return unitStr;
            }
          });

          // ‚≠ê SEND EMAIL AFTER ACCOUNT CREATION
          await sendAccountEmail(email, email, password, unitsWithDetails);

          occupiedUnits.push(...unitNumbers);

          await auth.signInWithEmailAndPassword(
            adminEmail,
            adminPassword
          );

          showPopup(
            "Unit Owner created successfully! Temporary password: " +
            password
          );

          form.reset();
          passwordInput.value = "";
          passwordInput.style.background = "#222";
          passwordInput.style.border =
            "1px solid rgba(255,255,255,0.18)";

          unitContainer.innerHTML = `
            <div class="unit-row" style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
              <select class="unitType" required style="padding:8px; flex:1; min-width:140px;">
                <option value="">-- Select Type --</option>
                <option value="1B">1B (1 Bedroom)</option>
                <option value="2B">2B (2 Bedroom)</option>
              </select>
              <select class="unitNumber" required style="padding:8px; flex:1; min-width:140px;">
                <option value="">-- Select Unit Number --</option>
              </select>
              <button type="button" class="removeUnitBtn" style="padding:8px 10px; background:#b33a3a; color:white; border:none; border-radius:6px;">X</button>
            </div>
          `;

          const newFirstType = document.querySelector(".unitType");
          const newFirstNumber = document.querySelector(".unitNumber");
          newFirstType.addEventListener("change", () =>
            populateUnitNumbers(
              newFirstType,
              newFirstNumber,
              occupiedUnits
            )
          );

          document
            .querySelector(".removeUnitBtn")
            .addEventListener("click", function () {
              if (
                document.querySelectorAll(".unit-row").length > 1
              ) {
                this.parentElement.remove();
              }
            });

          // Update the unit owners list display after adding a new user
          await loadAndDisplayUnitOwners();

        } catch (error) {
          showPopup("Error: " + error.message);
        }
      });
    })();
  }

    // ======================== FEEDBACK RECEIVED LOGIC ========================
    function initFeedbackReceived() {
      let allFeedback = [];
      let filteredFeedback = [];

      const ratingFilter = document.getElementById("ratingFilter");
      const feedbackSearch = document.getElementById("feedbackSearch");
      const sortBy = document.getElementById("sortBy");
      const resetFilters = document.getElementById("resetFilters");
      const refreshBtn = document.getElementById("refreshFeedbackBtn");
      const feedbackStats = document.getElementById("feedbackStats");
      const feedbackCount = document.getElementById("feedbackCount");
      const averageRating = document.getElementById("averageRating");
      const feedbackList = document.getElementById("feedback-list");

      async function loadFeedbacks() {
        feedbackList.innerHTML = "<p>Loading feedback...</p>";
        try {
          const snapshot = await db
            .collection("feedback")
            .orderBy("timestamp", "desc")
            .get();

          if (snapshot.empty) {
            allFeedback = [];
            filteredFeedback = [];
            feedbackList.innerHTML = "<p>No feedback found.</p>";
            feedbackStats.style.display = "none";
            return;
          }

          allFeedback = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data(),
          }));

          applyFiltersAndSort();
        } catch (error) {
          feedbackList.innerHTML = `<p style="color:red;">Error loading feedback: ${error.message}</p>`;
        }
      }

      function applyFiltersAndSort() {
        const ratingValue = ratingFilter.value;
        const searchValue = feedbackSearch.value.toLowerCase();
        const sortValue = sortBy.value;

        filteredFeedback = [...allFeedback];

        if (ratingValue !== "all") {
          filteredFeedback = filteredFeedback.filter(
            (f) => String(f.rating) === ratingValue
          );
        }

        if (searchValue) {
          filteredFeedback = filteredFeedback.filter((f) => {
            const emailMatch =
              f.tenantEmail &&
              f.tenantEmail.toLowerCase().includes(searchValue);

            const textFields = [
              f.q1,
              f.q2,
              f.q3,
              f.q4,
              f.q5,
              f.q6,
              f.question2,
              f.question3,
            ]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();

            return (
              emailMatch || textFields.includes(searchValue)
            );
          });
        }

        filteredFeedback.sort((a, b) => {
          const aDate = a.timestamp?.toDate ? a.timestamp.toDate() : null;
          const bDate = b.timestamp?.toDate ? b.timestamp.toDate() : null;

          switch (sortValue) {
            case "date-desc":
              return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
            case "date-asc":
              return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
            case "rating-desc":
              return (b.rating || 0) - (a.rating || 0);
            case "rating-asc":
              return (a.rating || 0) - (b.rating || 0);
            case "email-asc":
              return (a.tenantEmail || "").localeCompare(
                b.tenantEmail || ""
              );
            case "email-desc":
              return (b.tenantEmail || "").localeCompare(
                a.tenantEmail || ""
              );
            default:
              return 0;
          }
        });

        renderFeedbacks();
      }

      function renderFeedbacks() {
        if (!filteredFeedback.length) {
          feedbackList.innerHTML =
            "<p>No feedback found matching your criteria.</p>";
          feedbackStats.style.display = "none";
          return;
        }

        feedbackList.innerHTML = "";
        let totalRating = 0;

        filteredFeedback.forEach((f) => {
          const ts = f.timestamp?.toDate
            ? f.timestamp.toDate()
            : f.timestamp?.seconds
            ? new Date(f.timestamp.seconds * 1000)
            : null;
          const timeText = ts ? ts.toLocaleString() : "Unknown time";

          const rating = Number(f.rating) || 0;
          totalRating += rating;
          const stars = "‚≠ê".repeat(rating);
          const empty = "‚òÜ".repeat(5 - rating);

          const wrapper = document.createElement("div");
          wrapper.className = "feedback-item";

          // handle new schema q1‚Äìq6 or old question2/3
          const hasNewSchema =
            f.q1 || f.q2 || f.q3 || f.q4 || f.q5 || f.q6;

          let questionsHtml = "";

          if (hasNewSchema) {
            questionsHtml += `
              <div class="feedback-question">
                <strong>Overall condition and appearance of the property</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q1 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Maintenance services (unit, hallway, garden)</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q2 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Professionalism of property management staff</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q3 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Ease of paying monthly dues / rent</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q4 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Amenities (gym, pool, clubhouse)</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q5 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>Additional suggestions</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.q6 || "No suggestions provided"
                )}</div>
              </div>
            `;
          } else {
            questionsHtml += `
              <div class="feedback-question">
                <strong>What do you like about our services, unit, and facilities?</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.question2 || "No answer provided"
                )}</div>
              </div>
              <div class="feedback-question">
                <strong>What can we improve in our unit, services, or facilities?</strong>
                <div class="feedback-answer">${escapeHtml(
                  f.question3 || "No answer provided"
                )}</div>
              </div>
            `;
          }

          wrapper.innerHTML = `
            <div class="feedback-item-header">
              <div>
                <div class="feedback-email">${
                  f.tenantEmail || "Unknown User"
                }</div>
                <div class="feedback-rating">
                  ${stars}${empty}
                  <span class="meta">(${rating}/5)</span>
                </div>
              </div>
              <div class="feedback-time">${timeText}</div>
            </div>
            ${questionsHtml}
          `;

          feedbackList.appendChild(wrapper);
        });

        const avg =
          filteredFeedback.length > 0
            ? (totalRating / filteredFeedback.length).toFixed(1)
            : "0.0";
        feedbackCount.textContent = filteredFeedback.length;
        averageRating.textContent = avg;
        feedbackStats.style.display = "block";
      }

      ratingFilter.addEventListener("change", applyFiltersAndSort);
      feedbackSearch.addEventListener("input", applyFiltersAndSort);
      sortBy.addEventListener("change", applyFiltersAndSort);
      resetFilters.addEventListener("click", () => {
        ratingFilter.value = "all";
        feedbackSearch.value = "";
        sortBy.value = "date-desc";
        applyFiltersAndSort();
      });
      refreshBtn.addEventListener("click", loadFeedbacks);

      loadFeedbacks();
    }

    // ======================== HELPERS ========================
    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    window.showPopup = function (message) {
      document.getElementById("popupMessage").innerHTML = message;
      document.getElementById("customPopup").classList.remove("hidden");
    };

    window.closePopup = function () {
      document.getElementById("customPopup").classList.add("hidden");
    };

    window.onload = function () {
      loadContent("dashboard");
    };
  </script>

  <!-- ======================== POPUP ======================== -->
  <div id="customPopup" class="popup hidden">
    <div class="popup-content">
      <p id="popupMessage">Your message goes here</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>
</body>
</html>
