<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Your Personalized Mortgage Calculator | PHINMA Properties</title>
<link rel="stylesheet" href="Mortage_Calc.css" />

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>

<body>

<div class="email-container">
    <div class="header">
        <div class="logo">PHINMA PROPERTIES</div>
        <h1>Your Personalized Mortgage Calculator</h1>
        <p>Calculate your investment in Solano Hillside Residences</p>
    </div>

    <div class="content">
        <div class="intro">
            <h2>Hello! üëã</h2>
            <p>Thank you for your interest in Solano Hillside Residences. Use this interactive calculator to see how affordable your dream home can be. Adjust the sliders to customize based on your budget.</p>
        </div>

        <div class="calculator-section">
            <h3 class="section-title">Customize Your Investment</h3>

            <div class="input-group">

                <!-- Added Unit Type selector -->
                <div class="input-row">
                    <div class="input-label">Unit Type</div>
                    <div class="input-controls">
                        <select id="unitType" class="number-input" style="width:auto; text-align:left;">
                            <option value="1br" selected>1 Bedroom</option>
                            <option value="2br">2 Bedroom</option>
                        </select>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Property Price</div>
                    <div class="input-controls">
                        <span style="font-weight: 600; color: #cfa85b;">‚Ç±</span>
                        <input type="number" id="propertyPrice" class="number-input" value="386900" readonly>
                        <input type="range" id="propertyPriceSlider" class="slider" min="386900" max="773800" step="386900" value="386900" disabled>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Your Downpayment</div>
                    <div class="input-controls">
                        <input type="number" id="downpaymentPercent" class="number-input" value="10" min="10" max="100" step="1" />
                        <span style="font-weight: 600; color: #cfa85b;">%</span>
                        <input type="range" id="downpaymentSlider" class="slider" min="10" max="100" step="1" value="10" />
                        <span id="downpaymentAmountLabel" class="inline-amount">‚Ç± 0</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Loan Term</div>
                    <div class="input-controls">
                        <input type="number" id="loanTerm" class="number-input" value="25" min="5" max="30" step="1" />
                        <span style="font-weight: 600; color: #cfa85b;">years</span>
                        <input type="range" id="loanTermSlider" class="slider" min="5" max="30" step="1" value="25" />
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">Interest Rate</div>
                    <div class="input-controls">
                        <input type="number" id="interestRate" class="number-input" value="6.5" min="0" max="15" step="0.1" />
                        <span style="font-weight: 600; color: #cfa85b;">%</span>
                        <input type="range" id="interestRateSlider" class="slider" min="0" max="15" step="0.1" value="6.5" />
                    </div>
                </div>

            </div>
        </div>

        <div class="result-section">
            <h3 class="section-title">Your Payment Plan</h3>

            <div class="monthly-payment">
                <div class="payment-label">Estimated Monthly Payment</div>
                <div class="payment-amount" id="monthlyPayment">‚Ç± 14,003</div>
                <div style="color: #666; font-size: 14px; margin-top: 5px;">for <span id="termYears">25</span> years</div>
            </div>

            <div class="breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-label">Property Price</div>
                    <div class="breakdown-value" id="breakdownPrice">‚Ç± 3,868,900</div>
                </div>

                <div class="breakdown-item">
                    <div class="breakdown-label">Your Downpayment</div>
                    <div class="breakdown-value" id="breakdownDownpayment">‚Ç± 386,890</div>
                </div>

                <div class="breakdown-item">
                    <div class="breakdown-label">Loan Amount</div>
                    <div class="breakdown-value" id="breakdownLoan">‚Ç± 3,482,010</div>
                </div>

                <div class="breakdown-item">
                    <div class="breakdown-label">Total Interest</div>
                    <div class="breakdown-value" id="breakdownInterest">‚Ç± 1,718,083</div>
                </div>
            </div>

            <div class="schedule-preview">
                <div class="schedule-title">First Year Payment Preview</div>
                <table class="schedule-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="cta-section">
            <h3 class="cta-title">Get Your Full Amortization Schedule</h3>
            <p style="margin-bottom: 20px; color: #666;">Enter your email to receive a detailed payment schedule and connect with our property specialist.</p>

            <div class="email-form">
                <input type="email" id="clientEmail" class="email-input" placeholder="Your email address" required />
                <input type="text" id="clientName" class="email-input" placeholder="Your name (optional)" />
                <input type="tel" id="clientPhone" class="email-input" placeholder="Your phone number (optional)" />
                <button class="btn" id="sendScheduleBtn">Submit Computation</button>
            </div>

            <p style="margin-top: 15px; font-size: 14px; color: #666;">Please contact us again through our contact website or visit our site to discuss your options.</p>
        </div>

        <div class="disclaimer">
            <strong>Important Notes:</strong> This calculator provides estimates only. Final loan amounts, interest rates, and terms are subject to bank/HDMF approval based on your financial documents. Prices and promotions are subject to change without prior notice. All computations exclude processing fees, insurance, and other charges.
        </div>
    </div>

    <div class="footer">
        <p>PHINMA PRISM PROPERTY DEVELOPMENT CORPORATION</p>
        <p>Solano Hillside Residences | Finca Tower</p>
        <div class="contact-info">
            <p>üìç Solano, Paranaque | üìû (078) 123-4567 | ‚úâÔ∏è info@phinmaproperties.com</p>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
  authDomain: "solanodb-a4f65.firebaseapp.com",
  projectId: "solanodb-a4f65",
  storageBucket: "solanodb-a4f65.firebasestorage.app",
  messagingSenderId: "98081894649",
  appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= EMAILJS INIT ================= */
(function () {
  emailjs.init("JOQqxoCLq72v5huex");
})();

/* ================= CONSTANTS ================= */
const ONE_BEDROOM_PRICE = 386900;
const TWO_BEDROOM_PRICE = ONE_BEDROOM_PRICE * 2; // 773800
const MIN_DOWNPAYMENT_PERCENT = 10;
const ALLOWED_TERMS = [5, 10, 15, 20, 25, 30];

/* ================= DOM ================= */
const unitTypeSelect = document.getElementById('unitType');

const propertyPriceInput = document.getElementById('propertyPrice');
const propertyPriceSlider = document.getElementById('propertyPriceSlider');
const downpaymentPercentInput = document.getElementById('downpaymentPercent');
const downpaymentSlider = document.getElementById('downpaymentSlider');
const loanTermInput = document.getElementById('loanTerm');
const loanTermSlider = document.getElementById('loanTermSlider');
const interestRateInput = document.getElementById('interestRate');
const interestRateSlider = document.getElementById('interestRateSlider');

const monthlyPaymentEl = document.getElementById('monthlyPayment');
const termYearsEl = document.getElementById('termYears');
const breakdownPriceEl = document.getElementById('breakdownPrice');
const breakdownDownpaymentEl = document.getElementById('breakdownDownpayment');
const breakdownLoanEl = document.getElementById('breakdownLoan');
const breakdownInterestEl = document.getElementById('breakdownInterest');
const previewBody = document.getElementById('previewBody');

const downpaymentAmountLabel = document.getElementById('downpaymentAmountLabel');

const sendScheduleBtn = document.getElementById('sendScheduleBtn');

/* ================= HELPERS ================= */
function formatCurrency(n) {
  return '‚Ç± ' + n.toLocaleString('en-PH');
}

function formatCurrencyDecimal(n) {
  return '‚Ç± ' + n.toLocaleString('en-PH', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function snapToAllowedTerm(value) {
  let closest = ALLOWED_TERMS[0];
  let minDiff = Math.abs(value - closest);
  for (const t of ALLOWED_TERMS) {
    const diff = Math.abs(value - t);
    if (diff < minDiff) {
      minDiff = diff;
      closest = t;
    }
  }
  return closest;
}

/* ================= SYNC INPUTS ================= */
function setupInputSync(input, slider) {
  input.addEventListener('input', () => {
    slider.value = input.value;
    calculate();
  });

  slider.addEventListener('input', () => {
    input.value = slider.value;
    calculate();
  });
}

// For inputs except propertyPrice since that is fixed based on unitType
setupInputSync(downpaymentPercentInput, downpaymentSlider);
setupInputSync(loanTermInput, loanTermSlider);
setupInputSync(interestRateInput, interestRateSlider);

// propertyPrice is readonly + slider disabled; updated from unitType

/* ================= UNIT TYPE HANDLING ================= */
function updatePropertyPriceForUnit() {
  const price = unitTypeSelect.value === '2br'
    ? TWO_BEDROOM_PRICE
    : ONE_BEDROOM_PRICE;

  propertyPriceInput.value = price;
  propertyPriceSlider.value = price;
  calculate();
}

unitTypeSelect.addEventListener('change', updatePropertyPriceForUnit);

/* ================= DOWNPAYMENT INPUT BOUNDS ================= */
downpaymentPercentInput.min = MIN_DOWNPAYMENT_PERCENT;
downpaymentSlider.min = MIN_DOWNPAYMENT_PERCENT;

downpaymentPercentInput.addEventListener('input', () => {
  let val = parseFloat(downpaymentPercentInput.value);
  if (isNaN(val) || val < MIN_DOWNPAYMENT_PERCENT) val = MIN_DOWNPAYMENT_PERCENT;
  if (val > 100) val = 100;
  downpaymentPercentInput.value = val;
  downpaymentSlider.value = val;
  calculate();
});

downpaymentSlider.addEventListener('input', () => {
  let val = parseFloat(downpaymentSlider.value);
  if (isNaN(val) || val < MIN_DOWNPAYMENT_PERCENT) val = MIN_DOWNPAYMENT_PERCENT;
  if (val > 100) val = 100;
  downpaymentPercentInput.value = val;
  calculate();
});

/* ================= LOAN TERM INPUT BOUNDS & SNAP ================= */
loanTermInput.addEventListener('input', () => {
  let val = parseFloat(loanTermInput.value);
  if (isNaN(val)) val = ALLOWED_TERMS[0];
  val = snapToAllowedTerm(val);
  loanTermInput.value = val;
  loanTermSlider.value = val;
  calculate();
});

loanTermSlider.addEventListener('input', () => {
  let val = parseFloat(loanTermSlider.value);
  if (isNaN(val)) val = ALLOWED_TERMS[0];
  val = snapToAllowedTerm(val);
  loanTermSlider.value = val;
  loanTermInput.value = val;
  calculate();
});

/* ================= CALCULATE ================= */
function calculate() {
  const propertyPrice = parseFloat(propertyPriceInput.value);
  let downpaymentPercent = parseFloat(downpaymentPercentInput.value);
  if (isNaN(downpaymentPercent) || downpaymentPercent < MIN_DOWNPAYMENT_PERCENT) {
    downpaymentPercent = MIN_DOWNPAYMENT_PERCENT;
    downpaymentPercentInput.value = downpaymentPercent;
    downpaymentSlider.value = downpaymentPercent;
  }
  const loanTermYears = snapToAllowedTerm(parseFloat(loanTermInput.value));
  loanTermInput.value = loanTermYears;
  loanTermSlider.value = loanTermYears;

  const interestRate = parseFloat(interestRateInput.value) / 100;

  termYearsEl.textContent = loanTermYears;

  const downpaymentAmount = propertyPrice * (downpaymentPercent / 100);
  const loanAmount = propertyPrice - downpaymentAmount;

  const monthlyInterestRate = interestRate / 12;
  const loanTermMonths = loanTermYears * 12;

  let monthlyPayment;
  if (interestRate === 0) {
    monthlyPayment = loanAmount / loanTermMonths;
  } else {
    monthlyPayment =
      loanAmount *
      (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, loanTermMonths)) /
      (Math.pow(1 + monthlyInterestRate, loanTermMonths) - 1);
  }

  const totalPayment = monthlyPayment * loanTermMonths;
  const totalInterest = totalPayment - loanAmount;

  monthlyPaymentEl.textContent = formatCurrencyDecimal(monthlyPayment);
  breakdownPriceEl.textContent = formatCurrency(propertyPrice);
  breakdownDownpaymentEl.textContent = formatCurrency(downpaymentAmount);
  breakdownLoanEl.textContent = formatCurrency(loanAmount);
  breakdownInterestEl.textContent = formatCurrency(totalInterest);

  if (downpaymentAmountLabel) {
    downpaymentAmountLabel.textContent = formatCurrency(downpaymentAmount);
  }

  generateFirstYearPreview(loanAmount, monthlyInterestRate, monthlyPayment);
}

/* ================= AMORT PREVIEW ================= */
function generateFirstYearPreview(loanAmount, monthlyInterestRate, monthlyPayment) {
  previewBody.innerHTML = '';
  let balance = loanAmount;

  for (let month = 1; month <= 12; month++) {
    const interestPayment = balance * monthlyInterestRate;
    const principalPayment = monthlyPayment - interestPayment;
    balance -= principalPayment;

    const row = document.createElement('tr');
    if (month === 1 || month === 12) {
      row.style.backgroundColor = 'rgba(207, 168, 91, 0.12)';
    }

    row.innerHTML = `
      <td>Month ${month}</td>
      <td>${formatCurrencyDecimal(principalPayment)}</td>
      <td>${formatCurrencyDecimal(interestPayment)}</td>
      <td>${formatCurrency(balance)}</td>
    `;

    previewBody.appendChild(row);
  }
}

/* ================= FIREBASE SAVE ================= */
async function saveMortgageCalculation(data) {
  try {
    const docRef = await db.collection('mortgage_calculations').add({
      ...data,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      source: 'mortgage_calculator',
      status: 'new',
    });
    console.log('Mortgage calculation saved with ID:', docRef.id);
    return docRef.id;
  } catch (error) {
    console.error('Error saving mortgage calculation:', error);
    throw error;
  }
}

/* ================= CHECK EXISTING ================= */
async function checkExistingInquiry(email) {
  try {
    const snap = await db
      .collection('inquiries')
      .where('email', '==', email)
      .limit(1)
      .get();

    return !snap.empty;
  } catch (error) {
    console.error('Error checking existing inquiry:', error);
    return false;
  }
}

/* ================= EMAIL SEND ================= */
function sendCalculationEmail_EmailJS(email, name, data) {
  const message = `
Hello ${name || "Client"},

UNIT TYPE: ${unitTypeSelect.value === '2br' ? "2 Bedroom" : "1 Bedroom"}
PROPERTY PRICE: ${formatCurrency(data.propertyPrice)}
DOWNPAYMENT (${data.downpaymentPercent}%): ${formatCurrency(data.downpaymentAmount)}
LOAN AMOUNT: ${formatCurrency(data.loanAmount)}

LOAN TERM: ${data.loanTermYears} years
INTEREST RATE: ${data.interestRate}%

MONTHLY PAYMENT: ${formatCurrencyDecimal(data.monthlyPayment)}
TOTAL INTEREST: ${formatCurrency(data.totalInterest)}
TOTAL PAYMENT: ${formatCurrency(data.totalPayment)}

PHINMA Properties
Solano Hillside Residences
`;

  return emailjs.send("service_hehhqyt", "template_dc67lup", {
    to_email: email,
    client_name: name || "Client",
    message,
  });
}

/* ================= SUBMIT ================= */
sendScheduleBtn.addEventListener('click', async () => {
  const email = document.getElementById('clientEmail').value.trim();
  const name = document.getElementById('clientName').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();

  if (!email || !email.includes('@')) {
    alert('Enter a valid email');
    return;
  }

  calculate();

  const price = parseFloat(propertyPriceInput.value);
  const dpPercent = parseFloat(downpaymentPercentInput.value);
  const downpayment = price * (dpPercent / 100);
  const loanAmount = price - downpayment;
  const monthly = parseFloat(monthlyPaymentEl.textContent.replace(/[‚Ç±,]/g, ''));
  const years = parseFloat(loanTermInput.value);
  const months = years * 12;
  const totalPayment = monthly * months;
  const totalInterest = totalPayment - loanAmount;

  const isExisting = await checkExistingInquiry(email);

  const data = {
    email,
    name: name || 'Not provided',
    phone: phone || 'Not provided',
    unitType: unitTypeSelect.value === '2br' ? '2 Bedroom' : '1 Bedroom',  // added unit type here
    propertyPrice: price,
    downpaymentPercent: dpPercent,
    downpaymentAmount: downpayment,
    loanAmount,
    loanTermYears: years,
    interestRate: parseFloat(interestRateInput.value),
    monthlyPayment: monthly,
    totalInterest,
    totalPayment,
    isExistingClient: isExisting,
  };

  try {
    await saveMortgageCalculation(data);
    await sendCalculationEmail_EmailJS(email, name, data);
    alert('Calculation sent to Project manager and emailed to you successfully!');
  } catch (err) {
    alert('There was an error processing your request. Please try again later.');
  }
});

/* ================= INIT ================= */
updatePropertyPriceForUnit();
calculate();

</script>
</body>
</html>
