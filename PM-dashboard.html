<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Manager Dashboard</title>
  <link rel="stylesheet" href="PM-dasboard.css" />
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" id="showInboxBtn" onclick="loadContent(event, 'inbox')">Inquiries</a></li>
        <li><a href="#" onclick="loadContent(event, 'document')">Document</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="Greeting">Welcome Back!</h1>
      <p>Select a sidebar to start managing.</p>
    </div>
  </main>

  <!-- ======================== EMAILJS SDK ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("avvdJIIs04H8nGyu_");
    })();
  </script>

  <!-- ======================== FIREBASE & INBOX ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc,writeBatch, serverTimestamp, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");

    // ================= CONTENT LOADER =================
    window.loadContent = function (event, section) {
      if(event) event.preventDefault();

      // Remove active class and add to clicked
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => link.classList.remove("active"));
      if (event?.target?.tagName === "A") event.target.classList.add("active");

      mainContent.innerHTML = "";

      switch (section) {
        /* ================= DASHBOARD ================= */
        case "dashboard":
          mainContent.innerHTML = `
            <h1 id="Greeting1">Dashboard</h1>
            <div class="dashboard-container">
              
              <!-- ======== LEFT: WELCOME SLIDER ======== -->
              <div class="welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1"></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2"></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3"></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </div>

              <!-- ======== RIGHT: CALENDAR + INBOX ======== -->
              <div class="right-side">
                <div class="calendar-card">
                  <h3>üìÖ Calendar</h3>
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          `;

          // Image slider logic
          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);

            document.getElementById("sliderPrev").addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document.getElementById("sliderNext").addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(() => showSlidesLocal(++slideIndexLocal), 5000);
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl) sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          })();

          // Calendar logic
          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += "<tr><th class='cal-header' colspan='7'>" + monthName + " " + year + "</th></tr>";
              html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += "<td" + (isToday ? " class='today'" : "") + ">" + day + "</td>";
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) html += "</tr><tr>";
              }

              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();

          break;

        /* ================= INBOX ================= */
case "inbox":
  mainContent.innerHTML = `
    <h3>Inquiries & Mortgage Calculations</h3>
    <div style="margin-bottom: 20px;">
      <button id="toggleViewBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show: All
      </button>
      <button id="showInquiriesBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Inquiries Only
      </button>
      <button id="showCalculationsBtn" style="padding: 8px 16px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Calculations Only
      </button>
    </div>
    
    <!-- Compose Email Panel -->
    <div id="composePanel" style="display: none; background: #786032; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; position: relative; z-index: 100;">
      <h4>Compose Email</h4>
      <input type="email" id="composeEmailTo" placeholder="Recipient Email" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;" />
      <input type="text" id="composeSubject" placeholder="Subject" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;" />
      <textarea id="composeMessage" placeholder="Message" rows="5" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif;"></textarea>
      
      <!-- Pricelist Quick Send Buttons -->
      <div style="margin-bottom: 15px; padding: 10px; background: #fff8e1; border-radius: 6px; border: 1px solid #ffeaa7;">
        <h5 style="margin: 0 0 10px 0; color: #d35400;">Quick Send Pricelist:</h5>
        <div style="display: flex; gap: 10px;">
          <button id="send1BedPricelistBtn" style="padding: 8px 12px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send 1 Bedroom Pricelist
          </button>
          <button id="send2BedPricelistBtn" style="padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send 2 Bedroom Pricelist
          </button>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button id="sendMortgageLinkBtn" style="padding: 8px 12px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send Mortgage Calculator Link
          </button>
        </div>
      </div>
      
      <input type="file" id="composeAttachment" style="margin-bottom: 10px; display: block;" />
      <div style="display: flex; gap: 10px;">
        <button id="sendEmailBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
          Send Email
        </button>
        <button id="closeComposeBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
          Cancel
        </button>
      </div>
      <div id="composeStatus" style="margin-top: 10px; color: green;"></div>
    </div>
    
    <!-- Messages Popup Panel -->
    <div id="messagesPopupPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; width: 80%; max-width: 800px; max-height: 80%; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: #003366; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
          <h3 id="messagesPanelTitle" style="margin: 0; font-size: 18px;">Messages</h3>
          <button id="closeMessagesPanelBtn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        
        <div style="flex: 1; padding: 20px; overflow-y: auto; background: #black;">
          <div id="messagesContainer" style="margin-bottom: 20px;">
            <!-- Messages will be loaded here -->
          </div>
          
          <!-- Reply Section -->
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin-top: 0; color: #003366;">Send Reply</h4>
            <textarea id="replyMessage" placeholder="Type your reply here..." rows="4" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-family: Arial, sans-serif;"></textarea>
            
            <!-- Quick Reply Templates -->
            <div style="margin-bottom: 15px;">
              <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">Quick Replies:</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="quickReplyBtn" data-template="thankyou" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Thank You
                </button>
                <button class="quickReplyBtn" data-template="followup" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Follow Up
                </button>
                <button class="quickReplyBtn" data-template="pricelist" style="padding: 6px 12px; background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Send Pricelist
                </button>
                <button class="quickReplyBtn" data-template="appointment" style="padding: 6px 12px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Schedule Appointment
                </button>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="sendReplyBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Send Reply
              </button>
              <button id="cancelReplyBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Cancel
              </button>
            </div>
            <div id="replyStatus" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="dataContainer">Loading data...</div>
  `;

  const dataContainer = document.getElementById("dataContainer");
  let currentView = 'all'; // 'all', 'inquiries', 'calculations'
  
  // Mortgage Calculator Link
  const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";
  
  // Pricelist templates (keep your existing pricelist templates here)
  const pricelist1Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">1 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 150,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 12,500</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 2,800,000</td></tr>
    <tr><td style="padding:6px 8px;">Payment Terms</td><td style="padding:6px 8px;font-weight:600;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  const pricelist2Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">2 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 200,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 16,800</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600;">‚Ç± 3,800,000</td></tr>
    <tr><td style="padding:6px 8px;">Payment Terms</td><td style="padding:6px 8px;font-weight:600;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  // Helper maps
  const inquiryTopicMap = {
    payment: "Payment / Price",
    interested_1b: "I'm interested in 1 Bedroom unit",
    interested_2b: "I'm interested in 2 Bedroom unit",
    interested_both: "I'm interested in both bedroom unit",
    other: "Other (explain in message)"
  };

  const paymentInfoMap = {
    downpayment: "Downpayment",
    monthly_amortization: "Monthly Amortization",
    total_price: "Total Price",
    payment_terms: "Payment Terms",
    other_payment: "Other (explain in message)"
  };

  // View toggle functionality
  document.getElementById('toggleViewBtn').addEventListener('click', () => {
    currentView = 'all';
    loadData();
  });

  document.getElementById('showInquiriesBtn').addEventListener('click', () => {
    currentView = 'inquiries';
    loadData();
  });

  document.getElementById('showCalculationsBtn').addEventListener('click', () => {
    currentView = 'calculations';
    loadData();
  });

  // EmailJS Send Function
  async function sendEmailJS(email, name, subject, message) {
    try {
      const templateParams = {
        to_email: email,
        to_name: name,
        from_name: "Solano Hills Project Manager",
        subject: subject,
        message: message
      };

      await emailjs.send("service_u1n5d9t", "template_f2fwz7a", templateParams);
      return { success: true };
    } catch (error) {
      console.error("EmailJS Error:", error);
      return { success: false, error: error.message };
    }
  }

  // Setup compose panel event listeners
  function setupComposePanel() {
    const composePanel = document.getElementById('composePanel');
    const closeComposeBtn = document.getElementById('closeComposeBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const send1BedPricelistBtn = document.getElementById('send1BedPricelistBtn');
    const send2BedPricelistBtn = document.getElementById('send2BedPricelistBtn');
    const sendMortgageLinkBtn = document.getElementById('sendMortgageLinkBtn');
    const composeStatus = document.getElementById('composeStatus');

    // Close compose panel
    closeComposeBtn.addEventListener('click', () => {
      composePanel.style.display = 'none';
      composeStatus.textContent = '';
    });

    // Send custom email
    sendEmailBtn.addEventListener('click', async () => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      const subject = document.getElementById('composeSubject').value.trim();
      const message = document.getElementById('composeMessage').value.trim();

      if (!toEmail || !subject || !message) {
        alert('Please fill in all fields: recipient email, subject, and message.');
        return;
      }

      composeStatus.textContent = 'Sending email...';
      composeStatus.style.color = '#003366';

      // Add mortgage calculator link to the end of custom messages
      const enhancedMessage = `${message}<br><br><hr style="border:1px solid #eee;margin:20px 0;">
        <div style="background-color:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #003366;">
          <p style="margin:0 0 10px 0;color:#333;font-weight:bold;">üí° Want to calculate your personalized payments?</p>
          <p style="margin:0 0 10px 0;color:#666;">Use our interactive mortgage calculator to customize your payment plan:</p>
          <a href="${MORTGAGE_CALCULATOR_LINK}" style="color:#003366;font-weight:bold;text-decoration:none;">Open Mortgage Calculator ‚Üí</a>
        </div>`;

      const result = await sendEmailJS(toEmail, 'Client', subject, enhancedMessage);

      if (result.success) {
        composeStatus.textContent = 'Email sent successfully!';
        composeStatus.style.color = 'green';
        
        // Clear and close after 2 seconds
        setTimeout(() => {
          composePanel.style.display = 'none';
          document.getElementById('composeEmailTo').value = '';
          document.getElementById('composeSubject').value = '';
          document.getElementById('composeMessage').value = '';
          composeStatus.textContent = '';
        }, 2000);
      } else {
        composeStatus.textContent = 'Error: ' + result.error;
        composeStatus.style.color = 'red';
      }
    });

    // Send 1 Bedroom Pricelist
    send1BedPricelistBtn.addEventListener('click', async () => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      if (!toEmail) {
        alert('Please enter a recipient email first.');
        return;
      }

      composeStatus.textContent = 'Sending 1 Bedroom Pricelist...';
      composeStatus.style.color = '#003366';

      const result = await sendEmailJS(
        toEmail, 
        'Client', 
        '1 Bedroom Unit Pricelist - Solano Hillside Residences',
        pricelist1Bedroom
      );

      if (result.success) {
        composeStatus.textContent = '1 Bedroom Pricelist sent successfully!';
        composeStatus.style.color = 'green';
        
        setTimeout(() => {
          composePanel.style.display = 'none';
          composeStatus.textContent = '';
        }, 2000);
      } else {
        composeStatus.textContent = 'Error: ' + result.error;
        composeStatus.style.color = 'red';
      }
    });

    // Send 2 Bedroom Pricelist
    send2BedPricelistBtn.addEventListener('click', async () => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      if (!toEmail) {
        alert('Please enter a recipient email first.');
        return;
      }

      composeStatus.textContent = 'Sending 2 Bedroom Pricelist...';
      composeStatus.style.color = '#003366';

      const result = await sendEmailJS(
        toEmail, 
        'Client', 
        '2 Bedroom Unit Pricelist - Solano Hillside Residences',
        pricelist2Bedroom
      );

      if (result.success) {
        composeStatus.textContent = '2 Bedroom Pricelist sent successfully!';
        composeStatus.style.color = 'green';
        
        setTimeout(() => {
          composePanel.style.display = 'none';
          composeStatus.textContent = '';
        }, 2000);
      } else {
        composeStatus.textContent = 'Error: ' + result.error;
        composeStatus.style.color = 'red';
      }
    });

    // Send Mortgage Calculator Link
    sendMortgageLinkBtn.addEventListener('click', async () => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      if (!toEmail) {
        alert('Please enter a recipient email first.');
        return;
      }

      composeStatus.textContent = 'Sending Mortgage Calculator Link...';
      composeStatus.style.color = '#003366';

      const result = await sendEmailJS(
        toEmail, 
        'Client', 
        'Your Personal Mortgage Calculator - Solano Hillside Residences',
        mortgageCalculatorEmail
      );

      if (result.success) {
        composeStatus.textContent = 'Mortgage Calculator link sent successfully!';
        composeStatus.style.color = 'green';
        
        setTimeout(() => {
          composePanel.style.display = 'none';
          composeStatus.textContent = '';
        }, 2000);
      } else {
        composeStatus.textContent = 'Error: ' + result.error;
        composeStatus.style.color = 'red';
      }
    });
  }

  // Setup messages popup panel
  function setupMessagesPanel() {
    const messagesPanel = document.getElementById('messagesPopupPanel');
    const closeMessagesPanelBtn = document.getElementById('closeMessagesPanelBtn');
    const sendReplyBtn = document.getElementById('sendReplyBtn');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');
    const quickReplyBtns = document.querySelectorAll('.quickReplyBtn');
    
    // Close messages panel
    closeMessagesPanelBtn.addEventListener('click', () => {
      messagesPanel.style.display = 'none';
    });
    
    cancelReplyBtn.addEventListener('click', () => {
      document.getElementById('replyMessage').value = '';
    });
    
    // Send reply via EmailJS
  sendReplyBtn.addEventListener('click', async () => {
  const replyMessage = document.getElementById('replyMessage').value.trim();
  const currentInquiryId = messagesPanel.dataset.inquiryId;

  if (!replyMessage) {
    alert('Please enter a reply message.');
    return;
  }

  const replyStatus = document.getElementById('replyStatus');
  replyStatus.textContent = 'Sending reply...';
  replyStatus.style.color = '#003366';

  try {
    // Save reply to the LIVE CHAT messages subcollection
    await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
      sender: "admin",
      senderName: "Project Manager",   // change to your name if you want
      content: replyMessage,
      timestamp: serverTimestamp(),
      readByPM: true,
      readByUser: false
    });

    // (Optional) update inquiry status
    await updateDoc(doc(db, "inquiries", currentInquiryId), {
      status: "responded"
    });

    // Clear reply field
    document.getElementById('replyMessage').value = '';

    // Reload messages in your admin panel (this is your existing function)
    await loadInquiryMessages(currentInquiryId);

    replyStatus.textContent = 'Reply posted to live chat!';
    replyStatus.style.color = 'green';

    setTimeout(() => {
      replyStatus.textContent = '';
    }, 2000);
  } catch (error) {
    replyStatus.textContent = 'Error: ' + error.message;
    replyStatus.style.color = 'red';
  }
});
    // Quick reply templates
    quickReplyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        let message = '';
        
        switch(template) {
          case 'thankyou':
            message = `Thank you for your inquiry about Solano Hillside Residences. We appreciate your interest in our properties and would be happy to assist you further with any questions you may have.`;
            break;
          case 'followup':
            message = `I'm following up on your recent inquiry about our properties. Are you still interested in learning more about our available units or would you like to schedule a site viewing?`;
            break;
          case 'pricelist':
            message = `As requested, here are the price details for our units. I've also attached our full pricelist for your reference in your email. Please let me know if you'd like to discuss financing options or schedule a consultation.`;
            break;
          case 'appointment':
            message = `Would you be available for a site viewing this week? Please let me know your preferred date and time, and I'll arrange everything for you.`;
            break;
        }
        
        document.getElementById('replyMessage').value = message;
      });
    });
    
    // Close panel when clicking outside
    messagesPanel.addEventListener('click', (e) => {
      if (e.target === messagesPanel) {
        messagesPanel.style.display = 'none';
      }
    });
  }

  // Load inquiry messages
  window.viewInquiryMessages = async function(inquiryId) {
    try {
      const messagesPanel = document.getElementById('messagesPopupPanel');
      const messagesContainer = document.getElementById('messagesContainer');
      const panelTitle = document.getElementById('messagesPanelTitle');
      
      // Show loading
      messagesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Loading messages...</div>';
      messagesPanel.style.display = 'flex';
      
      // Load inquiry details
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      if (!inquiryDoc.exists()) {
        messagesContainer.innerHTML = '<div style="color: red;">Inquiry not found</div>';
        return;
      }
      
      const inquiryData = inquiryDoc.data();
      panelTitle.textContent = `Messages with ${inquiryData.name || 'Client'}`;
      
      // Store recipient info for replies
      messagesPanel.dataset.inquiryId = inquiryId;
      messagesPanel.dataset.recipientEmail = inquiryData.email;
      messagesPanel.dataset.recipientName = inquiryData.name || 'Client';
      
      // Load messages
      await loadInquiryMessages(inquiryId);
      
    } catch (error) {
      console.error('Error loading messages:', error);
      document.getElementById('messagesContainer').innerHTML = 
        `<div style="color: red;">Error loading messages: ${error.message}</div>`;
    }
  };

  // Load and display inquiry messages
  async function loadInquiryMessages(inquiryId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    try {
      // Get inquiry details
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      const inquiryData = inquiryDoc.data();
      
      // Get replies
      const repliesSnapshot = await getDocs(
        query(collection(db, "inquiries", inquiryId, "replies"), 
              orderBy("createdAt", "asc"))
      );
      
      let messagesHTML = '';
      
      // Display original inquiry as first message
      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || "No topic selected";
      const paymentInfoText = paymentInfoMap[inquiryData.payment_info] || "";
      const inquiryDate = inquiryData.createdAt?.toDate 
        ? inquiryData.createdAt.toDate().toLocaleString() 
        : 'Not available';
      
      messagesHTML += `
        <div style="margin-bottom: 20px;">
          <div style="background: #cfa85b; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <strong style="color: #2e7d32;">${inquiryData.name || 'Client'}</strong>
              <small style="color: #666;">${inquiryDate}</small>
            </div>
            <div style="margin-bottom: 10px;">
              <strong>Inquiry Topic:</strong> ${inquiryTopicText}<br/>
              ${paymentInfoText ? `<strong>Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
              <strong>Email:</strong> ${inquiryData.email}<br/>
              <strong>Phone:</strong> ${inquiryData.number || 'Not provided'}<br/>
              <strong>Employment:</strong> ${inquiryData.Employement_Type || 'Not provided'}
            </div>
            <div style="background: #8a6f3b; padding: 10px; border-radius: 4px; margin-top: 10px;">
              <strong>Original Message:</strong><br/>
              ${inquiryData.inquiry_topic === 'other' && inquiryData.other_inquiry 
                ? inquiryData.other_inquiry 
                : 'Client expressed interest in our properties.'}
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
              Status: <span style="color: ${inquiryData.status === 'responded' ? '#4CAF50' : '#ff9800'}; font-weight: bold;">
                ${inquiryData.status || 'new'}
              </span>
            </div>
          </div>
        </div>
      `;
      
      // Display replies
      if (!repliesSnapshot.empty) {
        messagesHTML += '<h4 style="color: #003366; margin: 20px 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Replies</h4>';
        
        repliesSnapshot.forEach(doc => {
          const reply = doc.data();
          const replyDate = reply.createdAt?.toDate 
            ? reply.createdAt.toDate().toLocaleString() 
            : 'Not available';
          
          messagesHTML += `
            <div style="margin-bottom: 15px;">
              <div style="background: ${reply.sender === 'admin' ? '#cfa85b' : '#fff3e0'}; 
                         padding: 12px; border-radius: 8px; 
                         border-left: 4px solid ${reply.sender === 'admin' ? '#2196F3' : '#ff9800'};
                         margin-left: ${reply.sender === 'admin' ? '40px' : '0'};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: ${reply.sender === 'admin' ? '#1565c0' : '#ef6c00'}">
                    ${reply.sender === 'admin' ? 'You (Admin)' : inquiryData.name || 'Client'}
                  </strong>
                  <small style="color: #666;">${replyDate}</small>
                </div>
                <div>${reply.message}</div>
                ${reply.emailSent ? '<div style="margin-top: 5px; font-size: 11px; color: #4CAF50;">‚úì Sent via email</div>' : ''}
              </div>
            </div>
          `;
        });
      } else {
        messagesHTML += `
          <div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">
            No replies yet. Send the first reply to this inquiry.
          </div>
        `;
      }
      
      messagesContainer.innerHTML = messagesHTML;
      
      // Scroll to bottom of messages
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
    } catch (error) {
      messagesContainer.innerHTML = `
        <div style="color: red; padding: 20px; text-align: center;">
          Error loading messages: ${error.message}
        </div>
      `;
    }
  }

  // Load all data (inquiries + mortgage calculations)
  async function loadData() {
    try {
      dataContainer.innerHTML = "Loading data...";
      
      // Load inquiries
      const inquiriesSnapshot = await getDocs(query(collection(db, "inquiries"), orderBy("createdAt", "desc")));
      const inquiriesData = [];
      inquiriesSnapshot.forEach(doc => {
        inquiriesData.push({
          id: doc.id,
          type: 'inquiry',
          data: doc.data(),
          createdAt: doc.data().createdAt
        });
      });

      // Load mortgage calculations
      const calculationsSnapshot = await getDocs(query(collection(db, "mortgage_calculations"), orderBy("createdAt", "desc")));
      const calculationsData = [];
      calculationsSnapshot.forEach(doc => {
        calculationsData.push({
          id: doc.id,
          type: 'calculation',
          data: doc.data(),
          createdAt: doc.data().createdAt
        });
      });

      // Combine and sort by date
      const allData = [...inquiriesData, ...calculationsData].sort((a, b) => {
        return b.createdAt?.toMillis() - a.createdAt?.toMillis();
      });

      // Filter based on current view
      let filteredData = allData;
      if (currentView === 'inquiries') {
        filteredData = allData.filter(item => item.type === 'inquiry');
        document.getElementById('toggleViewBtn').textContent = 'Show: Inquiries Only';
      } else if (currentView === 'calculations') {
        filteredData = allData.filter(item => item.type === 'calculation');
        document.getElementById('toggleViewBtn').textContent = 'Show: Calculations Only';
      } else {
        document.getElementById('toggleViewBtn').textContent = 'Show: All';
      }

      if (filteredData.length === 0) {
        dataContainer.innerHTML = `<p>No ${currentView === 'all' ? 'data' : currentView} yet.</p>`;
        return;
      }

      dataContainer.innerHTML = "";

      // Create a map to group by email
      const emailGroups = {};
      
      filteredData.forEach(item => {
        const email = item.data.email;
        if (!emailGroups[email]) {
          emailGroups[email] = {
            email: email,
            name: item.data.name || 'Not provided',
            inquiries: [],
            calculations: []
          };
        }
        
        if (item.type === 'inquiry') {
          emailGroups[email].inquiries.push(item);
        } else if (item.type === 'calculation') {
          emailGroups[email].calculations.push(item);
        }
      });

      // Display grouped by email
      Object.values(emailGroups).forEach(group => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'email-group';
        groupDiv.style = 'border: 2px solid #cfa85b; padding: 15px; margin-bottom: 20px; border-radius: 8px; background-color: #black;';
        
        let groupHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <strong style="color: #White; font-size: 16px;">${group.name}</strong><br/>
              <strong>Email:</strong> ${group.email}<br/>
            </div>
            <div style="text-align: right;">
              <span class="badge" style="background-color: #a57934; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">
                ${group.inquiries.length} Inquiry${group.inquiries.length !== 1 ? 'ies' : ''}
              </span>
              <span class="badge" style="background-color: #2e7d32; color: white; padding: 4px 8px; border-radius: 4px;">
                ${group.calculations.length} Calculation${group.calculations.length !== 1 ? 's' : ''}
              </span>
            </div>
          </div>
        `;

        // Show inquiries for this email
        if (group.inquiries.length > 0) {
          groupHTML += `<h4 style="color: #a57934; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Inquiries</h4>`;
          
          group.inquiries.forEach(inquiry => {
            const inquiryTopicText = inquiryTopicMap[inquiry.data.inquiry_topic] || "No topic selected";
            const paymentInfoText = paymentInfoMap[inquiry.data.payment_info] || "";
            const inquiryDate = inquiry.data.createdAt?.toDate 
              ? inquiry.data.createdAt.toDate().toLocaleString() 
              : 'Not available';
            
            // Check if there are replies
            const hasReplies = inquiry.data.hasReplies || false;
            const statusColor = inquiry.data.status === 'responded' ? '#4CAF50' : 
                              inquiry.data.status === 'pending' ? '#ff9800' : '#f44336';
            
            groupHTML += `
              <div style="background: #362b17; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #a57934;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <strong>Inquiry Topic:</strong> ${inquiryTopicText}<br/>
                    ${paymentInfoText ? `<strong>Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
                    <strong>Date:</strong> ${inquiryDate}<br/>
                    <strong>Status:</strong> 
                    <span style="color: ${statusColor}; font-weight: bold;">
                      ${inquiry.data.status || 'new'}
                      ${hasReplies ? ' (has replies)' : ''}
                    </span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="viewInquiryMessages('${inquiry.id}')" style="padding: 6px 12px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                      ${hasReplies ? 'View Messages' : 'Reply'}
                    </button>
                    <button onclick="sendEmailTo('${inquiry.data.email}', '${inquiry.data.name}', 'inquiry')" style="padding: 6px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                      Send Email
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
        }

        // Show mortgage calculations for this email
        if (group.calculations.length > 0) {
          groupHTML += `<h4 style="color: #2e7d32; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Mortgage Calculations</h4>`;
          
          group.calculations.forEach(calc => {
            const calcData = calc.data;
            const calcSummary = calcData.formatted || {};
            
            groupHTML += `
              <div style="background: #362b17; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #2e7d32;">
                <div style="display: flex; justify-content: space-between;">
                  <div>
                    <strong>Property Price:</strong> ${calcSummary.propertyPrice || formatCurrency(calcData.propertyPrice)}<br/>
                    <strong>Downpayment:</strong> ${calcData.downpaymentPercent}% (${calcSummary.downpayment || formatCurrency(calcData.downpaymentAmount)})<br/>
                    <strong>Loan Amount:</strong> ${calcSummary.loanAmount || formatCurrency(calcData.loanAmount)}<br/>
                  </div>
                  <div>
                    <strong>Monthly Payment:</strong> ${calcSummary.monthlyPayment || formatCurrencyDecimal(calcData.monthlyPayment)}<br/>
                    <strong>Term:</strong> ${calcData.loanTermYears} years @ ${calcData.interestRate}%<br/>
                    <strong>Total Interest:</strong> ${calcSummary.totalInterest || formatCurrency(calcData.totalInterest)}<br/>
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                  <strong>Calculation Date:</strong> ${new Date(calcData.calculationDate).toLocaleString()}<br/>
                  <strong>Phone:</strong> ${calcData.phone || 'Not provided'}<br/>
                  ${calcData.isExistingClient ? '<span style="color: #a57934; font-weight: bold;">‚òÖ Existing Client</span>' : ''}
                </div>
                <div style="margin-top: 10px;">
                  <button onclick="sendCalculationTo('${calcData.email}', '${calcData.name}', '${calc.id}')" style="padding: 6px 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;">
                    Send Amortization
                  </button>
                  <button onclick="deleteCalculation('${calc.id}')" style="padding: 6px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Delete
                  </button>
                </div>
              </div>
            `;
          });
        }

        groupDiv.innerHTML = groupHTML;
        dataContainer.appendChild(groupDiv);
      });

    } catch (error) {
      dataContainer.innerHTML = "Error loading data: " + error.message;
    }
  }

  // Helper function for currency formatting
  function formatCurrency(amount) {
    if (!amount && amount !== 0) return '‚Ç± 0';
    return '‚Ç± ' + amount.toLocaleString('en-PH', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  // Helper function for currency formatting with decimals
  function formatCurrencyDecimal(amount) {
    if (!amount && amount !== 0) return '‚Ç± 0.00';
    return '‚Ç± ' + amount.toLocaleString('en-PH', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  // Send email to client
  window.sendEmailTo = function(email, name, type = 'general') {
    const composePanel = document.getElementById('composePanel');
    const composeEmailTo = document.getElementById('composeEmailTo');
    const composeSubject = document.getElementById('composeSubject');
    
    composeEmailTo.value = email;
    
    if (type === 'inquiry') {
      composeSubject.value = `Regarding your inquiry - ${name}`;
    } else {
      composeSubject.value = `Message from Solano Hills - ${name}`;
    }
    
    composePanel.style.display = 'block';
    
    // Auto-focus on message field
    setTimeout(() => {
      document.getElementById('composeMessage').focus();
    }, 100);
  };

  // Send calculation details to client
  window.sendCalculationTo = async function(email, name, calcId) {
    try {
      const docSnap = await getDoc(doc(db, "mortgage_calculations", calcId));
      if (docSnap.exists()) {
        const calcData = docSnap.data();
        
        // Create email template
        const emailBody = `
Dear ${name},

Thank you for using our mortgage calculator for Solano Hillside Residences.

Here is a summary of your calculation:

PROPERTY DETAILS:
- Property Price: ${formatCurrency(calcData.propertyPrice)}
- Downpayment: ${calcData.downpaymentPercent}% (${formatCurrency(calcData.downpaymentAmount)})
- Loan Amount: ${formatCurrency(calcData.loanAmount)}
- Loan Term: ${calcData.loanTermYears} years
- Interest Rate: ${calcData.interestRate}%

PAYMENT SUMMARY:
- Monthly Payment: ${formatCurrencyDecimal(calcData.monthlyPayment)}
- Total Interest: ${formatCurrency(calcData.totalInterest)}
- Total Payment: ${formatCurrency(calcData.totalPayment)}

üîó Want to adjust these calculations?
You can use our interactive mortgage calculator to explore different scenarios:
${MORTGAGE_CALCULATOR_LINK}

For more information or to proceed with your reservation, please contact our sales team.

Best regards,
PHINMA Properties Team
Solano Hillside Residences
        `;
        
        // Show compose panel with pre-filled email
        const composePanel = document.getElementById('composePanel');
        const composeEmailTo = document.getElementById('composeEmailTo');
        const composeSubject = document.getElementById('composeSubject');
        const composeMessage = document.getElementById('composeMessage');
        
        composeEmailTo.value = email;
        composeSubject.value = `Your Mortgage Calculation - Solano Hillside Residences`;
        composeMessage.value = emailBody;
        composePanel.style.display = 'block';
        
        // Auto-focus on message field
        setTimeout(() => {
          document.getElementById('composeMessage').focus();
        }, 100);
      }
    } catch (error) {
      alert('Error loading calculation: ' + error.message);
    }
  };

  // Delete calculation
  window.deleteCalculation = async function(calcId) {
    if (confirm('Are you sure you want to delete this mortgage calculation?')) {
      try {
        await deleteDoc(doc(db, "mortgage_calculations", calcId));
        alert('Calculation deleted successfully.');
        loadData(); // Refresh the view
      } catch (error) {
        alert('Error deleting calculation: ' + error.message);
      }
    }
  };

  // Initialize panels
  setupComposePanel();
  setupMessagesPanel();

  // Load data initially
  loadData();

  break;
        /* ================= DOCUMENT ================= */
case "document":
  mainContent.innerHTML = `
    <h1>Upload Client Documents</h1>
    <p>Type your name/description, input quantity of required bedroom units, select payment terms, and attach exactly 8 files below:</p>

    <form id="uploadForm" style="display:flex; flex-direction:column; gap:10px; max-width: 400px;">
      <input type="text" id="name" placeholder="Client Name" required style="padding:8px; width: 80%;" />

      <!-- Number of 1 Bedroom units -->
      <label style="font-weight:600;">Number of 1 Bedroom Units:</label>
      <input type="number" id="num1Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Number of 2 Bedroom units -->
      <label style="font-weight:600;">Number of 2 Bedroom Units:</label>
      <input type="number" id="num2Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Payment Terms Dropdown -->
      <label style="font-weight:600;">Select Payment Terms:</label>
      <select id="paymentTerms" required style="padding:8px; width: 80%; margin-bottom:10px;">
        <option value="" disabled selected>-- Select Payment Terms --</option>
        <option value="Monthly">Monthly</option>
        <option value="Cash">Cash</option>
      </select>

      <!-- File inputs -->
      ${[...Array(8)].map((_, i) => `
        <input type="file" id="file${i+1}" required style="padding:8px; width:80%;" />
      `).join('')}

      <button type="submit" style="
        padding: 12px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: fit-content;
      ">Upload</button>
    </form>

    <div id="status" style="margin-top:10px;"></div>
    <h2>Upload History</h2>
    <div id="uploadHistory" style="margin-top:10px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
  `;

  const form = document.getElementById("uploadForm");
  const uploadHistory = document.getElementById("uploadHistory");
  const statusDiv = document.getElementById("status");
  const nameInput = document.getElementById("name");
  const paymentTermsSelect = document.getElementById("paymentTerms");
  const num1BedroomInput = document.getElementById("num1Bedroom");
  const num2BedroomInput = document.getElementById("num2Bedroom");
  const fileInputs = [...Array(8)].map((_, i) => document.getElementById(`file${i+1}`));

  const circumference = 2 * Math.PI * 45;

  function createProgressCircle() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "100");
    svg.setAttribute("height", "100");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.style.flexShrink = "0";

    const bgCircle = document.createElementNS(svgNS, "circle");
    bgCircle.setAttribute("cx", "50");
    bgCircle.setAttribute("cy", "50");
    bgCircle.setAttribute("r", "45");
    bgCircle.setAttribute("stroke", "#eee");
    bgCircle.setAttribute("stroke-width", "10");
    bgCircle.setAttribute("fill", "none");
    svg.appendChild(bgCircle);

    const progressCircle = document.createElementNS(svgNS, "circle");
    progressCircle.setAttribute("cx", "50");
    progressCircle.setAttribute("cy", "50");
    progressCircle.setAttribute("r", "45");
    progressCircle.setAttribute("stroke", "#4CAF50");
    progressCircle.setAttribute("stroke-width", "10");
    progressCircle.setAttribute("fill", "none");
    progressCircle.setAttribute("stroke-linecap", "round");
    progressCircle.setAttribute("stroke-dasharray", circumference);
    progressCircle.setAttribute("stroke-dashoffset", circumference);
    progressCircle.setAttribute("transform", "rotate(-90 50 50)");
    svg.appendChild(progressCircle);

    const progressText = document.createElementNS(svgNS, "text");
    progressText.setAttribute("x", "50");
    progressText.setAttribute("y", "55");
    progressText.setAttribute("font-size", "20");
    progressText.setAttribute("text-anchor", "middle");
    progressText.setAttribute("fill", "white");
    progressText.textContent = "0%";
    svg.appendChild(progressText);

    return { svg, progressCircle, progressText };
  }

  function setCircleProgress(circle, text, percent) {
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    text.textContent = `${Math.round(percent)}%`;
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
    uploadHistory.innerHTML = "";
    if (!history.length) {
      uploadHistory.innerHTML = "<p>No upload history yet.</p>";
      return;
    }

    history.forEach(entry => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ddd";
      div.style.marginBottom = "12px";
      div.style.paddingBottom = "12px";
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.gap = "12px";
      div.style.justifyContent = "space-between";

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `
        <strong>${entry.name}</strong><br/>
        <small><em>1 Bedroom Units: ${entry.num1Bedroom}</em></small><br/>
        <small><em>2 Bedroom Units: ${entry.num2Bedroom}</em></small><br/>
        <small><em>${entry.paymentTerms}</em></small><br/>
        <small><em>Uploaded at ${entry.time}</em></small>
        <ul style="margin: 8px 0 0 20px; padding-left: 0; list-style: disc;">
          ${entry.files.map(f => `<li>${f}</li>`).join("")}
        </ul>
        <p style="margin-top:8px; font-weight:600; color:#2e7d32;">
          The client is ready for account creation.
        </p>
      `;

      const { svg, progressCircle, progressText } = createProgressCircle();
      setCircleProgress(progressCircle, progressText, 100);

      div.appendChild(contentDiv);
      div.appendChild(svg);
      uploadHistory.appendChild(div);
    });
  }

  loadHistory();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const paymentTerms = paymentTermsSelect.value;
    const num1Bedroom = Number(num1BedroomInput.value);
    const num2Bedroom = Number(num2BedroomInput.value);

    if (num1Bedroom < 0 || num2Bedroom < 0) {
      alert("Bedroom unit counts cannot be negative.");
      return;
    }

    if (!paymentTerms) {
      alert("Please select a payment term.");
      return;
    }

    statusDiv.textContent = "Uploading files to Cloudinary...";

    let totalSize = 0;
    const files = fileInputs.map(f => f.files[0]);
    for (let i = 0; i < files.length; i++) {
      if (!files[i]) {
        alert(`Missing file #${i+1}`);
        return;
      }
      totalSize += files[i].size;
    }

    let uploadedSize = 0;
    const uploadedUrls = [];
    const uploadedFileNames = [];

    const tempDiv = document.createElement("div");
    tempDiv.style.display = "flex";
    tempDiv.style.justifyContent = "space-between";
    tempDiv.style.alignItems = "center";
    tempDiv.style.borderBottom = "1px solid #ddd";
    tempDiv.style.paddingBottom = "12px";
    tempDiv.style.marginBottom = "12px";

    const tempContentDiv = document.createElement("div");
    tempContentDiv.innerHTML = `<strong>${name}</strong><br/><small>Uploading...</small>`;
    const { svg, progressCircle, progressText } = createProgressCircle();

    tempDiv.appendChild(tempContentDiv);
    tempDiv.appendChild(svg);
    uploadHistory.prepend(tempDiv);

    // Upload
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "upload_preset");

      try {
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "https://api.cloudinary.com/v1_1/dfklsyjch/upload");

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = ((uploadedSize + event.loaded) / totalSize) * 100;
              setCircleProgress(progressCircle, progressText, percent);
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              const data = JSON.parse(xhr.responseText);
              uploadedUrls.push(data.secure_url);
              uploadedFileNames.push(file.name);
              uploadedSize += file.size;
              resolve();
            } else reject();
          };

          xhr.onerror = () => reject();
          xhr.send(formData);
        });
      } catch {
        statusDiv.textContent = "Upload failed.";
        return;
      }
    }

    statusDiv.textContent = "Sending email...";

    // Prepare email
    const templateParams = {
      name,
      paymentTerms,
      num1Bedroom,
      num2Bedroom,
      time: new Date().toLocaleString(),
      message: `
        <p>1 Bedroom Units: ${num1Bedroom}</p>
        <p>2 Bedroom Units: ${num2Bedroom}</p>
        <p>Payment Terms: ${paymentTerms}</p>
        <p>Files:</p>
        ${uploadedUrls.map((u, i) => `<a href="${u}">${uploadedFileNames[i]}</a>`).join("<br>")}
      `
    };

    try {
      await emailjs.send("service_u1n5d9t", "template_qu1s2lh", templateParams);

      statusDiv.textContent = "Email sent!";
      uploadHistory.removeChild(tempDiv);

      // Save history
      const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
      history.unshift({
        name,
        paymentTerms,
        num1Bedroom,
        num2Bedroom,
        time: new Date().toLocaleString(),
        files: uploadedFileNames
      });

      if (history.length > 10) history.pop();
      localStorage.setItem("uploadHistory", JSON.stringify(history));
      loadHistory();

      form.reset();
    } catch {
      statusDiv.textContent = "Email sending failed.";
    }
  });
  break;

        /* ================= DEFAULT ================= */
        default:
          mainContent.innerHTML = "<h1>Welcome</h1><p>Select an option from the sidebar.</p>";
      }
    };

    // ================= AUTHENTICATION CHECK =================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("You're not signed in. Redirecting to login...");
        window.location.href = "index.html";
        return;
      }
      // Show welcome message
      const greeting = document.getElementById("Greeting");
      const nameToShow = user.displayName || user.email;
      if (greeting) greeting.textContent = `Welcome Back!, ${nameToShow}`;
    });

    // ================= AUTO LOAD DASHBOARD ON PAGE OPEN =================
    window.addEventListener("load", () => {
      loadContent(null, "dashboard");

      // highlight sidebar tab
      document.querySelectorAll(".sidebar nav ul li a").forEach(link =>
        link.classList.remove("active")
      );
      document.querySelector(".sidebar nav ul li a[href='#']").classList.add("active");
    });

    // ================= SHOW REPLY FORM =================
    window.showReplyForm = function (email, id) {
      document.getElementById(`reply-${id}`).style.display = "block";
    };

    // ================= SEND REPLY =================
    window.sendReply = async function (toEmail, id, toName) {
      const replyText = document.getElementById(`replyText-${id}`).value.trim();
      if (!replyText) {
        alert("Please type a reply message.");
        return;
      }

      // Prepare data for backend with correct keys
      const payload = {
        to: toEmail,                  // was toEmail
        from: "your-email@gmail.com", // was fromEmail; replace with your actual sender email
        subject: `Reply from Project Manager to ${toName}`,
        message: replyText
      };

      try {
        const response = await fetch("http://localhost:3000/send-reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply.");
        }

        alert("Reply sent successfully to " + toEmail);

        const messageRef = doc(db, "messages", id);
        await updateDoc(messageRef, { replied: true });

        await addDoc(collection(db, "sentReplies"), {
          to: toEmail,
          message: replyText,
          timestamp: new Date()
        });

        document.getElementById(`reply-${id}`).style.display = "none";
        document.getElementById(`replyText-${id}`).value = "";

        loadContent(null, "inbox");

      } catch (error) {
        console.error("Error sending reply:", error);
        alert("Failed to send reply: " + error.message);
      }
    };


  </script>
</body>
</html>
