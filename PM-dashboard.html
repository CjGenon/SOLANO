<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Manager Dashboard</title>
  <link rel="stylesheet" href="PM-dasboard.css" />
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" id="showInboxBtn" onclick="loadContent(event, 'inbox')">Inquiries</a></li>
        <li><a href="#" onclick="loadContent(event, 'document')">Document</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="Greeting">Welcome Back!</h1>
      <p>Select a sidebar to start managing.</p>
    </div>
  </main>

  <!-- ======================== EMAILJS SDK ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("avvdJIIs04H8nGyu_");
    })();
  </script>

  <!-- ======================== FIREBASE & INBOX ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc,writeBatch, serverTimestamp, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");

    // ================= CONTENT LOADER =================
    window.loadContent = function (event, section) {
      if(event) event.preventDefault();

      // Remove active class and add to clicked
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => link.classList.remove("active"));
      if (event?.target?.tagName === "A") event.target.classList.add("active");

      mainContent.innerHTML = "";

      switch (section) {
        /* ================= DASHBOARD ================= */
        case "dashboard":
          mainContent.innerHTML = `
            <h1 id="Greeting1">Dashboard</h1>
            <div class="dashboard-container">
              
              <!-- ======== LEFT: WELCOME SLIDER ======== -->
              <div class="welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1"></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2"></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3"></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </div>

              <!-- ======== RIGHT: CALENDAR + INBOX ======== -->
              <div class="right-side">
                <div class="calendar-card">
                  <h3>üìÖ Calendar</h3>
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          `;

          // Image slider logic
          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);

            document.getElementById("sliderPrev").addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document.getElementById("sliderNext").addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(() => showSlidesLocal(++slideIndexLocal), 5000);
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl) sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          })();

          // Calendar logic
          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += "<tr><th class='cal-header' colspan='7'>" + monthName + " " + year + "</th></tr>";
              html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += "<td" + (isToday ? " class='today'" : "") + ">" + day + "</td>";
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) html += "</tr><tr>";
              }

              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();

          break;

        /* ================= INBOX ================= */
case "inbox":
  mainContent.innerHTML = `
    <h3 style="color: #003366;">Inquiries & Mortgage Calculations</h3>
    <div style="margin-bottom: 20px;">
      <button id="toggleViewBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show: All
      </button>
      <button id="showInquiriesBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Inquiries Only
      </button>
      <button id="showCalculationsBtn" style="padding: 8px 16px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Calculations Only
      </button>
    </div>
    
    <!-- Compose Email Panel -->
    <div id="composePanel" style="display: none; background: #f8f4e9; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; position: relative; z-index: 100;">
      <h4 style="color: #003366; margin-top: 0;">Compose Email</h4>
      <input type="email" id="composeEmailTo" placeholder="Recipient Email" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background: white; color: #333;" />
      <input type="text" id="composeSubject" placeholder="Subject" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background: white; color: #333;" />
      <textarea id="composeMessage" placeholder="Write your message here..." rows="5" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif; background: white; color: #333; resize: vertical;"></textarea>
      
      <!-- Quick Email Templates -->
      <div style="margin-bottom: 15px; padding: 15px; background: #f0f7ff; border-radius: 6px; border: 1px solid #d4e6f1;">
        <h5 style="margin: 0 0 10px 0; color: #003366; font-size: 14px;">Quick Email Templates:</h5>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="emailTemplateBtn" data-template="thankyou" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Thank You
          </button>
          <button class="emailTemplateBtn" data-template="followup" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Follow Up
          </button>
          <button class="emailTemplateBtn" data-template="pricelist" style="padding: 6px 12px; background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Send Pricelist
          </button>
          <button class="emailTemplateBtn" data-template="appointment" style="padding: 6px 12px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Schedule Appointment
          </button>
          <button class="emailTemplateBtn" data-template="welcome" style="padding: 6px 12px; background: #fff8e1; color: #a57934; border: 1px solid #ffeaa7; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Welcome
          </button>
          <button class="emailTemplateBtn" data-template="confirmation" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.2s;">
            Confirmation
          </button>
        </div>
      </div>
      
      <!-- File Attachment Section with Better UI -->
      <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px dashed #ddd;">
        <h5 style="margin: 0 0 10px 0; color: #003366; font-size: 14px;">Attachments (Optional)</h5>
        
        <!-- Custom File Upload Button -->
        <div style="position: relative;">
          <input type="file" id="composeAttachment" multiple style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;" />
          <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
            <div style="width: 40px; height: 40px; background: #003366; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: white;">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15.01L9.41 16.42L11 14.84V19H13V14.84L14.59 16.43L16 15.01L12.01 11L8 15.01Z" fill="currentColor"/>
              </svg>
            </div>
            <div>
              <div style="font-weight: 500; color: #003366;">Choose files to attach</div>
              <div style="font-size: 12px; color: #666;">Click to browse or drag and drop</div>
            </div>
          </div>
        </div>
        
        <!-- Selected Files Preview -->
        <div id="selectedFiles" style="margin-top: 10px; display: none;">
          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Selected files:</div>
          <div id="fileList" style="max-height: 100px; overflow-y: auto;"></div>
        </div>
      </div>
      
      <!-- Pricelist Quick Send Buttons -->
      <div style="margin-bottom: 15px; padding: 10px; background: #fff8e1; border-radius: 6px; border: 1px solid #ffeaa7;">
        <h5 style="margin: 0 0 10px 0; color: #d35400;">Quick Send Pricelist:</h5>
        <div style="display: flex; gap: 10px;">
          <button id="send1BedPricelistBtn" style="padding: 8px 12px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send 1 Bedroom Pricelist
          </button>
          <button id="send2BedPricelistBtn" style="padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send 2 Bedroom Pricelist
          </button>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button id="sendMortgageLinkBtn" style="padding: 8px 12px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
            Send Mortgage Calculator Link
          </button>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="sendEmailBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
          Send Email
        </button>
        <button id="closeComposeBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1;">
          Cancel
        </button>
      </div>
      <div id="composeStatus" style="margin-top: 10px; color: green;"></div>
    </div>
    
    <!-- Messages Popup Panel -->
    <div id="messagesPopupPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; width: 80%; max-width: 800px; max-height: 80%; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: #003366; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
          <h3 id="messagesPanelTitle" style="margin: 0; font-size: 18px; color: white;">Messages</h3>
          <button id="closeMessagesPanelBtn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        
        <div style="flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5;">
          <div id="messagesContainer" style="margin-bottom: 20px;">
            <!-- Messages will be loaded here -->
          </div>
          
          <!-- Reply Section -->
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin-top: 0; color: #003366;">Send Reply</h4>
            <textarea id="replyMessage" placeholder="Type your reply here..." rows="4" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-family: Arial, sans-serif; background: white; color: #333;"></textarea>
            
            <!-- Quick Reply Templates -->
            <div style="margin-bottom: 15px;">
              <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">Quick Replies:</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="quickReplyBtn" data-template="thankyou" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Thank You
                </button>
                <button class="quickReplyBtn" data-template="followup" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Follow Up
                </button>
                <button class="quickReplyBtn" data-template="pricelist" style="padding: 6px 12px; background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Send Pricelist
                </button>
                <button class="quickReplyBtn" data-template="appointment" style="padding: 6px 12px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Schedule Appointment
                </button>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="sendReplyBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Send Reply
              </button>
              <button id="cancelReplyBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Cancel
              </button>
            </div>
            <div id="replyStatus" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Loading Skeleton -->
    <div id="loadingSkeleton" style="display: none;">
      <div style="margin-bottom: 20px;">
        <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 10px; animation: pulse 1.5s infinite;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div style="width: 150px; height: 20px; background: #ddd; border-radius: 4px;"></div>
            <div style="width: 100px; height: 15px; background: #ddd; border-radius: 4px;"></div>
          </div>
          <div style="width: 100%; height: 60px; background: #ddd; border-radius: 4px;"></div>
        </div>
      </div>
    </div>
    
    <div id="dataContainer"></div>
    
    <style>
      @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .email-group {
        animation: slideIn 0.3s ease-out;
      }
      
      .loading-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      
      .toast-success {
        background-color: #4CAF50;
      }
      
      .toast-error {
        background-color: #f44336;
      }
      
      .toast-info {
        background-color: #2196F3;
      }
      
      .btn-loading {
        position: relative;
        color: transparent !important;
      }
      
      .btn-loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 8px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin-bottom: 4px;
        font-size: 12px;
      }
      
      .file-item:hover {
        background: #f5f5f5;
      }
      
      .remove-file {
        color: #f44336;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 6px;
        border-radius: 3px;
      }
      
      .remove-file:hover {
        background: #ffebee;
      }
      
      /* Custom file upload hover effects */
      #composeAttachment + div:hover {
        border-color: #003366;
        background: #f0f7ff;
      }
      
      #composeAttachment:focus + div {
        border-color: #003366;
        box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
      }
      
      .emailTemplateBtn:hover, .quickReplyBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
    </style>
  `;

  const dataContainer = document.getElementById("dataContainer");
  const loadingSkeleton = document.getElementById("loadingSkeleton");
  let currentView = 'all'; // 'all', 'inquiries', 'calculations'
  
  // Mortgage Calculator Link
  const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";
  
  // ========== EMAIL TEMPLATES ==========
  
  // Email templates for quick replies
  const emailTemplates = {
    thankyou: {
      subject: "Thank You for Your Inquiry - Solano Hillside Residences",
      message: `Dear [Client Name],

Thank you for your interest in Solano Hillside Residences. We appreciate you taking the time to inquire about our properties.

Our team is excited to assist you in finding your dream home. Whether you're looking for investment opportunities or a place to call home, we have options that might suit your needs.

Would you be interested in scheduling a virtual tour or site viewing to see our available units? Please let us know your preferred date and time, and we'll make the necessary arrangements.

In the meantime, feel free to explore our mortgage calculator to get a better understanding of payment options: 
${MORTGAGE_CALCULATOR_LINK}

Looking forward to assisting you further.

Best regards,
Solano Hillside Residences Team
PHINMA Properties`
    },
    
    followup: {
      subject: "Following Up on Your Inquiry - Solano Hillside Residences",
      message: `Dear [Client Name],

I'm following up on your recent inquiry about Solano Hillside Residences. I wanted to check if you had any additional questions or if there's specific information you'd like me to provide.

Our team has been working on some exciting updates, and we have new unit availabilities that might interest you. Would you like me to send you the latest pricelist and floor plans?

Additionally, I can schedule a personalized consultation where we can discuss:
- Available unit types and floor areas
- Payment terms and financing options
- Investment potential and ROI projections
- Site viewing arrangements

Please let me know what works best for your schedule, and I'll be happy to accommodate.

Warm regards,
Solano Hillside Residences Team
PHINMA Properties`
    },
    
    pricelist: {
      subject: "Property Pricelist & Details - Solano Hillside Residences",
      message: `Dear [Client Name],

As requested, here are the current property details and pricing for Solano Hillside Residences:

üìã PROPERTY OVERVIEW:
‚Ä¢ Location: Prime hillside area with panoramic views
‚Ä¢ Unit Types: 1-Bedroom, 2-Bedroom, and 3-Bedroom units
‚Ä¢ Amenities: Clubhouse, swimming pool, gym, function rooms
‚Ä¢ Completion: Phased turnover starting Q4 2024

üè† PRICING DETAILS:
1-Bedroom Units:
‚Ä¢ Floor Area: 24-28 sqm
‚Ä¢ Total Price: ‚Ç±2.8M - ‚Ç±3.2M
‚Ä¢ Downpayment: ‚Ç±150,000 (spot cash)
‚Ä¢ Monthly: ‚Ç±12,500 - ‚Ç±14,000 (24-36 months)

2-Bedroom Units:
‚Ä¢ Floor Area: 36-42 sqm
‚Ä¢ Total Price: ‚Ç±3.8M - ‚Ç±4.2M
‚Ä¢ Downpayment: ‚Ç±200,000 (spot cash)
‚Ä¢ Monthly: ‚Ç±16,800 - ‚Ç±18,500 (24-36 months)

3-Bedroom Units:
‚Ä¢ Floor Area: 48-56 sqm
‚Ä¢ Total Price: ‚Ç±4.8M - ‚Ç±5.4M
‚Ä¢ Downpayment: ‚Ç±250,000 (spot cash)
‚Ä¢ Monthly: ‚Ç±21,000 - ‚Ç±23,500 (24-36 months)

üí° FINANCING OPTIONS:
‚Ä¢ Bank Financing: 80% Loan-to-value ratio
‚Ä¢ In-house: Flexible payment terms
‚Ä¢ Pag-IBIG: Qualified units and buyers

üîó Calculate your personalized payments here: 
${MORTGAGE_CALCULATOR_LINK}

I've also attached our comprehensive brochure with floor plans and amenities. Please let me know if you'd like to discuss specific units or schedule a site viewing.

Best regards,
Solano Hillside Residences Team
PHINMA Properties`
    },
    
    appointment: {
      subject: "Schedule a Site Viewing - Solano Hillside Residences",
      message: `Dear [Client Name],

Thank you for your interest in Solano Hillside Residences. The best way to truly appreciate our properties is to experience them firsthand.

I'd like to invite you for a site viewing where you can:
‚Ä¢ Tour our model units and actual site
‚Ä¢ See the panoramic views and surroundings
‚Ä¢ Check the quality of construction and finishes
‚Ä¢ Discuss available units and locations
‚Ä¢ Get answers to all your questions

üìÖ Available Viewing Slots:
Monday - Friday: 9:00 AM - 5:00 PM
Saturday: 9:00 AM - 4:00 PM
Sunday: By special arrangement

üìç Location: Solano, Nueva Vizcaya
(We can provide directions or arrange transportation if needed)

Please let me know your preferred date and time, and I'll confirm the schedule immediately. If you have specific units you'd like to see, please mention them so I can prepare accordingly.

Looking forward to showing you around!

Warm regards,
Solano Hillside Residences Team
PHINMA Properties`
    },
    
    welcome: {
      subject: "Welcome to Solano Hillside Residences - Your Investment Journey Begins",
      message: `Dear [Client Name],

Welcome to the Solano Hillside Residences family! We're thrilled to have you consider our community for your real estate investment or future home.

As a valued prospective client, you'll receive:
‚Ä¢ Priority updates on new releases and promotions
‚Ä¢ Invitations to exclusive events and webinars
‚Ä¢ Personalized investment consultations
‚Ä¢ Early access to prime unit selections

üè° NEXT STEPS:
1. Review our property details and pricelist
2. Use our mortgage calculator to explore payment options: ${MORTGAGE_CALCULATOR_LINK}
3. Schedule a site viewing or virtual tour
4. Discuss reservation process with our sales team

üíº YOUR DEDICATED ADVISOR:
I'll be your personal point of contact throughout this journey. Feel free to reach out to me directly for:
‚Ä¢ Property information and availability
‚Ä¢ Financing options and payment plans
‚Ä¢ Site viewing arrangements
‚Ä¢ Any questions or concerns

Let's schedule a brief call next week to discuss your goals and how we can help you achieve them. What day and time works best for you?

Welcome aboard!

Sincerely,
Solano Hillside Residences Team
PHINMA Properties`
    },
    
    confirmation: {
      subject: "Meeting Confirmation - Solano Hillside Residences Consultation",
      message: `Dear [Client Name],

This email confirms your scheduled consultation with our Solano Hillside Residences team.

üìÖ APPOINTMENT DETAILS:
Date: [Date]
Time: [Time]
Mode: [In-person/Virtual]
Location/Platform: [Location or Meeting Link]

üë• MEETING AGENDA:
1. Property overview and available units
2. Investment analysis and ROI projections
3. Financing options and payment plans
4. Reservation process and requirements
5. Q&A session

üìã WHAT TO PREPARE:
‚Ä¢ Valid ID (for reservation purposes)
‚Ä¢ Questions about the property or process
‚Ä¢ Preferred unit types and budget range

üìç LOCATION DETAILS:
Solano Hillside Residences Sales Office
[Complete Address]
[Landmarks/Directions]

üí° TIP: You might want to check our mortgage calculator beforehand to have a better idea of payment options: ${MORTGAGE_CALCULATOR_LINK}

If you need to reschedule or have any questions before our meeting, please don't hesitate to contact me.

Looking forward to our discussion!

Best regards,
Solano Hillside Residences Team
PHINMA Properties`
    }
  };

  // Pricelist templates
  const pricelist1Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">1 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 150,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 12,500</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 2,800,000</td></tr>
    <tr><td style="padding:6px 8px; color: #333;">Payment Terms</td><td style="padding:6px 8px;font-weight:600; color: #333;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  const pricelist2Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">2 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 200,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 16,800</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 3,800,000</td></tr>
    <tr><td style="padding:6px 8px; color: #333;">Payment Terms</td><td style="padding:6px 8px;font-weight:600; color: #333;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  const mortgageCalculatorEmail = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h3 style="color:#003366;margin-bottom:15px;font-size:18px;font-weight:600;">Your Personal Mortgage Calculator</h3>
      <p style="color:#333;margin-bottom:20px;font-size:14px;line-height:1.5;">
        Use our interactive mortgage calculator to plan your investment in Solano Hillside Residences:
      </p>
      
      <div style="text-align: center; margin: 25px 0;">
        <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:15px 30px;background-color:#003366;color:white;text-decoration:none;border-radius:8px;font-weight:bold;font-size:16px;">
          üè† Open Mortgage Calculator
        </a>
      </div>
      
      <div style="background:#f8f9fa;padding:20px;border-radius:8px;border-left:4px solid #a57934;margin:20px 0;">
        <h4 style="color:#a57934;margin:0 0 10px 0;font-size:16px;">What You Can Calculate:</h4>
        <ul style="color:#333;margin:0;padding-left:20px;font-size:14px;line-height:1.6;">
          <li>Custom monthly payments based on your budget</li>
          <li>Different downpayment options (10%, 20%, 30%)</li>
          <li>Various loan terms (5, 10, 15, 20 years)</li>
          <li>Total interest payments</li>
          <li>Amortization schedule</li>
        </ul>
      </div>
      
      <p style="color:#666;margin-top:20px;font-size:13px;line-height:1.5;">
        Need assistance? Our financial advisors are ready to help you understand your options.
      </p>
    </div>
  `;

  // Helper maps
  const inquiryTopicMap = {
    payment: "Payment / Price",
    interested_1b: "I'm interested in 1 Bedroom unit",
    interested_2b: "I'm interested in 2 Bedroom unit",
    interested_both: "I'm interested in both bedroom unit",
    other: "Other (explain in message)"
  };

  const paymentInfoMap = {
    downpayment: "Downpayment",
    monthly_amortization: "Monthly Amortization",
    total_price: "Total Price",
    payment_terms: "Payment Terms",
    other_payment: "Other (explain in message)"
  };

  // ========== MODERN UTILITY FUNCTIONS ==========

  // Modern toast notification system
  const Toast = {
    show: (message, type = 'info', duration = 3000) => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
  };

  // Modern loading state management
  const Loading = {
    show: (element, showSkeleton = true) => {
      if (showSkeleton && loadingSkeleton) {
        loadingSkeleton.style.display = 'block';
      }
      if (element) {
        element.classList.add('loading-shimmer');
        element.setAttribute('data-original-content', element.innerHTML);
        element.innerHTML = '<div style="height: 100px;"></div>';
      }
    },
    
    hide: (element, restoreContent = true) => {
      if (loadingSkeleton) {
        loadingSkeleton.style.display = 'none';
      }
      if (element && restoreContent) {
        element.classList.remove('loading-shimmer');
        const originalContent = element.getAttribute('data-original-content');
        if (originalContent) {
          element.innerHTML = originalContent;
        }
      }
    },
    
    button: {
      start: (button, text = 'Processing...') => {
        button.setAttribute('data-original-text', button.textContent);
        button.setAttribute('disabled', 'true');
        button.classList.add('btn-loading');
        button.innerHTML = text;
      },
      
      stop: (button, restoreText = true) => {
        button.removeAttribute('disabled');
        button.classList.remove('btn-loading');
        if (restoreText) {
          const originalText = button.getAttribute('data-original-text');
          if (originalText) {
            button.textContent = originalText;
          }
        }
      }
    }
  };

  // Modern retry mechanism for network operations
  const retryOperation = async (operation, maxRetries = 3, delay = 1000) => {
    for (let i = 0; i < maxRetries; i++) {
      try {
        return await operation();
      } catch (error) {
        if (i === maxRetries - 1) throw error;
        console.log(`Retry ${i + 1}/${maxRetries} after error:`, error.message);
        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
      }
    }
  };

  // File handling utilities
  const FileHandler = {
    formatFileSize: (bytes) => {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },

    getFileIcon: (fileName) => {
      const extension = fileName.split('.').pop().toLowerCase();
      const icons = {
        pdf: 'üìÑ',
        doc: 'üìù',
        docx: 'üìù',
        xls: 'üìä',
        xlsx: 'üìä',
        ppt: 'üìΩÔ∏è',
        pptx: 'üìΩÔ∏è',
        jpg: 'üñºÔ∏è',
        jpeg: 'üñºÔ∏è',
        png: 'üñºÔ∏è',
        gif: 'üñºÔ∏è',
        txt: 'üìÑ',
        zip: 'üóúÔ∏è',
        rar: 'üóúÔ∏è',
      };
      return icons[extension] || 'üìé';
    },

    isValidFile: (file) => {
      const validTypes = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
        'application/pdf', 'application/msword', 
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain',
        'application/zip',
        'application/x-rar-compressed'
      ];
      
      const maxSize = 10 * 1024 * 1024; // 10MB
      
      if (!validTypes.includes(file.type)) {
        Toast.show(`File type not supported: ${file.name}`, 'error');
        return false;
      }
      
      if (file.size > maxSize) {
        Toast.show(`File too large: ${file.name} (max 10MB)`, 'error');
        return false;
      }
      
      return true;
    }
  };

  // ========== MODERN EMAIL FUNCTIONS ==========

  // Modern EmailJS wrapper with better error handling
  const EmailService = {
    send: async (email, name, subject, message, attachments = []) => {
      try {
        const templateParams = {
          to_email: email,
          to_name: name,
          from_name: "Solano Hills Project Manager",
          subject: subject,
          message: message
        };

        // Note: EmailJS doesn't support file attachments directly through the free plan
        // You would need a backend service or EmailJS paid plan for attachments
        // This is a placeholder for future implementation
        if (attachments.length > 0) {
          console.log('Attachments would be processed here:', attachments);
          Toast.show('Note: File attachments require backend setup', 'info');
        }

        const response = await emailjs.send(
          "service_u1n5d9t", 
          "template_f2fwz7a", 
          templateParams
        );
        
        return {
          success: true,
          data: response
        };
      } catch (error) {
        console.error("EmailJS Error:", error);
        return {
          success: false,
          error: error.text || error.message || "Failed to send email"
        };
      }
    },

    // Send custom message WITHOUT calculator link
    sendCustom: async (email, name, subject, message, attachments = []) => {
      // Send exactly what the user typed, no extra content
      return await EmailService.send(email, name, subject, message, attachments);
    },

    // Send with enhanced message formatting (only for pricelist/mortgage calculator)
    sendEnhanced: async (email, name, subject, message) => {
      // This function is only used for pricelist and calculator emails
      return await EmailService.send(email, name, subject, message);
    }
  };

  // ========== VIEW TOGGLE FUNCTIONALITY ==========

  document.getElementById('toggleViewBtn').addEventListener('click', () => {
    currentView = 'all';
    loadData();
  });

  document.getElementById('showInquiriesBtn').addEventListener('click', () => {
    currentView = 'inquiries';
    loadData();
  });

  document.getElementById('showCalculationsBtn').addEventListener('click', () => {
    currentView = 'calculations';
    loadData();
  });

  // ========== MODERN COMPOSE PANEL ==========

  function setupComposePanel() {
    const composePanel = document.getElementById('composePanel');
    const closeComposeBtn = document.getElementById('closeComposeBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const send1BedPricelistBtn = document.getElementById('send1BedPricelistBtn');
    const send2BedPricelistBtn = document.getElementById('send2BedPricelistBtn');
    const sendMortgageLinkBtn = document.getElementById('sendMortgageLinkBtn');
    const composeAttachment = document.getElementById('composeAttachment');
    const selectedFilesContainer = document.getElementById('selectedFiles');
    const fileListContainer = document.getElementById('fileList');
    const composeStatus = document.getElementById('composeStatus');
    const emailTemplateBtns = document.querySelectorAll('.emailTemplateBtn');
    
    let selectedFiles = [];

    // Initialize file attachment UI
    function initFileAttachment() {
      // Handle file selection
      composeAttachment.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        // Validate and add files
        files.forEach(file => {
          if (FileHandler.isValidFile(file)) {
            // Check if file already exists
            const exists = selectedFiles.some(f => 
              f.name === file.name && f.size === file.size
            );
            
            if (!exists) {
              selectedFiles.push(file);
            }
          }
        });
        
        updateFileList();
      });

      // Allow drag and drop
      const fileUploadArea = composeAttachment.parentElement.querySelector('div');
      
      fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#003366';
        fileUploadArea.style.background = '#f0f7ff';
      });

      fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#ccc';
        fileUploadArea.style.background = 'white';
      });

      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#ccc';
        fileUploadArea.style.background = 'white';
        
        const files = Array.from(e.dataTransfer.files);
        
        // Validate and add files
        files.forEach(file => {
          if (FileHandler.isValidFile(file)) {
            // Check if file already exists
            const exists = selectedFiles.some(f => 
              f.name === file.name && f.size === file.size
            );
            
            if (!exists) {
              selectedFiles.push(file);
            }
          }
        });
        
        updateFileList();
      });
    }

    // Update file list display
    function updateFileList() {
      if (selectedFiles.length === 0) {
        selectedFilesContainer.style.display = 'none';
        fileListContainer.innerHTML = '';
        return;
      }

      selectedFilesContainer.style.display = 'block';
      
      let fileListHTML = '';
      selectedFiles.forEach((file, index) => {
        const fileIcon = FileHandler.getFileIcon(file.name);
        const fileSize = FileHandler.formatFileSize(file.size);
        
        fileListHTML += `
          <div class="file-item">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 14px;">${fileIcon}</span>
              <div>
                <div style="font-weight: 500; color: #333;">${file.name}</div>
                <div style="color: #666; font-size: 11px;">${fileSize}</div>
              </div>
            </div>
            <span class="remove-file" onclick="removeSelectedFile(${index})">‚úï</span>
          </div>
        `;
      });
      
      fileListContainer.innerHTML = fileListHTML;
    }

    // Global function to remove files
    window.removeSelectedFile = function(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
      
      // Update the file input to reflect removed files
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => dataTransfer.items.add(file));
      composeAttachment.files = dataTransfer.files;
    };

    // Setup email template buttons
    emailTemplateBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        if (emailTemplates[template]) {
          const templateData = emailTemplates[template];
          document.getElementById('composeSubject').value = templateData.subject;
          document.getElementById('composeMessage').value = templateData.message;
          
          Toast.show(`Loaded "${btn.textContent}" template`, 'info', 2000);
          
          // Focus on message field for editing
          setTimeout(() => {
            document.getElementById('composeMessage').focus();
          }, 100);
        }
      });
    });

    // Close compose panel
    closeComposeBtn.addEventListener('click', () => {
      composePanel.style.display = 'none';
      composeStatus.textContent = '';
      // Reset files when closing
      selectedFiles = [];
      composeAttachment.value = '';
      updateFileList();
    });

    // Modern send email function
    const sendEmail = async (type, options = {}) => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      
      if (!toEmail) {
        Toast.show('Please enter recipient email', 'error');
        return;
      }

      let buttonToUse = sendEmailBtn;
      if (type === '1bed') buttonToUse = send1BedPricelistBtn;
      if (type === '2bed') buttonToUse = send2BedPricelistBtn;
      if (type === 'mortgage') buttonToUse = sendMortgageLinkBtn;

      Loading.button.start(buttonToUse, 'Sending...');
      composeStatus.textContent = '';
      
      try {
        let result;
        
        switch(type) {
          case 'custom':
            const subject = document.getElementById('composeSubject').value.trim();
            const message = document.getElementById('composeMessage').value.trim();
            
            if (!subject || !message) {
              Toast.show('Please fill in all fields', 'error');
              Loading.button.stop(buttonToUse);
              return;
            }
            
            // Send custom message WITHOUT calculator link
            result = await EmailService.sendCustom(
              toEmail, 
              'Client', 
              subject, 
              message, 
              selectedFiles
            );
            break;
            
          case '1bed':
            result = await EmailService.sendEnhanced(
              toEmail, 
              'Client', 
              '1 Bedroom Unit Pricelist - Solano Hillside Residences',
              pricelist1Bedroom
            );
            break;
            
          case '2bed':
            result = await EmailService.sendEnhanced(
              toEmail, 
              'Client', 
              '2 Bedroom Unit Pricelist - Solano Hillside Residences',
              pricelist2Bedroom
            );
            break;
            
          case 'mortgage':
            result = await EmailService.sendEnhanced(
              toEmail, 
              'Client', 
              'Your Personal Mortgage Calculator - Solano Hillside Residences',
              mortgageCalculatorEmail
            );
            break;
        }
        
        if (result.success) {
          Toast.show('Email sent successfully!', 'success');
          composeStatus.textContent = '‚úì Email sent successfully!';
          composeStatus.style.color = '#4CAF50';
          
          // Auto-close after success
          setTimeout(() => {
            composePanel.style.display = 'none';
            document.getElementById('composeEmailTo').value = '';
            document.getElementById('composeSubject').value = '';
            document.getElementById('composeMessage').value = '';
            composeStatus.textContent = '';
            // Reset files
            selectedFiles = [];
            composeAttachment.value = '';
            updateFileList();
          }, 1500);
        } else {
          Toast.show(`Failed to send email: ${result.error}`, 'error');
          composeStatus.textContent = `‚úó Error: ${result.error}`;
          composeStatus.style.color = '#f44336';
        }
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
        composeStatus.textContent = `‚úó Error: ${error.message}`;
        composeStatus.style.color = '#f44336';
      } finally {
        Loading.button.stop(buttonToUse);
      }
    };

    // Event listeners
    sendEmailBtn.addEventListener('click', () => sendEmail('custom'));
    send1BedPricelistBtn.addEventListener('click', () => sendEmail('1bed'));
    send2BedPricelistBtn.addEventListener('click', () => sendEmail('2bed'));
    sendMortgageLinkBtn.addEventListener('click', () => sendEmail('mortgage'));
    
    // Initialize file attachment
    initFileAttachment();
  }

  // ========== MODERN MESSAGES PANEL ==========

  function setupMessagesPanel() {
    const messagesPanel = document.getElementById('messagesPopupPanel');
    const closeMessagesPanelBtn = document.getElementById('closeMessagesPanelBtn');
    const sendReplyBtn = document.getElementById('sendReplyBtn');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');
    const quickReplyBtns = document.querySelectorAll('.quickReplyBtn');
    
    // Close messages panel
    closeMessagesPanelBtn.addEventListener('click', () => {
      messagesPanel.style.display = 'none';
    });
    
    cancelReplyBtn.addEventListener('click', () => {
      document.getElementById('replyMessage').value = '';
    });
    
    // Modern send reply function
    sendReplyBtn.addEventListener('click', async () => {
      const replyMessage = document.getElementById('replyMessage').value.trim();
      const currentInquiryId = messagesPanel.dataset.inquiryId;

      if (!replyMessage) {
        Toast.show('Please enter a reply message', 'error');
        return;
      }

      Loading.button.start(sendReplyBtn, 'Sending...');
      const replyStatus = document.getElementById('replyStatus');
      replyStatus.textContent = '';
      
      try {
        // Save reply to messages subcollection
        await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
          sender: "admin",
          senderName: "Project Manager",
          content: replyMessage,
          timestamp: serverTimestamp(),
          readByPM: true,
          readByUser: false
        });

        // Update inquiry status
        await updateDoc(doc(db, "inquiries", currentInquiryId), {
          status: "responded"
        });

        // Clear reply field
        document.getElementById('replyMessage').value = '';

        // Reload messages
        await loadInquiryMessages(currentInquiryId);

        Toast.show('Reply sent successfully!', 'success');
        replyStatus.textContent = '‚úì Reply sent successfully!';
        replyStatus.style.color = '#4CAF50';
        
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
        replyStatus.textContent = `‚úó Error: ${error.message}`;
        replyStatus.style.color = '#f44336';
      } finally {
        Loading.button.stop(sendReplyBtn);
      }
    });
    
    // Quick reply templates
    quickReplyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        let message = '';
        
        switch(template) {
          case 'thankyou':
            message = `Thank you for your inquiry about Solano Hillside Residences. We appreciate your interest in our properties and would be happy to assist you further with any questions you may have.`;
            break;
          case 'followup':
            message = `I'm following up on your recent inquiry about our properties. Are you still interested in learning more about our available units or would you like to schedule a site viewing?`;
            break;
          case 'pricelist':
            message = `As requested, here are the price details for our units. I've also attached our full pricelist for your reference in your email. Please let me know if you'd like to discuss financing options or schedule a consultation.`;
            break;
          case 'appointment':
            message = `Would you be available for a site viewing this week? Please let me know your preferred date and time, and I'll arrange everything for you.`;
            break;
        }
        
        document.getElementById('replyMessage').value = message;
      });
    });
    
    // Close panel when clicking outside
    messagesPanel.addEventListener('click', (e) => {
      if (e.target === messagesPanel) {
        messagesPanel.style.display = 'none';
      }
    });
  }

  // ========== MODERN INQUIRY MESSAGES ==========

  window.viewInquiryMessages = async function(inquiryId) {
    try {
      const messagesPanel = document.getElementById('messagesPopupPanel');
      const messagesContainer = document.getElementById('messagesContainer');
      const panelTitle = document.getElementById('messagesPanelTitle');
      
      // Show loading
      Loading.show(messagesContainer, false);
      messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading messages...</div>';
      messagesPanel.style.display = 'flex';
      
      // Load inquiry details with retry
      const inquiryDoc = await retryOperation(
        () => getDoc(doc(db, "inquiries", inquiryId))
      );
      
      if (!inquiryDoc.exists()) {
        Toast.show('Inquiry not found', 'error');
        messagesContainer.innerHTML = '<div style="color: #f44336; text-align: center; padding: 40px;">Inquiry not found</div>';
        return;
      }
      
      const inquiryData = inquiryDoc.data();
      panelTitle.textContent = `Messages with ${inquiryData.name || 'Client'}`;
      
      // Store recipient info for replies
      messagesPanel.dataset.inquiryId = inquiryId;
      messagesPanel.dataset.recipientEmail = inquiryData.email;
      messagesPanel.dataset.recipientName = inquiryData.name || 'Client';
      
      // Load messages
      await loadInquiryMessages(inquiryId);
      
    } catch (error) {
      console.error('Error loading messages:', error);
      Toast.show(`Failed to load messages: ${error.message}`, 'error');
      document.getElementById('messagesContainer').innerHTML = 
        `<div style="color: #f44336; padding: 40px; text-align: center;">
          Failed to load messages. Please try again.
        </div>`;
    } finally {
      Loading.hide(messagesContainer, false);
    }
  };

  // Modern load inquiry messages
  async function loadInquiryMessages(inquiryId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    try {
      // Get inquiry details
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      const inquiryData = inquiryDoc.data();
      
      // Get messages from the "messages" subcollection
      const messagesSnapshot = await getDocs(
        query(collection(db, "inquiries", inquiryId, "messages"), 
              orderBy("timestamp", "asc"))
      );
      
      let messagesHTML = '';
      
      // Display original inquiry
      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || "No topic selected";
      const paymentInfoText = paymentInfoMap[inquiryData.payment_info] || "";
      const inquiryDate = inquiryData.createdAt?.toDate 
        ? inquiryData.createdAt.toDate().toLocaleString() 
        : 'Not available';
      
      messagesHTML += `
        <div style="margin-bottom: 20px;">
          <div style="background: #e8d4a6; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <strong style="color: #2e7d32;">${inquiryData.name || 'Client'}</strong>
              <small style="color: #666;">${inquiryDate}</small>
            </div>
            <div style="margin-bottom: 10px; color: #333;">
              <strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>
              ${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
              <strong style="color: #003366;">Email:</strong> ${inquiryData.email}<br/>
              <strong style="color: #003366;">Phone:</strong> ${inquiryData.number || 'Not provided'}<br/>
              <strong style="color: #003366;">Employment:</strong> ${inquiryData.Employement_Type || 'Not provided'}
            </div>
            <div style="background: #d4b97a; padding: 10px; border-radius: 4px; margin-top: 10px; color: #333;">
              <strong style="color: #003366;">Original Message:</strong><br/>
              ${inquiryData.inquiry_topic === 'other' && inquiryData.other_inquiry 
                ? inquiryData.other_inquiry 
                : 'Client expressed interest in our properties.'}
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
              Status: <span style="color: ${inquiryData.status === 'responded' ? '#4CAF50' : '#ff9800'}; font-weight: bold;">
                ${inquiryData.status || 'new'}
              </span>
            </div>
          </div>
        </div>
      `;
      
      // Display chat messages
      if (!messagesSnapshot.empty) {
        messagesHTML += '<h4 style="color: #003366; margin: 20px 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Chat History</h4>';
        
        messagesSnapshot.forEach(doc => {
          const message = doc.data();
          const messageDate = message.timestamp?.toDate 
            ? message.timestamp.toDate().toLocaleString() 
            : 'Not available';
          
          // Determine if message is from admin or user
          const isAdmin = message.sender === "admin";
          const senderName = isAdmin ? "You (Admin)" : (inquiryData.name || 'Client');
          const bgColor = isAdmin ? '#d4e6f1' : '#f8f4e9';
          const borderColor = isAdmin ? '#2196F3' : '#a57934';
          const textColor = isAdmin ? '#1565c0' : '#333';
          
          messagesHTML += `
            <div style="margin-bottom: 15px;">
              <div style="background: ${bgColor}; 
                         padding: 12px; border-radius: 8px; 
                         border-left: 4px solid ${borderColor};
                         margin-left: ${isAdmin ? '40px' : '0'};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: ${textColor}">
                    ${senderName}
                  </strong>
                  <small style="color: #666;">${messageDate}</small>
                </div>
                <div style="color: #333;">${message.content}</div>
                ${message.senderName ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">Sent by: ${message.senderName}</div>` : ''}
              </div>
            </div>
          `;
        });
      } else {
        messagesHTML += `
          <div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">
            No messages yet. Send the first message to start the conversation.
          </div>
        `;
      }
      
      messagesContainer.innerHTML = messagesHTML;
      
      // Smooth scroll to bottom
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
      
    } catch (error) {
      messagesContainer.innerHTML = `
        <div style="color: #f44336; padding: 40px; text-align: center;">
          Failed to load messages. Please try again.
        </div>
      `;
    }
  }

  // ========== MODERN DATA LOADING ==========

  // Function to check if an inquiry has messages
  async function checkInquiryHasMessages(inquiryId) {
    try {
      const messagesSnapshot = await getDocs(collection(db, "inquiries", inquiryId, "messages"));
      return !messagesSnapshot.empty;
    } catch (error) {
      console.error("Error checking messages:", error);
      return false;
    }
  }

  // Modern load data function with parallel requests
  async function loadData() {
    try {
      // Show loading state
      Loading.show(dataContainer);
      dataContainer.innerHTML = '';
      
      // Load data in parallel for better performance
      const [inquiriesSnapshot, calculationsSnapshot] = await Promise.all([
        retryOperation(() => 
          getDocs(query(collection(db, "inquiries"), orderBy("createdAt", "desc")))
        ),
        retryOperation(() => 
          getDocs(query(collection(db, "mortgage_calculations"), orderBy("createdAt", "desc")))
        )
      ]);

      // Process data
      const inquiriesData = inquiriesSnapshot.docs.map(doc => ({
        id: doc.id,
        type: 'inquiry',
        data: doc.data(),
        createdAt: doc.data().createdAt
      }));

      const calculationsData = calculationsSnapshot.docs.map(doc => ({
        id: doc.id,
        type: 'calculation',
        data: doc.data(),
        createdAt: doc.data().createdAt
      }));

      // Combine and sort by date
      const allData = [...inquiriesData, ...calculationsData].sort((a, b) => {
        return b.createdAt?.toMillis() - a.createdAt?.toMillis();
      });

      // Filter based on current view
      let filteredData = allData;
      if (currentView === 'inquiries') {
        filteredData = allData.filter(item => item.type === 'inquiry');
        document.getElementById('toggleViewBtn').textContent = 'Show: Inquiries Only';
      } else if (currentView === 'calculations') {
        filteredData = allData.filter(item => item.type === 'calculation');
        document.getElementById('toggleViewBtn').textContent = 'Show: Calculations Only';
      } else {
        document.getElementById('toggleViewBtn').textContent = 'Show: All';
      }

      if (filteredData.length === 0) {
        dataContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 16px; margin-bottom: 10px;">No ${currentView === 'all' ? 'data' : currentView} yet.</p>
            <p style="font-size: 14px; color: #999;">Check back later for new inquiries and calculations.</p>
          </div>
        `;
        return;
      }

      // Create a map to group by email
      const emailGroups = {};
      
      // First, create all email groups
      filteredData.forEach(item => {
        const email = item.data.email;
        if (!emailGroups[email]) {
          emailGroups[email] = {
            email: email,
            name: item.data.name || 'Not provided',
            inquiries: [],
            calculations: []
          };
        }
        
        if (item.type === 'inquiry') {
          emailGroups[email].inquiries.push(item);
        } else if (item.type === 'calculation') {
          emailGroups[email].calculations.push(item);
        }
      });

      // Display grouped by email (sequential for message checks)
      dataContainer.innerHTML = '';
      let groupIndex = 0;
      
      for (const [email, group] of Object.entries(emailGroups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'email-group';
        groupDiv.style = `border: 2px solid #cfa85b; padding: 15px; margin-bottom: 20px; border-radius: 8px; background-color: #f9f9f9; animation-delay: ${groupIndex * 50}ms;`;
        
        let groupHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <strong style="color: #003366; font-size: 16px;">${group.name}</strong><br/>
              <strong style="color: #333;">Email:</strong> <span style="color: #333;">${group.email}</span><br/>
            </div>
            <div style="text-align: right;">
              <span class="badge" style="background-color: #a57934; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">
                ${group.inquiries.length} Inquiry${group.inquiries.length !== 1 ? 'ies' : ''}
              </span>
              <span class="badge" style="background-color: #2e7d32; color: white; padding: 4px 8px; border-radius: 4px;">
                ${group.calculations.length} Calculation${group.calculations.length !== 1 ? 's' : ''}
              </span>
            </div>
          </div>
        `;

        // Show inquiries for this email
        if (group.inquiries.length > 0) {
          groupHTML += `<h4 style="color: #a57934; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Inquiries</h4>`;
          
          for (const inquiry of group.inquiries) {
            const inquiryTopicText = inquiryTopicMap[inquiry.data.inquiry_topic] || "No topic selected";
            const paymentInfoText = paymentInfoMap[inquiry.data.payment_info] || "";
            const inquiryDate = inquiry.data.createdAt?.toDate 
              ? inquiry.data.createdAt.toDate().toLocaleString() 
              : 'Not available';
            
            // Check if there are messages
            const hasMessages = await checkInquiryHasMessages(inquiry.id);
            const statusColor = inquiry.data.status === 'responded' ? '#4CAF50' : 
                              inquiry.data.status === 'pending' ? '#ff9800' : '#f44336';
            
            groupHTML += `
              <div style="background: #ffffff; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #a57934; border: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1; color: #333;">
                    <strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>
                    ${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
                    <strong style="color: #003366;">Date:</strong> ${inquiryDate}<br/>
                    <strong style="color: #003366;">Status:</strong> 
                    <span style="color: ${statusColor}; font-weight: bold;">
                      ${inquiry.data.status || 'new'}
                      ${hasMessages ? ' (has messages)' : ''}
                    </span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="viewInquiryMessages('${inquiry.id}')" style="padding: 6px 12px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: background-color 0.2s;">
                      ${hasMessages ? 'View Chat' : 'Start Chat'}
                    </button>
                    <button onclick="sendEmailTo('${inquiry.data.email}', '${inquiry.data.name}', 'inquiry')" style="padding: 6px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: background-color 0.2s;">
                      Send Email
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
        }

        // Show mortgage calculations for this email
        if (group.calculations.length > 0) {
          groupHTML += `<h4 style="color: #2e7d32; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Mortgage Calculations</h4>`;
          
          group.calculations.forEach(calc => {
            const calcData = calc.data;
            const calcSummary = calcData.formatted || {};
            
            groupHTML += `
              <div style="background: #ffffff; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #2e7d32; border: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; color: #333;">
                  <div>
                    <strong style="color: #003366;">Property Price:</strong> ${calcSummary.propertyPrice || formatCurrency(calcData.propertyPrice)}<br/>
                    <strong style="color: #003366;">Downpayment:</strong> ${calcData.downpaymentPercent}% (${calcSummary.downpayment || formatCurrency(calcData.downpaymentAmount)})<br/>
                    <strong style="color: #003366;">Loan Amount:</strong> ${calcSummary.loanAmount || formatCurrency(calcData.loanAmount)}<br/>
                  </div>
                  <div>
                    <strong style="color: #003366;">Monthly Payment:</strong> ${calcSummary.monthlyPayment || formatCurrencyDecimal(calcData.monthlyPayment)}<br/>
                    <strong style="color: #003366;">Term:</strong> ${calcData.loanTermYears} years @ ${calcData.interestRate}%<br/>
                    <strong style="color: #003366;">Total Interest:</strong> ${calcSummary.totalInterest || formatCurrency(calcData.totalInterest)}<br/>
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                  <strong>Calculation Date:</strong> ${new Date(calcData.calculationDate).toLocaleString()}<br/>
                  <strong>Phone:</strong> ${calcData.phone || 'Not provided'}<br/>
                  ${calcData.isExistingClient ? '<span style="color: #a57934; font-weight: bold;">‚òÖ Existing Client</span>' : ''}
                </div>
                <div style="margin-top: 10px;">
                  <button onclick="deleteCalculation('${calc.id}')" style="padding: 6px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s;">
                    Delete
                  </button>
                </div>
              </div>
            `;
          });
        }

        groupDiv.innerHTML = groupHTML;
        dataContainer.appendChild(groupDiv);
        groupIndex++;
      }

      Toast.show(`Loaded ${filteredData.length} items`, 'info', 2000);
      
    } catch (error) {
      console.error('Error loading data:', error);
      Toast.show(`Failed to load data: ${error.message}`, 'error');
      dataContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #f44336;">
          <p style="font-size: 16px; margin-bottom: 10px;">Failed to load data</p>
          <p style="font-size: 14px; color: #999; margin-bottom: 20px;">${error.message}</p>
          <button onclick="loadData()" style="padding: 8px 16px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Retry Loading
          </button>
        </div>
      `;
    } finally {
      Loading.hide(dataContainer);
    }
  }

  // ========== HELPER FUNCTIONS ==========

  // Modern currency formatting
  const Currency = {
    format: (amount) => {
      if (!amount && amount !== 0) return '‚Ç± 0';
      return '‚Ç± ' + amount.toLocaleString('en-PH', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    },
    
    formatDecimal: (amount) => {
      if (!amount && amount !== 0) return '‚Ç± 0.00';
      return '‚Ç± ' + amount.toLocaleString('en-PH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
  };

  const formatCurrency = Currency.format;
  const formatCurrencyDecimal = Currency.formatDecimal;

  // Send email to client
  window.sendEmailTo = function(email, name, type = 'general') {
    const composePanel = document.getElementById('composePanel');
    const composeEmailTo = document.getElementById('composeEmailTo');
    const composeSubject = document.getElementById('composeSubject');
    
    composeEmailTo.value = email;
    
    if (type === 'inquiry') {
      composeSubject.value = `Regarding your inquiry - ${name}`;
    } else {
      composeSubject.value = `Message from Solano Hills - ${name}`;
    }
    
    composePanel.style.display = 'block';
    
    // Auto-focus on message field
    setTimeout(() => {
      document.getElementById('composeMessage').focus();
    }, 100);
  };

  // Modern send calculation details
  window.sendCalculationTo = async function(email, name, calcId) {
    try {
      Loading.show(dataContainer, false);
      
      const docSnap = await retryOperation(() => 
        getDoc(doc(db, "mortgage_calculations", calcId))
      );
      
      if (docSnap.exists()) {
        const calcData = docSnap.data();
        
        // Create email template
        const emailBody = `
Dear ${name},

Thank you for using our mortgage calculator for Solano Hillside Residences.

Here is a summary of your calculation:

PROPERTY DETAILS:
- Property Price: ${formatCurrency(calcData.propertyPrice)}
- Downpayment: ${calcData.downpaymentPercent}% (${formatCurrency(calcData.downpaymentAmount)})
- Loan Amount: ${formatCurrency(calcData.loanAmount)}
- Loan Term: ${calcData.loanTermYears} years
- Interest Rate: ${calcData.interestRate}%

PAYMENT SUMMARY:
- Monthly Payment: ${formatCurrencyDecimal(calcData.monthlyPayment)}
- Total Interest: ${formatCurrency(calcData.totalInterest)}
- Total Payment: ${formatCurrency(calcData.totalPayment)}

üîó Want to adjust these calculations?
You can use our interactive mortgage calculator to explore different scenarios:
${MORTGAGE_CALCULATOR_LINK}

For more information or to proceed with your reservation, please contact our sales team.

Best regards,
PHINMA Properties Team
Solano Hillside Residences
        `;
        
        // Show compose panel with pre-filled email
        const composePanel = document.getElementById('composePanel');
        const composeEmailTo = document.getElementById('composeEmailTo');
        const composeSubject = document.getElementById('composeSubject');
        const composeMessage = document.getElementById('composeMessage');
        
        composeEmailTo.value = email;
        composeSubject.value = `Your Mortgage Calculation - Solano Hillside Residences`;
        composeMessage.value = emailBody;
        composePanel.style.display = 'block';
        
        // Auto-focus on message field
        setTimeout(() => {
          document.getElementById('composeMessage').focus();
        }, 100);
        
        Toast.show('Calculation loaded successfully', 'success');
      } else {
        Toast.show('Calculation not found', 'error');
      }
    } catch (error) {
      Toast.show(`Error: ${error.message}`, 'error');
    } finally {
      Loading.hide(dataContainer, false);
    }
  };

  // Modern delete calculation
  window.deleteCalculation = async function(calcId) {
    if (confirm('Are you sure you want to delete this mortgage calculation?')) {
      try {
        Loading.show(dataContainer, false);
        
        await deleteDoc(doc(db, "mortgage_calculations", calcId));
        
        Toast.show('Calculation deleted successfully', 'success');
        
        // Refresh the view after a short delay
        setTimeout(() => {
          loadData();
        }, 500);
        
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
      } finally {
        Loading.hide(dataContainer, false);
      }
    }
  };

  // ========== INITIALIZATION ==========

  // Initialize panels
  setupComposePanel();
  setupMessagesPanel();

  // Load data initially
  loadData();

  break;
        /* ================= DOCUMENT ================= */
case "document":
  mainContent.innerHTML = `
    <h1>Upload Client Documents</h1>
    <p>Type your name/description, input quantity of required bedroom units, select payment terms, and attach exactly 8 files below:</p>

    <form id="uploadForm" style="display:flex; flex-direction:column; gap:10px; max-width: 400px;">
      <input type="text" id="name" placeholder="Client Name" required style="padding:8px; width: 80%;" />

      <!-- Number of 1 Bedroom units -->
      <label style="font-weight:600;">Number of 1 Bedroom Units:</label>
      <input type="number" id="num1Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Number of 2 Bedroom units -->
      <label style="font-weight:600;">Number of 2 Bedroom Units:</label>
      <input type="number" id="num2Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Payment Terms Dropdown -->
      <label style="font-weight:600;">Select Payment Terms:</label>
      <select id="paymentTerms" required style="padding:8px; width: 80%; margin-bottom:10px;">
        <option value="" disabled selected>-- Select Payment Terms --</option>
        <option value="Monthly">Monthly</option>
        <option value="Cash">Cash</option>
      </select>

      <!-- File inputs -->
      ${[...Array(8)].map((_, i) => `
        <input type="file" id="file${i+1}" required style="padding:8px; width:80%;" />
      `).join('')}

      <button type="submit" style="
        padding: 12px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: fit-content;
      ">Upload</button>
    </form>

    <div id="status" style="margin-top:10px;"></div>
    <h2>Upload History</h2>
    <div id="uploadHistory" style="margin-top:10px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
  `;

  const form = document.getElementById("uploadForm");
  const uploadHistory = document.getElementById("uploadHistory");
  const statusDiv = document.getElementById("status");
  const nameInput = document.getElementById("name");
  const paymentTermsSelect = document.getElementById("paymentTerms");
  const num1BedroomInput = document.getElementById("num1Bedroom");
  const num2BedroomInput = document.getElementById("num2Bedroom");
  const fileInputs = [...Array(8)].map((_, i) => document.getElementById(`file${i+1}`));

  const circumference = 2 * Math.PI * 45;

  function createProgressCircle() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "100");
    svg.setAttribute("height", "100");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.style.flexShrink = "0";

    const bgCircle = document.createElementNS(svgNS, "circle");
    bgCircle.setAttribute("cx", "50");
    bgCircle.setAttribute("cy", "50");
    bgCircle.setAttribute("r", "45");
    bgCircle.setAttribute("stroke", "#eee");
    bgCircle.setAttribute("stroke-width", "10");
    bgCircle.setAttribute("fill", "none");
    svg.appendChild(bgCircle);

    const progressCircle = document.createElementNS(svgNS, "circle");
    progressCircle.setAttribute("cx", "50");
    progressCircle.setAttribute("cy", "50");
    progressCircle.setAttribute("r", "45");
    progressCircle.setAttribute("stroke", "#4CAF50");
    progressCircle.setAttribute("stroke-width", "10");
    progressCircle.setAttribute("fill", "none");
    progressCircle.setAttribute("stroke-linecap", "round");
    progressCircle.setAttribute("stroke-dasharray", circumference);
    progressCircle.setAttribute("stroke-dashoffset", circumference);
    progressCircle.setAttribute("transform", "rotate(-90 50 50)");
    svg.appendChild(progressCircle);

    const progressText = document.createElementNS(svgNS, "text");
    progressText.setAttribute("x", "50");
    progressText.setAttribute("y", "55");
    progressText.setAttribute("font-size", "20");
    progressText.setAttribute("text-anchor", "middle");
    progressText.setAttribute("fill", "white");
    progressText.textContent = "0%";
    svg.appendChild(progressText);

    return { svg, progressCircle, progressText };
  }

  function setCircleProgress(circle, text, percent) {
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    text.textContent = `${Math.round(percent)}%`;
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
    uploadHistory.innerHTML = "";
    if (!history.length) {
      uploadHistory.innerHTML = "<p>No upload history yet.</p>";
      return;
    }

    history.forEach(entry => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ddd";
      div.style.marginBottom = "12px";
      div.style.paddingBottom = "12px";
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.gap = "12px";
      div.style.justifyContent = "space-between";

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `
        <strong>${entry.name}</strong><br/>
        <small><em>1 Bedroom Units: ${entry.num1Bedroom}</em></small><br/>
        <small><em>2 Bedroom Units: ${entry.num2Bedroom}</em></small><br/>
        <small><em>${entry.paymentTerms}</em></small><br/>
        <small><em>Uploaded at ${entry.time}</em></small>
        <ul style="margin: 8px 0 0 20px; padding-left: 0; list-style: disc;">
          ${entry.files.map(f => `<li>${f}</li>`).join("")}
        </ul>
        <p style="margin-top:8px; font-weight:600; color:#2e7d32;">
          The client is ready for account creation.
        </p>
      `;

      const { svg, progressCircle, progressText } = createProgressCircle();
      setCircleProgress(progressCircle, progressText, 100);

      div.appendChild(contentDiv);
      div.appendChild(svg);
      uploadHistory.appendChild(div);
    });
  }

  loadHistory();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const paymentTerms = paymentTermsSelect.value;
    const num1Bedroom = Number(num1BedroomInput.value);
    const num2Bedroom = Number(num2BedroomInput.value);

    if (num1Bedroom < 0 || num2Bedroom < 0) {
      alert("Bedroom unit counts cannot be negative.");
      return;
    }

    if (!paymentTerms) {
      alert("Please select a payment term.");
      return;
    }

    statusDiv.textContent = "Uploading files to Cloudinary...";

    let totalSize = 0;
    const files = fileInputs.map(f => f.files[0]);
    for (let i = 0; i < files.length; i++) {
      if (!files[i]) {
        alert(`Missing file #${i+1}`);
        return;
      }
      totalSize += files[i].size;
    }

    let uploadedSize = 0;
    const uploadedUrls = [];
    const uploadedFileNames = [];

    const tempDiv = document.createElement("div");
    tempDiv.style.display = "flex";
    tempDiv.style.justifyContent = "space-between";
    tempDiv.style.alignItems = "center";
    tempDiv.style.borderBottom = "1px solid #ddd";
    tempDiv.style.paddingBottom = "12px";
    tempDiv.style.marginBottom = "12px";

    const tempContentDiv = document.createElement("div");
    tempContentDiv.innerHTML = `<strong>${name}</strong><br/><small>Uploading...</small>`;
    const { svg, progressCircle, progressText } = createProgressCircle();

    tempDiv.appendChild(tempContentDiv);
    tempDiv.appendChild(svg);
    uploadHistory.prepend(tempDiv);

    // Upload
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "upload_preset");

      try {
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "https://api.cloudinary.com/v1_1/dfklsyjch/upload");

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = ((uploadedSize + event.loaded) / totalSize) * 100;
              setCircleProgress(progressCircle, progressText, percent);
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              const data = JSON.parse(xhr.responseText);
              uploadedUrls.push(data.secure_url);
              uploadedFileNames.push(file.name);
              uploadedSize += file.size;
              resolve();
            } else reject();
          };

          xhr.onerror = () => reject();
          xhr.send(formData);
        });
      } catch {
        statusDiv.textContent = "Upload failed.";
        return;
      }
    }

    statusDiv.textContent = "Sending email...";

    // Prepare email
    const templateParams = {
      name,
      paymentTerms,
      num1Bedroom,
      num2Bedroom,
      time: new Date().toLocaleString(),
      message: `
        <p>1 Bedroom Units: ${num1Bedroom}</p>
        <p>2 Bedroom Units: ${num2Bedroom}</p>
        <p>Payment Terms: ${paymentTerms}</p>
        <p>Files:</p>
        ${uploadedUrls.map((u, i) => `<a href="${u}">${uploadedFileNames[i]}</a>`).join("<br>")}
      `
    };

    try {
      await emailjs.send("service_u1n5d9t", "template_qu1s2lh", templateParams);

      statusDiv.textContent = "Email sent!";
      uploadHistory.removeChild(tempDiv);

      // Save history
      const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
      history.unshift({
        name,
        paymentTerms,
        num1Bedroom,
        num2Bedroom,
        time: new Date().toLocaleString(),
        files: uploadedFileNames
      });

      if (history.length > 10) history.pop();
      localStorage.setItem("uploadHistory", JSON.stringify(history));
      loadHistory();

      form.reset();
    } catch {
      statusDiv.textContent = "Email sending failed.";
    }
  });
  break;

        /* ================= DEFAULT ================= */
        default:
          mainContent.innerHTML = "<h1>Welcome</h1><p>Select an option from the sidebar.</p>";
      }
    };

    // ================= AUTHENTICATION CHECK =================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("You're not signed in. Redirecting to login...");
        window.location.href = "index.html";
        return;
      }
      // Show welcome message
      const greeting = document.getElementById("Greeting");
      const nameToShow = user.displayName || user.email;
      if (greeting) greeting.textContent = `Welcome Back!, ${nameToShow}`;
    });

    // ================= AUTO LOAD DASHBOARD ON PAGE OPEN =================
    window.addEventListener("load", () => {
      loadContent(null, "dashboard");

      // highlight sidebar tab
      document.querySelectorAll(".sidebar nav ul li a").forEach(link =>
        link.classList.remove("active")
      );
      document.querySelector(".sidebar nav ul li a[href='#']").classList.add("active");
    });

    // ================= SHOW REPLY FORM =================
    window.showReplyForm = function (email, id) {
      document.getElementById(`reply-${id}`).style.display = "block";
    };

    // ================= SEND REPLY =================
    window.sendReply = async function (toEmail, id, toName) {
      const replyText = document.getElementById(`replyText-${id}`).value.trim();
      if (!replyText) {
        alert("Please type a reply message.");
        return;
      }

      // Prepare data for backend with correct keys
      const payload = {
        to: toEmail,                  // was toEmail
        from: "your-email@gmail.com", // was fromEmail; replace with your actual sender email
        subject: `Reply from Project Manager to ${toName}`,
        message: replyText
      };

      try {
        const response = await fetch("http://localhost:3000/send-reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply.");
        }

        alert("Reply sent successfully to " + toEmail);

        const messageRef = doc(db, "messages", id);
        await updateDoc(messageRef, { replied: true });

        await addDoc(collection(db, "sentReplies"), {
          to: toEmail,
          message: replyText,
          timestamp: new Date()
        });

        document.getElementById(`reply-${id}`).style.display = "none";
        document.getElementById(`replyText-${id}`).value = "";

        loadContent(null, "inbox");

      } catch (error) {
        console.error("Error sending reply:", error);
        alert("Failed to send reply: " + error.message);
      }
    };


  </script>
</body>
</html>

