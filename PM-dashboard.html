<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Manager Dashboard</title>
  <link rel="stylesheet" href="PM-dasboard.css" />
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" id="showInboxBtn" onclick="loadContent(event, 'inbox')">Inquiries</a></li>
        <li><a href="#" onclick="loadContent(event, 'document')">Document</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="Greeting">Welcome Back!</h1>
      <p>Select a sidebar to start managing.</p>
    </div>
  </main>

  <!-- ======================== EMAILJS SDK ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("avvdJIIs04H8nGyu_");
    })();
  </script>

  <!-- ======================== FIREBASE & INBOX ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc,writeBatch, serverTimestamp, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");

    // ================= CONTENT LOADER =================
    window.loadContent = function (event, section) {
      if(event) event.preventDefault();

      // Remove active class and add to clicked
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => link.classList.remove("active"));
      if (event?.target?.tagName === "A") event.target.classList.add("active");

      mainContent.innerHTML = "";

      switch (section) {
        /* ================= DASHBOARD ================= */
        case "dashboard":
          mainContent.innerHTML = `
            <h1 id="Greeting1">Dashboard</h1>
            <div class="dashboard-container">
              
              <!-- ======== LEFT: WELCOME SLIDER ======== -->
              <div class="welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1"></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2"></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3"></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </div>

              <!-- ======== RIGHT: CALENDAR + INBOX ======== -->
              <div class="right-side">
                <div class="calendar-card">
                  <h3>üìÖ Calendar</h3>
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          `;

          // Image slider logic
          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);

            document.getElementById("sliderPrev").addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document.getElementById("sliderNext").addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(() => showSlidesLocal(++slideIndexLocal), 5000);
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl) sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          })();

          // Calendar logic
          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += "<tr><th class='cal-header' colspan='7'>" + monthName + " " + year + "</th></tr>";
              html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += "<td" + (isToday ? " class='today'" : "") + ">" + day + "</td>";
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) html += "</tr><tr>";
              }

              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();

          break;

        /* ================= INBOX ================= */
case "inbox":
  mainContent.innerHTML = `
    <h3 class="inbox-header">Inquiries & Mortgage Calculations</h3>
    <div style="margin-bottom: 20px;">
      <button id="toggleViewBtn" class="view-toggle-btn">Show: All</button>
      <button id="showInquiriesBtn" class="view-toggle-btn inquiries-btn">Show Inquiries Only</button>
      <button id="showCalculationsBtn" class="view-toggle-btn calculations-btn">Show Calculations Only</button>
    </div>
    
    <div id="composePanel" class="compose-panel">
      <h4 class="inbox-header" style="margin-top: 0;">Compose Email</h4>
      <input type="email" id="composeEmailTo" placeholder="Recipient Email" class="compose-input" />
      <input type="text" id="composeSubject" placeholder="Subject" class="compose-input" />
      <textarea id="composeMessage" placeholder="Write your message here..." rows="5" class="compose-textarea"></textarea>
      
      <div class="templates-section">
        <h5 style="margin: 0 0 10px 0; color: #003366; font-size: 14px;">Quick Email Templates:</h5>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="emailTemplateBtn template-btn btn-thankyou" data-template="thankyou">Thank You</button>
          <button class="emailTemplateBtn template-btn btn-followup" data-template="followup">Follow Up</button>
          <button class="emailTemplateBtn template-btn btn-pricelist" data-template="pricelist">Send Pricelist</button>
          <button class="emailTemplateBtn template-btn btn-appointment" data-template="appointment">Schedule Appointment</button>
          <button class="emailTemplateBtn template-btn btn-welcome" data-template="welcome">Welcome</button>
          <button class="emailTemplateBtn template-btn btn-confirmation" data-template="confirmation">Confirmation</button>
        </div>
      </div>
      
      <div class="attachment-section">
        <h5 style="margin: 0 0 10px 0; color: #003366; font-size: 14px;">Attachments (Optional)</h5>
        <div class="file-upload-area">
          <input type="file" id="composeAttachment" multiple class="file-upload-input" />
          <div class="file-upload-ui">
            <div class="file-upload-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: white;">
                <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15.01L9.41 16.42L11 14.84V19H13V14.84L14.59 16.43L16 15.01L12.01 11L8 15.01Z" fill="currentColor"/>
              </svg>
            </div>
            <div>
              <div style="font-weight: 500; color: #003366;">Choose files to attach</div>
              <div style="font-size: 12px; color: #666;">Click to browse or drag and drop</div>
            </div>
          </div>
        </div>
        <div id="selectedFiles" style="display: none;">
          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Selected files:</div>
          <div id="fileList" style="max-height: 100px; overflow-y: auto;"></div>
        </div>
      </div>
      
      <div class="pricelist-section">
        <h5 style="margin: 0 0 10px 0; color: #d35400;">Quick Send Pricelist:</h5>
        <div style="display: flex; gap: 10px;">
          <button id="send1BedPricelistBtn" class="pricelist-btn btn-1bed">Send 1 Bedroom Pricelist</button>
          <button id="send2BedPricelistBtn" class="pricelist-btn btn-2bed">Send 2 Bedroom Pricelist</button>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button id="sendMortgageLinkBtn" class="pricelist-btn btn-mortgage">Send Mortgage Calculator Link</button>
        </div>
      </div>
      
      <div class="action-buttons">
        <button id="sendEmailBtn" class="send-btn">Send Email</button>
        <button id="closeComposeBtn" class="send-btn cancel-btn">Cancel</button>
      </div>
      <div id="composeStatus" style="margin-top: 10px; color: green;"></div>
    </div>
    
    <div id="messagesPopupPanel" class="messages-popup">
      <div class="messages-container">
        <div class="messages-header">
          <h3 id="messagesPanelTitle" style="margin: 0; font-size: 18px;">Messages</h3>
          <button id="closeMessagesPanelBtn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <div class="messages-content">
          <div id="messagesContainer"></div>
          <div class="reply-section">
            <h4 style="margin-top: 0; color: #003366;">Send Reply</h4>
            <textarea id="replyMessage" placeholder="Type your reply here..." rows="4" class="reply-textarea"></textarea>
            <div style="margin-bottom: 15px;">
              <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">Quick Replies:</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="quickReplyBtn quick-reply-btn btn-thankyou" data-template="thankyou">Thank You</button>
                <button class="quickReplyBtn quick-reply-btn btn-followup" data-template="followup">Follow Up</button>
                <button class="quickReplyBtn quick-reply-btn btn-pricelist" data-template="pricelist">Send Pricelist</button>
                <button class="quickReplyBtn quick-reply-btn btn-appointment" data-template="appointment">Schedule Appointment</button>
              </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="sendReplyBtn" class="send-btn" style="flex: none;">Send Reply</button>
              <button id="cancelReplyBtn" class="send-btn cancel-btn" style="flex: none;">Cancel</button>
            </div>
            <div id="replyStatus" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="dataContainer"></div>
  `;

  const dataContainer = document.getElementById("dataContainer");
  let currentView = 'all';
  const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";
  
  // ========== CONSTANTS ==========
  const emailTemplates = {
    thankyou: { subject: "Thank You for Your Inquiry - Solano Hillside Residences", message: `Dear Client,\n\nThank you for your interest in our properties.\n\nBest regards,\nSolano Hillside Residences Team` },
    followup: { subject: "Following Up on Your Inquiry - Solano Hillside Residences", message: `Dear Client,\n\nI'm following up on your last inquiry are you still interested in inquiring if you are please contact us again through our contact page.\n\nWarm regards,\nSolano Hillside Residences Team` },
    pricelist: { subject: "Property Pricelist & Details - Solano Hillside Residences", message: `Dear Client,\n\nAs requested i have sent the pricelist in your email and I have also sent our calculator regarding in this matter\n\nüîó ${MORTGAGE_CALCULATOR_LINK}\n\nBest regards,\nSolano Hillside Residences Team` },
    appointment: { subject: "Schedule a Site Viewing - Solano Hillside Residences", message: `Dear Client,\n\nThank you of inquiring would you like to schedule a site visit? contact us through our live chat \n\nWarm regards,\nSolano Hillside Residences Team` },
    welcome: { subject: "Welcome to Solano Hillside Residences", message: `Dear Client,\n\nWelcome thank you for inquiring would what questions do you and i will answer preferrably ask me through live chat in our website\n\nSincerely,\nSolano Hillside Residences Team` },
    confirmation: { subject: "Meeting Confirmation - Solano Hillside Residences", message: `Dear Client,\n\nThis email confirms that your request are noted so when you vist to our site we will have a smooth process.\n\nBest regards,\nSolano Hillside Residences Team` }
  };

 const pricelist1Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">1 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 150,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 12,500</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 2,800,000</td></tr>
    <tr><td style="padding:6px 8px; color: #333;">Payment Terms</td><td style="padding:6px 8px;font-weight:600; color: #333;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  const pricelist2Bedroom = `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h3 style="color:#a57934;margin-bottom:8px;font-size:16px;font-weight:600;">2 Bedroom Unit - Investment Details</h3>
    <table style="width:100%;border-collapse:collapse;background:#fff;color:#333;font-size:16px;border:1px solid #ddd;">
    <tr style="background:#a57934;"><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Category</th><th style="padding:6px 8px;border-bottom:1px solid #ddd;text-align:left;font-weight:600; color: white;">Amount</th></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Downpayment</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 200,000</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Monthly Amortization</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 16,800</td></tr>
    <tr><td style="padding:6px 8px;border-bottom:1px solid #eee; color: #333;">Total Price</td><td style="padding:6px 8px;border-bottom:1px solid #eee;font-weight:600; color: #333;">‚Ç± 3,800,000</td></tr>
    <tr><td style="padding:6px 8px; color: #333;">Payment Terms</td><td style="padding:6px 8px;font-weight:600; color: #333;">12 / 24 / 36 months</td></tr>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background-color: #f0f7ff; border-radius: 8px; border-left: 4px solid #003366;">
      <h4 style="color:#003366;margin:0 0 10px 0;font-size:14px;">üí° Personalize Your Calculation</h4>
      <p style="margin:0 0 10px 0;color:#333;font-size:13px;line-height:1.4;">
        Want to see how these numbers work for your specific budget? Use our interactive mortgage calculator to customize your payment plan:
      </p>
      <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:10px 20px;background-color:#003366;color:white;text-decoration:none;border-radius:4px;font-weight:bold;font-size:14px;">
        üè† Open Mortgage Calculator
      </a>
      <p style="margin:10px 0 0 0;color:#666;font-size:12px;">
        The calculator allows you to adjust property price, downpayment, loan term, and interest rate to see real-time payment estimates.
      </p>
    </div>
    
    <p style="color:#666;margin-top:15px;font-size:12px;line-height:1.3;">For detailed financial planning and consultation, please contact our advisors.</p>
    </div>`;

  const mortgageCalculatorEmail = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h3 style="color:#003366;margin-bottom:15px;font-size:18px;font-weight:600;">Your Personal Mortgage Calculator</h3>
      <p style="color:#333;margin-bottom:20px;font-size:14px;line-height:1.5;">
        Use our interactive mortgage calculator to plan your investment in Solano Hillside Residences:
      </p>
      
      <div style="text-align: center; margin: 25px 0;">
        <a href="${MORTGAGE_CALCULATOR_LINK}" style="display:inline-block;padding:15px 30px;background-color:#003366;color:white;text-decoration:none;border-radius:8px;font-weight:bold;font-size:16px;">
          üè† Open Mortgage Calculator
        </a>
      </div>
      
      <div style="background:#f8f9fa;padding:20px;border-radius:8px;border-left:4px solid #a57934;margin:20px 0;">
        <h4 style="color:#a57934;margin:0 0 10px 0;font-size:16px;">What You Can Calculate:</h4>
        <ul style="color:#333;margin:0;padding-left:20px;font-size:14px;line-height:1.6;">
          <li>Custom monthly payments based on your budget</li>
          <li>Different downpayment options (10%, 20%, 30%)</li>
          <li>Various loan terms (5, 10, 15, 20 years)</li>
          <li>Total interest payments</li>
          <li>Amortization schedule</li>
        </ul>
      </div>
      
      <p style="color:#666;margin-top:20px;font-size:13px;line-height:1.5;">
        Need assistance? Our financial advisors are ready to help you understand your options.
      </p>
    </div>
  `;


  const inquiryTopicMap = {
    payment: "Payment / Price",
    interested_1b: "I'm interested in 1 Bedroom unit",
    interested_2b: "I'm interested in 2 Bedroom unit",
    interested_both: "I'm interested in both bedroom unit",
    other: "Other (explain in message)"
  };

  const paymentInfoMap = {
    downpayment: "Downpayment",
    monthly_amortization: "Monthly Amortization",
    total_price: "Total Price",
    payment_terms: "Payment Terms",
    other_payment: "Other (explain in message)"
  };

  // ========== UTILITY FUNCTIONS ==========
  const Toast = {
    show: (message, type = 'info', duration = 3000) => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), duration);
    }
  };

  const retryOperation = async (operation, maxRetries = 3, delay = 1000) => {
    for (let i = 0; i < maxRetries; i++) {
      try {
        return await operation();
      } catch (error) {
        if (i === maxRetries - 1) throw error;
        await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
      }
    }
  };

  const FileHandler = {
    formatFileSize: (bytes) => {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },
    getFileIcon: (fileName) => {
      const extension = fileName.split('.').pop().toLowerCase();
      const icons = { pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', xls: 'üìä', xlsx: 'üìä', ppt: 'üìΩÔ∏è', pptx: 'üìΩÔ∏è', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è', txt: 'üìÑ', zip: 'üóúÔ∏è', rar: 'üóúÔ∏è' };
      return icons[extension] || 'üìé';
    },
    isValidFile: (file) => {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation', 'text/plain', 'application/zip', 'application/x-rar-compressed'];
      const maxSize = 10 * 1024 * 1024;
      if (!validTypes.includes(file.type)) {
        Toast.show(`File type not supported: ${file.name}`, 'error');
        return false;
      }
      if (file.size > maxSize) {
        Toast.show(`File too large: ${file.name} (max 10MB)`, 'error');
        return false;
      }
      return true;
    }
  };

  const EmailService = {
    send: async (email, name, subject, message, attachments = []) => {
      try {
        const templateParams = { to_email: email, to_name: name, from_name: "Solano Hills Project Manager", subject, message };
        if (attachments.length > 0) {
          console.log('Attachments:', attachments);
          Toast.show('Note: File attachments require backend setup', 'info');
        }
        const response = await emailjs.send("service_u1n5d9t", "template_f2fwz7a", templateParams);
        return { success: true, data: response };
      } catch (error) {
        console.error("EmailJS Error:", error);
        return { success: false, error: error.text || error.message || "Failed to send email" };
      }
    },
    sendCustom: async (email, name, subject, message, attachments = []) => await EmailService.send(email, name, subject, message, attachments),
    sendEnhanced: async (email, name, subject, message) => await EmailService.send(email, name, subject, message)
  };

  const formatCurrency = (amount) => !amount && amount !== 0 ? '‚Ç± 0' : '‚Ç± ' + amount.toLocaleString('en-PH', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  const formatCurrencyDecimal = (amount) => !amount && amount !== 0 ? '‚Ç± 0.00' : '‚Ç± ' + amount.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // ========== VIEW TOGGLE ==========
  document.getElementById('toggleViewBtn').addEventListener('click', () => { currentView = 'all'; loadData(); });
  document.getElementById('showInquiriesBtn').addEventListener('click', () => { currentView = 'inquiries'; loadData(); });
  document.getElementById('showCalculationsBtn').addEventListener('click', () => { currentView = 'calculations'; loadData(); });

  // ========== COMPOSE PANEL ==========
  function setupComposePanel() {
    const composePanel = document.getElementById('composePanel');
    const closeComposeBtn = document.getElementById('closeComposeBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const send1BedPricelistBtn = document.getElementById('send1BedPricelistBtn');
    const send2BedPricelistBtn = document.getElementById('send2BedPricelistBtn');
    const sendMortgageLinkBtn = document.getElementById('sendMortgageLinkBtn');
    const composeAttachment = document.getElementById('composeAttachment');
    const selectedFilesContainer = document.getElementById('selectedFiles');
    const fileListContainer = document.getElementById('fileList');
    const composeStatus = document.getElementById('composeStatus');
    const emailTemplateBtns = document.querySelectorAll('.emailTemplateBtn');
    
    let selectedFiles = [];

    function initFileAttachment() {
      composeAttachment.addEventListener('change', (e) => {
        Array.from(e.target.files).forEach(file => {
          if (FileHandler.isValidFile(file) && !selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
          }
        });
        updateFileList();
      });

      const fileUploadArea = composeAttachment.parentElement.querySelector('div');
      fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#003366'; fileUploadArea.style.background = '#f0f7ff'; });
      fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#ccc'; fileUploadArea.style.background = 'white'; });
      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#ccc';
        fileUploadArea.style.background = 'white';
        Array.from(e.dataTransfer.files).forEach(file => {
          if (FileHandler.isValidFile(file) && !selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
          }
        });
        updateFileList();
      });
    }

    function updateFileList() {
      if (selectedFiles.length === 0) {
        selectedFilesContainer.style.display = 'none';
        fileListContainer.innerHTML = '';
        return;
      }
      selectedFilesContainer.style.display = 'block';
      let fileListHTML = '';
      selectedFiles.forEach((file, index) => {
        const fileIcon = FileHandler.getFileIcon(file.name);
        const fileSize = FileHandler.formatFileSize(file.size);
        fileListHTML += `<div class="file-item"><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 14px;">${fileIcon}</span><div><div style="font-weight: 500; color: #333;">${file.name}</div><div style="color: #666; font-size: 11px;">${fileSize}</div></div></div><span class="remove-file" onclick="removeSelectedFile(${index})">‚úï</span></div>`;
      });
      fileListContainer.innerHTML = fileListHTML;
    }

    window.removeSelectedFile = function(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => dataTransfer.items.add(file));
      composeAttachment.files = dataTransfer.files;
    };

    emailTemplateBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        if (emailTemplates[template]) {
          const templateData = emailTemplates[template];
          document.getElementById('composeSubject').value = templateData.subject;
          document.getElementById('composeMessage').value = templateData.message;
          Toast.show(`Loaded "${btn.textContent}" template`, 'info', 2000);
          setTimeout(() => document.getElementById('composeMessage').focus(), 100);
        }
      });
    });

    closeComposeBtn.addEventListener('click', () => {
      composePanel.style.display = 'none';
      composeStatus.textContent = '';
      selectedFiles = [];
      composeAttachment.value = '';
      updateFileList();
    });

    const sendEmail = async (type) => {
      const toEmail = document.getElementById('composeEmailTo').value.trim();
      if (!toEmail) { Toast.show('Please enter recipient email', 'error'); return; }

      let buttonToUse = sendEmailBtn;
      if (type === '1bed') buttonToUse = send1BedPricelistBtn;
      if (type === '2bed') buttonToUse = send2BedPricelistBtn;
      if (type === 'mortgage') buttonToUse = sendMortgageLinkBtn;

      const originalText = buttonToUse.textContent;
      buttonToUse.textContent = 'Sending...';
      buttonToUse.disabled = true;
      composeStatus.textContent = '';

      try {
        let result;
        switch(type) {
          case 'custom':
            const subject = document.getElementById('composeSubject').value.trim();
            const message = document.getElementById('composeMessage').value.trim();
            if (!subject || !message) { Toast.show('Please fill in all fields', 'error'); buttonToUse.textContent = originalText; buttonToUse.disabled = false; return; }
            result = await EmailService.sendCustom(toEmail, 'Client', subject, message, selectedFiles);
            break;
          case '1bed': result = await EmailService.sendEnhanced(toEmail, 'Client', '1 Bedroom Unit Pricelist', pricelist1Bedroom); break;
          case '2bed': result = await EmailService.sendEnhanced(toEmail, 'Client', '2 Bedroom Unit Pricelist', pricelist2Bedroom); break;
          case 'mortgage': result = await EmailService.sendEnhanced(toEmail, 'Client', 'Your Personal Mortgage Calculator', mortgageCalculatorEmail); break;
        }
        
        if (result.success) {
          Toast.show('Email sent successfully!', 'success');
          composeStatus.textContent = '‚úì Email sent successfully!';
          composeStatus.style.color = '#4CAF50';
          setTimeout(() => {
            composePanel.style.display = 'none';
            document.getElementById('composeEmailTo').value = '';
            document.getElementById('composeSubject').value = '';
            document.getElementById('composeMessage').value = '';
            composeStatus.textContent = '';
            selectedFiles = [];
            composeAttachment.value = '';
            updateFileList();
          }, 1500);
        } else {
          Toast.show(`Failed to send email: ${result.error}`, 'error');
          composeStatus.textContent = `‚úó Error: ${result.error}`;
          composeStatus.style.color = '#f44336';
        }
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
        composeStatus.textContent = `‚úó Error: ${error.message}`;
        composeStatus.style.color = '#f44336';
      } finally {
        buttonToUse.textContent = originalText;
        buttonToUse.disabled = false;
      }
    };

    sendEmailBtn.addEventListener('click', () => sendEmail('custom'));
    send1BedPricelistBtn.addEventListener('click', () => sendEmail('1bed'));
    send2BedPricelistBtn.addEventListener('click', () => sendEmail('2bed'));
    sendMortgageLinkBtn.addEventListener('click', () => sendEmail('mortgage'));
    initFileAttachment();
  }

  // ========== MESSAGES PANEL ==========
  function setupMessagesPanel() {
    const messagesPanel = document.getElementById('messagesPopupPanel');
    const closeMessagesPanelBtn = document.getElementById('closeMessagesPanelBtn');
    const sendReplyBtn = document.getElementById('sendReplyBtn');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');
    const quickReplyBtns = document.querySelectorAll('.quickReplyBtn');
    
    closeMessagesPanelBtn.addEventListener('click', () => messagesPanel.style.display = 'none');
    cancelReplyBtn.addEventListener('click', () => document.getElementById('replyMessage').value = '');
    
    sendReplyBtn.addEventListener('click', async () => {
      const replyMessage = document.getElementById('replyMessage').value.trim();
      const currentInquiryId = messagesPanel.dataset.inquiryId;
      if (!replyMessage) { Toast.show('Please enter a reply message', 'error'); return; }

      const originalText = sendReplyBtn.textContent;
      sendReplyBtn.textContent = 'Sending...';
      sendReplyBtn.disabled = true;
      const replyStatus = document.getElementById('replyStatus');
      replyStatus.textContent = '';

      try {
        await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
          sender: "admin", senderName: "Project Manager", content: replyMessage,
          timestamp: serverTimestamp(), readByPM: true, readByUser: false
        });
        await updateDoc(doc(db, "inquiries", currentInquiryId), { status: "responded" });
        document.getElementById('replyMessage').value = '';
        await loadInquiryMessages(currentInquiryId);
        Toast.show('Reply sent successfully!', 'success');
        replyStatus.textContent = '‚úì Reply sent successfully!';
        replyStatus.style.color = '#4CAF50';
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
        replyStatus.textContent = `‚úó Error: ${error.message}`;
        replyStatus.style.color = '#f44336';
      } finally {
        sendReplyBtn.textContent = originalText;
        sendReplyBtn.disabled = false;
      }
    });
    
    quickReplyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        let message = '';
        switch(template) {
          case 'thankyou': message = `Thank you for your inquiry about Solano Hillside Residences. We appreciate your interest Ill satisfy all your questions just ask`; break;
          case 'followup': message = `I'm following up on your recent inquiry about our properties, you have contacted me again do you any further questions?`; break;
          case 'pricelist': message = `As requested, I have sent the price details for our units in your gmail please check your inbox`; break;
          case 'appointment': message = `Would you be available for a site viewing this week? please state your preferred date and I will make time for you`; break;
        }
        document.getElementById('replyMessage').value = message;
      });
    });
    
    messagesPanel.addEventListener('click', (e) => { if (e.target === messagesPanel) messagesPanel.style.display = 'none'; });
  }

  // ========== MESSAGES FUNCTIONS ==========
  window.viewInquiryMessages = async function(inquiryId) {
    try {
      const messagesPanel = document.getElementById('messagesPopupPanel');
      const messagesContainer = document.getElementById('messagesContainer');
      const panelTitle = document.getElementById('messagesPanelTitle');
      
      messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading messages...</div>';
      messagesPanel.style.display = 'flex';
      
      const inquiryDoc = await retryOperation(() => getDoc(doc(db, "inquiries", inquiryId)));
      if (!inquiryDoc.exists()) { Toast.show('Inquiry not found', 'error'); messagesContainer.innerHTML = '<div style="color: #f44336; text-align: center; padding: 40px;">Inquiry not found</div>'; return; }
      
      const inquiryData = inquiryDoc.data();
      panelTitle.textContent = `Messages with ${inquiryData.name || 'Client'}`;
      messagesPanel.dataset.inquiryId = inquiryId;
      messagesPanel.dataset.recipientEmail = inquiryData.email;
      messagesPanel.dataset.recipientName = inquiryData.name || 'Client';
      await loadInquiryMessages(inquiryId);
    } catch (error) {
      console.error('Error loading messages:', error);
      Toast.show(`Failed to load messages: ${error.message}`, 'error');
      document.getElementById('messagesContainer').innerHTML = `<div style="color: #f44336; padding: 40px; text-align: center;">Failed to load messages. Please try again.</div>`;
    }
  };

  async function loadInquiryMessages(inquiryId) {
    const messagesContainer = document.getElementById('messagesContainer');
    try {
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      const inquiryData = inquiryDoc.data();
      const messagesSnapshot = await getDocs(query(collection(db, "inquiries", inquiryId, "messages"), orderBy("timestamp", "asc")));
      
      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || "No topic selected";
      const paymentInfoText = paymentInfoMap[inquiryData.payment_info] || "";
      const inquiryDate = inquiryData.createdAt?.toDate ? inquiryData.createdAt.toDate().toLocaleString() : 'Not available';
      
      let messagesHTML = `<div style="margin-bottom: 20px;"><div style="background: #e8d4a6; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;"><div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><strong style="color: #2e7d32;">${inquiryData.name || 'Client'}</strong><small style="color: #666;">${inquiryDate}</small></div><div style="margin-bottom: 10px; color: #333;"><strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}<strong style="color: #003366;">Email:</strong> ${inquiryData.email}<br/><strong style="color: #003366;">Phone:</strong> ${inquiryData.number || 'Not provided'}<br/><strong style="color: #003366;">Employment:</strong> ${inquiryData.Employement_Type || 'Not provided'}</div><div style="background: #d4b97a; padding: 10px; border-radius: 4px; margin-top: 10px; color: #333;"><strong style="color: #003366;">Original Message:</strong><br/>${inquiryData.inquiry_topic === 'other' && inquiryData.other_inquiry ? inquiryData.other_inquiry : 'Client expressed interest in our properties.'}</div><div style="margin-top: 10px; font-size: 12px; color: #666;">Status: <span style="color: ${inquiryData.status === 'responded' ? '#4CAF50' : '#ff9800'}; font-weight: bold;">${inquiryData.status || 'new'}</span></div></div></div>`;
      
      if (!messagesSnapshot.empty) {
        messagesHTML += '<h4 style="color: #003366; margin: 20px 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Chat History</h4>';
        messagesSnapshot.forEach(doc => {
          const message = doc.data();
          const messageDate = message.timestamp?.toDate ? message.timestamp.toDate().toLocaleString() : 'Not available';
          const isAdmin = message.sender === "admin";
          const senderName = isAdmin ? "You (Admin)" : (inquiryData.name || 'Client');
          const bgColor = isAdmin ? '#d4e6f1' : '#f8f4e9';
          const borderColor = isAdmin ? '#2196F3' : '#a57934';
          const textColor = isAdmin ? '#1565c0' : '#333';
          messagesHTML += `<div style="margin-bottom: 15px;"><div style="background: ${bgColor}; padding: 12px; border-radius: 8px; border-left: 4px solid ${borderColor}; margin-left: ${isAdmin ? '40px' : '0'};"><div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><strong style="color: ${textColor}">${senderName}</strong><small style="color: #666;">${messageDate}</small></div><div style="color: #333;">${message.content}</div>${message.senderName ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">Sent by: ${message.senderName}</div>` : ''}</div></div>`;
        });
      } else {
        messagesHTML += `<div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">No messages yet. Send the first message to start the conversation.</div>`;
      }
      messagesContainer.innerHTML = messagesHTML;
    } catch (error) {
      messagesContainer.innerHTML = `<div style="color: #f44336; padding: 40px; text-align: center;">Failed to load messages. Please try again.</div>`;
    }
  }

  // ========== DATA LOADING ==========
  async function checkInquiryHasMessages(inquiryId) {
    try {
      const messagesSnapshot = await getDocs(collection(db, "inquiries", inquiryId, "messages"));
      return !messagesSnapshot.empty;
    } catch (error) {
      console.error("Error checking messages:", error);
      return false;
    }
  }

  async function loadData() {
    try {
      dataContainer.innerHTML = '';
      const [inquiriesSnapshot, calculationsSnapshot] = await Promise.all([
        retryOperation(() => getDocs(query(collection(db, "inquiries"), orderBy("createdAt", "desc")))),
        retryOperation(() => getDocs(query(collection(db, "mortgage_calculations"), orderBy("createdAt", "desc"))))
      ]);

      const inquiriesData = inquiriesSnapshot.docs.map(doc => ({ id: doc.id, type: 'inquiry', data: doc.data(), createdAt: doc.data().createdAt }));
      const calculationsData = calculationsSnapshot.docs.map(doc => ({ id: doc.id, type: 'calculation', data: doc.data(), createdAt: doc.data().createdAt }));
      const allData = [...inquiriesData, ...calculationsData].sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());

      let filteredData = allData;
      if (currentView === 'inquiries') {
        filteredData = allData.filter(item => item.type === 'inquiry');
        document.getElementById('toggleViewBtn').textContent = 'Show: Inquiries Only';
      } else if (currentView === 'calculations') {
        filteredData = allData.filter(item => item.type === 'calculation');
        document.getElementById('toggleViewBtn').textContent = 'Show: Calculations Only';
      } else {
        document.getElementById('toggleViewBtn').textContent = 'Show: All';
      }

      if (filteredData.length === 0) {
        dataContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;"><p style="font-size: 16px; margin-bottom: 10px;">No ${currentView === 'all' ? 'data' : currentView} yet.</p><p style="font-size: 14px; color: #999;">Check back later for new inquiries and calculations.</p></div>`;
        return;
      }

      const emailGroups = {};
      filteredData.forEach(item => {
        const email = item.data.email;
        if (!emailGroups[email]) emailGroups[email] = { email, name: item.data.name || 'Not provided', inquiries: [], calculations: [] };
        if (item.type === 'inquiry') emailGroups[email].inquiries.push(item);
        else if (item.type === 'calculation') emailGroups[email].calculations.push(item);
      });

      dataContainer.innerHTML = '';
      for (const [email, group] of Object.entries(emailGroups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'email-group';
        let groupHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><div><strong style="color: #003366; font-size: 16px;">${group.name}</strong><br/><strong style="color: #333;">Email:</strong> <span style="color: #333;">${group.email}</span><br/></div><div style="text-align: right;"><span class="badge badge-inquiry">${group.inquiries.length} Inquiry${group.inquiries.length !== 1 ? 'ies' : ''}</span><span class="badge badge-calculation">${group.calculations.length} Calculation${group.calculations.length !== 1 ? 's' : ''}</span></div></div>`;

        if (group.inquiries.length > 0) {
          groupHTML += `<h4 style="color: #a57934; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Inquiries</h4>`;
          for (const inquiry of group.inquiries) {
            const inquiryTopicText = inquiryTopicMap[inquiry.data.inquiry_topic] || "No topic selected";
            const paymentInfoText = paymentInfoMap[inquiry.data.payment_info] || "";
            const inquiryDate = inquiry.data.createdAt?.toDate ? inquiry.data.createdAt.toDate().toLocaleString() : 'Not available';
            const hasMessages = await checkInquiryHasMessages(inquiry.id);
            const statusColor = inquiry.data.status === 'responded' ? '#4CAF50' : inquiry.data.status === 'pending' ? '#ff9800' : '#f44336';
            groupHTML += `<div class="inquiry-item"><div style="display: flex; justify-content: space-between; align-items: flex-start;"><div style="flex: 1; color: #333;"><strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}<strong style="color: #003366;">Date:</strong> ${inquiryDate}<br/><strong style="color: #003366;">Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${inquiry.data.status || 'new'}${hasMessages ? ' (has messages)' : ''}</span></div><div style="display: flex; flex-direction: column; gap: 5px;"><button onclick="viewInquiryMessages('${inquiry.id}')" class="action-btn btn-chat">${hasMessages ? 'View Chat' : 'Start Chat'}</button><button onclick="sendEmailTo('${inquiry.data.email}', '${inquiry.data.name}', 'inquiry')" class="action-btn btn-email">Send Email</button></div></div></div>`;
          }
        }

        if (group.calculations.length > 0) {
          groupHTML += `<h4 style="color: #2e7d32; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Mortgage Calculations</h4>`;
          group.calculations.forEach(calc => {
            const calcData = calc.data;
            const calcSummary = calcData.formatted || {};
            groupHTML += `<div class="calculation-item"><div style="display: flex; justify-content: space-between; color: #333;"><div><strong style="color: #003366;">Property Price:</strong> ${calcSummary.propertyPrice || formatCurrency(calcData.propertyPrice)}<br/><strong style="color: #003366;">Downpayment:</strong> ${calcData.downpaymentPercent}% (${calcSummary.downpayment || formatCurrency(calcData.downpaymentAmount)})<br/><strong style="color: #003366;">Loan Amount:</strong> ${calcSummary.loanAmount || formatCurrency(calcData.loanAmount)}<br/></div><div><strong style="color: #003366;">Monthly Payment:</strong> ${calcSummary.monthlyPayment || formatCurrencyDecimal(calcData.monthlyPayment)}<br/><strong style="color: #003366;">Term:</strong> ${calcData.loanTermYears} years @ ${calcData.interestRate}%<br/><strong style="color: #003366;">Total Interest:</strong> ${calcSummary.totalInterest || formatCurrency(calcData.totalInterest)}<br/></div></div><div style="margin-top: 10px; font-size: 12px; color: #666;"><strong>Calculation Date:</strong> ${new Date(calcData.calculationDate).toLocaleString()}<br/><strong>Phone:</strong> ${calcData.phone || 'Not provided'}<br/>${calcData.isExistingClient ? '<span style="color: #a57934; font-weight: bold;">‚òÖ Existing Client</span>' : ''}</div><div style="margin-top: 10px;"><button onclick="deleteCalculation('${calc.id}')" class="action-btn btn-delete">Delete</button></div></div>`;
          });
        }

        groupDiv.innerHTML = groupHTML;
        dataContainer.appendChild(groupDiv);
      }

      Toast.show(`Loaded ${filteredData.length} items`, 'info', 2000);
    } catch (error) {
      console.error('Error loading data:', error);
      Toast.show(`Failed to load data: ${error.message}`, 'error');
      dataContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: #f44336;"><p style="font-size: 16px; margin-bottom: 10px;">Failed to load data</p><p style="font-size: 14px; color: #999; margin-bottom: 20px;">${error.message}</p><button onclick="loadData()" class="action-btn btn-chat">Retry Loading</button></div>`;
    }
  }

  // ========== GLOBAL FUNCTIONS ==========
  window.sendEmailTo = function(email, name, type = 'general') {
    const composePanel = document.getElementById('composePanel');
    const composeEmailTo = document.getElementById('composeEmailTo');
    const composeSubject = document.getElementById('composeSubject');
    composeEmailTo.value = email;
    composeSubject.value = type === 'inquiry' ? `Regarding your inquiry - ${name}` : `Message from Solano Hills - ${name}`;
    composePanel.style.display = 'block';
    setTimeout(() => document.getElementById('composeMessage').focus(), 100);
  };

  window.sendCalculationTo = async function(email, name, calcId) {
    try {
      const docSnap = await retryOperation(() => getDoc(doc(db, "mortgage_calculations", calcId)));
      if (docSnap.exists()) {
        const calcData = docSnap.data();
        const emailBody = `Dear ${name},\n\nThank you for using our mortgage calculator...\n\n${MORTGAGE_CALCULATOR_LINK}\n\nBest regards,\nPHINMA Properties Team`;
        const composePanel = document.getElementById('composePanel');
        const composeEmailTo = document.getElementById('composeEmailTo');
        const composeSubject = document.getElementById('composeSubject');
        const composeMessage = document.getElementById('composeMessage');
        composeEmailTo.value = email;
        composeSubject.value = `Your Mortgage Calculation - Solano Hillside Residences`;
        composeMessage.value = emailBody;
        composePanel.style.display = 'block';
        setTimeout(() => document.getElementById('composeMessage').focus(), 100);
        Toast.show('Calculation loaded successfully', 'success');
      } else {
        Toast.show('Calculation not found', 'error');
      }
    } catch (error) {
      Toast.show(`Error: ${error.message}`, 'error');
    }
  };

  window.deleteCalculation = async function(calcId) {
    if (confirm('Are you sure you want to delete this mortgage calculation?')) {
      try {
        await deleteDoc(doc(db, "mortgage_calculations", calcId));
        Toast.show('Calculation deleted successfully', 'success');
        setTimeout(() => loadData(), 500);
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
      }
    }
  };

  // ========== INITIALIZATION ==========
  setupComposePanel();
  setupMessagesPanel();
  loadData();

  break;
  
  
  case "document":
  mainContent.innerHTML = `
    <h1>Upload Client Documents</h1>
    <p>Type your name/description, input quantity of required bedroom units, select payment terms, and attach exactly 8 files below:</p>

    <form id="uploadForm" style="display:flex; flex-direction:column; gap:10px; max-width: 400px;">
      <input type="text" id="name" placeholder="Client Name" required style="padding:8px; width: 80%;" />

      <!-- Number of 1 Bedroom units -->
      <label style="font-weight:600;">Number of 1 Bedroom Units:</label>
      <input type="number" id="num1Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Number of 2 Bedroom units -->
      <label style="font-weight:600;">Number of 2 Bedroom Units:</label>
      <input type="number" id="num2Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Payment Terms Dropdown -->
      <label style="font-weight:600;">Select Payment Terms:</label>
      <select id="paymentTerms" required style="padding:8px; width: 80%; margin-bottom:10px;">
        <option value="" disabled selected>-- Select Payment Terms --</option>
        <option value="Monthly">Monthly</option>
        <option value="Cash">Cash</option>
      </select>

      <!-- File inputs -->
      ${[...Array(8)].map((_, i) => `
        <input type="file" id="file${i+1}" required style="padding:8px; width:80%;" />
      `).join('')}

      <button type="submit" style="
        padding: 12px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: fit-content;
      ">Upload</button>
    </form>

    <div id="status" style="margin-top:10px;"></div>
    <h2>Upload History</h2>
    <div id="uploadHistory" style="margin-top:10px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
  `;

  const form = document.getElementById("uploadForm");
  const uploadHistory = document.getElementById("uploadHistory");
  const statusDiv = document.getElementById("status");
  const nameInput = document.getElementById("name");
  const paymentTermsSelect = document.getElementById("paymentTerms");
  const num1BedroomInput = document.getElementById("num1Bedroom");
  const num2BedroomInput = document.getElementById("num2Bedroom");
  const fileInputs = [...Array(8)].map((_, i) => document.getElementById(`file${i+1}`));

  const circumference = 2 * Math.PI * 45;

  function createProgressCircle() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "100");
    svg.setAttribute("height", "100");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.style.flexShrink = "0";

    const bgCircle = document.createElementNS(svgNS, "circle");
    bgCircle.setAttribute("cx", "50");
    bgCircle.setAttribute("cy", "50");
    bgCircle.setAttribute("r", "45");
    bgCircle.setAttribute("stroke", "#eee");
    bgCircle.setAttribute("stroke-width", "10");
    bgCircle.setAttribute("fill", "none");
    svg.appendChild(bgCircle);

    const progressCircle = document.createElementNS(svgNS, "circle");
    progressCircle.setAttribute("cx", "50");
    progressCircle.setAttribute("cy", "50");
    progressCircle.setAttribute("r", "45");
    progressCircle.setAttribute("stroke", "#4CAF50");
    progressCircle.setAttribute("stroke-width", "10");
    progressCircle.setAttribute("fill", "none");
    progressCircle.setAttribute("stroke-linecap", "round");
    progressCircle.setAttribute("stroke-dasharray", circumference);
    progressCircle.setAttribute("stroke-dashoffset", circumference);
    progressCircle.setAttribute("transform", "rotate(-90 50 50)");
    svg.appendChild(progressCircle);

    const progressText = document.createElementNS(svgNS, "text");
    progressText.setAttribute("x", "50");
    progressText.setAttribute("y", "55");
    progressText.setAttribute("font-size", "20");
    progressText.setAttribute("text-anchor", "middle");
    progressText.setAttribute("fill", "white");
    progressText.textContent = "0%";
    svg.appendChild(progressText);

    return { svg, progressCircle, progressText };
  }

  function setCircleProgress(circle, text, percent) {
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    text.textContent = `${Math.round(percent)}%`;
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
    uploadHistory.innerHTML = "";
    if (!history.length) {
      uploadHistory.innerHTML = "<p>No upload history yet.</p>";
      return;
    }

    history.forEach(entry => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ddd";
      div.style.marginBottom = "12px";
      div.style.paddingBottom = "12px";
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.gap = "12px";
      div.style.justifyContent = "space-between";

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `
        <strong>${entry.name}</strong><br/>
        <small><em>1 Bedroom Units: ${entry.num1Bedroom}</em></small><br/>
        <small><em>2 Bedroom Units: ${entry.num2Bedroom}</em></small><br/>
        <small><em>${entry.paymentTerms}</em></small><br/>
        <small><em>Uploaded at ${entry.time}</em></small>
        <ul style="margin: 8px 0 0 20px; padding-left: 0; list-style: disc;">
          ${entry.files.map(f => `<li>${f}</li>`).join("")}
        </ul>
        <p style="margin-top:8px; font-weight:600; color:#2e7d32;">
          The client is ready for account creation.
        </p>
      `;

      const { svg, progressCircle, progressText } = createProgressCircle();
      setCircleProgress(progressCircle, progressText, 100);

      div.appendChild(contentDiv);
      div.appendChild(svg);
      uploadHistory.appendChild(div);
    });
  }

  loadHistory();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const paymentTerms = paymentTermsSelect.value;
    const num1Bedroom = Number(num1BedroomInput.value);
    const num2Bedroom = Number(num2BedroomInput.value);

    if (num1Bedroom < 0 || num2Bedroom < 0) {
      alert("Bedroom unit counts cannot be negative.");
      return;
    }

    if (!paymentTerms) {
      alert("Please select a payment term.");
      return;
    }

    statusDiv.textContent = "Uploading files to Cloudinary...";

    let totalSize = 0;
    const files = fileInputs.map(f => f.files[0]);
    for (let i = 0; i < files.length; i++) {
      if (!files[i]) {
        alert(`Missing file #${i+1}`);
        return;
      }
      totalSize += files[i].size;
    }

    let uploadedSize = 0;
    const uploadedUrls = [];
    const uploadedFileNames = [];

    const tempDiv = document.createElement("div");
    tempDiv.style.display = "flex";
    tempDiv.style.justifyContent = "space-between";
    tempDiv.style.alignItems = "center";
    tempDiv.style.borderBottom = "1px solid #ddd";
    tempDiv.style.paddingBottom = "12px";
    tempDiv.style.marginBottom = "12px";

    const tempContentDiv = document.createElement("div");
    tempContentDiv.innerHTML = `<strong>${name}</strong><br/><small>Uploading...</small>`;
    const { svg, progressCircle, progressText } = createProgressCircle();

    tempDiv.appendChild(tempContentDiv);
    tempDiv.appendChild(svg);
    uploadHistory.prepend(tempDiv);

    // Upload
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "upload_preset");

      try {
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "https://api.cloudinary.com/v1_1/dfklsyjch/upload");

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = ((uploadedSize + event.loaded) / totalSize) * 100;
              setCircleProgress(progressCircle, progressText, percent);
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              const data = JSON.parse(xhr.responseText);
              uploadedUrls.push(data.secure_url);
              uploadedFileNames.push(file.name);
              uploadedSize += file.size;
              resolve();
            } else reject();
          };

          xhr.onerror = () => reject();
          xhr.send(formData);
        });
      } catch {
        statusDiv.textContent = "Upload failed.";
        return;
      }
    }

    statusDiv.textContent = "Sending email...";

    // Prepare email
    const templateParams = {
      name,
      paymentTerms,
      num1Bedroom,
      num2Bedroom,
      time: new Date().toLocaleString(),
      message: `
        <p>1 Bedroom Units: ${num1Bedroom}</p>
        <p>2 Bedroom Units: ${num2Bedroom}</p>
        <p>Payment Terms: ${paymentTerms}</p>
        <p>Files:</p>
        ${uploadedUrls.map((u, i) => `<a href="${u}">${uploadedFileNames[i]}</a>`).join("<br>")}
      `
    };

    try {
      await emailjs.send("service_u1n5d9t", "template_qu1s2lh", templateParams);

      statusDiv.textContent = "Email sent!";
      uploadHistory.removeChild(tempDiv);

      // Save history
      const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
      history.unshift({
        name,
        paymentTerms,
        num1Bedroom,
        num2Bedroom,
        time: new Date().toLocaleString(),
        files: uploadedFileNames
      });

      if (history.length > 10) history.pop();
      localStorage.setItem("uploadHistory", JSON.stringify(history));
      loadHistory();

      form.reset();
    } catch {
      statusDiv.textContent = "Email sending failed.";
    }
  });
  break;

        /* ================= DEFAULT ================= */
        default:
          mainContent.innerHTML = "<h1>Welcome</h1><p>Select an option from the sidebar.</p>";
      }
    };

    // ================= AUTHENTICATION CHECK =================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("You're not signed in. Redirecting to login...");
        window.location.href = "index.html";
        return;
      }
      // Show welcome message
      const greeting = document.getElementById("Greeting");
      const nameToShow = user.displayName || user.email;
      if (greeting) greeting.textContent = `Welcome Back!, ${nameToShow}`;
    });

    // ================= AUTO LOAD DASHBOARD ON PAGE OPEN =================
    window.addEventListener("load", () => {
      loadContent(null, "dashboard");

      // highlight sidebar tab
      document.querySelectorAll(".sidebar nav ul li a").forEach(link =>
        link.classList.remove("active")
      );
      document.querySelector(".sidebar nav ul li a[href='#']").classList.add("active");
    });

    // ================= SHOW REPLY FORM =================
    window.showReplyForm = function (email, id) {
      document.getElementById(`reply-${id}`).style.display = "block";
    };

    // ================= SEND REPLY =================
    window.sendReply = async function (toEmail, id, toName) {
      const replyText = document.getElementById(`replyText-${id}`).value.trim();
      if (!replyText) {
        alert("Please type a reply message.");
        return;
      }

      // Prepare data for backend with correct keys
      const payload = {
        to: toEmail,                  // was toEmail
        from: "your-email@gmail.com", // was fromEmail; replace with your actual sender email
        subject: `Reply from Project Manager to ${toName}`,
        message: replyText
      };

      try {
        const response = await fetch("http://localhost:3000/send-reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply.");
        }

        alert("Reply sent successfully to " + toEmail);

        const messageRef = doc(db, "messages", id);
        await updateDoc(messageRef, { replied: true });

        await addDoc(collection(db, "sentReplies"), {
          to: toEmail,
          message: replyText,
          timestamp: new Date()
        });

        document.getElementById(`reply-${id}`).style.display = "none";
        document.getElementById(`replyText-${id}`).value = "";

        loadContent(null, "inbox");

      } catch (error) {
        console.error("Error sending reply:", error);
        alert("Failed to send reply: " + error.message);
      }
    };


  </script>
</body>
</html>


