<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Manager Dashboard</title>
  <link rel="stylesheet" href="PM-dasboard.css" />
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" id="showInboxBtn" onclick="loadContent(event, 'inbox')">Inquiries</a></li>
        <li><a href="#" onclick="loadContent(event, 'document')">Document</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="Greeting">Welcome Back!</h1>
      <p>Select a sidebar to start managing.</p>
    </div>
  </main>

  <!-- ======================== EMAILJS SDK ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("avvdJIIs04H8nGyu_");
    })();
  </script>

  <!-- ======================== FIREBASE & INBOX ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc,writeBatch, serverTimestamp, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");

    // ================= CONTENT LOADER =================
    window.loadContent = function (event, section) {
      if(event) event.preventDefault();

      // Remove active class and add to clicked
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => link.classList.remove("active"));
      if (event?.target?.tagName === "A") event.target.classList.add("active");

      mainContent.innerHTML = "";

      switch (section) {
        /* ================= DASHBOARD ================= */
        case "dashboard":
          mainContent.innerHTML = `
            <h1 id="Greeting1">Dashboard</h1>
            <div class="dashboard-container">
              
              <!-- ======== LEFT: WELCOME SLIDER ======== -->
              <div class="welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1"></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2"></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3"></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </div>

              <!-- ======== RIGHT: CALENDAR + INBOX ======== -->
              <div class="right-side">
                <div class="calendar-card">
                  <h3>ðŸ“… Calendar</h3>
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          `;

          // Image slider logic
          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);

            document.getElementById("sliderPrev").addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document.getElementById("sliderNext").addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(() => showSlidesLocal(++slideIndexLocal), 5000);
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl) sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          })();

          // Calendar logic
          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += "<tr><th class='cal-header' colspan='7'>" + monthName + " " + year + "</th></tr>";
              html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += "<td" + (isToday ? " class='today'" : "") + ">" + day + "</td>";
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) html += "</tr><tr>";
              }

              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();

          break;

        /* ================= INBOX ================= */
case "inbox":
  mainContent.innerHTML = `
    <h3 style="color: #ffff;">Inquiries & Mortgage Calculations</h3>
    <div style="margin-bottom: 20px;">
      <button id="toggleViewBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show: All
      </button>
      <button id="showInquiriesBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Inquiries Only
      </button>
      <button id="showCalculationsBtn" style="padding: 8px 16px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Show Calculations Only
      </button>
    </div>
    
    <!-- Messages Popup Panel -->
    <div id="messagesPopupPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; width: 80%; max-width: 800px; max-height: 80%; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
        <div style="background: #003366; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
          <h3 id="messagesPanelTitle" style="margin: 0; font-size: 18px; color: white;">Messages</h3>
          <button id="closeMessagesPanelBtn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
        </div>
        
        <div style="flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5;">
          <div id="messagesContainer" style="margin-bottom: 20px;">
            <!-- Messages will be loaded here -->
          </div>
          
          <!-- Reply Section -->
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <h4 style="margin-top: 0; color: #003366;">Send Reply</h4>
            <textarea id="replyMessage" 
                      placeholder="Type your reply here..." 
                      rows="6" 
                      style="width: 100%; 
                             padding: 10px; 
                             border: 1px solid #ccc; 
                             border-radius: 4px; 
                             margin-bottom: 10px; 
                             background: white; 
                             color: #333; 
                             white-space: pre-wrap;
                             line-height: 1.5;"></textarea>
            
            <!-- Quick Reply Templates -->
            <div style="margin-bottom: 15px;">
              <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">Quick Replies:</p>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="quickReplyBtn" data-template="thankyou" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Thank You
                </button>
                <button class="quickReplyBtn" data-template="followup" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Follow Up
                </button>
                <button class="quickReplyBtn" data-template="pricelist_1bed" style="padding: 6px 12px; background: #fff3e0; color: #a57934; border: 1px solid #ffe0b2; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Send 1-Bed Pricelist
                </button>
                <button class="quickReplyBtn" data-template="pricelist_2bed" style="padding: 6px 12px; background: #e3f2fd; color: #1976D2; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Send 2-Bed Pricelist
                </button>
                <button class="quickReplyBtn" data-template="appointment" style="padding: 6px 12px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  Schedule Appointment
                </button>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="sendReplyBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Send Reply
              </button>
              <button id="cancelReplyBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Cancel
              </button>
            </div>
            <div id="replyStatus" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="dataContainer"></div>
    
    <style>
      .email-group {
      }
      
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      
      .toast-success {
        background-color: #4CAF50;
      }
      
      .toast-error {
        background-color: #f44336;
      }
      
      .toast-info {
        background-color: #2196F3;
      }
    </style>
  `;

  const dataContainer = document.getElementById("dataContainer");
  let currentView = 'all'; // 'all', 'inquiries', 'calculations'
  
  // Mortgage Calculator Link
  const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";
  
  // Helper maps
  const inquiryTopicMap = {
    payment: "Payment / Price",
    interested_1b: "I'm interested in 1 Bedroom unit",
    interested_2b: "I'm interested in 2 Bedroom unit",
    interested_both: "I'm interested in both bedroom unit",
    other: "Other (explain in message)"
  };

  const paymentInfoMap = {
    downpayment: "Downpayment",
    monthly_amortization: "Monthly Amortization",
    total_price: "Total Price",
    payment_terms: "Payment Terms",
    other_payment: "Other (explain in message)"
  };

  // ========== UTILITY FUNCTIONS ==========

  // Toast notification system
  const Toast = {
    show: (message, type = 'info', duration = 3000) => {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, duration);
    }
  };

  // Currency formatting
  const formatCurrency = (amount) => {
    if (!amount && amount !== 0) return 'â‚± 0';
    return 'â‚± ' + amount.toLocaleString('en-PH', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  };

  const formatCurrencyDecimal = (amount) => {
    if (!amount && amount !== 0) return 'â‚± 0.00';
    return 'â‚± ' + amount.toLocaleString('en-PH', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  };

  // ========== VIEW TOGGLE FUNCTIONALITY ==========

  document.getElementById('toggleViewBtn').addEventListener('click', () => {
    currentView = 'all';
    loadData();
  });

  document.getElementById('showInquiriesBtn').addEventListener('click', () => {
    currentView = 'inquiries';
    loadData();
  });

  document.getElementById('showCalculationsBtn').addEventListener('click', () => {
    currentView = 'calculations';
    loadData();
  });

  // ========== MESSAGES PANEL ==========

  function setupMessagesPanel() {
    const messagesPanel = document.getElementById('messagesPopupPanel');
    const closeMessagesPanelBtn = document.getElementById('closeMessagesPanelBtn');
    const sendReplyBtn = document.getElementById('sendReplyBtn');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');
    const quickReplyBtns = document.querySelectorAll('.quickReplyBtn');
    
    // Close messages panel
    closeMessagesPanelBtn.addEventListener('click', () => {
      messagesPanel.style.display = 'none';
    });
    
    cancelReplyBtn.addEventListener('click', () => {
      document.getElementById('replyMessage').value = '';
    });
    
    // Send reply function
    sendReplyBtn.addEventListener('click', async () => {
      const replyMessage = document.getElementById('replyMessage').value.trim();
      const currentInquiryId = messagesPanel.dataset.inquiryId;

      if (!replyMessage) {
        Toast.show('Please enter a reply message', 'error');
        return;
      }

      const originalText = sendReplyBtn.textContent;
      sendReplyBtn.textContent = 'Sending...';
      sendReplyBtn.disabled = true;
      
      const replyStatus = document.getElementById('replyStatus');
      replyStatus.textContent = '';
      
      try {
        // Save reply to messages subcollection WITH senderId
        await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
          sender: "admin",
          senderName: "Project Manager",
          senderId: "admin_pm", // Required for Firestore rules
          content: replyMessage,
          timestamp: serverTimestamp(),
          readByPM: true,
          readByUser: false
        });

        // Update inquiry status
        await updateDoc(doc(db, "inquiries", currentInquiryId), {
          status: "responded"
        });

        // Clear reply field
        document.getElementById('replyMessage').value = '';

        // Reload messages
        await loadInquiryMessages(currentInquiryId);

        Toast.show('Reply sent successfully!', 'success');
        replyStatus.textContent = 'âœ“ Reply sent successfully!';
        replyStatus.style.color = '#4CAF50';
        
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
        replyStatus.textContent = `âœ— Error: ${error.message}`;
        replyStatus.style.color = '#f44336';
      } finally {
        sendReplyBtn.textContent = originalText;
        sendReplyBtn.disabled = false;
      }
    });
    
    // Quick reply templates
    quickReplyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const template = btn.dataset.template;
        let message = '';
        
        switch(template) {
          case 'thankyou':
            message = `Thank you for your inquiry about Solano Hillside Residences. We appreciate your interest in our properties and would be happy to assist you further with any questions you may have.`;
            break;
          case 'followup':
            message = `I'm following up on your recent inquiry about our properties. Are you still interested in learning more about our available units or would you like to schedule a site viewing?`;
            break;
          case 'pricelist_1bed':
            message = `Here are the details for our 1-Bedroom units:\n\nðŸ  1-BEDROOM UNIT DETAILS:\nâ€¢ Floor Area: 24-28 sqm\nâ€¢ Total Price: â‚±2.8M - â‚±3.2M\nâ€¢ Downpayment: â‚±150,000 (spot cash)\nâ€¢ Monthly: â‚±12,500 - â‚±14,000 (24-36 months)\n\nðŸ’¡ FINANCING OPTIONS:\nâ€¢ Bank Financing: 80% Loan-to-value ratio\nâ€¢ In-house: Flexible payment terms\nâ€¢ Pag-IBIG: Qualified units and buyers\n\nðŸ”— Calculate your personalized payments here:${MORTGAGE_CALCULATOR_LINK}\n`;
            break;
          case 'pricelist_2bed':
            message = `Here are the details for our 2-Bedroom units:\n\nðŸ  2-BEDROOM UNIT DETAILS:\nâ€¢ Floor Area: 36-42 sqm\nâ€¢ Total Price: â‚±3.8M - â‚±4.2M\nâ€¢ Downpayment: â‚±200,000 (spot cash)\nâ€¢ Monthly: â‚±16,800 - â‚±18,500 (24-36 months)\n\nðŸ’¡ FINANCING OPTIONS:\nâ€¢ Bank Financing: 80% Loan-to-value ratio\nâ€¢ In-house: Flexible payment terms\nâ€¢ Pag-IBIG: Qualified units and buyers\n\nðŸ”— Calculate your personalized payments here:${MORTGAGE_CALCULATOR_LINK}\n`;
            break;
          case 'appointment':
            message = `Want more details? schedule a site viewing this week, Please let me know your preferred date and time, and I'll arrange everything for you.\n\nðŸ“… Available Viewing Slots:\nMonday - Friday: 9:00 AM - 5:00 PM\nSaturday: 9:00 AM - 4:00 PM\nSunday: By special arrangement\n\nðŸ“ Location: Solano, Muntinlupa Paranaque\n\nLooking forward to showing you around!`;
            break;
        }
        
        document.getElementById('replyMessage').value = message;
        
        // Scroll to textarea
        document.getElementById('replyMessage').focus();
      });
    });
    
    // Close panel when clicking outside
    messagesPanel.addEventListener('click', (e) => {
      if (e.target === messagesPanel) {
        messagesPanel.style.display = 'none';
      }
    });
  }

  // ========== INQUIRY MESSAGES ==========

  window.viewInquiryMessages = async function(inquiryId) {
    try {
      const messagesPanel = document.getElementById('messagesPopupPanel');
      const messagesContainer = document.getElementById('messagesContainer');
      const panelTitle = document.getElementById('messagesPanelTitle');
      
      messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading messages...</div>';
      messagesPanel.style.display = 'flex';
      
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      
      if (!inquiryDoc.exists()) {
        Toast.show('Inquiry not found', 'error');
        messagesContainer.innerHTML = '<div style="color: #f44336; text-align: center; padding: 40px;">Inquiry not found</div>';
        return;
      }
      
      const inquiryData = inquiryDoc.data();
      panelTitle.textContent = `Messages with ${inquiryData.name || 'Client'}`;
      
      messagesPanel.dataset.inquiryId = inquiryId;
      
      await loadInquiryMessages(inquiryId);
      
    } catch (error) {
      console.error('Error loading messages:', error);
      Toast.show(`Failed to load messages: ${error.message}`, 'error');
      document.getElementById('messagesContainer').innerHTML = 
        `<div style="color: #f44336; padding: 40px; text-align: center;">
          Failed to load messages. Please try again.
        </div>`;
    }
  };

  async function loadInquiryMessages(inquiryId) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    try {
      const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
      const inquiryData = inquiryDoc.data();
      
      const messagesSnapshot = await getDocs(
        query(collection(db, "inquiries", inquiryId, "messages"), 
              orderBy("timestamp", "asc"))
      );
      
      let messagesHTML = '';
      
      // Display original inquiry
      const inquiryTopicText = inquiryTopicMap[inquiryData.inquiry_topic] || "No topic selected";
      const paymentInfoText = paymentInfoMap[inquiryData.payment_info] || "";
      const inquiryDate = inquiryData.createdAt?.toDate 
        ? inquiryData.createdAt.toDate().toLocaleString() 
        : 'Not available';
      
      messagesHTML += `
        <div style="margin-bottom: 20px;">
          <div style="background: #e8d4a6; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <strong style="color: #2e7d32;">${inquiryData.name || 'Client'}</strong>
              <small style="color: #666;">${inquiryDate}</small>
            </div>
            <div style="margin-bottom: 10px; color: #333;">
              <strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>
              ${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
              <strong style="color: #003366;">Email:</strong> ${inquiryData.email}<br/>
              <strong style="color: #003366;">Phone:</strong> ${inquiryData.number || 'Not provided'}<br/>
              <strong style="color: #003366;">Employment:</strong> ${inquiryData.Employement_Type || 'Not provided'}
            </div>
            <div style="background: #d4b97a; padding: 10px; border-radius: 4px; margin-top: 10px; color: #333;">
              <strong style="color: #003366;">Original Message:</strong><br/>
              ${inquiryData.inquiry_topic === 'other' && inquiryData.other_inquiry 
                ? inquiryData.other_inquiry 
                : 'Client expressed interest in our properties.'}
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
              Status: <span style="color: ${inquiryData.status === 'responded' ? '#4CAF50' : '#ff9800'}; font-weight: bold;">
                ${inquiryData.status || 'new'}
              </span>
            </div>
          </div>
        </div>
      `;
      
      // Display chat messages
      if (!messagesSnapshot.empty) {
        messagesHTML += '<h4 style="color: #003366; margin: 20px 0 10px 0; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Chat History</h4>';
        
        messagesSnapshot.forEach(doc => {
          const message = doc.data();
          const messageDate = message.timestamp?.toDate 
            ? message.timestamp.toDate().toLocaleString() 
            : 'Not available';
          
          const isAdmin = message.sender === "admin";
          const senderName = isAdmin ? "You (Admin)" : (inquiryData.name || 'Client');
          const bgColor = isAdmin ? '#d4e6f1' : '#f8f4e9';
          const borderColor = isAdmin ? '#2196F3' : '#a57934';
          const textColor = isAdmin ? '#1565c0' : '#333';
          
          messagesHTML += `
            <div style="margin-bottom: 15px;">
              <div style="background: ${bgColor}; 
                         padding: 12px; border-radius: 8px; 
                         border-left: 4px solid ${borderColor};
                         margin-left: ${isAdmin ? '40px' : '0'};">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <strong style="color: ${textColor}">
                    ${senderName}
                  </strong>
                  <small style="color: #666;">${messageDate}</small>
                </div>
                <div style="color: #333; white-space: pre-wrap; word-wrap: break-word;">
                  ${message.content}
                </div>
                ${message.senderName ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">Sent by: ${message.senderName}</div>` : ''}
              </div>
            </div>
          `;
        });
      } else {
        messagesHTML += `
          <div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">
            No messages yet. Send the first message to start the conversation.
          </div>
        `;
      }
      
      messagesContainer.innerHTML = messagesHTML;
      
      // Scroll to bottom
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
      
    } catch (error) {
      messagesContainer.innerHTML = `
        <div style="color: #f44336; padding: 40px; text-align: center;">
          Failed to load messages. Please try again.
        </div>
      `;
    }
  }

  // ========== OPTIMIZED DATA LOADING ==========

  async function loadData() {
    try {
      // Show loading indicator
      dataContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
          <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #003366; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p style="margin-top: 10px;">Loading data...</p>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;
      
      // Load data in parallel
      const [inquiriesSnapshot, calculationsSnapshot] = await Promise.all([
        getDocs(query(collection(db, "inquiries"), orderBy("createdAt", "desc"))),
        getDocs(query(collection(db, "mortgage_calculations"), orderBy("createdAt", "desc")))
      ]);

      // Process data
      const inquiriesData = inquiriesSnapshot.docs.map(doc => ({
        id: doc.id,
        type: 'inquiry',
        data: doc.data()
      }));

      const calculationsData = calculationsSnapshot.docs.map(doc => ({
        id: doc.id,
        type: 'calculation',
        data: doc.data()
      }));

      // Filter based on current view
      let filteredData;
      if (currentView === 'inquiries') {
        filteredData = inquiriesData;
        document.getElementById('toggleViewBtn').textContent = 'Show: Inquiries Only';
      } else if (currentView === 'calculations') {
        filteredData = calculationsData;
        document.getElementById('toggleViewBtn').textContent = 'Show: Calculations Only';
      } else {
        filteredData = [...inquiriesData, ...calculationsData];
        document.getElementById('toggleViewBtn').textContent = 'Show: All';
      }

      // Sort by date
      filteredData.sort((a, b) => {
        const dateA = a.data.createdAt?.toMillis?.() || a.data.calculationDate || 0;
        const dateB = b.data.createdAt?.toMillis?.() || b.data.calculationDate || 0;
        return dateB - dateA;
      });

      if (filteredData.length === 0) {
        dataContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 16px; margin-bottom: 10px;">No ${currentView === 'all' ? 'data' : currentView} yet.</p>
            <p style="font-size: 14px; color: #999;">Check back later for new inquiries and calculations.</p>
          </div>
        `;
        return;
      }

      // Create a map to group by email
      const emailGroups = new Map();
      
      filteredData.forEach(item => {
        const email = item.data.email;
        if (!emailGroups.has(email)) {
          emailGroups.set(email, {
            email: email,
            name: item.data.name || 'Not provided',
            inquiries: [],
            calculations: []
          });
        }
        
        const group = emailGroups.get(email);
        if (item.type === 'inquiry') {
          group.inquiries.push(item);
        } else if (item.type === 'calculation') {
          group.calculations.push(item);
        }
      });

      // Create document fragments for faster DOM manipulation
      const fragment = document.createDocumentFragment();
      
      // Process each email group
      for (const [email, group] of emailGroups) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'email-group';
        groupDiv.style.cssText = 'border: 2px solid #ffffff; padding: 15px; margin-bottom: 20px; border-radius: 8px; background-color: #cfa85b;';
        
        let groupHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <strong style="color: #003366; font-size: 16px;">${group.name}</strong><br/>
              <strong style="color: #333;">Email:</strong> <span style="color: #333;">${group.email}</span><br/>
            </div>
            <div style="text-align: right;">
              <span class="badge" style="background-color: #a57934; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 5px;">
                ${group.inquiries.length} Inquiry${group.inquiries.length !== 1 ? 'ies' : ''}
              </span>
              <span class="badge" style="background-color: #2e7d32; color: white; padding: 4px 8px; border-radius: 4px;">
                ${group.calculations.length} Calculation${group.calculations.length !== 1 ? 's' : ''}
              </span>
            </div>
          </div>
        `;

        // Show inquiries for this email
        if (group.inquiries.length > 0) {
          groupHTML += `<h4 style="color: #a57934; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Inquiries</h4>`;
          
          for (const inquiry of group.inquiries) {
            const inquiryTopicText = inquiryTopicMap[inquiry.data.inquiry_topic] || "No topic selected";
            const paymentInfoText = paymentInfoMap[inquiry.data.payment_info] || "";
            const inquiryDate = inquiry.data.createdAt?.toDate 
              ? inquiry.data.createdAt.toDate().toLocaleString() 
              : 'Not available';
            
            const statusColor = inquiry.data.status === 'responded' ? '#4CAF50' : 
                              inquiry.data.status === 'pending' ? '#ff9800' : '#f44336';
            
            groupHTML += `
              <div style="background: #ffffff; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #a57934; border: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1; color: #333;">
                    <strong style="color: #003366;">Inquiry Topic:</strong> ${inquiryTopicText}<br/>
                    ${paymentInfoText ? `<strong style="color: #003366;">Payment Info:</strong> ${paymentInfoText}<br/>` : ""}
                    <strong style="color: #003366;">Date:</strong> ${inquiryDate}<br/>
                    <strong style="color: #003366;">Status:</strong> 
                    <span style="color: ${statusColor}; font-weight: bold;">
                      ${inquiry.data.status || 'new'}
                    </span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="viewInquiryMessages('${inquiry.id}')" style="padding: 6px 12px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                      View Chat
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
        }

        // Show mortgage calculations for this email
        if (group.calculations.length > 0) {
          groupHTML += `<h4 style="color: #2e7d32; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Mortgage Calculations</h4>`;
          
          group.calculations.forEach(calc => {
            const calcData = calc.data;
            const calcSummary = calcData.formatted || {};
            
            groupHTML += `
              <div style="background: #ffffff; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #2e7d32; border: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; color: #333; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 200px;">
                    <strong style="color: #003366;">Property Price:</strong> ${calcSummary.propertyPrice || formatCurrency(calcData.propertyPrice)}<br/>
                    <strong style="color: #003366;">Downpayment:</strong> ${calcData.downpaymentPercent}% (${calcSummary.downpayment || formatCurrency(calcData.downpaymentAmount)})<br/>
                    <strong style="color: #003366;">Loan Amount:</strong> ${calcSummary.loanAmount || formatCurrency(calcData.loanAmount)}<br/>
                  </div>
                  <div style="flex: 1; min-width: 200px;">
                    <strong style="color: #003366;">Monthly Payment:</strong> ${calcSummary.monthlyPayment || formatCurrencyDecimal(calcData.monthlyPayment)}<br/>
                    <strong style="color: #003366;">Term:</strong> ${calcData.loanTermYears} years @ ${calcData.interestRate}%<br/>
                    <strong style="color: #003366;">Total Interest:</strong> ${calcSummary.totalInterest || formatCurrency(calcData.totalInterest)}<br/>
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                  <strong>Calculation Date:</strong> ${calcData.calculationDate ? new Date(calcData.calculationDate).toLocaleString() : 'Not available'}<br/>
                  <strong>Phone:</strong> ${calcData.phone || 'Not provided'}<br/>
                  ${calcData.isExistingClient ? '<span style="color: #a57934; font-weight: bold;">â˜… Existing Client</span>' : ''}
                </div>
                <div style="margin-top: 10px;">
                  <button onclick="deleteCalculation('${calc.id}')" style="padding: 6px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Delete
                  </button>
                </div>
              </div>
            `;
          });
        }

        groupDiv.innerHTML = groupHTML;
        fragment.appendChild(groupDiv);
      }

      // Clear and append in one operation
      dataContainer.innerHTML = '';
      dataContainer.appendChild(fragment);

      Toast.show(`Loaded ${filteredData.length} items`, 'info', 1500);
      
    } catch (error) {
      console.error('Error loading data:', error);
      Toast.show(`Failed to load data: ${error.message}`, 'error');
      dataContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #f44336;">
          <p style="font-size: 16px; margin-bottom: 10px;">Failed to load data</p>
          <p style="font-size: 14px; color: #999; margin-bottom: 20px;">${error.message}</p>
          <button onclick="loadData()" style="padding: 8px 16px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Retry Loading
          </button>
        </div>
      `;
    }
  }

  // ========== HELPER FUNCTIONS ==========

  // Delete calculation
  window.deleteCalculation = async function(calcId) {
    if (confirm('Are you sure you want to delete this mortgage calculation?')) {
      try {
        await deleteDoc(doc(db, "mortgage_calculations", calcId));
        
        Toast.show('Calculation deleted successfully', 'success');
        
        setTimeout(() => {
          loadData();
        }, 500);
        
      } catch (error) {
        Toast.show(`Error: ${error.message}`, 'error');
      }
    }
  };

  // ========== INITIALIZATION ==========

  // Initialize panels
  setupMessagesPanel();

  // Load data initially
  loadData();

  break; 
     
  case "document":
  mainContent.innerHTML = `
    <h1>Upload Client Documents</h1>
    <p>Type your name/description, input quantity of required bedroom units, select payment terms, and attach exactly 8 files below:</p>

    <form id="uploadForm" style="display:flex; flex-direction:column; gap:10px; max-width: 400px;">
      <input type="text" id="name" placeholder="Client Name" required style="padding:8px; width: 80%;" />

      <!-- Number of 1 Bedroom units -->
      <label style="font-weight:600;">Number of 1 Bedroom Units:</label>
      <input type="number" id="num1Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Number of 2 Bedroom units -->
      <label style="font-weight:600;">Number of 2 Bedroom Units:</label>
      <input type="number" id="num2Bedroom" min="0" value="0" style="padding:8px; width: 80%;" />

      <!-- Payment Terms Dropdown -->
      <label style="font-weight:600;">Select Payment Terms:</label>
      <select id="paymentTerms" required style="padding:8px; width: 80%; margin-bottom:10px;">
        <option value="" disabled selected>-- Select Payment Terms --</option>
        <option value="Monthly">Monthly</option>
        <option value="Cash">Cash</option>
      </select>

      <!-- File inputs -->
      ${[...Array(8)].map((_, i) => `
        <input type="file" id="file${i+1}" required style="padding:8px; width:80%;" />
      `).join('')}

      <button type="submit" style="
        padding: 12px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        width: fit-content;
      ">Upload</button>
    </form>

    <div id="status" style="margin-top:10px;"></div>
    <h2>Upload History</h2>
    <div id="uploadHistory" style="margin-top:10px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
  `;

  const form = document.getElementById("uploadForm");
  const uploadHistory = document.getElementById("uploadHistory");
  const statusDiv = document.getElementById("status");
  const nameInput = document.getElementById("name");
  const paymentTermsSelect = document.getElementById("paymentTerms");
  const num1BedroomInput = document.getElementById("num1Bedroom");
  const num2BedroomInput = document.getElementById("num2Bedroom");
  const fileInputs = [...Array(8)].map((_, i) => document.getElementById(`file${i+1}`));

  const circumference = 2 * Math.PI * 45;

  function createProgressCircle() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", "100");
    svg.setAttribute("height", "100");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.style.flexShrink = "0";

    const bgCircle = document.createElementNS(svgNS, "circle");
    bgCircle.setAttribute("cx", "50");
    bgCircle.setAttribute("cy", "50");
    bgCircle.setAttribute("r", "45");
    bgCircle.setAttribute("stroke", "#eee");
    bgCircle.setAttribute("stroke-width", "10");
    bgCircle.setAttribute("fill", "none");
    svg.appendChild(bgCircle);

    const progressCircle = document.createElementNS(svgNS, "circle");
    progressCircle.setAttribute("cx", "50");
    progressCircle.setAttribute("cy", "50");
    progressCircle.setAttribute("r", "45");
    progressCircle.setAttribute("stroke", "#4CAF50");
    progressCircle.setAttribute("stroke-width", "10");
    progressCircle.setAttribute("fill", "none");
    progressCircle.setAttribute("stroke-linecap", "round");
    progressCircle.setAttribute("stroke-dasharray", circumference);
    progressCircle.setAttribute("stroke-dashoffset", circumference);
    progressCircle.setAttribute("transform", "rotate(-90 50 50)");
    svg.appendChild(progressCircle);

    const progressText = document.createElementNS(svgNS, "text");
    progressText.setAttribute("x", "50");
    progressText.setAttribute("y", "55");
    progressText.setAttribute("font-size", "20");
    progressText.setAttribute("text-anchor", "middle");
    progressText.setAttribute("fill", "white");
    progressText.textContent = "0%";
    svg.appendChild(progressText);

    return { svg, progressCircle, progressText };
  }

  function setCircleProgress(circle, text, percent) {
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    text.textContent = `${Math.round(percent)}%`;
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
    uploadHistory.innerHTML = "";
    if (!history.length) {
      uploadHistory.innerHTML = "<p>No upload history yet.</p>";
      return;
    }

    history.forEach(entry => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ddd";
      div.style.marginBottom = "12px";
      div.style.paddingBottom = "12px";
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.gap = "12px";
      div.style.justifyContent = "space-between";

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `
        <strong>${entry.name}</strong><br/>
        <small><em>1 Bedroom Units: ${entry.num1Bedroom}</em></small><br/>
        <small><em>2 Bedroom Units: ${entry.num2Bedroom}</em></small><br/>
        <small><em>${entry.paymentTerms}</em></small><br/>
        <small><em>Uploaded at ${entry.time}</em></small>
        <ul style="margin: 8px 0 0 20px; padding-left: 0; list-style: disc;">
          ${entry.files.map(f => `<li>${f}</li>`).join("")}
        </ul>
        <p style="margin-top:8px; font-weight:600; color:#2e7d32;">
          The client is ready for account creation.
        </p>
      `;

      const { svg, progressCircle, progressText } = createProgressCircle();
      setCircleProgress(progressCircle, progressText, 100);

      div.appendChild(contentDiv);
      div.appendChild(svg);
      uploadHistory.appendChild(div);
    });
  }

  loadHistory();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const paymentTerms = paymentTermsSelect.value;
    const num1Bedroom = Number(num1BedroomInput.value);
    const num2Bedroom = Number(num2BedroomInput.value);

    if (num1Bedroom < 0 || num2Bedroom < 0) {
      alert("Bedroom unit counts cannot be negative.");
      return;
    }

    if (!paymentTerms) {
      alert("Please select a payment term.");
      return;
    }

    statusDiv.textContent = "Uploading files to Cloudinary...";

    let totalSize = 0;
    const files = fileInputs.map(f => f.files[0]);
    for (let i = 0; i < files.length; i++) {
      if (!files[i]) {
        alert(`Missing file #${i+1}`);
        return;
      }
      totalSize += files[i].size;
    }

    let uploadedSize = 0;
    const uploadedUrls = [];
    const uploadedFileNames = [];

    const tempDiv = document.createElement("div");
    tempDiv.style.display = "flex";
    tempDiv.style.justifyContent = "space-between";
    tempDiv.style.alignItems = "center";
    tempDiv.style.borderBottom = "1px solid #ddd";
    tempDiv.style.paddingBottom = "12px";
    tempDiv.style.marginBottom = "12px";

    const tempContentDiv = document.createElement("div");
    tempContentDiv.innerHTML = `<strong>${name}</strong><br/><small>Uploading...</small>`;
    const { svg, progressCircle, progressText } = createProgressCircle();

    tempDiv.appendChild(tempContentDiv);
    tempDiv.appendChild(svg);
    uploadHistory.prepend(tempDiv);

    // Upload
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "upload_preset");

      try {
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "https://api.cloudinary.com/v1_1/dfklsyjch/upload");

          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable) {
              const percent = ((uploadedSize + event.loaded) / totalSize) * 100;
              setCircleProgress(progressCircle, progressText, percent);
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              const data = JSON.parse(xhr.responseText);
              uploadedUrls.push(data.secure_url);
              uploadedFileNames.push(file.name);
              uploadedSize += file.size;
              resolve();
            } else reject();
          };

          xhr.onerror = () => reject();
          xhr.send(formData);
        });
      } catch {
        statusDiv.textContent = "Upload failed.";
        return;
      }
    }

    statusDiv.textContent = "Sending email...";

    // Prepare download URLs with fl_attachment to force download
    const downloadUrls = uploadedUrls.map(url => url.replace('/upload/', '/upload/fl_attachment/'));

    // Prepare email
    const templateParams = {
      name,
      paymentTerms,
      num1Bedroom,
      num2Bedroom,
      time: new Date().toLocaleString(),
      message: `
        <p>1 Bedroom Units: ${num1Bedroom}</p>
        <p>2 Bedroom Units: ${num2Bedroom}</p>
        <p>Payment Terms: ${paymentTerms}</p>
        <p>Files:</p>
        ${downloadUrls.map((u, i) => `<a href="${u}" target="_blank" rel="noopener noreferrer">${uploadedFileNames[i]}</a>`).join("<br>")}
      `
    };

    try {
      await emailjs.send("service_u1n5d9t", "template_qu1s2lh", templateParams);

      statusDiv.textContent = "Email sent!";
      uploadHistory.removeChild(tempDiv);

      // Save history
      const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
      history.unshift({
        name,
        paymentTerms,
        num1Bedroom,
        num2Bedroom,
        time: new Date().toLocaleString(),
        files: uploadedFileNames
      });

      if (history.length > 10) history.pop();
      localStorage.setItem("uploadHistory", JSON.stringify(history));
      loadHistory();

      form.reset();
    } catch {
      statusDiv.textContent = "Email sending failed.";
    }
  });
  break;

        /* ================= DEFAULT ================= */
        default:
          mainContent.innerHTML = "<h1>Welcome</h1><p>Select an option from the sidebar.</p>";
      }
    };

    // ================= AUTHENTICATION CHECK =================
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("You're not signed in. Redirecting to login...");
        window.location.href = "index.html";
        return;
      }
      // Show welcome message
      const greeting = document.getElementById("Greeting");
      const nameToShow = user.displayName || user.email;
      if (greeting) greeting.textContent = `Welcome Back!, ${nameToShow}`;
    });

    // ================= AUTO LOAD DASHBOARD ON PAGE OPEN =================
    window.addEventListener("load", () => {
      loadContent(null, "dashboard");

      // highlight sidebar tab
      document.querySelectorAll(".sidebar nav ul li a").forEach(link =>
        link.classList.remove("active")
      );
      document.querySelector(".sidebar nav ul li a[href='#']").classList.add("active");
    });

    // ================= SHOW REPLY FORM =================
    window.showReplyForm = function (email, id) {
      document.getElementById(`reply-${id}`).style.display = "block";
    };

    // ================= SEND REPLY =================
    window.sendReply = async function (toEmail, id, toName) {
      const replyText = document.getElementById(`replyText-${id}`).value.trim();
      if (!replyText) {
        alert("Please type a reply message.");
        return;
      }

      // Prepare data for backend with correct keys
      const payload = {
        to: toEmail,                  // was toEmail
        from: "your-email@gmail.com", // was fromEmail; replace with your actual sender email
        subject: `Reply from Project Manager to ${toName}`,
        message: replyText
      };

      try {
        const response = await fetch("http://localhost:3000/send-reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply.");
        }

        alert("Reply sent successfully to " + toEmail);

        const messageRef = doc(db, "messages", id);
        await updateDoc(messageRef, { replied: true });

        await addDoc(collection(db, "sentReplies"), {
          to: toEmail,
          message: replyText,
          timestamp: new Date()
        });

        document.getElementById(`reply-${id}`).style.display = "none";
        document.getElementById(`replyText-${id}`).value = "";

        loadContent(null, "inbox");

      } catch (error) {
        console.error("Error sending reply:", error);
        alert("Failed to send reply: " + error.message);
      }
    };


  </script>
</body>
</html>

