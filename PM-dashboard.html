<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager Dashboard â€“ Solano Hills</title>
  <link rel="stylesheet" href="PM-dasboard.css" />
  <!-- Charts for dashboard KPIs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" id="showInboxBtn" onclick="loadContent(event, 'inbox')">Inquiries</a></li>
        <li><a href="#" onclick="loadContent(event, 'document')">Document</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="Greeting">Welcome Back!</h1>
      <p>Select a sidebar option to start managing.</p>
    </div>
  </main>

  <!-- ======================== EMAILJS SDK ======================== -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("avvdJIIs04H8nGyu_");
    })();
  </script>

  <!-- ======================== FIREBASE & APP LOGIC ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      getDocs,
      addDoc,
      writeBatch,
      serverTimestamp,
      updateDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // ================= FIREBASE CONFIG =================
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");
    window.pmInboxStartView = null; // for dashboard KPI drill-down

    // ================= CONTENT LOADER =================
    window.loadContent = function (event, section) {
      if (event) event.preventDefault();

      // Remove active class and add to clicked link
      document.querySelectorAll(".sidebar nav ul li a").forEach(link => link.classList.remove("active"));
      if (event?.target?.tagName === "A") event.target.classList.add("active");

      mainContent.innerHTML = "";

      switch (section) {
        /* ================= DASHBOARD ================= */
        case "dashboard":
          mainContent.innerHTML = `
            <div class="pm-dashboard">
              <div class="pm-dashboard-header">
                <h1 class="pm-page-title">Project Manager Dashboard</h1>
                <p class="pm-page-subtitle">
                  High-level overview of inquiries, mortgage calculations, and client documents.
                </p>
              </div>

              <!-- KPI row -->
              <div class="pm-kpi-row">
                <div class="card pm-kpi-card" id="kpiInquiries">
                  <div class="pm-kpi-label">Inquiries</div>
                  <div class="pm-kpi-value" id="kpiInquiriesTotal">0</div>
                  <div class="pm-kpi-sub" id="kpiInquiriesSub">Loading...</div>
                  <div class="pm-kpi-pill">Click to view inbox</div>
                </div>

                <div class="card pm-kpi-card" id="kpiCalcs">
                  <div class="pm-kpi-label">Mortgage Calculations</div>
                  <div class="pm-kpi-value" id="kpiCalcsTotal">0</div>
                  <div class="pm-kpi-sub" id="kpiCalcsSub">Loading...</div>
                  <div class="pm-kpi-pill">Click to view calculations</div>
                </div>

                <div class="card pm-kpi-card" id="kpiDocs">
                  <div class="pm-kpi-label">Client Documents</div>
                  <div class="pm-kpi-value" id="kpiDocsTotal">0</div>
                  <div class="pm-kpi-sub" id="kpiDocsSub">Based on local upload history</div>
                  <div class="pm-kpi-pill">Click to view documents</div>
                </div>
              </div>

              <div class="pm-main-grid">
                <div class="pm-main-left">
                  <div class="card pm-chart-card">
                    <div class="pm-card-header">
                      <span>Inquiries â€“ last 6 months</span>
                      <span>Created date from inquiry form</span>
                    </div>
                    <div class="pm-chart-wrapper">
                      <canvas id="inquiriesTrendChart"></canvas>
                    </div>
                  </div>

                  <div class="card pm-chart-card">
                    <div class="pm-card-header">
                      <span>Client types from document uploads</span>
                      <span>Employed vs Selfâ€‘Employed vs Business Owner</span>
                    </div>
                    <div class="pm-chart-wrapper">
                      <canvas id="clientTypeChart"></canvas>
                    </div>
                  </div>
                </div>

                <div class="pm-main-right">
                  <div class="card calendar-card">
                    <h3>ðŸ“… Calendar</h3>
                    <div id="calendar"></div>
                  </div>

                  <div class="card pm-recent-card">
                    <div class="pm-card-header">
                      <span>Recent activity</span>
                      <span>Latest inquiries & calculations</span>
                    </div>
                    <div class="pm-recent-list" id="dashboardRecentList">
                      <p class="pm-muted">Loading recent activity...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          // --- Drill-down behaviour from KPI cards ---
          const kpiInquiriesCard = document.getElementById("kpiInquiries");
          const kpiCalcsCard = document.getElementById("kpiCalcs");
          const kpiDocsCard = document.getElementById("kpiDocs");

          kpiInquiriesCard.addEventListener("click", () => {
            window.pmInboxStartView = "inquiries";
            loadContent(null, "inbox");
          });

          kpiCalcsCard.addEventListener("click", () => {
            window.pmInboxStartView = "calculations";
            loadContent(null, "inbox");
          });

          kpiDocsCard.addEventListener("click", () => {
            loadContent(null, "document");
          });

          // --- Calendar render ---
          const renderCalendar = () => {
            const calendar = document.getElementById("calendar");
            if (!calendar) return;

            const today = new Date();
            const monthName = today.toLocaleString("default", { month: "long" });
            const year = today.getFullYear();
            const firstDay = new Date(year, today.getMonth(), 1);
            const lastDay = new Date(year, today.getMonth() + 1, 0);
            const startDay = firstDay.getDay();

            let html = "<table class='cal-table'>";
            html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
            html += "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

            for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

            for (let day = 1; day <= lastDay.getDate(); day++) {
              const isToday = day === today.getDate();
              html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
              if ((day + startDay) % 7 === 0 && day !== lastDay.getDate()) {
                html += "</tr><tr>";
              }
            }
            html += "</tr></table>";
            calendar.innerHTML = html;
          };

          // --- Dashboard metrics + charts ---
          const inquiriesTrendCtx = document.getElementById("inquiriesTrendChart").getContext("2d");
          const clientTypeCtx = document.getElementById("clientTypeChart").getContext("2d");
          let inquiriesTrendChart;
          let clientTypeChart;

          const monthLabels = (() => {
            const labels = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
              const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
              labels.push(d.toLocaleString("default", { month: "short" }));
            }
            return labels;
          })();

          const getClientTypeCounts = () => {
            const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
            const counts = {
              employed: 0,
              "self-employed": 0,
              "business-owner": 0,
              other: 0
            };

            history.forEach(entry => {
              switch (entry.clientType) {
                case "employed":
                  counts.employed++;
                  break;
                case "self-employed":
                  counts["self-employed"]++;
                  break;
                case "business-owner":
                  counts["business-owner"]++;
                  break;
                default:
                  counts.other++;
                  break;
              }
            });

            return { counts, total: history.length };
          };

          const loadDashboardMetrics = async () => {
            const now = new Date();
            const msPerDay = 1000 * 60 * 60 * 24;

            // Inquiries
            const inquiriesRef = collection(db, "inquiries");
            const inquiriesSnap = await getDocs(
              query(inquiriesRef, orderBy("createdAt", "desc"))
            );

            let totalInquiries = 0;
            let inquiriesLast7 = 0;
            const inquiriesPerMonth = new Array(6).fill(0);
            const recentEvents = [];

            const topicMap = {
              payment: "Payment / Price",
              interested_1b: "Interested in 1BR",
              interested_2b: "Interested in 2BR",
              interested_both: "Interested in both",
              other: "Other"
            };

            inquiriesSnap.forEach(docSnap => {
              const data = docSnap.data();
              const ts = data.createdAt;
              let dt = null;
              if (ts?.toDate) dt = ts.toDate();

              totalInquiries++;

              if (dt) {
                const diffDays = (now - dt) / msPerDay;
                if (diffDays <= 7) inquiriesLast7++;

                const monthsAgo =
                  (now.getFullYear() - dt.getFullYear()) * 12 +
                  (now.getMonth() - dt.getMonth());
                if (monthsAgo >= 0 && monthsAgo < 6) {
                  const idx = 5 - monthsAgo; // 0 = oldest, 5 = current month
                  inquiriesPerMonth[idx]++;
                }

                recentEvents.push({
                  type: "inquiry",
                  date: dt,
                  primary: data.name || data.email || "Inquiry",
                  secondary:
                    topicMap[data.inquiry_topic] || "Property inquiry"
                });
              }
            });

            // Mortgage calculations
            const calcsRef = collection(db, "mortgage_calculations");
            const calcsSnap = await getDocs(
              query(calcsRef, orderBy("createdAt", "desc"))
            );

            let totalCalcs = 0;
            let calcsLast30 = 0;

            calcsSnap.forEach(docSnap => {
              const data = docSnap.data();
              let dt = null;
              if (data.createdAt?.toDate) {
                dt = data.createdAt.toDate();
              } else if (data.calculationDate) {
                dt = new Date(data.calculationDate);
              }

              totalCalcs++;

              if (dt) {
                const diffDays = (now - dt) / msPerDay;
                if (diffDays <= 30) calcsLast30++;

                recentEvents.push({
                  type: "calc",
                  date: dt,
                  primary: data.name || data.email || "Mortgage calc",
                  secondary: data.formatted?.propertyPrice
                    ? `Property ${data.formatted.propertyPrice}`
                    : "Mortgage calculation"
                });
              }
            });

            // Document / client-type metrics (from localStorage)
            const { counts, total } = getClientTypeCounts();

            // --- Update KPI cards text ---
            document.getElementById("kpiInquiriesTotal").textContent =
              totalInquiries;
            document.getElementById(
              "kpiInquiriesSub"
            ).textContent = `${inquiriesLast7} in the last 7 days`;

            document.getElementById("kpiCalcsTotal").textContent = totalCalcs;
            document.getElementById(
              "kpiCalcsSub"
            ).textContent = `${calcsLast30} in the last 30 days`;

            document.getElementById("kpiDocsTotal").textContent = total;
            document.getElementById(
              "kpiDocsSub"
            ).textContent = total
              ? `Employed: ${counts.employed} â€¢ Selfâ€‘Employed: ${
                  counts["self-employed"]
                } â€¢ Business: ${counts["business-owner"]}`
              : "No document sets uploaded yet";

            // --- Build Inquiries trend chart ---
            if (inquiriesTrendChart) inquiriesTrendChart.destroy();
            inquiriesTrendChart = new Chart(inquiriesTrendCtx, {
              type: "line",
              data: {
                labels: monthLabels,
                datasets: [
                  {
                    label: "Inquiries",
                    data: inquiriesPerMonth,
                    tension: 0.35,
                    borderWidth: 2,
                    pointRadius: 3,
                    borderColor: "#c0933c",
                    backgroundColor: "rgba(192, 147, 60, 0.25)",
                    fill: true
                  }
                ]
              },
              options: {
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  x: {
                    grid: { display: false },
                    ticks: { color: "#cccccc" }
                  },
                  y: {
                    grid: { color: "rgba(255,255,255,0.06)" },
                    ticks: { color: "#cccccc", precision: 0 }
                  }
                },
                animation: {
                  duration: 900,
                  easing: "easeOutQuart"
                }
              }
            });

            // --- Build Client types doughnut chart ---
            if (clientTypeChart) clientTypeChart.destroy();
            clientTypeChart = new Chart(clientTypeCtx, {
              type: "doughnut",
              data: {
                labels: [
                  "Employed",
                  "Selfâ€‘Employed",
                  "Business Owner",
                  "Other / Unspecified"
                ],
                datasets: [
                  {
                    data: [
                      counts.employed,
                      counts["self-employed"],
                      counts["business-owner"],
                      counts.other
                    ],
                    backgroundColor: [
                      "#66bb6a",
                      "#29b6f6",
                      "#ffb74d",
                      "#757575"
                    ],
                    borderWidth: 0
                  }
                ]
              },
              options: {
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: { color: "#f7f7f7", boxWidth: 12, font: { size: 11 } }
                  }
                },
                cutout: "65%",
                animation: {
                  duration: 900,
                  easing: "easeOutQuart"
                }
              }
            });

            // --- Recent activity list ---
            const recentList = document.getElementById("dashboardRecentList");
            if (!recentEvents.length) {
              recentList.innerHTML =
                '<p class="pm-muted">No recent activity yet.</p>';
            } else {
              recentEvents.sort((a, b) => b.date - a.date);
              const top = recentEvents.slice(0, 5);

              recentList.innerHTML = top
                .map(ev => {
                  const badgeClass = ev.type === "calc" ? "calc" : "inquiry";
                  return `
                    <div class="pm-recent-item">
                      <div>
                        <div class="pm-recent-main">${ev.primary}</div>
                        <div class="pm-recent-meta">${ev.secondary}</div>
                        <div class="pm-recent-time">
                          ${ev.date.toLocaleString()}
                        </div>
                      </div>
                      <div class="pm-recent-badge ${badgeClass}">
                        ${ev.type === "calc" ? "MORTGAGE" : "INQUIRY"}
                      </div>
                    </div>
                  `;
                })
                .join("");
            }
          };

          renderCalendar();
          loadDashboardMetrics();
          break;

        /* ================= INBOX ================= */
        case "inbox":
          mainContent.innerHTML = `
            <h3 style="color: #f3efe9; margin-top: 0;">Inquiries &amp; Mortgage Calculations</h3>
            <div style="margin-bottom: 20px;">
              <button id="toggleViewBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show: All
              </button>
              <button id="showInquiriesBtn" style="padding: 8px 16px; margin-right: 10px; background-color: #a57934; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show Inquiries Only
              </button>
              <button id="showCalculationsBtn" style="padding: 8px 16px; background-color: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show Calculations Only
              </button>
            </div>

            <!-- Messages Popup Panel -->
            <div id="messagesPopupPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
              <div style="background: #262626; width: 80%; max-width: 800px; max-height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.12);">
                <div style="background: #003366; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                  <h3 id="messagesPanelTitle" style="margin: 0; font-size: 18px; color: white;">Messages</h3>
                  <button id="closeMessagesPanelBtn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
                </div>

                <div style="flex: 1; padding: 20px; overflow-y: auto; background: #181818;">
                  <div id="messagesContainer" style="margin-bottom: 20px;">
                    <!-- Messages will be loaded here -->
                  </div>

                  <!-- Reply Section -->
                  <div style="background: #202020; padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12);">
                    <h4 style="margin-top: 0; color: #ffffff;">Send Reply</h4>
                    <textarea id="replyMessage"
                              placeholder="Type your reply here..."
                              rows="6"
                              style="width: 100%;
                                     padding: 10px;
                                     border: 1px solid rgba(255,255,255,0.1);
                                     border-radius: 4px;
                                     margin-bottom: 10px;
                                     background: #181818;
                                     color: #f7f7f7;
                                     white-space: pre-wrap;
                                     line-height: 1.5;"></textarea>

                    <!-- Quick Reply Templates -->
                    <div style="margin-bottom: 15px;">
                      <p style="margin: 0 0 8px 0; color: #b3b3b3; font-size: 14px;">Quick Replies:</p>
                      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="quickReplyBtn" data-template="thankyou" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          Thank You
                        </button>
                        <button class="quickReplyBtn" data-template="followup" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          Follow Up
                        </button>
                        <button class="quickReplyBtn" data-template="pricelist_1bed" style="padding: 6px 12px; background: #fff3e0; color: #a57934; border: 1px solid #ffe0b2; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          Send 1-Bed Pricelist
                        </button>
                        <button class="quickReplyBtn" data-template="pricelist_2bed" style="padding: 6px 12px; background: #e3f2fd; color: #1976D2; border: 1px solid #bbdefb; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          Send 2-Bed Pricelist
                        </button>
                        <button class="quickReplyBtn" data-template="appointment" style="padding: 6px 12px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          Schedule Appointment
                        </button>
                      </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                      <button id="sendReplyBtn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Send Reply
                      </button>
                      <button id="cancelReplyBtn" style="padding: 8px 16px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Cancel
                      </button>
                    </div>
                    <div id="replyStatus" style="margin-top: 10px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="dataContainer"></div>
          `;

          const dataContainer = document.getElementById("dataContainer");
          let currentView = window.pmInboxStartView || "all"; // 'all', 'inquiries', 'calculations'
          window.pmInboxStartView = null;

          // Mortgage Calculator Link (for templates)
          const MORTGAGE_CALCULATOR_LINK = "https://cjgenon.github.io/SOLANO/Mortage_Calc.html";

          // Helper maps
          const inquiryTopicMap = {
            payment: "Payment / Price",
            interested_1b: "I'm interested in 1 Bedroom unit",
            interested_2b: "I'm interested in 2 Bedroom unit",
            interested_both: "I'm interested in both bedroom unit",
            other: "Other (explain in message)"
          };

          const paymentInfoMap = {
            downpayment: "Downpayment",
            monthly_amortization: "Monthly Amortization",
            total_price: "Total Price",
            payment_terms: "Payment Terms",
            other_payment: "Other (explain in message)"
          };

          // Toast notification system
          const Toast = {
            show: (message, type = "info", duration = 3000) => {
              const toast = document.createElement("div");
              toast.className = `toast toast-${type}`;
              toast.textContent = message;
              document.body.appendChild(toast);

              setTimeout(() => {
                toast.remove();
              }, duration);
            }
          };

          const formatCurrency = amount => {
            if (!amount && amount !== 0) return "â‚± 0";
            return (
              "â‚± " +
              amount.toLocaleString("en-PH", {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
              })
            );
          };

          const formatCurrencyDecimal = amount => {
            if (!amount && amount !== 0) return "â‚± 0.00";
            return (
              "â‚± " +
              amount.toLocaleString("en-PH", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })
            );
          };

          // View toggle buttons
          document.getElementById("toggleViewBtn").addEventListener("click", () => {
            currentView = "all";
            loadData();
          });

          document.getElementById("showInquiriesBtn").addEventListener("click", () => {
            currentView = "inquiries";
            loadData();
          });

          document.getElementById("showCalculationsBtn").addEventListener("click", () => {
            currentView = "calculations";
            loadData();
          });

          // Messages panel setup
          function setupMessagesPanel() {
            const messagesPanel = document.getElementById("messagesPopupPanel");
            const closeMessagesPanelBtn = document.getElementById("closeMessagesPanelBtn");
            const sendReplyBtn = document.getElementById("sendReplyBtn");
            const cancelReplyBtn = document.getElementById("cancelReplyBtn");
            const quickReplyBtns = document.querySelectorAll(".quickReplyBtn");

            closeMessagesPanelBtn.addEventListener("click", () => {
              messagesPanel.style.display = "none";
            });

            cancelReplyBtn.addEventListener("click", () => {
              document.getElementById("replyMessage").value = "";
            });

            // Send reply
            sendReplyBtn.addEventListener("click", async () => {
              const replyMessage = document.getElementById("replyMessage").value.trim();
              const currentInquiryId = messagesPanel.dataset.inquiryId;

              if (!replyMessage) {
                Toast.show("Please enter a reply message", "error");
                return;
              }

              const originalText = sendReplyBtn.textContent;
              sendReplyBtn.textContent = "Sending...";
              sendReplyBtn.disabled = true;

              const replyStatus = document.getElementById("replyStatus");
              replyStatus.textContent = "";

              try {
                await addDoc(collection(db, "inquiries", currentInquiryId, "messages"), {
                  sender: "admin",
                  senderName: "Project Manager",
                  senderId: "admin_pm",
                  content: replyMessage,
                  timestamp: serverTimestamp(),
                  readByPM: true,
                  readByUser: false
                });

                await updateDoc(doc(db, "inquiries", currentInquiryId), {
                  status: "responded"
                });

                document.getElementById("replyMessage").value = "";
                await loadInquiryMessages(currentInquiryId);

                Toast.show("Reply sent successfully!", "success");
                replyStatus.textContent = "âœ“ Reply sent successfully!";
                replyStatus.style.color = "#4CAF50";
              } catch (error) {
                Toast.show(`Error: ${error.message}`, "error");
                replyStatus.textContent = `âœ— Error: ${error.message}`;
                replyStatus.style.color = "#f44336";
              } finally {
                sendReplyBtn.textContent = originalText;
                sendReplyBtn.disabled = false;
              }
            });

            // Quick reply templates
            quickReplyBtns.forEach(btn => {
              btn.addEventListener("click", () => {
                const template = btn.dataset.template;
                let message = "";

                switch (template) {
                  case "thankyou":
                    message =
                      "Thank you for your inquiry about Solano Hillside Residences. We appreciate your interest in our properties and would be happy to assist you further with any questions you may have.";
                    break;
                  case "followup":
                    message =
                      "I'm following up on your recent inquiry about our properties. Are you still interested in learning more about our available units or would you like to schedule a site viewing?";
                    break;
                  case "pricelist_1bed":
                    message = `Here are the details for our 1-Bedroom units:\n\nðŸ  1-BEDROOM UNIT DETAILS:\nâ€¢ Floor Area: 24-28 sqm\nâ€¢ Total Price: â‚±2.8M - â‚±3.2M\nâ€¢ Downpayment: â‚±150,000 (spot cash)\nâ€¢ Monthly: â‚±12,500 - â‚±14,000 (24-36 months)\n\nðŸ’¡ FINANCING OPTIONS:\nâ€¢ Bank Financing: 80% Loan-to-value ratio\nâ€¢ In-house: Flexible payment terms\nâ€¢ Pag-IBIG: Qualified units and buyers\n\nðŸ”— Calculate your personalized payments here: ${MORTGAGE_CALCULATOR_LINK}\n`;
                    break;
                  case "pricelist_2bed":
                    message = `Here are the details for our 2-Bedroom units:\n\nðŸ  2-BEDROOM UNIT DETAILS:\nâ€¢ Floor Area: 36-42 sqm\nâ€¢ Total Price: â‚±3.8M - â‚±4.2M\nâ€¢ Downpayment: â‚±200,000 (spot cash)\nâ€¢ Monthly: â‚±16,800 - â‚±18,500 (24-36 months)\n\nðŸ’¡ FINANCING OPTIONS:\nâ€¢ Bank Financing: 80% Loan-to-value ratio\nâ€¢ In-house: Flexible payment terms\nâ€¢ Pag-IBIG: Qualified units and buyers\n\nðŸ”— Calculate your personalized payments here: ${MORTGAGE_CALCULATOR_LINK}\n`;
                    break;
                  case "appointment":
                    message =
                      "Want more details? We can schedule a site viewing this week. Please let me know your preferred date and time, and I'll arrange everything for you.\n\nðŸ“… Available Viewing Slots:\nMonday - Friday: 9:00 AM - 5:00 PM\nSaturday: 9:00 AM - 4:00 PM\nSunday: By special arrangement\n\nðŸ“ Location: Solano, Muntinlupa Paranaque\n\nLooking forward to showing you around!";
                    break;
                }

                document.getElementById("replyMessage").value = message;
                document.getElementById("replyMessage").focus();
              });
            });

            messagesPanel.addEventListener("click", e => {
              if (e.target === messagesPanel) {
                messagesPanel.style.display = "none";
              }
            });
          }

          // View messages of an inquiry
          window.viewInquiryMessages = async function (inquiryId) {
            try {
              const messagesPanel = document.getElementById("messagesPopupPanel");
              const messagesContainer = document.getElementById("messagesContainer");
              const panelTitle = document.getElementById("messagesPanelTitle");

              messagesContainer.innerHTML =
                '<div style="text-align: center; padding: 40px; color: #666;">Loading messages...</div>';
              messagesPanel.style.display = "flex";

              const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));

              if (!inquiryDoc.exists()) {
                Toast.show("Inquiry not found", "error");
                messagesContainer.innerHTML =
                  '<div style="color: #f44336; text-align: center; padding: 40px;">Inquiry not found</div>';
                return;
              }

              const inquiryData = inquiryDoc.data();
              panelTitle.textContent = `Messages with ${inquiryData.name || "Client"}`;

              messagesPanel.dataset.inquiryId = inquiryId;

              await loadInquiryMessages(inquiryId);
            } catch (error) {
              console.error("Error loading messages:", error);
              Toast.show(`Failed to load messages: ${error.message}`, "error");
              document.getElementById("messagesContainer").innerHTML =
                '<div style="color: #f44336; padding: 40px; text-align: center;">Failed to load messages. Please try again.</div>';
            }
          };

          async function loadInquiryMessages(inquiryId) {
            const messagesContainer = document.getElementById("messagesContainer");

            try {
              const inquiryDoc = await getDoc(doc(db, "inquiries", inquiryId));
              const inquiryData = inquiryDoc.data();

              const messagesSnapshot = await getDocs(
                query(collection(db, "inquiries", inquiryId, "messages"), orderBy("timestamp", "asc"))
              );

              let messagesHTML = "";

              const inquiryTopicText =
                inquiryTopicMap[inquiryData.inquiry_topic] || "No topic selected";
              const paymentInfoText = paymentInfoMap[inquiryData.payment_info] || "";
              const inquiryDate = inquiryData.createdAt?.toDate
                ? inquiryData.createdAt.toDate().toLocaleString()
                : "Not available";

              messagesHTML += `
                <div style="margin-bottom: 20px;">
                  <div style="background: #3a2f1b; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                      <strong style="color: #ffffff;">${inquiryData.name || "Client"}</strong>
                      <small style="color: #cccccc;">${inquiryDate}</small>
                    </div>
                    <div style="margin-bottom: 10px; color: #f7f7f7; font-size:13px;">
                      <strong>Inquiry Topic:</strong> ${inquiryTopicText}<br/>
                      ${
                        paymentInfoText
                          ? `<strong>Payment Info:</strong> ${paymentInfoText}<br/>`
                          : ""
                      }
                      <strong>Email:</strong> ${inquiryData.email}<br/>
                      <strong>Phone:</strong> ${inquiryData.number || "Not provided"}<br/>
                      <strong>Employment:</strong> ${
                        inquiryData.Employement_Type || "Not provided"
                      }
                    </div>
                    <div style="background: #5a4625; padding: 10px; border-radius: 4px; margin-top: 10px; color: #f7f7f7; font-size:13px;">
                      <strong>Original Message:</strong><br/>
                      ${
                        inquiryData.inquiry_topic === "other" && inquiryData.other_inquiry
                          ? inquiryData.other_inquiry
                          : "Client expressed interest in our properties."
                      }
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #cccccc;">
                      Status:
                      <span style="color: ${
                        inquiryData.status === "responded" ? "#4CAF50" : "#ff9800"
                      }; font-weight: bold;">
                        ${inquiryData.status || "new"}
                      </span>
                    </div>
                  </div>
                </div>
              `;

              if (!messagesSnapshot.empty) {
                messagesHTML +=
                  '<h4 style="color: #ffffff; margin: 20px 0 10px 0; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 5px; font-size:14px;">Chat History</h4>';

                messagesSnapshot.forEach(docSnap => {
                  const message = docSnap.data();
                  const messageDate = message.timestamp?.toDate
                    ? message.timestamp.toDate().toLocaleString()
                    : "Not available";

                  const isAdmin = message.sender === "admin";
                  const senderName = isAdmin ? "You (Admin)" : inquiryData.name || "Client";
                  const bgColor = isAdmin ? "#28384a" : "#3b3326";
                  const borderColor = isAdmin ? "#2196F3" : "#c0933c";
                  const textColor = "#f7f7f7";

                  messagesHTML += `
                    <div style="margin-bottom: 15px;">
                      <div style="
                        background: ${bgColor};
                        padding: 12px;
                        border-radius: 8px;
                        border-left: 4px solid ${borderColor};
                        margin-left: ${isAdmin ? "40px" : "0"};
                      ">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                          <strong style="color: ${textColor}; font-size:13px;">
                            ${senderName}
                          </strong>
                          <small style="color: #cccccc;">${messageDate}</small>
                        </div>
                        <div style="color: #f7f7f7; white-space: pre-wrap; word-wrap: break-word; font-size:13px;">
                          ${message.content}
                        </div>
                        ${
                          message.senderName
                            ? `<div style="font-size: 11px; color: #b3b3b3; margin-top: 5px;">Sent by: ${message.senderName}</div>`
                            : ""
                        }
                      </div>
                    </div>
                  `;
                });
              } else {
                messagesHTML += `
                  <div style="text-align: center; padding: 20px; color: #b3b3b3; background: #202020; border-radius: 8px; margin: 20px 0; font-size:13px;">
                    No messages yet. Send the first message to start the conversation.
                  </div>
                `;
              }

              messagesContainer.innerHTML = messagesHTML;

              setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
              }, 100);
            } catch (error) {
              console.error(error);
              messagesContainer.innerHTML =
                '<div style="color: #f44336; padding: 40px; text-align: center;">Failed to load messages. Please try again.</div>';
            }
          }

          // Optimized data loading
          async function loadData() {
            try {
              dataContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #b3b3b3;">
                  <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #555; border-top: 3px solid #c0933c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                  <p style="margin-top: 10px; font-size:13px;">Loading data...</p>
                  <style>
                    @keyframes spin {
                      0% { transform: rotate(0deg); }
                      100% { transform: rotate(360deg); }
                    }
                  </style>
                </div>
              `;

              const [inquiriesSnapshot, calculationsSnapshot] = await Promise.all([
                getDocs(query(collection(db, "inquiries"), orderBy("createdAt", "desc"))),
                getDocs(query(collection(db, "mortgage_calculations"), orderBy("createdAt", "desc")))
              ]);

              const inquiriesData = inquiriesSnapshot.docs.map(docSnap => ({
                id: docSnap.id,
                type: "inquiry",
                data: docSnap.data()
              }));

              const calculationsData = calculationsSnapshot.docs.map(docSnap => ({
                id: docSnap.id,
                type: "calculation",
                data: docSnap.data()
              }));

              let filteredData;
              if (currentView === "inquiries") {
                filteredData = inquiriesData;
                document.getElementById("toggleViewBtn").textContent = "Show: Inquiries Only";
              } else if (currentView === "calculations") {
                filteredData = calculationsData;
                document.getElementById("toggleViewBtn").textContent = "Show: Calculations Only";
              } else {
                filteredData = [...inquiriesData, ...calculationsData];
                document.getElementById("toggleViewBtn").textContent = "Show: All";
              }

              filteredData.sort((a, b) => {
                const dateA =
                  a.data.createdAt?.toMillis?.() || a.data.calculationDate || 0;
                const dateB =
                  b.data.createdAt?.toMillis?.() || b.data.calculationDate || 0;
                return dateB - dateA;
              });

              if (!filteredData.length) {
                dataContainer.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #b3b3b3;">
                    <p style="font-size: 16px; margin-bottom: 10px;">No ${
                      currentView === "all" ? "data" : currentView
                    } yet.</p>
                    <p style="font-size: 14px; color: #777;">Check back later for new inquiries and calculations.</p>
                  </div>
                `;
                return;
              }

              const emailGroups = new Map();

              filteredData.forEach(item => {
                const email = item.data.email;
                if (!emailGroups.has(email)) {
                  emailGroups.set(email, {
                    email,
                    name: item.data.name || "Not provided",
                    inquiries: [],
                    calculations: []
                  });
                }

                const group = emailGroups.get(email);
                if (item.type === "inquiry") {
                  group.inquiries.push(item);
                } else if (item.type === "calculation") {
                  group.calculations.push(item);
                }
              });

              const fragment = document.createDocumentFragment();

              for (const [email, group] of emailGroups) {
                const groupDiv = document.createElement("div");
                groupDiv.className = "email-group";

                let groupHTML = `
                  <div class="email-group-header">
                    <div>
                      <div class="email-group-name">${group.name}</div>
                      <div style="font-size: 13px; color: #b3b3b3;">
                        Email: <span>${group.email}</span>
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <span class="badge">
                        ${group.inquiries.length} Inquiry${
                          group.inquiries.length !== 1 ? "ies" : ""
                        }
                      </span>
                      <span class="badge">
                        ${group.calculations.length} Calculation${
                          group.calculations.length !== 1 ? "s" : ""
                        }
                      </span>
                    </div>
                  </div>
                `;

                if (group.inquiries.length > 0) {
                  groupHTML += `<h4 style="color: #f7f7f7; margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; font-size:14px;">Inquiries</h4>`;

                  for (const inquiry of group.inquiries) {
                    const inquiryTopicText =
                      inquiryTopicMap[inquiry.data.inquiry_topic] || "No topic selected";
                    const paymentInfoText =
                      paymentInfoMap[inquiry.data.payment_info] || "";
                    const inquiryDate = inquiry.data.createdAt?.toDate
                      ? inquiry.data.createdAt.toDate().toLocaleString()
                      : "Not available";

                    const statusColor =
                      inquiry.data.status === "responded"
                        ? "#4CAF50"
                        : inquiry.data.status === "pending"
                        ? "#ff9800"
                        : "#f44336";

                    groupHTML += `
                      <div class="inquiry-item">
                        <div style="display:flex; justify-content: space-between; align-items:flex-start; gap:12px;">
                          <div style="flex:1; color:#f7f7f7; font-size:13px;">
                            <strong>Inquiry Topic:</strong> ${inquiryTopicText}<br/>
                            ${
                              paymentInfoText
                                ? `<strong>Payment Info:</strong> ${paymentInfoText}<br/>`
                                : ""
                            }
                            <strong>Date:</strong> ${inquiryDate}<br/>
                            <strong>Status:</strong>
                            <span style="color: ${statusColor}; font-weight:bold;">
                              ${inquiry.data.status || "new"}
                            </span>
                          </div>
                          <div style="display:flex; flex-direction:column; gap:5px;">
                            <button onclick="viewInquiryMessages('${
                              inquiry.id
                            }')" style="padding: 6px 12px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                              View Chat
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                }

                if (group.calculations.length > 0) {
                  groupHTML += `<h4 style="color: #a5d6a7; margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; font-size:14px;">Mortgage Calculations</h4>`;

                  group.calculations.forEach(calc => {
                    const calcData = calc.data;
                    const calcSummary = calcData.formatted || {};

                    groupHTML += `
                      <div class="calculation-item">
                        <div style="display:flex; justify-content:space-between; color:#f7f7f7; flex-wrap:wrap; gap:10px; font-size:13px;">
                          <div style="flex:1; min-width:200px;">
                            <strong>Property Price:</strong> ${
                              calcSummary.propertyPrice ||
                              formatCurrency(calcData.propertyPrice)
                            }<br/>
                            <strong>Downpayment:</strong> ${calcData.downpaymentPercent}% (${
                      calcSummary.downpayment || formatCurrency(calcData.downpaymentAmount)
                    })<br/>
                            <strong>Loan Amount:</strong> ${
                              calcSummary.loanAmount || formatCurrency(calcData.loanAmount)
                            }<br/>
                          </div>
                          <div style="flex:1; min-width:200px;">
                            <strong>Monthly Payment:</strong> ${
                              calcSummary.monthlyPayment ||
                              formatCurrencyDecimal(calcData.monthlyPayment)
                            }<br/>
                            <strong>Term:</strong> ${calcData.loanTermYears} years @ ${
                      calcData.interestRate
                    }%<br/>
                            <strong>Total Interest:</strong> ${
                              calcSummary.totalInterest ||
                              formatCurrency(calcData.totalInterest)
                            }<br/>
                          </div>
                        </div>
                        <div style="margin-top: 8px; font-size:12px; color:#cccccc;">
                          <strong>Calculation Date:</strong> ${
                            calcData.calculationDate
                              ? new Date(calcData.calculationDate).toLocaleString()
                              : "Not available"
                          }<br/>
                          <strong>Phone:</strong> ${calcData.phone || "Not provided"}<br/>
                          ${
                            calcData.isExistingClient
                              ? '<span style="color: #f6d7a0; font-weight:bold;">â˜… Existing Client</span>'
                              : ""
                          }
                        </div>
                        <div style="margin-top: 8px;">
                          <button onclick="deleteCalculation('${
                            calc.id
                          }')" style="padding: 6px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Delete
                          </button>
                        </div>
                      </div>
                    `;
                  });
                }

                groupDiv.innerHTML = groupHTML;
                fragment.appendChild(groupDiv);
              }

              dataContainer.innerHTML = "";
              dataContainer.appendChild(fragment);

              Toast.show(`Loaded ${filteredData.length} items`, "info", 1500);
            } catch (error) {
              console.error("Error loading data:", error);
              Toast.show(`Failed to load data: ${error.message}`, "error");
              dataContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #f44336;">
                  <p style="font-size: 16px; margin-bottom: 10px;">Failed to load data</p>
                  <p style="font-size: 14px; color: #999; margin-bottom: 20px;">${
                    error.message
                  }</p>
                  <button onclick="loadContent(null, 'inbox')" style="padding: 8px 16px; background-color: #003366; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Retry Loading
                  </button>
                </div>
              `;
            }
          }

          // Delete calculation
          window.deleteCalculation = async function (calcId) {
            if (confirm("Are you sure you want to delete this mortgage calculation?")) {
              try {
                await deleteDoc(doc(db, "mortgage_calculations", calcId));
                Toast.show("Calculation deleted successfully", "success");
                setTimeout(() => {
                  loadData();
                }, 500);
              } catch (error) {
                Toast.show(`Error: ${error.message}`, "error");
              }
            }
          };

          setupMessagesPanel();
          loadData();
          break;

        /* ================= DOCUMENT ================= */
        case "document":
          mainContent.innerHTML = `
            <div class="pm-doc">
              <div class="pm-doc-header">
                <h1 class="pm-page-title">Client Documents</h1>
                <p class="pm-page-subtitle">
                  Upload and track document sets, categorized by client type.
                </p>
              </div>

              <div class="pm-doc-layout">
                <!-- LEFT: form + history -->
                <div class="pm-doc-left">
                  <div class="card pm-doc-form-card">
                    <h2 class="pm-section-title">Upload document set</h2>
                    <form id="uploadForm" class="pm-doc-form">
                      <div class="pm-form-row">
                        <label class="pm-label" for="name">Client name</label>
                        <input type="text" id="name" class="pm-input" placeholder="Full name" required />
                      </div>

                      <div class="pm-form-row">
                        <label class="pm-label" for="clientType">Client type</label>
                        <select id="clientType" class="pm-input" required>
                          <option value="">-- Select client type --</option>
                          <option value="employed">Employed</option>
                          <option value="self-employed">Selfâ€‘Employed / Freelancer</option>
                          <option value="business-owner">Business Owner</option>
                        </select>
                      </div>

                      <div class="pm-form-row-inline">
                        <div class="pm-form-row">
                          <label class="pm-label" for="num1Bedroom"># of 1BR units</label>
                          <input type="number" id="num1Bedroom" min="0" value="0" class="pm-input" />
                        </div>
                        <div class="pm-form-row">
                          <label class="pm-label" for="num2Bedroom"># of 2BR units</label>
                          <input type="number" id="num2Bedroom" min="0" value="0" class="pm-input" />
                        </div>
                      </div>

                      <div class="pm-form-row">
                        <label class="pm-label" for="paymentTerms">Payment terms</label>
                        <select id="paymentTerms" class="pm-input" required>
                          <option value="" disabled selected>-- Select payment terms --</option>
                          <option value="Monthly">Monthly</option>
                          <option value="Cash">Cash</option>
                        </select>
                      </div>

                      <div class="pm-form-row">
                        <label class="pm-label">Attach 8 files (scans / PDFs)</label>
                        <div class="pm-file-grid">
                          ${[...Array(8)]
                            .map(
                              (_, i) =>
                                `<input type="file" id="file${i + 1}" class="pm-input pm-file-input" required />`
                            )
                            .join("")}
                        </div>
                      </div>

                      <div class="pm-form-row">
                        <button type="submit" class="pm-btn pm-btn-primary">
                          Upload &amp; send to admin
                        </button>
                      </div>

                      <p id="status" class="pm-status-text"></p>
                    </form>
                  </div>

                  <div class="card pm-doc-history-card">
                    <h2 class="pm-section-title">Upload history</h2>
                    <p class="pm-muted" style="margin-bottom:8px;">
                      Local summary of recent document sets (for this browser).
                    </p>
                    <div id="uploadHistory"></div>
                  </div>
                </div>

                <!-- RIGHT: requirements panel -->
                <div class="pm-doc-right">
                  <div class="card pm-doc-req-card">
                    <h2 class="pm-section-title">Requirements per client type</h2>
                    <p class="pm-doc-req-note">
                      General requirements apply to all buyers. Specific requirements depend on the selected client type.
                    </p>

                    <div class="pm-req-group">
                      <h4>General requirements (all buyers)</h4>
                      <ul>
                        <li>Photocopy of at least two valid government IDs</li>
                        <li>Tax Identification Number (TIN) and BIR verification slip (if applicable)</li>
                        <li>Proof of billing under the buyerâ€™s name</li>
                        <li>Marriage certificate (if married)</li>
                        <li>Community Tax Certificate (Cedula, if required)</li>
                        <li>Reservation agreement &amp; reservation fee (for preâ€‘selling units)</li>
                        <li>Passport / ACR for foreign nationals residing in the Philippines</li>
                      </ul>
                    </div>

                    <div class="pm-req-group doc-type-requirements" data-type="employed">
                      <h4>Employed individuals</h4>
                      <ul>
                        <li>Certificate of Employment and Compensation (COEC)</li>
                        <li>Latest payslips (last 3 months)</li>
                        <li>OFW employment contract (for overseas workers)</li>
                      </ul>
                    </div>

                    <div class="pm-req-group doc-type-requirements" data-type="self-employed">
                      <h4>Selfâ€‘employed / freelancers / commissionâ€‘based</h4>
                      <ul>
                        <li>Certificate of Engagement from client / business owner</li>
                        <li>Commission vouchers for the last 12 months</li>
                        <li>Bank statements (3â€“12 months) showing consistent income</li>
                        <li>Lease contract &amp; tax declaration (for rental income)</li>
                        <li>Certified true copy of transport franchise (for PUV operators)</li>
                      </ul>
                    </div>

                    <div class="pm-req-group doc-type-requirements" data-type="business-owner">
                      <h4>Business owners</h4>
                      <ul>
                        <li>DTI registration (sole proprietors)</li>
                        <li>SEC registration &amp; Articles of Incorporation / Byâ€‘laws</li>
                        <li>Business or Mayorâ€™s Permit</li>
                        <li>ITR (BIR 1701 for sole props, 1702 for corporations)</li>
                        <li>Audited financial statements for the last 2â€“3 years</li>
                        <li>Bank statements / passbook (3â€“12 months, original or CTC)</li>
                        <li>Trade references (key suppliers &amp; customers w/ contact details)</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          // === Document tab logic ===
          const form = document.getElementById("uploadForm");
          const uploadHistory = document.getElementById("uploadHistory");
          const statusDiv = document.getElementById("status");
          const nameInput = document.getElementById("name");
          const clientTypeSelect = document.getElementById("clientType");
          const paymentTermsSelect = document.getElementById("paymentTerms");
          const num1BedroomInput = document.getElementById("num1Bedroom");
          const num2BedroomInput = document.getElementById("num2Bedroom");
          const fileInputs = [...Array(8)].map((_, i) =>
            document.getElementById(`file${i + 1}`)
          );

          const reqBlocks = document.querySelectorAll(".doc-type-requirements");
          const syncRequirementBlocks = () => {
            const type = clientTypeSelect.value;
            reqBlocks.forEach(block => {
              if (block.dataset.type === type) {
                block.classList.add("active");
              } else {
                block.classList.remove("active");
              }
            });
          };
          clientTypeSelect.addEventListener("change", syncRequirementBlocks);

          const circumference = 2 * Math.PI * 45;

          const createProgressCircle = () => {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "80");
            svg.setAttribute("height", "80");
            svg.setAttribute("viewBox", "0 0 100 100");

            const bgCircle = document.createElementNS(svgNS, "circle");
            bgCircle.setAttribute("cx", "50");
            bgCircle.setAttribute("cy", "50");
            bgCircle.setAttribute("r", "45");
            bgCircle.setAttribute("stroke", "#444");
            bgCircle.setAttribute("stroke-width", "10");
            bgCircle.setAttribute("fill", "none");
            svg.appendChild(bgCircle);

            const progressCircle = document.createElementNS(svgNS, "circle");
            progressCircle.setAttribute("cx", "50");
            progressCircle.setAttribute("cy", "50");
            progressCircle.setAttribute("r", "45");
            progressCircle.setAttribute("stroke", "#4CAF50");
            progressCircle.setAttribute("stroke-width", "10");
            progressCircle.setAttribute("fill", "none");
            progressCircle.setAttribute("stroke-linecap", "round");
            progressCircle.setAttribute("stroke-dasharray", circumference);
            progressCircle.setAttribute("stroke-dashoffset", circumference);
            progressCircle.setAttribute("transform", "rotate(-90 50 50)");
            svg.appendChild(progressCircle);

            const progressText = document.createElementNS(svgNS, "text");
            progressText.setAttribute("x", "50");
            progressText.setAttribute("y", "55");
            progressText.setAttribute("font-size", "18");
            progressText.setAttribute("text-anchor", "middle");
            progressText.setAttribute("fill", "#ffffff");
            progressText.textContent = "0%";
            svg.appendChild(progressText);

            return { svg, progressCircle, progressText };
          };

          const setCircleProgress = (circle, text, percent) => {
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            text.textContent = `${Math.round(percent)}%`;
          };

          const clientTypeLabel = type => {
            switch (type) {
              case "employed":
                return "Employed";
              case "self-employed":
                return "Selfâ€‘Employed / Freelancer";
              case "business-owner":
                return "Business Owner";
              default:
                return "Unspecified";
            }
          };

          const loadHistory = () => {
            const history = JSON.parse(localStorage.getItem("uploadHistory") || "[]");
            uploadHistory.innerHTML = "";
            if (!history.length) {
              uploadHistory.innerHTML =
                '<p class="pm-muted">No upload history yet.</p>';
              return;
            }

            history.forEach(entry => {
              const div = document.createElement("div");
              div.style.borderBottom = "1px solid rgba(255,255,255,0.08)";
              div.style.marginBottom = "12px";
              div.style.paddingBottom = "12px";
              div.style.display = "flex";
              div.style.alignItems = "center";
              div.style.gap = "12px";
              div.style.justifyContent = "space-between";

              const contentDiv = document.createElement("div");
              const typeLabel = clientTypeLabel(entry.clientType);
              contentDiv.innerHTML = `
                <strong>${entry.name}</strong><br/>
                <small>Client type: ${typeLabel}</small><br/>
                <small>1BR: ${entry.num1Bedroom} â€¢ 2BR: ${
                entry.num2Bedroom
              }</small><br/>
                <small>Terms: ${entry.paymentTerms}</small><br/>
                <small>Uploaded at ${entry.time}</small>
                <ul style="margin: 6px 0 0 18px; padding-left: 0; list-style: disc; font-size:12px;">
                  ${entry.files.map(f => `<li>${f}</li>`).join("")}
                </ul>
                <p style="margin-top:6px; font-weight:600; color:#a5d6a7; font-size:12px;">
                  The client is ready for account creation.
                </p>
              `;

              const { svg, progressCircle, progressText } = createProgressCircle();
              setCircleProgress(progressCircle, progressText, 100);

              div.appendChild(contentDiv);
              div.appendChild(svg);
              uploadHistory.appendChild(div);
            });
          };

          loadHistory();

          form.addEventListener("submit", async e => {
            e.preventDefault();

            const name = nameInput.value.trim();
            const clientType = clientTypeSelect.value;
            const paymentTerms = paymentTermsSelect.value;
            const num1Bedroom = Number(num1BedroomInput.value);
            const num2Bedroom = Number(num2BedroomInput.value);

            if (!clientType) {
              alert("Please select a client type.");
              return;
            }

            if (num1Bedroom < 0 || num2Bedroom < 0) {
              alert("Bedroom unit counts cannot be negative.");
              return;
            }

            if (!paymentTerms) {
              alert("Please select payment terms.");
              return;
            }

            statusDiv.textContent = "Uploading files to Cloudinary...";

            let totalSize = 0;
            const files = fileInputs.map(f => f.files[0]);
            for (let i = 0; i < files.length; i++) {
              if (!files[i]) {
                alert(`Missing file #${i + 1}`);
                return;
              }
              totalSize += files[i].size;
            }

            let uploadedSize = 0;
            const uploadedUrls = [];
            const uploadedFileNames = [];

            const tempDiv = document.createElement("div");
            tempDiv.style.display = "flex";
            tempDiv.style.justifyContent = "space-between";
            tempDiv.style.alignItems = "center";
            tempDiv.style.borderBottom = "1px solid rgba(255,255,255,0.08)";
            tempDiv.style.paddingBottom = "12px";
            tempDiv.style.marginBottom = "12px";

            const tempContentDiv = document.createElement("div");
            tempContentDiv.innerHTML = `<strong>${name}</strong><br/><small>Uploading...</small>`;
            const { svg, progressCircle, progressText } = createProgressCircle();

            tempDiv.appendChild(tempContentDiv);
            tempDiv.appendChild(svg);
            uploadHistory.prepend(tempDiv);

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const formData = new FormData();
              formData.append("file", file);
              formData.append("upload_preset", "upload_preset");

              try {
                await new Promise((resolve, reject) => {
                  const xhr = new XMLHttpRequest();
                  xhr.open(
                    "POST",
                    "https://api.cloudinary.com/v1_1/dfklsyjch/upload"
                  );

                  xhr.upload.onprogress = event => {
                    if (event.lengthComputable) {
                      const percent =
                        ((uploadedSize + event.loaded) / totalSize) * 100;
                      setCircleProgress(progressCircle, progressText, percent);
                    }
                  };

                  xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                      const data = JSON.parse(xhr.responseText);
                      uploadedUrls.push(data.secure_url);
                      uploadedFileNames.push(file.name);
                      uploadedSize += file.size;
                      resolve();
                    } else {
                      reject(new Error("Upload failed"));
                    }
                  };

                  xhr.onerror = () => reject(new Error("Upload failed"));
                  xhr.send(formData);
                });
              } catch (err) {
                console.error(err);
                statusDiv.textContent = "Upload failed.";
                return;
              }
            }

            statusDiv.textContent = "Sending email...";

            const downloadUrls = uploadedUrls.map(url =>
              url.replace("/upload/", "/upload/fl_attachment/")
            );

            const typeLabel = clientTypeLabel(clientType);

            const templateParams = {
              name,
              clientType: typeLabel,
              paymentTerms,
              num1Bedroom,
              num2Bedroom,
              time: new Date().toLocaleString(),
              message: `
                <p><strong>Client type:</strong> ${typeLabel}</p>
                <p><strong>1BR units:</strong> ${num1Bedroom}</p>
                <p><strong>2BR units:</strong> ${num2Bedroom}</p>
                <p><strong>Payment terms:</strong> ${paymentTerms}</p>
                <p><strong>Files:</strong></p>
                ${downloadUrls
                  .map(
                    (u, i) =>
                      `<a href="${u}" target="_blank" rel="noopener noreferrer">${uploadedFileNames[i]}</a>`
                  )
                  .join("<br>")}
              `
            };

            try {
              await emailjs.send(
                "service_u1n5d9t",
                "template_qu1s2lh",
                templateParams
              );

              statusDiv.textContent = "Email sent and history updated.";
              uploadHistory.removeChild(tempDiv);

              const history = JSON.parse(
                localStorage.getItem("uploadHistory") || "[]"
              );
              history.unshift({
                name,
                clientType,
                paymentTerms,
                num1Bedroom,
                num2Bedroom,
                time: new Date().toLocaleString(),
                files: uploadedFileNames
              });
              if (history.length > 20) history.pop();
              localStorage.setItem("uploadHistory", JSON.stringify(history));
              loadHistory();

              form.reset();
              syncRequirementBlocks();
            } catch (err) {
              console.error(err);
              statusDiv.textContent = "Email sending failed.";
            }
          });
          break;

        /* ================= DEFAULT ================= */
        default:
          mainContent.innerHTML = "<h1>Welcome</h1><p>Select an option from the sidebar.</p>";
      }
    };

    // ================= AUTHENTICATION CHECK =================
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("You're not signed in. Redirecting to login...");
        window.location.href = "index.html";
        return;
      }
      const greeting = document.getElementById("Greeting");
      const nameToShow = user.displayName || user.email;
      if (greeting) greeting.textContent = `Welcome Back!, ${nameToShow}`;
    });

    // ================= AUTO LOAD DASHBOARD ON PAGE OPEN =================
    window.addEventListener("load", () => {
      loadContent(null, "dashboard");

      document
        .querySelectorAll(".sidebar nav ul li a")
        .forEach(link => link.classList.remove("active"));
      const firstLink = document.querySelector(".sidebar nav ul li a[href='#']");
      if (firstLink) firstLink.classList.add("active");
    });

    // Legacy reply helpers (if still used anywhere else)
    window.showReplyForm = function (email, id) {
      const el = document.getElementById(`reply-${id}`);
      if (el) el.style.display = "block";
    };

    window.sendReply = async function (toEmail, id, toName) {
      const replyEl = document.getElementById(`replyText-${id}`);
      if (!replyEl) return;
      const replyText = replyEl.value.trim();
      if (!replyText) {
        alert("Please type a reply message.");
        return;
      }

      const payload = {
        to: toEmail,
        from: "your-email@gmail.com",
        subject: `Reply from Project Manager to ${toName}`,
        message: replyText
      };

      try {
        const response = await fetch("http://localhost:3000/send-reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Failed to send reply.");
        }

        alert("Reply sent successfully to " + toEmail);

        const messageRef = doc(db, "messages", id);
        await updateDoc(messageRef, { replied: true });

        await addDoc(collection(db, "sentReplies"), {
          to: toEmail,
          message: replyText,
          timestamp: new Date()
        });

        const container = document.getElementById(`reply-${id}`);
        if (container) container.style.display = "none";
        replyEl.value = "";

        loadContent(null, "inbox");
      } catch (error) {
        console.error("Error sending reply:", error);
        alert("Failed to send reply: " + error.message);
      }
    };
  </script>
</body>
</html>
