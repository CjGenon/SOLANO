<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Owner Dashboard ‚Äì Solano Hills</title>
  <link rel="stylesheet" href="Dashboard.css" />
</head>
<body>

  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <!-- <li><a href="#" onclick="loadContent(event, 'profile')">My Profile</a></li> -->
        <li><a href="#" onclick="loadContent(event, 'maintenance')">Maintenance</a></li>
        <li><a href="#" onclick="loadContent(event, 'billing')">Billing and Payments</a></li>
        <li><a href="#" onclick="loadContent(event, 'feedback')">Feedback</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="tenantGreeting">Welcome back, Tenant</h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <!-- ======================== THIRD-PARTY SCRIPTS ======================== -->
  <script src="https://www.paypal.com/sdk/js?client-id=ASbUIe1_A3shQqfiUe1_TnYnp7jGyD-_pClj10rYjAG7Fmbu_sPi6s8LoJD2bRv6bT2XkJBo-FpPO5t4&currency=PHP"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("lqyGatNXQhoDJsu2B");
    })();
  </script>

  <!-- ======================== APP SCRIPT (MODULE) ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      getDoc,
      limit,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    /* ======================== FIREBASE INIT ======================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    /* ==================== SIMPLE LOADING & BUTTON HELPERS ==================== */
function showLoading() {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.classList.remove("hidden");
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.classList.add("hidden");
}

function setButtonLoading(button, isLoading) {
  if (!button) return;

  if (isLoading) {
    button.disabled = true;
    button.classList.add("button-loading");
    const originalText = button.textContent;
    button.setAttribute("data-original-text", originalText);
    button.textContent = "Loading...";
  } else {
    button.disabled = false;
    button.classList.remove("button-loading");
    const originalText = button.getAttribute("data-original-text");
    if (originalText) {
      button.textContent = originalText;
    }
  }
}

// expose to inline handlers / other scripts if needed
window.showLoading = showLoading;
window.hideLoading = hideLoading;
window.setButtonLoading = setButtonLoading;


    function getCurrentUserEmail() {
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? user.email : "Unknown Tenant");
        });
      });
    }

    const mainContent = document.getElementById("mainContent");

    /* ======================== DASHBOARD INIT FUNCTION ======================== */
    async function initDashboard() {
      function escapeHtml(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      let communityFeedbackData = [];
      let showingAllFeedback = false;

      // Wait for auth state before loading units
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await populateMyUnits();
          // Load feedback after units are loaded
          setTimeout(() => {
            loadCommunityFeedback();
          }, 300);
        } else {
          const unitListEl = document.getElementById("myUnitList");
          if (unitListEl) unitListEl.textContent = "Please log in to view units.";
        }
      });

      async function populateMyUnits() {
        try {
          const currentUser = auth.currentUser;
          if (!currentUser) {
            console.log("No user logged in");
            return;
          }

          const unitListEl = document.getElementById("myUnitList");
          if (!unitListEl) return;

          const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
          
          if (!tenantDocSnap.exists()) {
            unitListEl.textContent = "No units found.";
            return;
          }

          const units = tenantDocSnap.data().unitNumbers || [];
          
          if (units.length === 0) {
            unitListEl.textContent = "No units assigned.";
            return;
          }

          unitListEl.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${units.map(u => `
                <div style="
                  padding: 8px 12px;
                  background: rgba(255,255,255,0.1);
                  border-radius: 6px;
                  border-left: 3px solid #8d6c39;
                  font-weight: 500;
                  transition: all 0.3s ease;
                ">
                  ${u}
                </div>
              `).join("")}
            </div>
          `;
          
          const unitItems = document.querySelectorAll("#myUnitList > div > div");
          unitItems.forEach(item => {
            item.addEventListener("mouseenter", () => {
              item.style.transform = "translateX(5px)";
              item.style.background = "rgba(141, 108, 57, 0.2)";
            });
            item.addEventListener("mouseleave", () => {
              item.style.transform = "translateX(0)";
              item.style.background = "rgba(255,255,255,0.1)";
            });
          });
          
        } catch (e) {
          console.error("Error fetching units:", e);
          const unitListEl = document.getElementById("myUnitList");
          if (!unitListEl) return;
          unitListEl.innerHTML = `
            <div style="color: #ff6b6b; padding: 10px; background: rgba(255,107,107,0.1); border-radius: 6px;">
              Failed to load units. Please try refreshing the page.
            </div>
          `;
        }
      }

      async function loadCommunityFeedback() {
        const communityFeedback = document.getElementById("communityFeedback");
        if (!communityFeedback) {
          console.error("Community feedback element not found");
          return;
        }
        
        const currentUser = auth.currentUser;
        const currentUserEmail = currentUser ? currentUser.email : null;

        try {
          const snapshot = await getDocs(collection(db, "feedback"));

          if (snapshot.empty) {
            communityFeedback.innerHTML =
              '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available yet.</p>';
            const msg = document.getElementById("feedbackMessage");
            if (msg) msg.style.display = "none";
            return;
          }

          communityFeedbackData = [];
          let totalRating = 0;
          const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

          snapshot.forEach(docSnap => {
            const data = docSnap.data();

            communityFeedbackData.push({
              id: docSnap.id,
              ...data
            });

            const rating = data.rating || 0;
            if (rating >= 1 && rating <= 5) {
              totalRating += rating;
              ratingCounts[rating]++;
            }
          });

          if (communityFeedbackData.length === 0) {
            communityFeedback.innerHTML =
              '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback from other unit owners yet.</p>';
            const msg = document.getElementById("feedbackMessage");
            if (msg) msg.style.display = "block";
            return;
          }

          // Update stats with animation
          animateCounter("totalFeedback", communityFeedbackData.length);
          const avgEl = document.getElementById("avgRating");
          if (avgEl) {
            avgEl.textContent = (totalRating / communityFeedbackData.length).toFixed(1);
          }
          animateCounter("rating5", ratingCounts[5]);
          animateCounter("rating4", ratingCounts[4]);
          animateCounter("rating3", ratingCounts[3]);
          animateCounter("rating2", ratingCounts[2]);
          animateCounter("rating1", ratingCounts[1]);

          if (communityFeedbackData.length > 4) {
            const controls = document.getElementById("expandControls");
            if (controls) controls.style.display = "block";
            const totalCountEl = document.getElementById("totalCount");
            if (totalCountEl) totalCountEl.textContent = communityFeedbackData.length;
          }

          applyFeedbackSorting();
          const msg = document.getElementById("feedbackMessage");
          if (msg) msg.style.display = "block";
          
          setTimeout(() => {
            const feedbackSortSelect = document.getElementById("feedbackSort");
            const expandAllBtn = document.getElementById("expandAllBtn");
            
            if (feedbackSortSelect) {
              feedbackSortSelect.addEventListener("change", applyFeedbackSorting);
            }
            
            if (expandAllBtn) {
              expandAllBtn.addEventListener("click", function () {
                showingAllFeedback = !showingAllFeedback;
                applyFeedbackSorting();
                if (showingAllFeedback) {
                  document
                    .querySelector("#communityFeedback")
                    .scrollIntoView({ behavior: "smooth", block: "start" });
                }
              });
            }
          }, 100);
          
        } catch (error) {
          console.error("Error loading community feedback:", error);
          communityFeedback.innerHTML = `<p style="color: white; text-align: center; grid-column: 1 / -1; color: #ffcccc;">Error loading community feedback: ${error.message}</p>`;
        }
      }

      function animateCounter(elementId, targetValue, duration = 1000) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let startValue = parseInt(element.textContent) || 0;
        let startTime = null;
        
        function updateCounter(timestamp) {
          if (!startTime) startTime = timestamp;
          const progress = timestamp - startTime;
          const percentage = Math.min(progress / duration, 1);
          
          const easeOutQuad = t => t * (2 - t);
          const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuad(percentage));
          
          element.textContent = currentValue;
          
          if (percentage < 1) {
            requestAnimationFrame(updateCounter);
          } else {
            element.textContent = targetValue;
          }
        }
        
        requestAnimationFrame(updateCounter);
      }

      function applyFeedbackSorting() {
        const sortValue = document.getElementById("feedbackSort")?.value || "date-desc";
        if (communityFeedbackData.length === 0) return;

        let sortedFeedback = [...communityFeedbackData];

        switch (sortValue) {
          case "date-desc":
            sortedFeedback.sort(
              (a, b) =>
                (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0)
            );
            break;
          case "date-asc":
            sortedFeedback.sort(
              (a, b) =>
                (a.timestamp?.toDate?.() || 0) - (b.timestamp?.toDate?.() || 0)
            );
            break;
          case "rating-desc":
            sortedFeedback.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            break;
          case "rating-asc":
            sortedFeedback.sort((a, b) => (a.rating || 0) - (b.rating || 0));
            break;
          case "random":
            for (let i = sortedFeedback.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [sortedFeedback[i], sortedFeedback[j]] = [
                sortedFeedback[j],
                sortedFeedback[i]
              ];
            }
            break;
        }

        renderCommunityFeedback(sortedFeedback);
      }

      function renderCommunityFeedback(feedbackArray) {
        const communityFeedback = document.getElementById("communityFeedback");
        if (!communityFeedback) return;

        if (feedbackArray.length === 0) {
          communityFeedback.innerHTML =
            '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available.</p>';
          return;
        }

        communityFeedback.innerHTML = "";

        let itemsToShow = feedbackArray;
        if (!showingAllFeedback && feedbackArray.length > 4) {
          itemsToShow = feedbackArray.slice(0, 4);
          const showingEl = document.getElementById("showingCount");
          if (showingEl) showingEl.textContent = "4";
        } else {
          const showingEl = document.getElementById("showingCount");
          if (showingEl) showingEl.textContent = feedbackArray.length;
        }

        const expandBtn = document.getElementById("expandAllBtn");
        if (expandBtn) {
          if (showingAllFeedback) {
            expandBtn.textContent = "Show Less (First 4)";
            expandBtn.style.background = "#4a3728";
            expandBtn.style.color = "white";
          } else {
            expandBtn.textContent = `Show All ${feedbackArray.length} Feedback Items`;
            expandBtn.style.background = "white";
            expandBtn.style.color = "#4a3728";
          }
        }

        itemsToShow.forEach((feedback, index) => {
          const timeText = feedback.timestamp?.toDate
            ? feedback.timestamp
                .toDate()
                .toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric"
                })
            : "Recent";

          const stars = "‚≠ê".repeat(feedback.rating || 0);
          const emptyStars = "‚òÜ".repeat(5 - (feedback.rating || 0));

          let bgColor = "#f5f1e8";
          let borderColor = "#d4c9b8";

          if (feedback.rating >= 4) {
            bgColor = "#e8e0d1";
            borderColor = "#c9b89c";
          }
          if (feedback.rating <= 2) {
            bgColor = "#f0e6d6";
            borderColor = "#d9c6a9";
          }

          const card = document.createElement("div");
          card.style.background = bgColor;
          card.style.border = `2px solid ${borderColor}`;
          card.style.borderRadius = "10px";
          card.style.padding = "18px";
          card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
          card.style.transition = "all 0.3s ease";
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.1}s forwards`;

          const hasNewSchema =
            feedback.q1 ||
            feedback.q2 ||
            feedback.q3 ||
            feedback.q4 ||
            feedback.q5 ||
            feedback.q6;

          let bodyHtml = "";

          if (hasNewSchema) {
            bodyHtml = `
              <div style="margin-top: 12px;">
                <div style="margin-bottom: 8px;">
                  <strong style="color: #4a3728; font-size: 14px;">Overall condition and appearance of the property</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                    ${escapeHtml(feedback.q1 || "No answer provided")}
                  </div>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong style="color: #4a3728; font-size: 14px;">Maintenance services (unit, hallway, garden)</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                    ${escapeHtml(feedback.q2 || "No answer provided")}
                  </div>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong style="color: #4a3728; font-size: 14px;">Professionalism of property management staff</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                    ${escapeHtml(feedback.q3 || "No answer provided")}
                  </div>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong style="color: #4a3728; font-size: 14px;">Ease of paying monthly dues/rent</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                    ${escapeHtml(feedback.q4 || "No answer provided")}
                  </div>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong style="color: #4a3728; font-size: 14px;">Amenities (gym, pool, clubhouse)</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                    ${escapeHtml(feedback.q5 || "No answer provided")}
                  </div>
                </div>
                <div>
                  <strong style="color: #4a3728; font-size: 14px;">Additional suggestions</strong>
                  <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #4a3728;">
                    ${escapeHtml(feedback.q6 || "No suggestions provided")}
                  </div>
                </div>
              </div>
            `;
          } else {
            bodyHtml = `
              <div style="margin-top: 12px;">
                <div style="margin-bottom: 12px;">
                  <strong style="color: #4a3728; font-size: 14px;">What do you like about our services, unit, and facilities?</strong>
                  <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #8d6c39;">
                    ${escapeHtml(feedback.question2 || "No answer provided")}
                  </div>
                </div>
                <div>
                  <strong style="color: #4a3728; font-size: 14px;">What can we improve in our unit, services, or facilities?</strong>
                  <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #4a3728;">
                    ${escapeHtml(feedback.question3 || "No answer provided")}
                  </div>
                </div>
              </div>
            `;
          }

          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div style="color: #8d6c39; font-size: 20px;">
                ${stars}${emptyStars}
                <span style="color: #4a3728; font-size: 15px; margin-left: 8px;">(${feedback.rating || 0}/5)</span>
              </div>
              <div style="color: #8d6c39; font-size: 13px; font-weight: 500;">
                ${timeText}
              </div>
            </div>
            ${bodyHtml}
          `;

          card.addEventListener("mouseenter", () => {
            card.style.transform = "translateY(-5px)";
            card.style.boxShadow = "0 8px 25px rgba(74, 55, 40, 0.3)";
          });

          card.addEventListener("mouseleave", () => {
            card.style.transform = "translateY(0)";
            card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
          });

          communityFeedback.appendChild(card);
        });

        const style = document.createElement('style');
        style.textContent = `
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }

      // Image slider
      (function initImageSlider() {
        let slideIndexLocal = 1;
        const slides = () => document.querySelectorAll(".welcome-slider .slide");

        function showSlidesLocal(n) {
          const nodeList = slides();
          if (!nodeList || nodeList.length === 0) return;
          if (n > nodeList.length) slideIndexLocal = 1;
          if (n < 1) slideIndexLocal = nodeList.length;
          nodeList.forEach(s => (s.style.display = "none"));
          nodeList[slideIndexLocal - 1].style.display = "block";
        }

        setTimeout(() => {
          showSlidesLocal(slideIndexLocal);
          
          const sliderPrev = document.getElementById("sliderPrev");
          const sliderNext = document.getElementById("sliderNext");
          
          if (sliderPrev) {
            sliderPrev.addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
          }
          if (sliderNext) {
            sliderNext.addEventListener("click", () => showSlidesLocal(++slideIndexLocal));
          }

          const sliderInterval = setInterval(
            () => showSlidesLocal(++slideIndexLocal),
            5000
          );
          const sliderEl = document.querySelector(".welcome-slider");
          if (sliderEl) {
            sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
          }
        }, 200);
      })();

      // Calendar
      (function initCalendar() {
        function generateCalendar() {
          const calendar = document.getElementById("calendar");
          if (!calendar) return;

          const today = new Date();
          const monthName = today.toLocaleString("default", { month: "long" });
          const year = today.getFullYear();
          const firstDay = new Date(year, today.getMonth(), 1);
          const lastDay = new Date(year, today.getMonth() + 1, 0);
          const startDay = firstDay.getDay();

          let html = "<table class='cal-table'>";
          html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
          html +=
            "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

          for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

          for (let day = 1; day <= lastDay.getDate(); day++) {
            const isToday = day === today.getDate();
            html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
            if ((day + startDay) % 7 === 0 && day !== lastDay.getDate())
              html += "</tr><tr>";
          }
          html += "</tr></table>";
          calendar.innerHTML = html;
        }
        
        setTimeout(() => {
          generateCalendar();
        }, 200);
      })();
    }

    /* ======================== MAIN ROUTER ======================== */
    window.loadContent = function (event, section) {
      localStorage.setItem('activeTab', section);
      showLoading();
      
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }

      document
        .querySelectorAll(".sidebar nav ul li a")
        .forEach(link => link.classList.remove("active"));

      if (event && event.target) {
        event.target.classList.add("active");
      } else {
        const selector = `.sidebar nav ul li a[onclick*="${section}"]`;
        const defaultLink = document.querySelector(selector);
        if (defaultLink) defaultLink.classList.add("active");
      }

      switch (section) {
        /* ======================== DASHBOARD ======================== */
        case "dashboard":
          mainContent.innerHTML = `
            <div class="tab-header">
              <div>
                <h1 class="page-title" id="Greeting1">Dashboard</h1>
                <p class="page-subtitle">Overview of your units, calendar, and community feedback.</p>
              </div>
            </div>

            <div class="dashboard-container">
              <section class="card welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1" /></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2" /></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3" /></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </section>

              <div class="dashboard-right">
                <section class="card calendar-card">
                  <h3 class="section-title">üìÖ Calendar</h3>
                  <div id="calendar"></div>
                </section>

                <section class="card inbox-card">
                  <h3 class="section-title">My Unit List</h3>
                  <p>Unit(s) you own:</p>
                  <div id="myUnitList" style="padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); max-width:280px; margin-top:10px;">
                    Loading units...
                  </div>
                </section>
              </div>
            </div>

            <section class="card community-card">
              <div class="section-header">
                <h2 class="section-title">üèòÔ∏è Community Feedback</h2>
                <div class="section-actions">
                  <label for="feedbackSort">Sort by:</label>
                  <select id="feedbackSort" class="select-sm">
                    <option value="date-desc">Date (Newest First)</option>
                    <option value="date-asc">Date (Oldest First)</option>
                    <option value="rating-desc">Rating (High to Low)</option>
                    <option value="rating-asc">Rating (Low to High)</option>
                    <option value="random">Random</option>
                  </select>
                </div>
              </div>

              <div id="communityStats" class="community-stats">
                <div>
                  <strong>Total Feedback:</strong> <span id="totalFeedback">0</span>
                </div>
                <div>
                  <strong>Average Rating:</strong> <span id="avgRating">0.0</span>/5
                </div>
                <div>
                  <strong>Rating Distribution:</strong>
                  <span id="rating5">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
                  <span id="rating4">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê |
                  <span id="rating3">0</span> ‚≠ê‚≠ê‚≠ê |
                  <span id="rating2">0</span> ‚≠ê‚≠ê |
                  <span id="rating1">0</span> ‚≠ê
                </div>
              </div>

              <div id="communityFeedback" class="community-grid">
                <p class="community-empty">Loading community feedback...</p>
              </div>

              <div id="expandControls" class="community-expand" style="display:none;">
                <div class="community-expand-inner">
                  <p style="margin:0 0 8px;">
                    Showing <span id="showingCount">4</span> of <span id="totalCount">0</span> feedback items
                  </p>
                  <button id="expandAllBtn" class="btn-primary">Show All Feedback</button>
                </div>
              </div>

              <div id="feedbackMessage" class="community-note">
                <strong>Note:</strong> These are anonymous feedback from other unit owners. Your own feedback is not shown here to maintain privacy.
              </div>
            </section>
          `;

          setTimeout(() => {
            initDashboard();
            hideLoading();
          }, 100);
          break;

        /* ======================== MAINTENANCE ======================== */
        case "maintenance":
          mainContent.innerHTML = `
            <div class="tab-header">
              <div>
                <h1 class="page-title">Maintenance Request</h1>
                <p class="page-subtitle">Report issues in your unit and chat with maintenance personnel.</p>
              </div>
            </div>

            <div class="maintenance-tab">
              <div class="maintenance-left">
                <section class="card maintenance-form">
                  <h2 class="section-title">New Request</h2>
                  <p><strong>What issue do you want to report?</strong></p>
                  <p style="font-size:0.85rem; color:var(--solano-text-muted); margin-top:4px;">
                    Step 1: Select unit ¬∑ Step 2: Choose issue ¬∑ Step 3: Add date & photos ¬∑ Step 4: Submit
                  </p>

                  <label for="unitSelect">Select Unit:</label>
                  <select id="unitSelect" required>
                    <option value="">-- Select Unit --</option>
                  </select>

                  <label for="problem" style="margin-top:10px;">Select issue type:</label>
                  <select id="problem">
                    <option value="">-- Select Issue --</option>
                    <optgroup label="Handyman Works">
                      <option>Drilling Works</option>
                      <option>Peephole Installation</option>
                      <option>PVC Door</option>
                      <option>Vinyl Tiles</option>
                      <option>Main Door Lockset</option>
                      <option>Window Grills</option>
                      <option>Door Repainting</option>
                    </optgroup>
                    <optgroup label="Electrical Works">
                      <option>Chandelier Installation</option>
                      <option>Circuit Breaker</option>
                      <option>Outlet / Switch</option>
                      <option>Electrical Troubleshooting</option>
                      <option>Smoke Detector Installation</option>
                    </optgroup>
                    <optgroup label="Plumbing Works">
                      <option>Bidet Installation</option>
                      <option>Grease Trap Cleaning</option>
                      <option>Shower Valve</option>
                      <option>Angle Valve</option>
                      <option>P-Trap Replacement</option>
                    </optgroup>
                    <optgroup label="Aircon / ACU Services">
                      <option>ACU Installation</option>
                      <option>ACU Re-Opening / Adjustment</option>
                      <option>ACU Drain Pipe</option>
                      <option>ACU Cleaning (Split Type)</option>
                    </optgroup>
                    <optgroup label="Other Services">
                      <option>Wall Mounted TV Installation</option>
                      <option>Sprinkler Installation</option>
                      <option>Wall Opening</option>
                      <option>Painting / Repainting</option>
                    </optgroup>
                    <optgroup label="Cleaning">
                      <option>Exhaust Fan Cleaning</option>
                      <option>Electrical Panel Cleaning</option>
                      <option>Sweeping / General Cleaning</option>
                    </optgroup>
                    <option value="other">Other (Not Listed)</option>
                  </select>

                  <div id="otherSection" style="display:none; margin-top:15px;">
                    <label for="otherComment">Describe the problem:</label>
                    <textarea id="otherComment" rows="4" placeholder="Write details here..."></textarea>
                  </div>

                  <div id="detailsSection" style="display:none; margin-top:10px;">
                    <label for="imageUpload" style="display:block;">Upload 1 or 2 JPEG images (optional, required for "Others"):</label>
                    <input type="file" id="imageUpload" accept="image/jpeg" multiple>
                    <div id="imagePreview" class="image-preview-row"></div>

                    <label for="preferredDate" style="margin-top:15px; display:block;">Select preferred maintenance visit date and time:</label>
                    <label>Preferred Date:</label>
                    <input type="date" id="preferredDate" required>
                    <label>Preferred Time:</label>
                    <select id="preferredTime" required>
                      <option value="">Select Time</option>
                      <option value="10:00 AM">10:00 AM</option>
                      <option value="11:00 AM">11:00 AM</option>
                      <option value="12:00 PM">12:00 PM</option>
                      <option value="1:00 PM">1:00 PM</option>
                      <option value="2:00 PM">2:00 PM</option>
                      <option value="3:00 PM">3:00 PM</option>
                      <option value="4:00 PM">4:00 PM</option>
                      <option value="5:00 PM">5:00 PM</option>
                      <option value="6:00 PM">6:00 PM</option>
                      <option value="7:00 PM">7:00 PM</option>
                      <option value="8:00 PM">8:00 PM</option>
                      <option value="9:00 PM">9:00 PM</option>
                      <option value="10:00 PM">10:00 PM</option>
                    </select>
                  </div>
                  <button id="submitReport" class="btn-primary" style="margin-top:12px;">Submit Request</button>
                  <p id="statusMessage" class="status-text"></p>
                </section>

                <section class="card">
                  <h3 class="section-title">üìå Solano Hills Job Service Rates</h3>
                  <div class="service-rates-scroll">
                    <h4>Handyman Works</h4>
                    <table class="rate-table">
                      <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
                      <tr><td>Drilling Works</td><td>Php 120.00/set</td><td>Main Door Locket</td><td>Php 250.00</td></tr>
                      <tr><td>Peephole (provision)</td><td>Php 120.00/set</td><td>Window Grills</td><td>Php 400.00</td></tr>
                      <tr><td>Peephole (w/ provision)</td><td>Php 350.00/set</td><td>Main Door</td><td>Php 560.00</td></tr>
                      <tr><td>Vinyl Tiles</td><td>Php 200.00/sqmtr</td><td>Plastering of ACU sides</td><td>Php 560.00</td></tr>
                      <tr><td>PVC door</td><td>Php 560.00/set</td><td>Repainting of window grills</td><td>Php 560.00</td></tr>
                      <tr><td>Rangehood w/ provision</td><td>Php 650.00/set</td><td>Repainting of ACU sides</td><td>Php 400.00</td></tr>
                    </table>

                    <h4>Electrical Works</h4>
                    <table class="rate-table">
                      <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
                      <tr><td>Chandelier</td><td>Php 1,800.00/pc</td><td>Bulb / Receptacle</td><td>Php 120.00</td></tr>
                      <tr><td>Circuit Breaker</td><td>Php 760.00/pc</td><td>Troubleshooting</td><td>Php 250.00/item</td></tr>
                    </table>

                    <h4>Plumbing Works</h4>
                    <table class="rate-table">
                      <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
                      <tr><td>Bidet</td><td>Php 395.00/set</td><td>Faucet / Shower Head</td><td>Php 250.00</td></tr>
                      <tr><td>Grease Trap</td><td>Php 1,500.00</td><td>Shower Valve</td><td>Php 900.00</td></tr>
                    </table>

                    <h4>Other Services</h4>
                    <table class="rate-table">
                      <tr><th>Service</th><th>Rate</th></tr>
                      <tr><td>Wall Mounted TV (below 40in)</td><td>Php 460.00/set</td></tr>
                      <tr><td>ACU Installation</td><td>Php 1,500.00</td></tr>
                      <tr><td>Smoke Detector Cleaning</td><td>Php 120.00</td></tr>
                    </table>

                    <h4>Cleaning Services</h4>
                    <table class="rate-table">
                      <tr><th>Service</th><th>Rate</th></tr>
                      <tr><td>ACU Cleaning Split Type</td><td>Php 1500.00/pc</td></tr>
                      <tr><td>Exhaust Fan Cleaning</td><td>Php 600.00/unit</td></tr>
                    </table>
                  </div>
                </section>
              </div>

              <aside class="maintenance-right">
                <section class="card maintenance-history-card">
                  <h3 class="history-header">Request History</h3>
                  <div id="historyList">
                    <p>Loading your requests...</p>
                  </div>
                </section>
              </aside>
            </div>
          `;

          hideLoading();

          /* ------ Maintenance logic (same as last version, unchanged) ------ */
          function formatDateTimeAMPM(date) {
            if (!(date instanceof Date)) date = date?.toDate ? date.toDate() : null;
            if (!date) return "No Response Yet";
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";
            hours = hours % 12 || 12;
            const day = date.getDate().toString().padStart(2, "0");
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const year = date.getFullYear();
            return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
          }

          function getStatusPill(status) {
            const normalized = (status || "").toLowerCase();
            let cls = "status-pill ";
            if (normalized === "pending") cls += "pending";
            else if (normalized === "in progress") cls += "in-progress";
            else if (normalized === "complete" || normalized === "completed") cls += "completed";
            else if (normalized === "cancelled") cls += "cancelled";
            else cls += "rejected";
            return `<span class="${cls}">${status}</span>`;
          }

          function calculateWaitTime(priority) {
            const waitTimes = {
              'high': '1-2 hours',
              'medium': '4-6 hours', 
              'low': '24-48 hours'
            };
            if (priority && waitTimes[priority]) return waitTimes[priority];
            return waitTimes['medium'];
          }

          const preferredDateInput = document.getElementById("preferredDate");
          const preferredTimeSelect = document.getElementById("preferredTime");

          preferredDateInput.addEventListener("change", () => {
            const selected = new Date(preferredDateInput.value);
            const day = selected.getDay();

            if (day === 0) {
              showPopup("Maintenance is NOT available on Sundays. Please pick Monday to Saturday.");
              preferredDateInput.value = "";
              return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selected.setHours(0, 0, 0, 0);

            if (selected < today) {
              showPopup("Preferred visit date cannot be in the past.");
              preferredDateInput.value = "";
            }
          });

          preferredTimeSelect.addEventListener("change", function() {
            const selectedDate = preferredDateInput.value;
            const selectedTime = this.value;
            if (!selectedDate || !selectedTime) return;
            
            const timeMap = {
              "10:00 AM": "10:00",
              "11:00 AM": "11:00", 
              "12:00 PM": "12:00",
              "1:00 PM": "13:00",
              "2:00 PM": "14:00",
              "3:00 PM": "15:00",
              "4:00 PM": "16:00",
              "5:00 PM": "17:00",
              "6:00 PM": "18:00",
              "7:00 PM": "19:00",
              "8:00 PM": "20:00",
              "9:00 PM": "21:00",
              "10:00 PM": "22:00"
            };
            
            const time24 = timeMap[selectedTime];
            const selectedDateTime = new Date(`${selectedDate}T${time24}:00`);
            const now = new Date();
            
            if (selectedDateTime < now) {
              showPopup("Preferred visit time cannot be in the past.");
              this.value = "";
            }
          });

          const nowMaint = new Date();
          nowMaint.setMinutes(Math.ceil(nowMaint.getMinutes() / 15) * 15);
          preferredDateInput.min = nowMaint.toISOString().slice(0, 10);

          const problemSelect = document.getElementById("problem");
          const otherSection = document.getElementById("otherSection");
          const detailsSection = document.getElementById("detailsSection");
          const submitButton = document.getElementById("submitReport");
          const statusMessageMaint = document.getElementById("statusMessage");
          const imageUpload = document.getElementById("imageUpload");
          const imagePreview = document.getElementById("imagePreview");
          const otherComment = document.getElementById("otherComment");
          const historyList = document.getElementById("historyList");
          const unitSelect = document.getElementById("unitSelect");
          let estimatedWaitTimeElement = null;

          imageUpload.addEventListener("change", () => {
            const files = Array.from(imageUpload.files || []);
            if (files.length > 2) {
              showPopup("You can upload a maximum of 2 images.");
              imageUpload.value = "";
              if (imagePreview) imagePreview.innerHTML = "";
              return;
            }

            if (!imagePreview) return;
            imagePreview.innerHTML = "";
            files.forEach(file => {
              if (!file.type.startsWith("image/")) return;
              const img = document.createElement("img");
              img.className = "image-preview-thumb";
              img.src = URL.createObjectURL(file);
              imagePreview.appendChild(img);
            });
          });

          problemSelect.addEventListener("change", () => {
            otherSection.style.display =
              problemSelect.value === "other" ? "block" : "none";
            detailsSection.style.display =
              problemSelect.value !== "" ? "block" : "none";
              
            if (problemSelect.value !== "") {
              updateEstimatedWaitTime(problemSelect.value);
            } else {
              if (estimatedWaitTimeElement) {
                estimatedWaitTimeElement.style.display = "none";
              }
              preferredDateInput.value = "";
              preferredTimeSelect.value = "";
              imageUpload.value = "";
              if (imagePreview) imagePreview.innerHTML = "";
            }
          });

          function updateEstimatedWaitTime(problemType) {
            let priority = 'medium';
            if ([
              'Circuit Breaker', 'Electrical Troubleshooting', 'ACU Drain Pipe',
              'Angle Valve', 'P-Trap Replacement', 'Shower Valve'
            ].includes(problemType)) {
              priority = 'high';
            } else if ([
              'Drilling Works', 'Peephole Installation', 'PVC Door',
              'Vinyl Tiles', 'Door Repainting', 'Painting / Repainting',
              'Exhaust Fan Cleaning', 'Electrical Panel Cleaning',
              'Sweeping / General Cleaning', 'other'
            ].includes(problemType)) {
              priority = 'low';
            }
            
            const waitTime = calculateWaitTime(priority);
            
            if (!estimatedWaitTimeElement) {
              estimatedWaitTimeElement = document.createElement("div");
              estimatedWaitTimeElement.className = "estimated-wait-time";
              estimatedWaitTimeElement.style.marginTop = "15px";
              const submitButton = document.getElementById("submitReport");
              submitButton.parentNode.insertBefore(estimatedWaitTimeElement, submitButton);
            }
            
            let priorityColor = "#f39c12";
            if (priority === 'high') priorityColor = "#e74c3c";
            if (priority === 'low') priorityColor = "#27ae60";
            
            estimatedWaitTimeElement.innerHTML = `
              <div style="display:flex; flex-direction:column; gap:4px;">
                <div style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; background:rgba(141,108,57,0.15); font-size:0.85rem;">
                  <span>‚è±Ô∏è</span>
                  <span><strong>Estimated wait:</strong> ${waitTime}</span>
                </div>
                <div style="color:#ccc; font-size:0.8rem;">
                  Priority: <span style="color:${priorityColor}; font-weight:bold;">${priority.toUpperCase()}</span>
                </div>
                <div style="color:#777; font-size:0.75rem;">
                  <em>Note: Actual time may vary based on technician availability.</em>
                </div>
              </div>
            `;
            estimatedWaitTimeElement.style.display = "block";
          }

          async function populateUnits() {
            try {
              const currentUser = auth.currentUser;
              const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
              if (tenantDocSnap.exists()) {
                const units = tenantDocSnap.data().unitNumbers || [];
                unitSelect.innerHTML =
                  `<option value="">-- Select Unit --</option>` +
                  units.map(u => `<option value="${u}">${u}</option>`).join("");

                if (units.length === 1) {
                  unitSelect.value = units[0];
                }
              }
            } catch (e) {
              console.error("Error fetching tenant units:", e);
            }
          }
          populateUnits();

          async function sendTenantReply(requestId, message) {
            const user = auth.currentUser;
            if (!user) {
              await showPopup("Please log in before sending a reply.");
              return;
            }
            await addDoc(
              collection(db, "maintenanceRequests", requestId, "responses"),
              {
                sender: "tenant",
                senderEmail: user.email,
                message,
                timestamp: serverTimestamp()
              }
            );
          }

          const completedStyles = document.createElement('style');
          completedStyles.textContent = `
            @keyframes pulse {
              0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
              70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
              100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
            }
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(10px); }
              to { opacity: 1; transform: translateY(0); }
            }
            @keyframes checkmarkPop {
              0% { transform: scale(0); opacity: 0; }
              70% { transform: scale(1.2); opacity: 1; }
              100% { transform: scale(1); opacity: 1; }
            }
            @keyframes shimmer {
              0% { background-position: -1000px 0; }
              100% { background-position: 1000px 0; }
            }
            .completed-item {
              animation: fadeIn 0.5s ease-out;
              position: relative;
              overflow: hidden;
            }
            .completed-item::before {
              content: '';
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
              animation: shimmer 3s infinite;
            }
            .status-complete {
              color: #27ae60 !important;
              font-weight: bold !important;
              position: relative;
              padding-left: 20px;
            }
            .status-complete::before {
              content: '‚úì';
              position: absolute;
              left: 0;
              animation: checkmarkPop 0.5s ease-out;
            }
          `;
          document.head.appendChild(completedStyles);

          async function loadHistory() {
            historyList.innerHTML = "<p>Loading your requests...</p>";
            try {
              const tenantEmail = await getCurrentUserEmail();
              const qCol = collection(db, "maintenanceRequests");
              const querySnapshot = await getDocs(
                query(
                  qCol,
                  where("tenantEmail", "==", tenantEmail),
                  orderBy("timestamp", "desc"),
                  limit(10)
                )
              );
              if (querySnapshot.empty) {
                historyList.innerHTML = "<p>No maintenance requests found.</p>";
                return;
              }

              historyList.innerHTML = "";
              for (const docSnap of querySnapshot.docs) {
                const data = docSnap.data();
                const docId = docSnap.id;
                const timeStamp = data.timestamp
                  ? formatDateTimeAMPM(data.timestamp)
                  : "N/A";
                const status = data.status || "Pending";
                const responseTime = data.responseTime
                  ? formatDateTimeAMPM(data.responseTime)
                  : "Not yet responded";
                const maintenanceName = data.maintenanceName || "Not assigned";
                const scheduledVisit = data.preferredVisitTime
                  ? formatDateTimeAMPM(data.preferredVisitTime)
                  : "Not scheduled";
                
                const estimatedWaitTime = calculateWaitTime(data.priority);
                
                let timeSinceRequest = "";
                if (data.timestamp) {
                  const requestDate = data.timestamp.toDate();
                  const now = new Date();
                  const diffMs = now - requestDate;
                  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                  const diffDays = Math.floor(diffHours / 24);
                  
                  if (diffDays > 0) {
                    timeSinceRequest = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                  } else if (diffHours > 0) {
                    timeSinceRequest = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                  } else {
                    timeSinceRequest = "Recently";
                  }
                }

                const item = document.createElement("div");
                item.style.borderBottom = "1px solid #333";
                item.style.padding = "10px 0";
                item.style.position = "relative";
                item.style.overflow = "hidden";
                
                if (status === "Complete" || status === "Completed") {
                  item.style.background = "linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, rgba(46, 204, 113, 0.05) 100%)";
                  item.style.borderLeft = "4px solid #27ae60";
                  item.style.borderRadius = "8px 0 0 8px";
                  item.style.marginBottom = "15px";
                  item.style.boxShadow = "0 2px 10px rgba(39, 174, 96, 0.1)";
                  item.style.transition = "all 0.3s ease";
                  item.addEventListener("mouseenter", function() {
                    this.style.transform = "translateX(5px)";
                    this.style.boxShadow = "0 4px 15px rgba(39, 174, 96, 0.25)";
                  });
                  item.addEventListener("mouseleave", function() {
                    this.style.transform = "translateX(0)";
                    this.style.boxShadow = "0 2px 10px rgba(39, 174, 96, 0.1)";
                  });
                  
                  item.classList.add("completed-item");
                  
                  const checkmarkBadge = document.createElement("div");
                  checkmarkBadge.innerHTML = "‚úÖ COMPLETED";
                  checkmarkBadge.style.position = "absolute";
                  checkmarkBadge.style.top = "10px";
                  checkmarkBadge.style.right = "10px";
                  checkmarkBadge.style.background = "linear-gradient(135deg, #27ae60, #2ecc71)";
                  checkmarkBadge.style.color = "white";
                  checkmarkBadge.style.padding = "5px 12px";
                  checkmarkBadge.style.borderRadius = "20px";
                  checkmarkBadge.style.fontSize = "11px";
                  checkmarkBadge.style.boxShadow = "0 2px 5px rgba(39, 174, 96, 0.3)";
                  checkmarkBadge.style.animation = "pulse 2s infinite";
                  checkmarkBadge.style.zIndex = "2";
                  
                  const celebration = document.createElement("div");
                  celebration.innerHTML = "üéâ";
                  celebration.style.position = "absolute";
                  celebration.style.top = "10px";
                  celebration.style.right = "100px";
                  celebration.style.fontSize = "20px";
                  celebration.style.animation = "checkmarkPop 0.5s ease-out 0.5s both";
                  
                  item.appendChild(checkmarkBadge);
                  item.appendChild(celebration);
                } else if (status === "In Progress") {
                  item.style.borderLeft = "4px solid #3498db";
                  item.style.background = "rgba(52, 152, 219, 0.03)";
                } else if (status === "Cancelled") {
                  item.style.borderLeft = "4px solid #777";
                  item.style.background = "rgba(120, 120, 120, 0.03)";
                } else {
                  item.style.borderLeft = "4px solid #f39c12";
                  item.style.background = "rgba(243, 156, 18, 0.03)";
                }

                const responsesContainer = document.createElement("div");
                responsesContainer.style.marginTop = "8px";
                responsesContainer.style.paddingLeft = "10px";
                responsesContainer.style.borderLeft = "3px solid #8d6c39";
                responsesContainer.style.display = "flex";
                responsesContainer.style.flexDirection = "column";
                responsesContainer.style.gap = "6px";
                responsesContainer.className = "history-thread";
                responsesContainer.innerHTML = "<em>Loading messages...</em>";

                const statusDisplay = getStatusPill(status);

                item.innerHTML = `
                  <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                    <div>
                      <div style="font-weight:600; font-size:0.95rem;">${data.problem}</div>
                      <div style="font-size:0.8rem; color:#aaa;">Unit ${data.unitNumber || "N/A"} ‚Ä¢ ${timeSinceRequest}</div>
                    </div>
                    <div style="text-align:right;">
                      ${statusDisplay}<br/>
                      ${data.priority ? `<span style="font-size:0.75rem; color:#ccc;">Priority: ${data.priority}</span>` : ""}
                    </div>
                  </div>
                  <div style="margin-top:4px; font-size:0.85rem; line-height:1.5;">
                    <strong>Description:</strong> ${data.comment || "-"}<br/>
                    <strong>Scheduled Visit:</strong> ${scheduledVisit}<br/>
                    <strong>Maintenance Personnel:</strong>
                    <span style="color:#b08d35; font-weight:700;">
                      ${maintenanceName}
                    </span>
                    ${data.maintenanceType ? `<span style="font-size:0.8rem; color:#aaa;"> (${data.maintenanceType})</span>` : ""}<br/>
                    <strong>Response Time:</strong> ${responseTime}<br/>
                    <strong>Submitted:</strong> ${timeStamp}
                  </div>
                  <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:rgba(141,108,57,0.15); font-size:0.8rem;">
                      <span>‚è±Ô∏è</span>
                      <span><strong>Est. Wait:</strong> ${estimatedWaitTime}</span>
                    </div>
                    ${
                      data.completionTime
                        ? `<div style="padding:6px 10px; background:rgba(39,174,96,0.1); border-radius:999px; border:1px solid #27ae60; font-size:0.78rem; color:#27ae60;">
                            ‚úì Work Completed: ${formatDateTimeAMPM(data.completionTime)}
                          </div>`
                        : ""
                    }
                  </div>
                `;

                const imagesContainer = document.createElement("div");
                imagesContainer.style.marginTop = "10px";
                imagesContainer.style.display = "flex";
                imagesContainer.style.flexWrap = "wrap";
                imagesContainer.style.gap = "8px";
                if (data.imageUrls && data.imageUrls.length > 0) {
                  const imagesLabel = document.createElement("strong");
                  imagesLabel.textContent = "Uploaded Images:";
                  imagesContainer.appendChild(imagesLabel);
                  imagesContainer.appendChild(document.createElement("br"));
                  data.imageUrls.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.style.width = "100px";
                    img.style.height = "auto";
                    img.style.borderRadius = "6px";
                    img.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";
                    img.style.objectFit = "cover";
                    img.style.transition = "transform 0.3s ease";
                    img.addEventListener("mouseenter", () => {
                      img.style.transform = "scale(1.05)";
                      img.style.boxShadow = "0 0 10px rgba(0,0,0,0.5)";
                    });
                    img.addEventListener("mouseleave", () => {
                      img.style.transform = "scale(1)";
                      img.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";
                    });
                    imagesContainer.appendChild(img);
                  });
                } else {
                  imagesContainer.innerHTML = "<em>No images uploaded.</em>";
                }

                item.appendChild(imagesContainer);
                item.appendChild(responsesContainer);
                historyList.appendChild(item);

                const responsesQuery = query(
                  collection(db, "maintenanceRequests", docId, "responses"),
                  orderBy("timestamp", "asc")
                );
                const responsesSnapshot = await getDocs(responsesQuery);
                if (responsesSnapshot.empty) {
                  responsesContainer.innerHTML =
                    "<em>No messages yet. You can send a reply below.</em>";
                } else {
                  responsesContainer.innerHTML = "";
                  responsesSnapshot.forEach(respDoc => {
                    const respData = respDoc.data();
                    const time = respData.timestamp
                      ? formatDateTimeAMPM(respData.timestamp)
                      : "No timestamp";
                    const isTenant = respData.sender === "tenant";

                    const senderLabel = isTenant
                      ? "You"
                      : respData.adminEmail ||
                        respData.senderEmail ||
                        "Maintenance";

                    const respDiv = document.createElement("div");
                    respDiv.classList.add("chat-bubble", isTenant ? "tenant" : "staff");

                    respDiv.innerHTML = `
                      <div class="chat-meta">
                        <strong>${senderLabel}</strong> ¬∑ <small>${time}</small>
                      </div>
                      <div>${respData.message}</div>
                    `;
                    responsesContainer.appendChild(respDiv);
                  });
                }

                if (status === "Complete" || status === "Completed") {
                  const completedMessage = document.createElement("div");
                  completedMessage.innerHTML = `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(39, 174, 96, 0.1); border-radius: 6px; border-left: 3px solid #27ae60;">
                      <strong style="color: #27ae60;">‚úì This request has been completed.</strong><br>
                      <small style="color: #666;">If the issue is still not resolved, let us know below.</small>
                    </div>
                  `;
                  item.appendChild(completedMessage);

                  const actions = document.createElement("div");
                  actions.className = "history-actions";
                  actions.innerHTML = `
                    <button class="btn-ghost history-notresolved-btn">Issue not resolved</button>
                  `;
                  item.appendChild(actions);

                  const notResolvedBtn = actions.querySelector(".history-notresolved-btn");
                  notResolvedBtn.addEventListener("click", async () => {
                    const details = window.prompt("Tell us what is still not fixed:");
                    if (!details) return;
                    try {
                      await sendTenantReply(docId, `[Issue not resolved] ${details}`);
                      await updateDoc(doc(db, "maintenanceRequests", docId), { status: "In Progress" });
                      showPopup("Thank you. We've reopened this ticket and will review it.");
                      await loadHistory();
                    } catch (err) {
                      console.error(err);
                      showPopup("Could not reopen the ticket. Please try again.");
                    }
                  });
                } else {
                  const replyContainer = document.createElement("div");
                  replyContainer.className = "history-reply";
                  replyContainer.innerHTML = `
                    <textarea rows="2" placeholder="Type a reply to maintenance..."></textarea>
                    <button class="tenant-reply-btn btn-primary">
                      Send Reply
                    </button>
                    <small style="display:block; margin-top:4px; color:#ccc;">Replies are visible to Admin.</small>
                  `;

                  const replyTextarea = replyContainer.querySelector("textarea");
                  const replyButton = replyContainer.querySelector(".tenant-reply-btn");

                  replyButton.addEventListener("click", async () => {
                    const message = replyTextarea.value.trim();
                    if (!message) {
                      await showPopup("Please type a message before sending.");
                      return;
                    }
                    
                    setButtonLoading(replyButton, true);
                    
                    try {
                      await sendTenantReply(docId, message);
                      replyTextarea.value = "";
                      
                      replyButton.style.background = "#27ae60";
                      replyButton.textContent = "‚úì Sent!";
                      
                      setTimeout(() => {
                        replyButton.style.background = "#8d6c39";
                        replyButton.textContent = "Send Reply";
                        replyButton.disabled = false;
                      }, 1500);
                      
                      await loadHistory();
                    } catch (err) {
                      console.error("Failed to send reply:", err);
                      await showPopup("Failed to send reply. Please try again.");
                      setButtonLoading(replyButton, false);
                    }
                  });

                  item.appendChild(replyContainer);

                  const actions = document.createElement("div");
                  actions.className = "history-actions";
                  actions.innerHTML = `
                    <button class="btn-secondary history-resched-btn">Request Reschedule</button>
                    <button class="btn-ghost history-cancel-btn">Cancel Request</button>
                  `;
                  item.appendChild(actions);

                  const reschedBtn = actions.querySelector(".history-resched-btn");
                  const cancelBtn = actions.querySelector(".history-cancel-btn");

                  reschedBtn.addEventListener("click", async () => {
                    const newTime = window.prompt("Enter your new preferred date & time (e.g. 12/20/2025 3:00 PM):");
                    if (!newTime) return;
                    try {
                      await sendTenantReply(docId, `[Reschedule Request] Tenant prefers: ${newTime}`);
                      showPopup("Your reschedule request has been sent to the admin.");
                    } catch (err) {
                      console.error(err);
                      showPopup("Could not send reschedule request. Please try again.");
                    }
                  });

                  cancelBtn.addEventListener("click", async () => {
                    const confirmCancel = window.confirm("Are you sure you want to cancel this maintenance request?");
                    if (!confirmCancel) return;
                    try {
                      await sendTenantReply(docId, "[Cancellation Request] Tenant would like to cancel this maintenance request.");
                      await updateDoc(doc(db, "maintenanceRequests", docId), { status: "Cancelled" });
                      showPopup("Your cancellation request has been recorded.");
                      await loadHistory();
                    } catch (err) {
                      console.error(err);
                      showPopup("Could not cancel the request. Please try again.");
                    }
                  });
                }
              }
            } catch (error) {
              historyList.innerHTML = `<p style="color:red;">Failed to load history: ${error.message}</p>`;
            }
          }
          loadHistory();

          async function uploadToCloudinary(file) {
            showLoading();
            try {
              const url = "https://api.cloudinary.com/v1_1/dfklsyjch/upload";
              const preset = "tenant_uploads";
              const formData = new FormData();
              formData.append("file", file);
              formData.append("upload_preset", preset);
              const response = await fetch(url, { method: "POST", body: formData });
              if (!response.ok) throw new Error("Cloudinary upload failed");
              return (await response.json()).secure_url;
            } finally {
              hideLoading();
            }
          }

          submitButton.addEventListener("click", async () => {
            const unitNumber = unitSelect.value;
            const problem = problemSelect.value;
            const comment = otherComment.value.trim();
            const preferredVisitDate = preferredDateInput.value;
            const preferredVisitTime = preferredTimeSelect.value;
            const files = imageUpload.files;

            if (!unitNumber) {
              await showPopup("Please select the unit for maintenance.");
              return;
            }
            if (!problem) {
              await showPopup("Please select an issue type");
              return;
            }
            if (!preferredVisitDate) {
              await showPopup("Please select your preferred maintenance visit date.");
              return;
            }
            if (!preferredVisitTime) {
              await showPopup("Please select your preferred maintenance visit time.");
              return;
            }
            
            const timeMap = {
              "10:00 AM": "10:00",
              "11:00 AM": "11:00", 
              "12:00 PM": "12:00",
              "1:00 PM": "13:00",
              "2:00 PM": "14:00",
              "3:00 PM": "15:00",
              "4:00 PM": "16:00",
              "5:00 PM": "17:00",
              "6:00 PM": "18:00",
              "7:00 PM": "19:00",
              "8:00 PM": "20:00",
              "9:00 PM": "21:00",
              "10:00 PM": "22:00"
            };
            
            const time24 = timeMap[preferredVisitTime];
            const selectedDateTime = new Date(`${preferredVisitDate}T${time24}:00`);
            const now = new Date();

            if (selectedDateTime < now) {
              await showPopup("Preferred visit time cannot be in the past.");
              return;
            }
            
            if (problem === "other") {
              if (!comment) {
                await showPopup('Please describe the problem in "Others".');
                return;
              }
              if (!files || files.length < 2) {
                await showPopup('Please upload at least 2 JPEG images for "Others".');
                return;
              }
            }
            if (files && files.length > 0) {
              for (const file of files) {
                if (file.type !== "image/jpeg") {
                  await showPopup("Only JPEG images are allowed.");
                  return;
                }
              }
            }

            statusMessageMaint.style.color = "gray";
            statusMessageMaint.textContent = "Submitting your request...";

            try {
              setButtonLoading(submitButton, true);
              
              const tenantEmail = await getCurrentUserEmail();
              let imageUrls = [];
              if (files && files.length > 0) {
                for (const file of files) {
                  imageUrls.push(await uploadToCloudinary(file));
                }
              }
              
              let priority = 'medium';
              if ([
                'Circuit Breaker', 'Electrical Troubleshooting', 'ACU Drain Pipe',
                'Angle Valve', 'P-Trap Replacement', 'Shower Valve'
              ].includes(problem)) {
                priority = 'high';
              } else if ([
                'Drilling Works', 'Peephole Installation', 'PVC Door',
                'Vinyl Tiles', 'Door Repainting', 'Painting / Repainting',
                'Exhaust Fan Cleaning', 'Electrical Panel Cleaning',
                'Sweeping / General Cleaning', 'other'
              ].includes(problem)) {
                priority = 'low';
              }

              await addDoc(collection(db, "maintenanceRequests"), {
                tenantEmail,
                unitNumber,
                problem,
                comment: problem === "other" ? comment : "",
                imageUrls,
                priority,
                status: "Pending",
                responseTime: "Not yet responded",
                preferredVisitTime: selectedDateTime,
                timestamp: serverTimestamp()
              });

              statusMessageMaint.style.color = "green";
              statusMessageMaint.textContent =
                "Maintenance request submitted successfully! ‚úÖ\nEstimated wait time: " + calculateWaitTime(priority);
              
              statusMessageMaint.style.fontWeight = "bold";
              statusMessageMaint.style.padding = "10px";
              statusMessageMaint.style.background = "rgba(39, 174, 96, 0.1)";
              statusMessageMaint.style.borderRadius = "8px";
              statusMessageMaint.style.border = "2px solid #27ae60";
              
              problemSelect.value = "";
              otherComment.value = "";
              imageUpload.value = "";
              if (imagePreview) imagePreview.innerHTML = "";
              otherSection.style.display = "none";
              detailsSection.style.display = "none";
              preferredDateInput.value = "";
              preferredTimeSelect.value = "";
              unitSelect.value = "";
              if (estimatedWaitTimeElement) {
                estimatedWaitTimeElement.style.display = "none";
              }
              
              setTimeout(() => {
                loadHistory();
              }, 1000);
              
            } catch (error) {
              statusMessageMaint.style.color = "red";
              statusMessageMaint.textContent =
                "Failed to submit request: " + error.message;
              statusMessageMaint.style.background = "rgba(231, 76, 60, 0.1)";
              statusMessageMaint.style.border = "2px solid #e74c3c";
              console.error(error);
            } finally {
              setButtonLoading(submitButton, false);
            }
          });

          break;

        /* ======================== BILLING ======================== */
        case "billing":
          mainContent.innerHTML = `
            <div class="tab-header">
              <div>
                <h1 class="page-title">Billing & Payments</h1>
                <p class="page-subtitle">Review your current invoice and payment history.</p>
              </div>
            </div>

            <div class="billing-grid payment-tab">
              <section class="card">
                <h2 class="section-title">Current Invoice</h2>
                <p>Pay your monthly dues securely via PayPal.</p>

                <div id="invoiceSection" style="margin-top:14px;">
                  <p id="invoiceDetails">Loading your invoice...</p>
                </div>

                <hr style="margin:22px 0; border-color:rgba(255,255,255,0.12);">

                <h3 class="section-title">Payment Method</h3>
                <p>Payments are processed securely through PayPal.</p>

                <div id="paypal-section" style="margin-top:16px;">
                  <div id="paypal-button-container"></div>
                </div>
              </section>

              <section class="card">
                <div class="section-header">
                  <h2 class="section-title">Payment History</h2>
                  <div class="section-actions">
                    <label for="historySort">Sort by:</label>
                    <select id="historySort" class="select-sm">
                      <option value="date-desc">Date (Newest First)</option>
                      <option value="date-asc">Date (Oldest First)</option>
                    </select>
                  </div>
                </div>

                <div id="paymentStats" class="payment-stats" style="display:none;">
                  <span style="font-weight:bold;">Showing:</span>
                  <span id="paymentCount">0</span> payments ¬∑
                  <span style="font-weight:bold;">Total Paid:</span> ‚Ç±<span id="totalPaid">0.00</span>
                </div>

                <div id="paymentHistory" class="payment-history-scroll">
                  <p>Loading your payment history...</p>
                </div>
              </section>
            </div>
          `;

          hideLoading();

          const invoiceDetails = document.getElementById("invoiceDetails");
          const paymentHistory = document.getElementById("paymentHistory");
          const paypalContainer = document.getElementById("paypal-button-container");
          const historySort = document.getElementById("historySort");
          const paymentStats = document.getElementById("paymentStats");
          const paymentCount = document.getElementById("paymentCount");
          const totalPaid = document.getElementById("totalPaid");

          const unitPricing = { "1B": 10, "2B": 20 };
          let computedAmount = 0;
          let tenantUnits = [];
          let allPayments = [];
          let filteredPayments = [];

          async function loadInvoice() {
            const tenantEmail = await getCurrentUserEmail();
            const uid = auth.currentUser.uid;
            const userDoc = await getDoc(doc(db, "users", uid));
            tenantUnits = userDoc.data()?.unitNumbers || [];

            computedAmount = tenantUnits.reduce((total, unit) => {
              const type = unit.split("-")[0];
              return total + (unitPricing[type] || 0);
            }, 0);

            invoiceDetails.innerHTML = `
              <strong>Unit Owner:</strong> ${tenantEmail}<br>
              <strong>Units:</strong> ${tenantUnits.join(", ") || "None"}<br>
              <strong>Amount Due:</strong> ‚Ç±${computedAmount}<br>
              <strong>Due Date:</strong> 25th of this month
            `;
          }

          async function loadAllPayments() {
            const tenantEmail = await getCurrentUserEmail();

            try {
              const qCol = query(
                collection(db, "payments"),
                where("tenantEmail", "==", tenantEmail),
                orderBy("timestamp", "desc")
              );
              const snapshot = await getDocs(qCol);

              if (snapshot.empty) {
                allPayments = [];
                applySorting();
                return;
              }

              allPayments = snapshot.docs.map(docSnap => ({
                id: docSnap.id,
                ...docSnap.data()
              }));

              applySorting();
            } catch (error) {
              console.error("Error loading payments:", error);
              paymentHistory.innerHTML = `<p style="color:red;">Error loading history: ${error.message}</p>`;
            }
          }

          function applySorting() {
            const sortValue = historySort.value;
            filteredPayments = [...allPayments];

            filteredPayments.sort((a, b) => {
              switch (sortValue) {
                case "date-desc":
                  return (
                    (b.timestamp?.toDate?.() || 0) -
                    (a.timestamp?.toDate?.() || 0)
                  );
                case "date-asc":
                  return (
                    (a.timestamp?.toDate?.() || 0) -
                    (b.timestamp?.toDate?.() || 0)
                  );
                default:
                  return 0;
              }
            });

            renderPaymentHistory();
          }

          function renderPaymentHistory() {
            if (filteredPayments.length === 0) {
              paymentHistory.innerHTML = "<p>No payment records found.</p>";
              paymentStats.style.display = "none";
              return;
            }

            paymentHistory.innerHTML = "";

            let total = 0;

            filteredPayments.forEach(payment => {
              const d = payment;
              const time = d.timestamp
                ? d.timestamp.toDate().toLocaleString()
                : "N/A";

              let receipt = "";
              if (d.method === "Cash on Hand" && d.receiptUrl) {
                receipt = `<br><strong>Receipt:</strong><br><img src="${d.receiptUrl}" style="max-width:150px; border-radius:6px;">`;
              }

              let statusColor = "#666";
              if (d.status === "Paid" || d.status === "Approved") statusColor = "#4CAF50";
              if (d.status === "Pending Verification") statusColor = "#FF9800";
              if (d.status === "Rejected") statusColor = "#F44336";

              const div = document.createElement("div");
              div.style.borderBottom = "1px solid #ccc";
              div.style.padding = "12px 0";
              div.style.marginBottom = "10px";
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <strong>Invoice ID:</strong> ${d.invoiceId || "-"}<br>
                    <strong>Amount:</strong> ‚Ç±${d.amount}<br>
                    <strong>Status:</strong> <span style="color:${statusColor};">${d.status}</span><br>
                    <strong>Date:</strong> ${time}<br>
                    <strong>Method:</strong> ${d.method}
                    ${receipt}
                  </div>
                  <div style="min-width: 150px; text-align: right;">
                    ${d.transactionId ? `<strong>Transaction ID:</strong><br><small>${d.transactionId}</small><br>` : ""}
                    ${d.payerEmail ? `<strong>Paid with:</strong><br><small>${d.payerEmail}</small>` : ""}
                  </div>
                </div>
              `;
              paymentHistory.appendChild(div);

              if (
                d.status === "Paid" ||
                d.status === "Approved" ||
                d.status === "Completed"
              ) {
                total += Number(d.amount) || 0;
              }
            });

            paymentCount.textContent = filteredPayments.length;
            totalPaid.textContent = total.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });
            paymentStats.style.display = "block";
          }

          async function sendEmailReceipt(paymentData) {
            try {
              const templateParams = {
                from_name: "Solano Hills Admin",
                to_email: paymentData.payerEmail,
                invoice_id: paymentData.invoiceId,
                amount: paymentData.amount,
                payment_method: paymentData.method,
                transaction_id: paymentData.transactionId,
                payment_date: new Date().toLocaleString()
              };
              await emailjs.send("service_izx63bb", "template_asn4687", templateParams);
              console.log("Email receipt sent successfully");
            } catch (error) {
              console.error("Failed to send email receipt:", error);
            }
          }

          async function setupPayPal() {
            const tenantEmail = await getCurrentUserEmail();
            const invoiceId = "INV-" + Date.now();

            paypal
              .Buttons({
                style: { color: "gold", shape: "rect", label: "pay", height: 40 },
                createOrder: function (data, actions) {
                  return actions.order.create({
                    purchase_units: [
                      {
                        reference_id: invoiceId,
                        description: "Monthly Dues Payment",
                        amount: { currency_code: "PHP", value: computedAmount.toString() }
                      }
                    ]
                  });
                },
                onApprove: async function (data, actions) {
                  showLoading();
                  try {
                    const order = await actions.order.capture();

                    const paymentRecord = {
                      tenantEmail,
                      invoiceId,
                      amount: computedAmount,
                      method: "PayPal",
                      status: "Paid",
                      transactionId: order.id,
                      payerEmail: order.payer.email_address,
                      timestamp: serverTimestamp()
                    };

                    await addDoc(collection(db, "payments"), paymentRecord);

                    showPopup("‚úÖ Payment successful!");
                    await loadAllPayments();
                    await sendEmailReceipt(paymentRecord);
                  } catch (error) {
                    console.error("Payment error:", error);
                    showPopup("‚ùå Payment failed. Please try again.");
                  } finally {
                    hideLoading();
                  }
                },
                onCancel: async function () {
                  showPopup("‚ö†Ô∏è Payment cancelled by user.");
                },
                onError: async function (err) {
                  console.error("PayPal error:", err);
                  showPopup("‚ùå Payment failed. Please try again later.");
                }
              })
              .render(paypalContainer);
          }

          historySort.addEventListener("change", applySorting);

          (async () => {
            await loadInvoice();
            await loadAllPayments();
            await setupPayPal();
          })();

          break;

        /* ======================== FEEDBACK ======================== */
        case "feedback":
          loadFeedbackForm();
          hideLoading();
          break;

        default:
          mainContent.innerHTML = "<p>Section not found.</p>";
          hideLoading();
      }
    };

    /* ======================== FEEDBACK FORM FUNCTION ======================== */
    function loadFeedbackForm() {
      const mainContent = document.getElementById("mainContent");
      mainContent.innerHTML = `
        <div class="tab-header">
          <div>
            <h1 class="page-title">Tenant Feedback</h1>
            <p class="page-subtitle">Share your thoughts so we can improve your experience.</p>
          </div>
        </div>

        <div class="feedback-container">
          <section class="card feedback-card">
            <form id="feedbackForm" class="feedback-form">
              <div class="form-group">
                <label for="rating">1. How satisfied are you with our services?</label>
                <div id="rating" style="font-size: 2rem; margin: 8px 0; user-select:none;">
                  <span data-value="1" style="cursor:pointer;">‚≠êÔ∏è</span>
                  <span data-value="2" style="cursor:pointer;">‚≠êÔ∏è</span>
                  <span data-value="3" style="cursor:pointer;">‚≠êÔ∏è</span>
                  <span data-value="4" style="cursor:pointer;">‚≠êÔ∏è</span>
                  <span data-value="5" style="cursor:pointer;">‚≠êÔ∏è</span>
                </div>
                <input type="hidden" id="ratingValue" name="ratingValue" required />
              </div>

              <div class="form-group">
                <label for="q1">2. How satisfied are you with the overall condition and appearance of the property?</label>
                <select id="q1" name="q1" required>
                  <option value="">-- Select --</option>
                  <option>Very Satisfied</option>
                  <option>Satisfied</option>
                  <option>Neutral</option>
                  <option>Dissatisfied</option>
                  <option>Very Dissatisfied</option>
                </select>
              </div>

              <div class="form-group">
                <label for="q2">3. How satisfied are you with the maintenance services (unit, hallway, garden)?</label>
                <select id="q2" name="q2" required>
                  <option value="">-- Select --</option>
                  <option>Very Satisfied</option>
                  <option>Satisfied</option>
                  <option>Neutral</option>
                  <option>Dissatisfied</option>
                  <option>Very Dissatisfied</option>
                </select>
              </div>

              <div class="form-group">
                <label for="q3">4. How would you rate the professionalism of the property management staff?</label>
                <select id="q3" name="q3" required>
                  <option value="">-- Select --</option>
                  <option>Excellent</option>
                  <option>Good</option>
                  <option>Average</option>
                  <option>Poor</option>
                  <option>Very Poor</option>
                </select>
              </div>

              <div class="form-group">
                <label for="q4">5. Is it easy to pay your monthly dues or rent?</label>
                <select id="q4" name="q4" required>
                  <option value="">-- Select --</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </div>

              <div class="form-group">
                <label for="q5">6. How would you rate the amenities (gym, pool, clubhouse)?</label>
                <select id="q5" name="q5" required>
                  <option value="">-- Select --</option>
                  <option>Excellent</option>
                  <option>Good</option>
                  <option>Average</option>
                  <option>Poor</option>
                </select>
              </div>

              <div class="form-group">
                <label for="q6">7. Any additional suggestions?</label>
                <textarea id="q6" name="q6" placeholder="Write your suggestions here..."></textarea>
              </div>

              <button id="sendFeedbackBtn" type="submit" class="btn-primary">Send Feedback</button>
              <p id="statusMessage" class="status-text"></p>
            </form>
            
            <div id="cooldownInfo" style="margin-top: 15px; padding: 10px; background: rgba(141, 108, 57, 0.1); border-radius: 6px; border-left: 3px solid #8d6c39;">
              <p style="margin: 0; color: #4a3728; font-size: 13px;">
                <strong>Note:</strong> You can submit feedback once per week to ensure everyone has a chance to share their thoughts.
              </p>
            </div>
          </section>
        </div>
      `;

      const form = document.getElementById("feedbackForm");
      const ratingStars = document.querySelectorAll("#rating span");
      const ratingValueInput = document.getElementById("ratingValue");
      const statusMessage = document.getElementById("statusMessage");
      const sendBtn = document.getElementById("sendFeedbackBtn");

      ratingStars.forEach(star => {
        star.style.opacity = "0.3";
        star.style.transition = "opacity 0.3s ease";
        star.addEventListener("click", () => {
          const val = star.getAttribute("data-value");
          ratingValueInput.value = val;
          ratingStars.forEach(s => {
            s.style.opacity = s.getAttribute("data-value") <= val ? "1" : "0.3";
          });
        });
        
        star.addEventListener("mouseenter", () => {
          if (!star.style.opacity || star.style.opacity === "0.3") {
            star.style.transform = "scale(1.1)";
          }
        });
        
        star.addEventListener("mouseleave", () => {
          star.style.transform = "scale(1)";
        });
      });

      function disableButtonForCooldown() {
        sendBtn.disabled = true;
        sendBtn.style.background = "linear-gradient(135deg, #777, #999)";
        sendBtn.style.cursor = "not-allowed";
        sendBtn.style.opacity = "0.7";
      }

      function enableButton() {
        sendBtn.disabled = false;
        sendBtn.style.background = "";
        sendBtn.style.cursor = "pointer";
        sendBtn.style.opacity = "1";
      }

      function formatTimeRemaining(milliseconds) {
        const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
        const hours = Math.floor((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

        if (days > 0) {
          return `${days} day${days > 1 ? 's' : ''}, ${hours} hour${hours > 1 ? 's' : ''}`;
        } else if (hours > 0) {
          return `${hours} hour${hours > 1 ? 's' : ''}, ${minutes} minute${minutes > 1 ? 's' : ''}`;
        } else if (minutes > 0) {
          return `${minutes} minute${minutes > 1 ? 's' : ''}, ${seconds} second${seconds > 1 ? 's' : ''}`;
        } else {
          return `${seconds} second${seconds > 1 ? 's' : ''}`;
        }
      }

      function formatCountdownTime(milliseconds) {
        const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
        const hours = Math.floor((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

        let parts = [];
        if (days > 0) parts.push(`${days}d`);
        if (hours > 0) parts.push(`${hours}h`);
        if (minutes > 0) parts.push(`${minutes}m`);
        if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);
        
        return parts.join(" ");
      }

      const cooldownEnd = localStorage.getItem("feedbackCooldownEnd");
      if (cooldownEnd && Date.now() < cooldownEnd) {
        disableButtonForCooldown();
        const remainingMs = cooldownEnd - Date.now();
        
        const countdown = setInterval(() => {
          const timeLeftMs = cooldownEnd - Date.now();
          
          if (timeLeftMs <= 0) {
            clearInterval(countdown);
            enableButton();
            statusMessage.textContent = "";
            statusMessage.style.color = "";
            localStorage.removeItem("feedbackCooldownEnd");
            
            statusMessage.style.color = "#27ae60";
            statusMessage.textContent = "Ready to submit feedback!";
            setTimeout(() => {
              statusMessage.textContent = "";
              statusMessage.style.color = "";
            }, 3000);
          } else {
            const countdownText = formatCountdownTime(timeLeftMs);
            statusMessage.style.color = "#f39c12";
            statusMessage.textContent = `Next feedback available in: ${countdownText}`;
          }
        }, 1000);
      }

      onAuthStateChanged(auth, user => {
        if (!user) {
          statusMessage.textContent = "Please log in to send feedback.";
          form.style.display = "none";
        } else {
          form.addEventListener("submit", async e => {
            e.preventDefault();

            if (!ratingValueInput.value) {
              await showPopup("Please select a rating by clicking the stars.");
              return;
            }

            const requiredFields = ['q1', 'q2', 'q3', 'q4', 'q5'];
            for (const fieldId of requiredFields) {
              const field = document.getElementById(fieldId);
              if (!field.value) {
                await showPopup(`Please answer question ${fieldId.replace('q', '')}.`);
                field.focus();
                return;
              }
            }

            setButtonLoading(sendBtn, true);
            statusMessage.style.color = "#3498db";
            statusMessage.textContent = "Sending your feedback...";

            try {
              await addDoc(collection(db, "feedback"), {
                tenantEmail: user.email,
                rating: Number(ratingValueInput.value),
                q1: form.q1.value,
                q2: form.q2.value,
                q3: form.q3.value,
                q4: form.q4.value,
                q5: form.q5.value,
                q6: form.q6.value.trim(),
                timestamp: serverTimestamp()
              });

              statusMessage.style.color = "#27ae60";
              statusMessage.textContent = "‚úÖ Feedback sent successfully! Thank you for sharing your thoughts.";
              
              statusMessage.style.fontWeight = "bold";
              statusMessage.style.padding = "10px";
              statusMessage.style.background = "rgba(39, 174, 96, 0.1)";
              statusMessage.style.borderRadius = "6px";
              statusMessage.style.border = "2px solid #27ae60";

              form.reset();
              ratingStars.forEach(s => (s.style.opacity = "0.3"));
              ratingValueInput.value = "";

              const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
              const cooldownTime = Date.now() + ONE_WEEK;
              localStorage.setItem("feedbackCooldownEnd", cooldownTime);

              let countdown = setInterval(() => {
                const timeLeftMs = cooldownTime - Date.now();
                
                if (timeLeftMs <= 0) {
                  clearInterval(countdown);
                  enableButton();
                  statusMessage.textContent = "";
                  statusMessage.style.background = "";
                  statusMessage.style.border = "";
                  localStorage.removeItem("feedbackCooldownEnd");
                  
                  statusMessage.style.color = "#27ae60";
                  statusMessage.textContent = "Ready to submit feedback again!";
                  setTimeout(() => {
                    statusMessage.textContent = "";
                    statusMessage.style.color = "";
                  }, 3000);
                } else {
                  const countdownText = formatCountdownTime(timeLeftMs);
                  statusMessage.style.color = "#f39c12";
                  statusMessage.textContent = `Next feedback available in: ${countdownText}`;
                }
              }, 1000);

            } catch (error) {
              console.error("Error sending feedback: ", error);
              statusMessage.style.color = "#e74c3c";
              statusMessage.textContent = "‚ùå Error sending feedback. Please try again.";
              enableButton();
              
              setTimeout(() => {
                statusMessage.textContent = "";
              }, 5000);
            }
          });
        }
      });
    }

    /* ======================== GREETING & POPUP ======================== */
    function showWelcomeBack() {
      onAuthStateChanged(auth, user => {
        if (user) {
          const greeting = document.getElementById("tenantGreeting");
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    showWelcomeBack();

    /* ======================== POPUP HELPERS ======================== */
function showPopup(message) {
  const msgEl = document.getElementById("popupMessage");
  const popupEl = document.getElementById("customPopup");
  if (!msgEl || !popupEl) return;

  msgEl.innerHTML = message;
  popupEl.classList.remove("hidden");
}

function closePopup() {
  const popupEl = document.getElementById("customPopup");
  if (!popupEl) return;
  popupEl.classList.add("hidden");
}

// make them available to the inline "onclick" on the Close button
window.showPopup = showPopup;
window.closePopup = closePopup;


    /* ======================== TAB PERSISTENCE ======================== */
    function setActiveTabOnLoad() {
      const savedTab = localStorage.getItem('activeTab');
      if (savedTab) {
        document.querySelectorAll(".sidebar nav ul li a").forEach(link => {
          link.classList.remove("active");
        });
        
        const savedTabLink = document.querySelector(`.sidebar nav ul li a[onclick*="${savedTab}"]`);
        if (savedTabLink) {
          savedTabLink.classList.add("active");
        }
      }
    }

   window.addEventListener("DOMContentLoaded", () => {
  // safety: make sure overlay is hidden when the app boots
  hideLoading();

  setActiveTabOnLoad();
  const savedTab = localStorage.getItem("activeTab");
  if (savedTab && ["dashboard", "maintenance", "billing", "feedback"].includes(savedTab)) {
    loadContent(null, savedTab);
  } else {
    loadContent(null, "dashboard");
  }
});
  </script>

  <!-- ======================== POPUP ======================== -->
  <div id="customPopup" class="popup hidden">
    <div class="popup-content">
      <p id="popupMessage">Your message goes here</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>
</body>
</html>
