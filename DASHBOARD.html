<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Owner Dashboard ‚Äì Solano Hills</title>
  <link rel="stylesheet" href="Dashboard.css" />
</head>
<body>

  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <li><a href="#" onclick="loadContent(event, 'maintenance')">Maintenance</a></li>
        <li><a href="#" onclick="loadContent(event, 'billing')">Billing and Payments</a></li>
        <li><a href="#" onclick="loadContent(event, 'feedback')">Feedback</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <main class="main-content">
    <div id="mainContent">
      <h1 id="tenantGreeting">Welcome back, Tenant</h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id=ASDYl8DDDQKLSnsL75To3794uumVSxwIKExnbGsTeuNsmrdqIMJTf9FKF3BWjULxHoQOvA5oNflYDSgh&currency=PHP"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("lqyGatNXQhoDJsu2B");
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      getDoc,
      updateDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";
    
    /* ======================== FIREBASE INIT ======================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    /* ==================== SIMPLE LOADING FUNCTIONS ==================== */
    window.showLoading = function() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('hidden');
      }
    };

    window.hideLoading = function() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.add('hidden');
      }
    };

    window.setButtonLoading = function(button, isLoading) {
      if (!button) return;
      
      if (isLoading) {
        button.disabled = true;
        button.classList.add('button-loading');
        const originalText = button.textContent;
        button.setAttribute('data-original-text', originalText);
        button.textContent = 'Loading...';
      } else {
        button.disabled = false;
        button.classList.remove('button-loading');
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
          button.textContent = originalText;
        }
      }
    };

    function getCurrentUserEmail() {
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? user.email : "Unknown Tenant");
        });
      });
    }

    const mainContent = document.getElementById("mainContent");

    /* ======================== MAIN ROUTER ======================== */
    window.loadContent = function (event, section) {
      // Save the active tab to localStorage
      localStorage.setItem('activeTab', section);
      
      // Show loading when switching sections
      showLoading();
      
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }

      // remove active class from all sidebar links
      document
        .querySelectorAll(".sidebar nav ul li a")
        .forEach(link => link.classList.remove("active"));

      // add active class to clicked or default link
      if (event && event.target) {
        event.target.classList.add("active");
      } else {
        const selector = `.sidebar nav ul li a[onclick*="${section}"]`;
        const defaultLink = document.querySelector(selector);
        if (defaultLink) defaultLink.classList.add("active");
      }

      switch (section) {
        /* ======================== DASHBOARD ======================== */
        case "dashboard":
          mainContent.innerHTML = `
            <div class="tab-header">
              <div>
                <h1 class="page-title" id="Greeting1">Dashboard</h1>
                <p class="page-subtitle">Overview of your units, calendar, and community feedback.</p>
              </div>
            </div>

            <div class="dashboard-container">
              <section class="card welcome-slider">
                <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1" /></div>
                <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2" /></div>
                <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3" /></div>
                <button class="prev" id="sliderPrev">&#10094;</button>
                <button class="next" id="sliderNext">&#10095;</button>
              </section>

              <div class="dashboard-right">
                <section class="card calendar-card">
                  <h3 class="section-title">üìÖ Calendar</h3>
                  <div id="calendar"></div>
                </section>

                <section class="card inbox-card">
                  <h3 class="section-title">My Unit List</h3>
                  <p>Unit(s) you own:</p>
                  <div id="myUnitList" style="padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); max-width:280px; margin-top:10px;">
                    Loading units...
                  </div>
                </section>
              </div>
            </div>

            <section class="card community-card">
              <div class="section-header">
                <h2 class="section-title">üèòÔ∏è Community Feedback</h2>
                <div class="section-actions">
                  <label for="feedbackSort">Sort by:</label>
                  <select id="feedbackSort" class="select-sm">
                    <option value="date-desc">Date (Newest First)</option>
                    <option value="date-asc">Date (Oldest First)</option>
                    <option value="rating-desc">Rating (High to Low)</option>
                    <option value="rating-asc">Rating (Low to High)</option>
                    <option value="random">Random</option>
                  </select>
                </div>
              </div>

              <div id="communityStats" class="community-stats">
                <div>
                  <strong>Total Feedback:</strong> <span id="totalFeedback">0</span>
                </div>
                <div>
                  <strong>Average Rating:</strong> <span id="avgRating">0.0</span>/5
                </div>
                <div>
                  <strong>Rating Distribution:</strong>
                  <span id="rating5">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
                  <span id="rating4">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê |
                  <span id="rating3">0</span> ‚≠ê‚≠ê‚≠ê |
                  <span id="rating2">0</span> ‚≠ê‚≠ê |
                  <span id="rating1">0</span> ‚≠ê
                </div>
              </div>

              <div id="communityFeedback" class="community-grid">
                <p class="community-empty">Loading community feedback...</p>
              </div>

              <div id="expandControls" class="community-expand" style="display:none;">
                <div class="community-expand-inner">
                  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px;">
                    <p style="margin:0;">
                      Showing <span id="showingCount">4</span> of <span id="totalCount">0</span> feedback items
                    </p>
                    <div style="display: flex; gap: 10px;">
                      <button id="toggleDetailsBtn" class="btn-primary" style="background: white; color: #4a3728;">
                        See More Details
                      </button>
                      <button id="expandAllBtn" class="btn-primary">Show All Feedback</button>
                    </div>
                  </div>
                </div>
              </div>

              <div id="feedbackMessage" class="community-note">
                <strong>Note:</strong> These are anonymous feedback from other unit owners. Your own feedback is not shown here to maintain privacy.
              </div>
            </section>
          `;

          // Initialize dashboard functions after DOM is ready
          setTimeout(() => {
            initDashboard();
            hideLoading(); // Hide loading after content is ready
          }, 100);
          break;

        // Add this function outside the switch statement or at the top level
        async function initDashboard() {
          function escapeHtml(text) {
            if (!text) return "";
            return text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }

          let communityFeedbackData = [];
          let showingAllFeedback = false;
          let showingAllDetails = false;

          // Wait for auth state before loading units
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              await populateMyUnits();
              // Load feedback after units are loaded
              setTimeout(() => {
                loadCommunityFeedback();
              }, 300);
            } else {
              document.getElementById("myUnitList").textContent = "Please log in to view units.";
            }
          });

          async function populateMyUnits() {
            try {
              const currentUser = auth.currentUser;
              if (!currentUser) {
                console.log("No user logged in");
                return;
              }

              console.log("Fetching units for user:", currentUser.uid);
              const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
              
              if (!tenantDocSnap.exists()) {
                document.getElementById("myUnitList").textContent = "No units found.";
                return;
              }

              const units = tenantDocSnap.data().unitNumbers || [];
              console.log("Units found:", units);
              
              if (units.length === 0) {
                document.getElementById("myUnitList").textContent = "No units assigned.";
                return;
              }

              // Create a more visually appealing unit list
              document.getElementById("myUnitList").innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  ${units.map(u => `
                    <div style="
                      padding: 8px 12px;
                      background: rgba(255,255,255,0.1);
                      border-radius: 6px;
                      border-left: 3px solid #8d6c39;
                      font-weight: 500;
                      transition: all 0.3s ease;
                    ">
                      ${u}
                    </div>
                  `).join("")}
                </div>
              `;
              
              // Add hover effect
              const unitItems = document.querySelectorAll("#myUnitList > div > div");
              unitItems.forEach(item => {
                item.addEventListener("mouseenter", () => {
                  item.style.transform = "translateX(5px)";
                  item.style.background = "rgba(141, 108, 57, 0.2)";
                });
                item.addEventListener("mouseleave", () => {
                  item.style.transform = "translateX(0)";
                  item.style.background = "rgba(255,255,255,0.1)";
                });
              });
              
            } catch (e) {
              console.error("Error fetching units:", e);
              document.getElementById("myUnitList").innerHTML = `
                <div style="color: #ff6b6b; padding: 10px; background: rgba(255,107,107,0.1); border-radius: 6px;">
                  Failed to load units. Please try refreshing the page.
                </div>
              `;
            }
          }

          async function loadCommunityFeedback() {
            const communityFeedback = document.getElementById("communityFeedback");
            if (!communityFeedback) {
              console.error("Community feedback element not found");
              return;
            }
            
            const currentUser = auth.currentUser;
            const currentUserEmail = currentUser ? currentUser.email : null;

            try {
              console.log("Loading community feedback...");
              const snapshot = await getDocs(collection(db, "feedback"));

              if (snapshot.empty) {
                communityFeedback.innerHTML =
                  '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available yet.</p>';
                document.getElementById("feedbackMessage").style.display = "none";
                return;
              }

              communityFeedbackData = [];
              let totalRating = 0;
              const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

              snapshot.forEach(docSnap => {
                const data = docSnap.data();

                communityFeedbackData.push({
                  id: docSnap.id,
                  ...data
                });

                const rating = data.rating || 0;
                if (rating >= 1 && rating <= 5) {
                  totalRating += rating;
                  ratingCounts[rating]++;
                }
              });

              if (communityFeedbackData.length === 0) {
                communityFeedback.innerHTML =
                  '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback from other unit owners yet.</p>';
                document.getElementById("feedbackMessage").style.display = "block";
                return;
              }

              // Update stats with animation
              animateCounter("totalFeedback", communityFeedbackData.length);
              document.getElementById("avgRating").textContent = (
                totalRating / communityFeedbackData.length
              ).toFixed(1);
              animateCounter("rating5", ratingCounts[5]);
              animateCounter("rating4", ratingCounts[4]);
              animateCounter("rating3", ratingCounts[3]);
              animateCounter("rating2", ratingCounts[2]);
              animateCounter("rating1", ratingCounts[1]);

              if (communityFeedbackData.length > 4) {
                document.getElementById("expandControls").style.display = "block";
                document.getElementById("totalCount").textContent = communityFeedbackData.length;
              }

              // Initialize sorting
              applyFeedbackSorting();
              document.getElementById("feedbackMessage").style.display = "block";
              
              // Setup event listeners after DOM is ready
              setTimeout(() => {
                const feedbackSortSelect = document.getElementById("feedbackSort");
                const expandAllBtn = document.getElementById("expandAllBtn");
                const toggleDetailsBtn = document.getElementById("toggleDetailsBtn");
                
                if (feedbackSortSelect) {
                  feedbackSortSelect.addEventListener("change", applyFeedbackSorting);
                }
                
                if (expandAllBtn) {
                  expandAllBtn.addEventListener("click", function () {
                    showingAllFeedback = !showingAllFeedback;
                    applyFeedbackSorting();
                    if (showingAllFeedback) {
                      document
                        .querySelector("#communityFeedback")
                        .scrollIntoView({ behavior: "smooth", block: "start" });
                    }
                  });
                }
                
                if (toggleDetailsBtn) {
                  toggleDetailsBtn.addEventListener("click", function() {
                    showingAllDetails = !showingAllDetails;
                    toggleAllDetails();
                  });
                }
              }, 100);
              
            } catch (error) {
              console.error("Error loading community feedback:", error);
              communityFeedback.innerHTML = `<p style="color: white; text-align: center; grid-column: 1 / -1; color: #ffcccc;">Error loading community feedback: ${error.message}</p>`;
            }
          }

          // Helper function for animated counters
          function animateCounter(elementId, targetValue, duration = 1000) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let startValue = parseInt(element.textContent) || 0;
            let startTime = null;
            
            function updateCounter(timestamp) {
              if (!startTime) startTime = timestamp;
              const progress = timestamp - startTime;
              const percentage = Math.min(progress / duration, 1);
              
              // Easing function for smooth animation
              const easeOutQuad = t => t * (2 - t);
              const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuad(percentage));
              
              element.textContent = currentValue;
              
              if (percentage < 1) {
                requestAnimationFrame(updateCounter);
              } else {
                element.textContent = targetValue;
              }
            }
            
            requestAnimationFrame(updateCounter);
          }

          function applyFeedbackSorting() {
            const sortValue = document.getElementById("feedbackSort")?.value || "date-desc";
            if (communityFeedbackData.length === 0) return;

            let sortedFeedback = [...communityFeedbackData];

            switch (sortValue) {
              case "date-desc":
                sortedFeedback.sort(
                  (a, b) =>
                    (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0)
                );
                break;
              case "date-asc":
                sortedFeedback.sort(
                  (a, b) =>
                    (a.timestamp?.toDate?.() || 0) - (b.timestamp?.toDate?.() || 0)
                );
                break;
              case "rating-desc":
                sortedFeedback.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                break;
              case "rating-asc":
                sortedFeedback.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                break;
              case "random":
                for (let i = sortedFeedback.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [sortedFeedback[i], sortedFeedback[j]] = [
                    sortedFeedback[j],
                    sortedFeedback[i]
                  ];
                }
                break;
            }

            renderCommunityFeedback(sortedFeedback);
          }

          function renderCommunityFeedback(feedbackArray) {
            const communityFeedback = document.getElementById("communityFeedback");
            if (!communityFeedback) return;

            if (feedbackArray.length === 0) {
              communityFeedback.innerHTML =
                '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available.</p>';
              return;
            }

            communityFeedback.innerHTML = "";

            let itemsToShow = feedbackArray;
            if (!showingAllFeedback && feedbackArray.length > 4) {
              itemsToShow = feedbackArray.slice(0, 4);
              document.getElementById("showingCount").textContent = "4";
            } else {
              document.getElementById("showingCount").textContent = feedbackArray.length;
            }

            const expandBtn = document.getElementById("expandAllBtn");
            if (expandBtn) {
              if (showingAllFeedback) {
                expandBtn.textContent = "Show Less (First 4)";
                expandBtn.style.background = "#4a3728";
                expandBtn.style.color = "white";
              } else {
                expandBtn.textContent = `Show All ${feedbackArray.length} Feedback Items`;
                expandBtn.style.background = "white";
                expandBtn.style.color = "#4a3728";
              }
            }

            // Update toggle details button
            const toggleDetailsBtn = document.getElementById("toggleDetailsBtn");
            if (toggleDetailsBtn) {
              if (showingAllDetails) {
                toggleDetailsBtn.textContent = "See Less Details";
                toggleDetailsBtn.style.background = "#4a3728";
                toggleDetailsBtn.style.color = "white";
              } else {
                toggleDetailsBtn.textContent = "See More Details";
                toggleDetailsBtn.style.background = "white";
                toggleDetailsBtn.style.color = "#4a3728";
              }
            }

            // Add fade-in animation for each card
            itemsToShow.forEach((feedback, index) => {
              const timeText = feedback.timestamp?.toDate
                ? feedback.timestamp
                    .toDate()
                    .toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric"
                    })
                : "Recent";

              const stars = "‚≠ê".repeat(feedback.rating || 0);
              const emptyStars = "‚òÜ".repeat(5 - (feedback.rating || 0));

              let bgColor = "#f5f1e8";
              let borderColor = "#d4c9b8";

              if (feedback.rating >= 4) {
                bgColor = "#e8e0d1";
                borderColor = "#c9b89c";
              }
              if (feedback.rating <= 2) {
                bgColor = "#f0e6d6";
                borderColor = "#d9c6a9";
              }

              const card = document.createElement("div");
              card.style.background = bgColor;
              card.style.border = `2px solid ${borderColor}`;
              card.style.borderRadius = "10px";
              card.style.padding = "18px";
              card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
              card.style.transition = "all 0.3s ease";
              card.style.opacity = "0";
              card.style.transform = "translateY(20px)";
              card.style.animation = `fadeInUp 0.5s ease-out ${index * 0.1}s forwards`;

              const hasNewSchema =
                feedback.q1 ||
                feedback.q2 ||
                feedback.q3 ||
                feedback.q4 ||
                feedback.q5 ||
                feedback.q6;

              // Create simplified view (stars and date only by default)
              const cardId = `feedback-card-${feedback.id || index}`;
              
              // Create the main content (stars and date)
              const headerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                  <div style="color: #8d6c39; font-size: 20px;">
                    ${stars}${emptyStars}
                    <span style="color: #4a3728; font-size: 15px; margin-left: 8px;">(${feedback.rating || 0}/5)</span>
                  </div>
                  <div style="color: #8d6c39; font-size: 13px; font-weight: 500;">
                    ${timeText}
                  </div>
                </div>
              `;

              // Create details content (hidden by default unless showingAllDetails is true)
              let detailsHtml = "";
              
              if (hasNewSchema) {
                detailsHtml = `
                  <div id="${cardId}-details" style="display: ${showingAllDetails ? 'block' : 'none'}; margin-top: 12px; animation: fadeIn 0.3s ease-out;">
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Overall condition and appearance of the property</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q1 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Maintenance services (unit, hallway, garden)</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q2 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Professionalism of property management staff</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q3 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Ease of paying monthly dues/rent</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q4 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Amenities (gym, pool, clubhouse)</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q5 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <strong style="color: #4a3728; font-size: 14px;">Additional suggestions</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #4a3728;">
                        ${escapeHtml(feedback.q6 || "No suggestions provided")}
                      </div>
                    </div>
                  </div>
                `;
              } else {
                detailsHtml = `
                  <div id="${cardId}-details" style="display: ${showingAllDetails ? 'block' : 'none'}; margin-top: 12px; animation: fadeIn 0.3s ease-out;">
                    <div style="margin-bottom: 12px;">
                      <strong style="color: #4a3728; font-size: 14px;">What do you like about our services, unit, and facilities?</strong>
                      <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #8d6c39;">
                        ${escapeHtml(feedback.question2 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                      <strong style="color: #4a3728; font-size: 14px;">What can we improve in our unit, services, or facilities?</strong>
                      <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #4a3728;">
                        ${escapeHtml(feedback.question3 || "No answer provided")}
                      </div>
                    </div>
                  </div>
                `;
              }

              card.innerHTML = `
                ${headerHtml}
                ${detailsHtml}
              `;

              card.addEventListener("mouseenter", () => {
                card.style.transform = "translateY(-5px)";
                card.style.boxShadow = "0 8px 25px rgba(74, 55, 40, 0.3)";
              });

              card.addEventListener("mouseleave", () => {
                card.style.transform = "translateY(0)";
                card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
              });

              communityFeedback.appendChild(card);
            });

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
              @keyframes fadeInUp {
                from {
                  opacity: 0;
                  transform: translateY(20px);
                }
                to {
                  opacity: 1;
                  transform: translateY(0);
                }
              }
              @keyframes fadeIn {
                from {
                  opacity: 0;
                }
                to {
                  opacity: 1;
                }
              }
            `;
            document.head.appendChild(style);
          }

          function toggleAllDetails() {
            const feedbackCards = document.querySelectorAll('#communityFeedback > div');
            const toggleDetailsBtn = document.getElementById("toggleDetailsBtn");
            
            feedbackCards.forEach((card, index) => {
              const detailsSection = card.querySelector(`[id$="-details"]`);
              if (detailsSection) {
                if (showingAllDetails) {
                  detailsSection.style.display = "block";
                } else {
                  detailsSection.style.display = "none";
                }
              }
            });
            
            // Update button text and style
            if (toggleDetailsBtn) {
              if (showingAllDetails) {
                toggleDetailsBtn.textContent = "See Less Details";
                toggleDetailsBtn.style.background = "#4a3728";
                toggleDetailsBtn.style.color = "white";
              } else {
                toggleDetailsBtn.textContent = "See More Details";
                toggleDetailsBtn.style.background = "white";
                toggleDetailsBtn.style.color = "#4a3728";
              }
            }
          }

          // Initialize image slider
          (function initImageSlider() {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            // Wait for DOM to be ready
            setTimeout(() => {
              showSlidesLocal(slideIndexLocal);
              
              const sliderPrev = document.getElementById("sliderPrev");
              const sliderNext = document.getElementById("sliderNext");
              
              if (sliderPrev) {
                sliderPrev.addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
              }
              if (sliderNext) {
                sliderNext.addEventListener("click", () => showSlidesLocal(++slideIndexLocal));
              }

              const sliderInterval = setInterval(
                () => showSlidesLocal(++slideIndexLocal),
                5000
              );
              const sliderEl = document.querySelector(".welcome-slider");
              if (sliderEl) {
                sliderEl.addEventListener("mouseenter", () => clearInterval(sliderInterval));
              }
            }, 200);
          })();

          // Initialize calendar
          (function initCalendar() {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
              html +=
                "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate())
                  html += "</tr><tr>";
              }
              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            
            // Wait for calendar element to be ready
            setTimeout(() => {
              generateCalendar();
            }, 200);
          })();
        }
        break;

        /* ======================== MAINTENANCE ======================== */
 case "maintenance":
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Maintenance Request</h1>
        <p class="page-subtitle">Report issues in your unit and chat with maintenance personnel.</p>
      </div>
    </div>

    <div class="maintenance-tab">
      <div class="maintenance-left">
        <section class="card maintenance-form">
          <h2 class="section-title">New Request</h2>
          <p><strong>What issue do you want to report?</strong></p>

          <label for="unitSelect">Select Unit:</label>
          <select id="unitSelect" required>
            <option value="">-- Select Unit --</option>
          </select>

          <label for="problem" style="margin-top:10px;">Select issue type:</label>
          <select id="problem">
            <option value="">-- Select Issue --</option>
            <optgroup label="Handyman Works">
              <option>Drilling Works</option>
              <option>Peephole Installation</option>
              <option>PVC Door</option>
              <option>Vinyl Tiles</option>
              <option>Main Door Lockset</option>
              <option>Window Grills</option>
              <option>Door Repainting</option>
            </optgroup>
            <optgroup label="Electrical Works">
              <option>Chandelier Installation</option>
              <option>Circuit Breaker</option>
              <option>Outlet / Switch</option>
              <option>Electrical Troubleshooting</option>
              <option>Smoke Detector Installation</option>
            </optgroup>
            <optgroup label="Plumbing Works">
              <option>Bidet Installation</option>
              <option>Grease Trap Cleaning</option>
              <option>Shower Valve</option>
              <option>Angle Valve</option>
              <option>P-Trap Replacement</option>
            </optgroup>
            <optgroup label="Aircon / ACU Services">
              <option>ACU Installation</option>
              <option>ACU Re-Opening / Adjustment</option>
              <option>ACU Drain Pipe</option>
              <option>ACU Cleaning (Split Type)</option>
            </optgroup>
            <optgroup label="Other Services">
              <option>Wall Mounted TV Installation</option>
              <option>Sprinkler Installation</option>
              <option>Wall Opening</option>
              <option>Painting / Repainting</option>
            </optgroup>
            <optgroup label="Cleaning">
              <option>Exhaust Fan Cleaning</option>
              <option>Electrical Panel Cleaning</option>
              <option>Sweeping / General Cleaning</option>
            </optgroup>
            <option value="other">Other (Not Listed)</option>
          </select>

          <div id="otherSection" style="display:none; margin-top:15px;">
            <label for="otherComment">Describe the problem:</label>
            <textarea id="otherComment" rows="4" placeholder="Write details here..."></textarea>
          </div>

          <div id="detailsSection" style="display:none; margin-top:10px;">
            <label for="imageUpload" style="display:block;">Upload 1 or 2 JPEG images (optional, required for "Others"):</label>
            <input type="file" id="imageUpload" accept="image/jpeg" multiple>

            <label for="preferredDate" style="margin-top:15px; display:block;">Select preferred maintenance visit date and time:</label>
            <label>Preferred Date:</label>
            <input type="date" id="preferredDate" required>
            <label>Preferred Time:</label>
            <select id="preferredTime" required>
              <option value="">Select Time</option>
              <option value="10:00 AM">10:00 AM</option>
              <option value="11:00 AM">11:00 AM</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="1:00 PM">1:00 PM</option>
              <option value="2:00 PM">2:00 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="4:00 PM">4:00 PM</option>
              <option value="5:00 PM">5:00 PM</option>
              <option value="6:00 PM">6:00 PM</option>
              <option value="7:00 PM">7:00 PM</option>
              <option value="8:00 PM">8:00 PM</option>
              <option value="9:00 PM">9:00 PM</option>
              <option value="10:00 PM">10:00 PM</option>
            </select>
          </div>
          <button id="submitReport" class="btn-primary" style="margin-top:12px;">Submit Request</button>
          <p id="statusMessage" class="status-text"></p>
        </section>

        <section class="card">
          <h3 class="section-title">üìå Solano Hills Job Service Rates</h3>
          <div class="service-rates-scroll">
            <h4>Handyman Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Drilling Works</td><td>Php 120.00/set</td><td>Main Door Locket</td><td>Php 250.00</td></tr>
              <tr><td>Peephole (provision)</td><td>Php 120.00/set</td><td>Window Grills</td><td>Php 400.00</td></tr>
              <tr><td>Peephole (w/ provision)</td><td>Php 350.00/set</td><td>Main Door</td><td>Php 560.00</td></tr>
              <tr><td>Vinyl Tiles</td><td>Php 200.00/sqmtr</td><td>Plastering of ACU sides</td><td>Php 560.00</td></tr>
              <tr><td>PVC door</td><td>Php 560.00/set</td><td>Repainting of window grills</td><td>Php 560.00</td></tr>
              <tr><td>Rangehood w/ provision</td><td>Php 650.00/set</td><td>Repainting of ACU sides</td><td>Php 400.00</td></tr>
            </table>

            <h4>Electrical Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Chandelier</td><td>Php 1,800.00/pc</td><td>Bulb / Receptacle</td><td>Php 120.00</td></tr>
              <tr><td>Circuit Breaker</td><td>Php 760.00/pc</td><td>Troubleshooting</td><td>Php 250.00/item</td></tr>
            </table>

            <h4>Plumbing Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Bidet</td><td>Php 395.00/set</td><td>Faucet / Shower Head</td><td>Php 250.00</td></tr>
              <tr><td>Grease Trap</td><td>Php 1,500.00</td><td>Shower Valve</td><td>Php 900.00</td></tr>
            </table>

            <h4>Other Services</h4>
            <table class="rate-table">
              <tr><th>Service</th><th>Rate</th></tr>
              <tr><td>Wall Mounted TV (below 40in)</td><td>Php 460.00/set</td></tr>
              <tr><td>ACU Installation</td><td>Php 1,500.00</td></tr>
              <tr><td>Smoke Detector Cleaning</td><td>Php 120.00</td></tr>
            </table>

            <h4>Cleaning Services</h4>
            <table class="rate-table">
              <tr><th>Service</th><th>Rate</th></tr>
              <tr><td>ACU Cleaning Split Type</td><td>Php 1500.00/pc</td></tr>
              <tr><td>Exhaust Fan Cleaning</td><td>Php 600.00/unit</td></tr>
            </table>
          </div>
        </section>
      </div>

      <aside class="maintenance-right">
        <section class="card maintenance-history-card">
          <h3 class="history-header">Request History</h3>
          <div id="historyList">
            <p>Loading your requests...</p>
          </div>
        </section>
      </aside>
    </div>
  `;

  // Hide loading after content is rendered
  hideLoading();

  function formatDateTimeAMPM(date) {
    if (!(date instanceof Date)) date = date?.toDate ? date.toDate() : null;
    if (!date) return "No Response Yet";
    let hours = date.getHours();
    const minutes = date.getMinutes().toString().padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    const day = date.getDate().toString().padStart(2, "0");
    const month = (date.getMonth() + 1).toString().padStart(2, "0");
    const year = date.getFullYear();
    return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
  }

  function calculateWaitTime(priority) {
    const waitTimes = {
      'high': '1-2 hours',
      'medium': '4-6 hours', 
      'low': '24-48 hours'
    };
    
    const highPriority = [
      'Circuit Breaker', 'Electrical Troubleshooting', 'ACU Drain Pipe',
      'Angle Valve', 'P-Trap Replacement', 'Shower Valve'
    ];
    
    const mediumPriority = [
      'Outlet / Switch', 'Main Door Lockset', 'Window Grills',
      'Bidet Installation', 'ACU Cleaning (Split Type)', 'ACU Installation',
      'ACU Re-Opening / Adjustment', 'Smoke Detector Installation'
    ];
    
    if (priority && waitTimes[priority]) {
      return waitTimes[priority];
    }
    
    return waitTimes['medium'];
  }

  const preferredDateInput = document.getElementById("preferredDate");
  const preferredTimeSelect = document.getElementById("preferredTime");

  preferredDateInput.addEventListener("change", () => {
    const selected = new Date(preferredDateInput.value);
    const day = selected.getDay();
    
    if (day === 0) {
      showPopup("Maintenance is NOT available on Sundays. Please pick Monday to Saturday.");
      preferredDateInput.value = "";
      return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    selected.setHours(0, 0, 0, 0);

    if (selected < today) {
      showPopup("Preferred visit date cannot be in the past.");
      preferredDateInput.value = "";
    }
  });

  preferredTimeSelect.addEventListener("change", function() {
    const selectedDate = preferredDateInput.value;
    const selectedTime = this.value;
    
    if (!selectedDate || !selectedTime) return;
    
    const timeMap = {
      "10:00 AM": "10:00",
      "11:00 AM": "11:00", 
      "12:00 PM": "12:00",
      "1:00 PM": "13:00",
      "2:00 PM": "14:00",
      "3:00 PM": "15:00",
      "4:00 PM": "16:00",
      "5:00 PM": "17:00",
      "6:00 PM": "18:00",
      "7:00 PM": "19:00",
      "8:00 PM": "20:00",
      "9:00 PM": "21:00",
      "10:00 PM": "22:00"
    };
    
    const time24 = timeMap[selectedTime];
    const selectedDateTime = new Date(`${selectedDate}T${time24}:00`);
    const now = new Date();
    
    if (selectedDateTime < now) {
      showPopup("Preferred visit time cannot be in the past.");
      this.value = "";
    }
  });

  const nowMaint = new Date();
  nowMaint.setMinutes(Math.ceil(nowMaint.getMinutes() / 15) * 15);
  preferredDateInput.min = nowMaint.toISOString().slice(0, 16);

  const problemSelect = document.getElementById("problem");
  const otherSection = document.getElementById("otherSection");
  const detailsSection = document.getElementById("detailsSection");
  const submitButton = document.getElementById("submitReport");
  const statusMessageMaint = document.getElementById("statusMessage");
  const imageUpload = document.getElementById("imageUpload");
  const otherComment = document.getElementById("otherComment");
  const historyList = document.getElementById("historyList");
  const unitSelect = document.getElementById("unitSelect");

  let estimatedWaitTimeElement = null;

  problemSelect.addEventListener("change", () => {
    otherSection.style.display =
      problemSelect.value === "other" ? "block" : "none";
    detailsSection.style.display =
      problemSelect.value !== "" ? "block" : "none";
      
    if (problemSelect.value !== "") {
      updateEstimatedWaitTime(problemSelect.value);
    } else {
      if (estimatedWaitTimeElement) {
        estimatedWaitTimeElement.style.display = "none";
      }
      preferredDateInput.value = "";
      preferredTimeSelect.value = "";
      imageUpload.value = "";
    }
  });

  function updateEstimatedWaitTime(problemType) {
    let priority = 'medium';
    
    if ([
      'Circuit Breaker', 'Electrical Troubleshooting', 'ACU Drain Pipe',
      'Angle Valve', 'P-Trap Replacement', 'Shower Valve'
    ].includes(problemType)) {
      priority = 'high';
    }
    else if ([
      'Drilling Works', 'Peephole Installation', 'PVC Door',
      'Vinyl Tiles', 'Door Repainting', 'Painting / Repainting',
      'Exhaust Fan Cleaning', 'Electrical Panel Cleaning',
      'Sweeping / General Cleaning', 'other'
    ].includes(problemType)) {
      priority = 'low';
    }
    
    const waitTime = calculateWaitTime(priority);
    
    if (!estimatedWaitTimeElement) {
      estimatedWaitTimeElement = document.createElement("div");
      estimatedWaitTimeElement.className = "estimated-wait-time";
      estimatedWaitTimeElement.style.marginTop = "15px";
      estimatedWaitTimeElement.style.padding = "12px";
      estimatedWaitTimeElement.style.backgroundColor = "rgba(141, 108, 57, 0.1)";
      estimatedWaitTimeElement.style.border = "1px solid rgba(141, 108, 57, 0.3)";
      estimatedWaitTimeElement.style.borderRadius = "8px";
      estimatedWaitTimeElement.style.fontSize = "14px";
      
      const submitButton = document.getElementById("submitReport");
      submitButton.parentNode.insertBefore(estimatedWaitTimeElement, submitButton);
    }
    
    let priorityColor = "#f39c12";
    if (priority === 'high') priorityColor = "#e74c3c";
    if (priority === 'low') priorityColor = "#27ae60";
    
    estimatedWaitTimeElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
        <span style="color: #4a3728; font-weight: bold;">‚è±Ô∏è Estimated Wait Time:</span>
        <span style="color: ${priorityColor}; font-weight: bold; font-size: 15px;">${waitTime}</span>
      </div>
      <div style="color: #666; font-size: 13px;">
        <strong>Priority Level:</strong> 
        <span style="color: ${priorityColor}; font-weight: bold;">${priority.toUpperCase()}</span>
        ${priority === 'high' ? ' (Emergency/Urgent)' : 
          priority === 'medium' ? ' (Standard)' : 
          ' (Non-Urgent)'}
      </div>
      <div style="color: #666; font-size: 12px; margin-top: 6px;">
        <em>Note: This is an estimate. Actual time may vary based on technician availability and workload.</em>
      </div>
    `;
    estimatedWaitTimeElement.style.display = "block";
  }

  async function populateUnits() {
    try {
      const currentUser = auth.currentUser;
      const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
      if (tenantDocSnap.exists()) {
        const units = tenantDocSnap.data().unitNumbers || [];
        unitSelect.innerHTML =
          `<option value="">-- Select Unit --</option>` +
          units.map(u => `<option value="${u}">${u}</option>`).join("");
      }
    } catch (e) {
      console.error("Error fetching tenant units:", e);
    }
  }
  populateUnits();

  async function sendTenantReply(requestId, message) {
    const user = auth.currentUser;
    if (!user) {
      await showPopup("Please log in before sending a reply.");
      return;
    }
    await addDoc(
      collection(db, "maintenanceRequests", requestId, "responses"),
      {
        sender: "tenant",
        senderEmail: user.email,
        message,
        timestamp: serverTimestamp()
      }
    );
  }

  // Function for unit owner to mark maintenance as complete
  async function markAsComplete(requestId, requestData) {
    try {
      const confirmComplete = confirm("Have the maintenance crew finished the work? Marking this as complete will notify the admin.");
      
      if (!confirmComplete) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      // Update the maintenance request - set tenantMarkedComplete to true
      await updateDoc(doc(db, "maintenanceRequests", requestId), {
        tenantMarkedComplete: true,
        tenantMarkedAt: serverTimestamp(),
        tenantMarkedBy: user.email,
        updatedAt: serverTimestamp()
      });
      
      // Send notification to admin
      await addDoc(collection(db, "adminNotifications"), {
        type: "maintenance_tenant_completed",
        requestId: requestId,
        tenantEmail: user.email,
        unitNumber: requestData.unitNumber,
        problem: requestData.problem,
        timestamp: serverTimestamp(),
        read: false,
        message: `Unit owner marked maintenance as complete for ${requestData.unitNumber}`
      });
      
      // Send a chat message
      await addDoc(
        collection(db, "maintenanceRequests", requestId, "responses"),
        {
          sender: "tenant",
          senderEmail: user.email,
          message: "‚úÖ I confirm that the maintenance work has been completed and is satisfactory.",
          timestamp: serverTimestamp()
        }
      );
      
      showPopup("‚úÖ Maintenance marked as complete! Admin has been notified and will finalize the request.");
      
      // Refresh history
      setTimeout(() => {
        loadHistory();
      }, 500);
      
    } catch (error) {
      console.error("Error marking as complete:", error);
      showPopup("Error: " + error.message);
    }
  }

  /* ===================== UPDATED HISTORY LOADER ===================== */
  async function loadHistory() {
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <div class="loading-spinner-small"></div>
        <p style="color:#888; font-size:0.9rem;">Loading history...</p>
      </div>`;

    try {
      const tenantEmail = await getCurrentUserEmail();
      const qCol = collection(db, "maintenanceRequests");
      
      const querySnapshot = await getDocs(
        query(
          qCol,
          where("tenantEmail", "==", tenantEmail),
          orderBy("timestamp", "desc"),
          limit(10)
        )
      );

      if (querySnapshot.empty) {
        historyList.innerHTML = `
          <div style="text-align:center; padding:30px; color:#666; border:1px dashed #444; border-radius:8px;">
            <p>No maintenance requests found.</p>
          </div>`;
        return;
      }

      historyList.innerHTML = "";

      for (const docSnap of querySnapshot.docs) {
        const data = docSnap.data();
        const docId = docSnap.id;
        
        const status = data.status || "Pending";
        const problem = data.problem || "Unspecified Issue";
        const unit = data.unitNumber || "N/A";
        const personnel = data.maintenanceName || "Not assigned yet";
        const priority = data.priority || "medium";
        const waitTime = calculateWaitTime(priority);
        
        const submittedDate = data.timestamp ? formatDateTimeAMPM(data.timestamp) : "Unknown Date";
        const scheduledDate = data.preferredVisitTime ? formatDateTimeAMPM(data.preferredVisitTime) : "Not scheduled";

        // ========== UPDATED STATUS COLORS ==========
        let statusClass = "status-pending";
        let statusColor = "#f39c12"; // Pending - Orange
        if (status === "In Progress") { 
          statusClass = "status-progress"; 
          statusColor = "#3498db"; // In Progress - Blue
        } 
        if (status === "On Hold") { 
          statusClass = "status-onhold"; 
          statusColor = "#e67e22"; // On Hold - Dark Orange
        }
        if (status === "Work Finished") { 
          statusClass = "status-finished"; 
          statusColor = "#9b59b6"; // Work Finished - Purple
        }
        if (status === "Complete") { 
          statusClass = "status-complete"; 
          statusColor = "#27ae60"; // Complete - Green
        }

        // Check if tenant has marked as complete
        const tenantMarkedComplete = data.tenantMarkedComplete || false;
        const tenantMarkedAt = data.tenantMarkedAt ? formatDateTimeAMPM(data.tenantMarkedAt) : null;

        const item = document.createElement("div");
        item.className = `history-card-item ${statusClass}`;
        
        // ========== UPDATED BUTTON LOGIC ==========
        // Only show "Mark as Complete" button when status is "Work Finished" 
        // AND tenant hasn't already marked it as complete
        let markCompleteButton = "";
        if (status === "Work Finished" && !tenantMarkedComplete) {
          markCompleteButton = `
            <button class="mark-complete-btn" data-id="${docId}" 
                    style="background: #27ae60; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 13px; margin-top: 10px; display: flex; align-items: center; gap: 5px;">
              <i class="fas fa-check-circle"></i> Confirm Work is Complete
            </button>
          `;
        }
        
        // ========== UPDATED STATUS DISPLAY ==========
        // Show maintenance crew completion status
        let workFinishedStatus = "";
        if (status === "Work Finished") {
          const finishedTime = data.finishedTime ? formatDateTimeAMPM(data.finishedTime) : "Recently";
          workFinishedStatus = `
            <div style="background: #d4edda; color: #155724; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 13px; border-left: 4px solid #9b59b6;">
              <i class="fas fa-hard-hat"></i> 
              <strong>Maintenance Status:</strong> Work finished by ${personnel} on ${finishedTime}<br>
              <small>Please confirm the work is satisfactory by clicking "Confirm Work is Complete" above.</small>
            </div>
          `;
        }
        
        // Show tenant completion status
        let completionStatus = "";
        if (tenantMarkedComplete && status !== "Complete") {
          completionStatus = `
            <div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 13px; border-left: 4px solid #f39c12;">
              <i class="fas fa-clock"></i> 
              <strong>Your Status:</strong> You confirmed completion on ${tenantMarkedAt}<br>
              <small>Waiting for admin to finalize the request.</small>
            </div>
          `;
        } else if (tenantMarkedComplete && status === "Complete") {
          completionStatus = `
            <div style="background: #d4edda; color: #155724; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 13px;">
              <i class="fas fa-check-circle"></i> 
              <strong>Status:</strong> Completed and finalized by admin<br>
              <small>You confirmed completion on ${tenantMarkedAt}</small>
            </div>
          `;
        }
        
        item.innerHTML = `
          <div class="req-header">
            <div>
              <span class="req-title">${problem}</span>
              <span class="req-date">Ref: ${docId.substring(0,6)} ‚Ä¢ ${submittedDate}</span>
            </div>
            <div class="badge-group">
              <span class="badge" style="color:${statusColor}; border:1px solid ${statusColor}">${status}</span>
              <span class="badge badge-priority">${priority}</span>
            </div>
          </div>

          <div class="req-details-grid">
            <div class="req-row">
              <span class="req-label">Unit:</span>
              <span class="req-value">${unit}</span>
            </div>
            <div class="req-row">
              <span class="req-label">Personnel:</span>
              <span class="req-value highlight">${personnel}</span>
            </div>
            <div class="req-row">
              <span class="req-label">Est. Wait:</span>
              <span class="req-value">${waitTime}</span>
            </div>
             <div class="req-row">
              <span class="req-label">Scheduled:</span>
              <span class="req-value">${scheduledDate}</span>
            </div>
          </div>
          
          ${workFinishedStatus}
          ${markCompleteButton}
          ${completionStatus}
          
          <div class="chat-section" id="chat-${docId}">
              <div class="chat-messages" id="messages-${docId}">
                  <small style="color:#666; font-style:italic;">Loading conversation...</small>
              </div>
              
              ${status !== "Complete" ? `
              <div class="reply-area">
                  <textarea id="input-${docId}" class="reply-input" rows="2" placeholder="Type a message to admin..."></textarea>
                  <button id="btn-${docId}" class="reply-btn">Send Reply</button>
              </div>
              ` : `<div style="text-align:center; color:#27ae60; font-size:0.8rem; margin-top:5px;">‚úì Request Completed</div>`}
          </div>
        `;

        historyList.appendChild(item);

        // Add event listener for mark as complete button
        if (status === "Work Finished" && !tenantMarkedComplete) {
          const markCompleteBtn = item.querySelector(".mark-complete-btn");
          if (markCompleteBtn) {
            markCompleteBtn.addEventListener("click", function() {
              const requestId = this.getAttribute("data-id");
              markAsComplete(requestId, data);
            });
          }
        }

        // Load chat messages
        const responsesQuery = query(
          collection(db, "maintenanceRequests", docId, "responses"),
          orderBy("timestamp", "asc")
        );
        
        getDocs(responsesQuery).then(snaps => {
          const msgContainer = document.getElementById(`messages-${docId}`);
          msgContainer.innerHTML = "";
          
          if (snaps.empty) {
            msgContainer.innerHTML = `<small style="color:#666; display:block; text-align:center;">No messages yet.</small>`;
          } else {
            snaps.forEach(r => {
              const rData = r.data();
              const isTenant = rData.sender === "tenant";
              const bubble = document.createElement("div");
              bubble.className = `message-bubble ${isTenant ? 'msg-tenant' : 'msg-admin'}`;
              bubble.textContent = rData.message;
              msgContainer.appendChild(bubble);
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;
          }
        });

        // Attach reply event listener
        if (status !== "Complete") {
            const btn = document.getElementById(`btn-${docId}`);
            const input = document.getElementById(`input-${docId}`);
            
            btn.addEventListener("click", async () => {
               const txt = input.value.trim();
               if(!txt) return;
               
               btn.textContent = "Sending...";
               btn.disabled = true;
               
               try {
                  await sendTenantReply(docId, txt);
                  input.value = "";
                  
                  const msgContainer = document.getElementById(`messages-${docId}`);
                  const bubble = document.createElement("div");
                  bubble.className = `message-bubble msg-tenant`;
                  bubble.textContent = txt;
                  msgContainer.appendChild(bubble);
                  msgContainer.scrollTop = msgContainer.scrollHeight;

                  const emptyMsg = msgContainer.querySelector("small");
                  if(emptyMsg) emptyMsg.remove();
                  
               } catch(e) {
                  console.error(e);
                  alert("Failed to send");
               } finally {
                  btn.textContent = "Send Reply";
                  btn.disabled = false;
               }
            });
        }
      }

    } catch (error) {
      console.error("History Error", error);
      historyList.innerHTML = `<p style="color:red;">Error loading history.</p>`;
    }
  }
  
  loadHistory();

  async function uploadToCloudinary(file) {
    showLoading();
    try {
      const url = "https://api.cloudinary.com/v1_1/dfklsyjch/upload";
      const preset = "tenant_uploads";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", preset);
      const response = await fetch(url, { method: "POST", body: formData });
      if (!response.ok) throw new Error("Cloudinary upload failed");
      return (await response.json()).secure_url;
    } finally {
      hideLoading();
    }
  }

  submitButton.addEventListener("click", async () => {
    const unitNumber = unitSelect.value;
    const problem = problemSelect.value;
    const comment = otherComment.value.trim();
    const preferredVisitDate = preferredDateInput.value;
    const preferredVisitTime = preferredTimeSelect.value;
    const files = imageUpload.files;

    if (!unitNumber) {
      await showPopup("Please select the unit for maintenance.");
      return;
    }
    if (!problem) {
      await showPopup("Please select an issue type");
      return;
    }
    if (!preferredVisitDate) {
      await showPopup("Please select your preferred maintenance visit date.");
      return;
    }
    if (!preferredVisitTime) {
      await showPopup("Please select your preferred maintenance visit time.");
      return;
    }
    
    const timeMap = {
      "10:00 AM": "10:00",
      "11:00 AM": "11:00", 
      "12:00 PM": "12:00",
      "1:00 PM": "13:00",
      "2:00 PM": "14:00",
      "3:00 PM": "15:00",
      "4:00 PM": "16:00",
      "5:00 PM": "17:00",
      "6:00 PM": "18:00",
      "7:00 PM": "19:00",
      "8:00 PM": "20:00",
      "9:00 PM": "21:00",
      "10:00 PM": "22:00"
    };
    
    const time24 = timeMap[preferredVisitTime];
    const selectedDateTime = new Date(`${preferredVisitDate}T${time24}:00`);
    const now = new Date();

    if (selectedDateTime < now) {
      await showPopup("Preferred visit time cannot be in the past.");
      return;
    }
    
    if (problem === "other") {
      if (!comment) {
        await showPopup('Please describe the problem in "Others".');
        return;
      }
      if (!files || files.length < 2) {
        await showPopup('Please upload at least 2 JPEG images for "Others".');
        return;
      }
    }
    if (files && files.length > 0) {
      for (const file of files) {
        if (file.type !== "image/jpeg") {
          await showPopup("Only JPEG images are allowed.");
          return;
        }
      }
    }

    statusMessageMaint.style.color = "gray";
    statusMessageMaint.textContent = "Submitting your request...";

    try {
      setButtonLoading(submitButton, true);
      
      const tenantEmail = await getCurrentUserEmail();
      let imageUrls = [];
      if (files && files.length > 0) {
        for (const file of files) {
          imageUrls.push(await uploadToCloudinary(file));
        }
      }
      
      let priority = 'medium';
      if ([
        'Circuit Breaker', 'Electrical Troubleshooting', 'ACU Drain Pipe',
        'Angle Valve', 'P-Trap Replacement', 'Shower Valve'
      ].includes(problem)) {
        priority = 'high';
      } else if ([
        'Drilling Works', 'Peephole Installation', 'PVC Door',
        'Vinyl Tiles', 'Door Repainting', 'Painting / Repainting',
        'Exhaust Fan Cleaning', 'Electrical Panel Cleaning',
        'Sweeping / General Cleaning', 'other'
      ].includes(problem)) {
        priority = 'low';
      }

      await addDoc(collection(db, "maintenanceRequests"), {
        tenantEmail,
        unitNumber,
        problem,
        comment: problem === "other" ? comment : "",
        imageUrls,
        priority,
        status: "Pending",
        responseTime: "Not yet responded",
        preferredVisitTime: selectedDateTime,
        tenantMarkedComplete: false,
        timestamp: serverTimestamp()
      });

      statusMessageMaint.style.color = "green";
      statusMessageMaint.textContent =
        "Maintenance request submitted successfully! ‚úÖ\nEstimated wait time: " + calculateWaitTime(priority);
      
      statusMessageMaint.style.fontWeight = "bold";
      statusMessageMaint.style.padding = "10px";
      statusMessageMaint.style.background = "rgba(39, 174, 96, 0.1)";
      statusMessageMaint.style.borderRadius = "8px";
      statusMessageMaint.style.border = "2px solid #27ae60";
      
      problemSelect.value = "";
      otherComment.value = "";
      imageUpload.value = "";
      otherSection.style.display = "none";
      detailsSection.style.display = "none";
      preferredDateInput.value = "";
      preferredTimeSelect.value = "";
      unitSelect.value = "";
      if (estimatedWaitTimeElement) {
        estimatedWaitTimeElement.style.display = "none";
      }
      
      setTimeout(() => {
        loadHistory();
      }, 1000);
      
    } catch (error) {
      statusMessageMaint.style.color = "red";
      statusMessageMaint.textContent =
        "Failed to submit request: " + error.message;
      statusMessageMaint.style.background = "rgba(231, 76, 60, 0.1)";
      statusMessageMaint.style.border = "2px solid #e74c3c";
      console.error(error);
    } finally {
      setButtonLoading(submitButton, false);
    }
  });

  break;
  
         /* ======================== BILLING ======================== */
case "billing":
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Billing & Payments</h1>
        <p class="page-subtitle">Review your current invoice and payment history.</p>
      </div>
    </div>

    <div class="billing-grid payment-tab">
      <section class="card">
        <h2 class="section-title">Current Invoice</h2>
        <p>Pay your monthly dues securely via PayPal.</p>

        <div id="invoiceSection" style="margin-top:14px;">
          <p id="invoiceDetails">Loading your invoice...</p>
          <div id="coverageStatus" style="margin-top:10px; padding:8px; border-radius:4px; display:none;"></div>
        </div>

        <hr style="margin:22px 0; border-color:rgba(255,255,255,0.12);">

        <h3 class="section-title">Payment Method</h3>
        <p>Payments are processed securely through PayPal.</p>

        <div id="paypal-section" style="margin-top:16px;">
          <div id="paypal-button-container"></div>
          <div style="margin-top:15px; padding:15px; background:#4a3728; border-radius:8px;">
            <label style="display:flex; align-items:center; margin-bottom:10px;">
              <input type="checkbox" id="advancePaymentCheckbox" style="margin-right:10px;">
              <strong>Pay in Advance</strong>
            </label>
            
            <div id="advanceOptions" style="display:none; margin-top:10px;">
              <label for="advanceMonths">Advance Period:</label>
              <select id="advanceMonths" style="margin-left:10px; padding:5px 10px; border-radius:4px;">
                <option value="1">1 month</option>
                <option value="2">2 months</option>
                <option value="3">3 months</option>
                <option value="6">6 months</option>
                <option value="12">12 months</option>
              </select>
              
              <div id="advanceAmountDisplay" style="margin-top:10px; padding:8px; background:#c0933c; border-radius:4px;">
                <strong>Advance Amount:</strong> <span id="advanceTotalAmount">‚Ç±0.00</span><br>
                <small>Total for selected months</small>
              </div>
              
              <div style="margin-top:10px; font-size:14px; color:#666;">
                <small>‚úÖ Each month covers until end of month</small><br>
                <small>‚úÖ Pay once, covered for multiple months</small>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-header">
          <h2 class="section-title">Payment History</h2>
          <div class="section-actions">
            <label for="historySort">Sort by:</label>
            <select id="historySort" class="select-sm">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
            </select>
          </div>
        </div>

        <div id="paymentStats" class="payment-stats" style="display:none;">
          <span style="font-weight:bold;">Showing:</span>
          <span id="paymentCount">0</span> payments ¬∑
          <span style="font-weight:bold;">Total Paid:</span> ‚Ç±<span id="totalPaid">0.00</span>
        </div>

        <div id="paymentHistory" class="payment-history-scroll">
          <p>Loading your payment history...</p>
        </div>
      </section>
    </div>
  `;

  // Hide loading after content is rendered
  hideLoading();

  const invoiceDetails = document.getElementById("invoiceDetails");
  const paymentHistory = document.getElementById("paymentHistory");
  const paypalContainer = document.getElementById("paypal-button-container");
  const historySort = document.getElementById("historySort");
  const paymentStats = document.getElementById("paymentStats");
  const paymentCount = document.getElementById("paymentCount");
  const totalPaid = document.getElementById("totalPaid");
  const coverageStatus = document.getElementById("coverageStatus");
  const advancePaymentCheckbox = document.getElementById("advancePaymentCheckbox");
  const advanceOptions = document.getElementById("advanceOptions");
  const advanceMonths = document.getElementById("advanceMonths");
  const advanceTotalAmount = document.getElementById("advanceTotalAmount");

  let computedAmount = 0;
  let tenantUnits = [];
  let allPayments = [];
  let filteredPayments = [];
  let unitPricing = { "1B": 10, "2B": 20 };
  let currentDueDate = new Date();
  let gracePeriodDays = 5;
  let monthlyBaseAmount = 0;
  let paymentCoverageData = [];

  // Function to get last day of month for a given date
  function getLastDayOfMonth(date) {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0); // 0th day of next month = last day of current month
  }

  // Function to calculate next due date (always end of month)
  async function calculateNextDueDateFromHistory(payments) {
    if (!payments || payments.length === 0) {
      // No payments yet, set to end of current month
      const today = new Date();
      return getLastDayOfMonth(today);
    }

    // Filter only paid/approved payments
    const validPayments = payments.filter(p => 
      p.status === "Paid" || 
      p.status === "Approved" || 
      p.status === "Completed"
    );

    if (validPayments.length === 0) {
      // No valid payments, set to end of current month
      const today = new Date();
      return getLastDayOfMonth(today);
    }

    // Sort payments by date (oldest first for calculation)
    const sortedPayments = [...validPayments].sort((a, b) => {
      const dateA = a.paymentDate?.toDate?.() || a.timestamp?.toDate?.() || new Date(0);
      const dateB = b.paymentDate?.toDate?.() || b.timestamp?.toDate?.() || new Date(0);
      return dateA - dateB;
    });

    let lastCoveredDate = null;

    for (const payment of sortedPayments) {
      const paymentDate = payment.paymentDate?.toDate?.() || payment.timestamp?.toDate?.() || new Date();
      const monthsCovered = payment.advanceMonths || 1; // Default to 1 month if not specified
      
      if (!lastCoveredDate) {
        // First payment - start from payment month
        lastCoveredDate = new Date(paymentDate);
        lastCoveredDate = getLastDayOfMonth(lastCoveredDate); // End of payment month
        
        // Add remaining months if advance payment
        for (let i = 1; i < monthsCovered; i++) {
          lastCoveredDate.setMonth(lastCoveredDate.getMonth() + 1);
          lastCoveredDate = getLastDayOfMonth(lastCoveredDate);
        }
      } else {
        // Check if payment is within or after current coverage
        if (paymentDate <= lastCoveredDate) {
          // Payment is within current coverage - extend from last covered date
          for (let i = 0; i < monthsCovered; i++) {
            lastCoveredDate.setMonth(lastCoveredDate.getMonth() + 1);
            lastCoveredDate = getLastDayOfMonth(lastCoveredDate);
          }
        } else {
          // There's a gap - start new coverage from payment month
          lastCoveredDate = new Date(paymentDate);
          lastCoveredDate = getLastDayOfMonth(lastCoveredDate);
          
          // Add remaining months if advance payment
          for (let i = 1; i < monthsCovered; i++) {
            lastCoveredDate.setMonth(lastCoveredDate.getMonth() + 1);
            lastCoveredDate = getLastDayOfMonth(lastCoveredDate);
          }
        }
      }
    }

    // Return the day AFTER last covered date as next due
    const nextDueDate = new Date(lastCoveredDate);
    nextDueDate.setDate(nextDueDate.getDate() + 1);
    return nextDueDate;
  }

  // Function to calculate coverage data
  function calculateCoverageData(payments) {
    const validPayments = payments.filter(p => 
      p.status === "Paid" || 
      p.status === "Approved" || 
      p.status === "Completed"
    );

    if (validPayments.length === 0) return [];

    const sortedPayments = [...validPayments].sort((a, b) => {
      const dateA = a.paymentDate?.toDate?.() || a.timestamp?.toDate?.() || new Date(0);
      const dateB = b.paymentDate?.toDate?.() || b.timestamp?.toDate?.() || new Date(0);
      return dateA - dateB;
    });

    const coverageData = [];
    let currentCoverageEnd = null;

    for (const payment of sortedPayments) {
      const paymentDate = payment.paymentDate?.toDate?.() || payment.timestamp?.toDate?.() || new Date();
      const monthsCovered = payment.advanceMonths || 1;
      
      let periodStart, periodEnd;
      
      if (!currentCoverageEnd) {
        // First payment - start from payment month
        periodStart = new Date(paymentDate.getFullYear(), paymentDate.getMonth(), 1); // 1st of month
        periodEnd = getLastDayOfMonth(paymentDate); // End of payment month
        
        // Add remaining months if advance payment
        for (let i = 1; i < monthsCovered; i++) {
          periodEnd.setMonth(periodEnd.getMonth() + 1);
          periodEnd = getLastDayOfMonth(periodEnd);
        }
        currentCoverageEnd = new Date(periodEnd);
      } else if (paymentDate <= currentCoverageEnd) {
        // Payment within current coverage - extend from current end
        periodStart = new Date(currentCoverageEnd);
        periodStart.setDate(periodStart.getDate() + 1); // Start day after current coverage
        
        periodEnd = new Date(periodStart);
        periodEnd = getLastDayOfMonth(periodEnd); // End of that month
        
        // Add remaining months if advance payment
        for (let i = 1; i < monthsCovered; i++) {
          periodEnd.setMonth(periodEnd.getMonth() + 1);
          periodEnd = getLastDayOfMonth(periodEnd);
        }
        currentCoverageEnd = new Date(periodEnd);
      } else {
        // Gap in coverage - start new period from payment month
        periodStart = new Date(paymentDate.getFullYear(), paymentDate.getMonth(), 1);
        periodEnd = getLastDayOfMonth(paymentDate);
        
        // Add remaining months if advance payment
        for (let i = 1; i < monthsCovered; i++) {
          periodEnd.setMonth(periodEnd.getMonth() + 1);
          periodEnd = getLastDayOfMonth(periodEnd);
        }
        currentCoverageEnd = new Date(periodEnd);
      }
      
      coverageData.push({
        paymentId: payment.id,
        paymentDate: paymentDate,
        amount: payment.amount,
        monthsCovered: monthsCovered,
        periodStart: periodStart,
        periodEnd: periodEnd,
        paymentMethod: payment.method,
        invoiceId: payment.invoiceId,
        isAdvance: monthsCovered > 1
      });
    }
    
    return coverageData;
  }

  // Function to update advance payment UI
  function updateAdvancePaymentUI() {
    if (advancePaymentCheckbox.checked) {
      advanceOptions.style.display = 'block';
      const selectedMonths = parseInt(advanceMonths.value) || 1;
      const advanceAmount = monthlyBaseAmount * selectedMonths;
      advanceTotalAmount.textContent = `‚Ç±${advanceAmount.toLocaleString()}`;
    } else {
      advanceOptions.style.display = 'none';
    }
  }

  // Function to load tenant data
  async function loadTenantData() {
    try {
      const tenantEmail = await getCurrentUserEmail();
      const uid = auth.currentUser.uid;
      
      // Load user units
      const userDoc = await getDoc(doc(db, "users", uid));
      tenantUnits = userDoc.data()?.unitNumbers || [];
      
      // Calculate monthly base amount
      monthlyBaseAmount = 0;
      tenantUnits.forEach(unit => {
        const type = unit.split("-")[0];
        const price = unitPricing[type] || 0;
        monthlyBaseAmount += price;
      });
      
      // Load all payments
      await loadAllPayments();
      
      // Calculate next due date from payment history
      currentDueDate = await calculateNextDueDateFromHistory(allPayments);
      
      // Calculate coverage data
      paymentCoverageData = calculateCoverageData(allPayments);
      
      return currentDueDate;
    } catch (error) {
      console.error("Error loading tenant data:", error);
      const today = new Date();
      currentDueDate = getLastDayOfMonth(today);
      return currentDueDate;
    }
  }

  // Function to format date
  function formatDate(date) {
    if (!date) return "N/A";
    const day = date.getDate();
    const month = date.toLocaleString('default', { month: 'long' });
    const year = date.getFullYear();
    
    const suffix = (day % 10 === 1 && day !== 11) ? 'st' :
                  (day % 10 === 2 && day !== 12) ? 'nd' :
                  (day % 10 === 3 && day !== 13) ? 'rd' : 'th';
    
    return `${day}${suffix} of ${month} ${year}`;
  }

  // Function to format short date
  function formatShortDate(date) {
    if (!date) return "N/A";
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  }

  // Function to check if payment is overdue
  function checkIfOverdue() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const dueDate = new Date(currentDueDate);
    dueDate.setHours(0, 0, 0, 0);
    
    return today > dueDate;
  }

  // Function to calculate days until due
  function calculateDaysUntilDue() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const dueDate = new Date(currentDueDate);
    dueDate.setHours(0, 0, 0, 0);
    
    const diffTime = dueDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
  }

  // Function to calculate late fee
  function calculateLateFee() {
    if (!checkIfOverdue()) return 0;
    
    const today = new Date();
    const dueDate = new Date(currentDueDate);
    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
    
    if (daysOverdue > gracePeriodDays) {
      const lateDays = daysOverdue - gracePeriodDays;
      return lateDays * 50;
    }
    
    return 0;
  }

  async function loadPricing() {
    try {
      const pricingDoc = await getDoc(doc(db, "settings", "unitPricing"));
      if (pricingDoc.exists()) {
        const data = pricingDoc.data();
        unitPricing = {
          "1B": data["1B"] || 10,
          "2B": data["2B"] || 20
        };
      } else {
        await setDoc(doc(db, "settings", "unitPricing"), {
          "1B": 10,
          "2B": 20,
          lastUpdated: serverTimestamp()
        });
      }
      await loadInvoice();
    } catch (error) {
      console.error("Error loading pricing:", error);
      await loadInvoice();
    }
  }

  async function loadInvoice() {
    const tenantEmail = await getCurrentUserEmail();
    
    await loadTenantData();
    
    const lateFee = calculateLateFee();
    computedAmount = monthlyBaseAmount + lateFee;
    
    const isOverdue = checkIfOverdue();
    const daysUntilDue = calculateDaysUntilDue();
    
    const formattedDisplayedAmount = `‚Ç± ${computedAmount.toLocaleString()}`;
    const formattedBaseAmount = `‚Ç± ${monthlyBaseAmount.toLocaleString()}`;
    const formattedLateFee = `‚Ç± ${lateFee.toLocaleString()}`;

    let breakdown = [];
    let breakdownHtml = "";
    tenantUnits.forEach(unit => {
      const type = unit.split("-")[0];
      const price = unitPricing[type] || 0;
      breakdown.push(`${unit}: ‚Ç±${price.toLocaleString()}`);
    });
    
    if (breakdown.length > 0) {
      breakdownHtml = `<br><strong>Breakdown:</strong><br>${breakdown.join("<br>")}`;
    }
    
    let statusHtml = "";
    if (isOverdue) {
      statusHtml = `<br><span style="color: #ff4444; font-weight: bold;">‚ö†Ô∏è OVERDUE</span>`;
    } else if (daysUntilDue <= 7) {
      statusHtml = `<br><span style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è Due in ${daysUntilDue} days</span>`;
    } else {
      statusHtml = `<br><span style="color: #4CAF50; font-weight: bold;">‚úì Current</span>`;
    }
    
    let lateFeeHtml = "";
    if (lateFee > 0) {
      lateFeeHtml = `<br><strong>Late Fee:</strong> ${formattedLateFee}`;
    }
    
    // Show coverage status
    const today = new Date();
    if (paymentCoverageData.length > 0) {
      const lastCoverage = paymentCoverageData[paymentCoverageData.length - 1];
      const paidUntil = lastCoverage.periodEnd;
      
      if (paidUntil > today) {
        const monthsAhead = Math.ceil((paidUntil.getMonth() - today.getMonth() + 
          (paidUntil.getFullYear() - today.getFullYear()) * 12));
        
        coverageStatus.innerHTML = `
          <span style="color: #2196F3; font-weight: bold;">üìÖ Payment Coverage:</span><br>
          <strong>Covered Until:</strong> ${formatDate(paidUntil)}<br>
          <strong>Months Ahead:</strong> ${monthsAhead} month(s)<br>
          <strong>Total Payments:</strong> ${paymentCoverageData.length} payment(s)
        `;
        coverageStatus.style.display = 'block';
        coverageStatus.style.backgroundColor = '#4a3728';
        coverageStatus.style.borderLeft = '4px solid #c0933c';
      } else {
        coverageStatus.style.display = 'none';
      }
    } else {
      coverageStatus.style.display = 'none';
    }

    invoiceDetails.innerHTML = `
      <strong>Unit Owner:</strong> ${tenantEmail}<br>
      <strong>Units:</strong> ${tenantUnits.join(", ") || "None"}<br>
      <strong>Monthly Amount:</strong> ${formattedBaseAmount}<br>
      ${lateFeeHtml}
      <strong>Amount Due Now:</strong> ${formattedDisplayedAmount}<br>
      <strong>Next Due Date:</strong> ${formatDate(currentDueDate)}
      ${statusHtml}
      ${breakdownHtml}
      <br><br><small style="color: #888;">
        Note: Due dates are always at end of month<br>
        You can pay multiple months in advance<br>
        1-Bedroom = ‚Ç±${(unitPricing["1B"] || 10).toLocaleString()}, 
        2-Bedroom = ‚Ç±${(unitPricing["2B"] || 20).toLocaleString()}<br>
        Grace period: ${gracePeriodDays} days after due date
      </small>
    `;
  }

  async function loadAllPayments() {
    const tenantEmail = await getCurrentUserEmail();

    try {
      const qCol = query(
        collection(db, "payments"),
        where("tenantEmail", "==", tenantEmail),
        orderBy("timestamp", "desc")
      );
      const snapshot = await getDocs(qCol);

      if (snapshot.empty) {
        allPayments = [];
        applySorting();
        return;
      }

      allPayments = snapshot.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));

      applySorting();
    } catch (error) {
      console.error("Error loading payments:", error);
      paymentHistory.innerHTML = `<p style="color:red;">Error loading history: ${error.message}</p>`;
    }
  }

  function applySorting() {
    const sortValue = historySort.value;
    filteredPayments = [...allPayments];

    filteredPayments.sort((a, b) => {
      switch (sortValue) {
        case "date-desc":
          return (
            (b.timestamp?.toDate?.() || 0) -
            (a.timestamp?.toDate?.() || 0)
          );
        case "date-asc":
          return (
            (a.timestamp?.toDate?.() || 0) -
            (b.timestamp?.toDate?.() || 0)
          );
        default:
          return 0;
      }
    });

    renderPaymentHistory();
  }

  function renderPaymentHistory() {
    if (filteredPayments.length === 0) {
      paymentHistory.innerHTML = "<p>No payment records found.</p>";
      paymentStats.style.display = "none";
      return;
    }

    paymentHistory.innerHTML = "";

    let total = 0;

    filteredPayments.forEach(payment => {
      const d = payment;
      const time = d.timestamp
        ? d.timestamp.toDate().toLocaleString()
        : "N/A";
      
      // Find coverage data for this payment
      const coverage = paymentCoverageData.find(c => c.paymentId === d.id);
      
      let periodCovered = "N/A";
      let advanceInfo = "";
      
      if (coverage) {
        periodCovered = `${formatShortDate(coverage.periodStart)} to ${formatShortDate(coverage.periodEnd)}`;
        if (coverage.monthsCovered > 1) {
          advanceInfo = `<br><span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:3px; font-size:12px;">
            ‚è© Advance (${coverage.monthsCovered} months)
          </span>`;
        }
      } else if (d.periodStart && d.periodEnd) {
        const start = formatShortDate(d.periodStart.toDate());
        const end = formatShortDate(d.periodEnd.toDate());
        periodCovered = `${start} to ${end}`;
        if (d.advanceMonths > 1) {
          advanceInfo = `<br><span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:3px; font-size:12px;">
            ‚è© Advance (${d.advanceMonths} months)
          </span>`;
        }
      }

      let receipt = "";
      if (d.method === "Cash on Hand" && d.receiptUrl) {
        receipt = `<br><strong>Receipt:</strong><br><img src="${d.receiptUrl}" style="max-width:150px; border-radius:6px;">`;
      }

      let statusColor = "#666";
      if (d.status === "Paid" || d.status === "Approved") statusColor = "#4CAF50";
      if (d.status === "Pending Verification") statusColor = "#FF9800";
      if (d.status === "Rejected") statusColor = "#F44336";

      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ccc";
      div.style.padding = "12px 0";
      div.style.marginBottom = "10px";
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <strong>Invoice ID:</strong> ${d.invoiceId || "-"}<br>
            <strong>Amount:</strong> ‚Ç±${d.amount}${advanceInfo}<br>
            <strong>Period Covered:</strong> ${periodCovered}<br>
            <strong>Status:</strong> <span style="color:${statusColor};">${d.status}</span><br>
            <strong>Date:</strong> ${time}<br>
            <strong>Method:</strong> ${d.method}
            ${receipt}
          </div>
          <div style="min-width: 150px; text-align: right;">
            ${d.transactionId ? `<strong>Transaction ID:</strong><br><small>${d.transactionId}</small><br>` : ""}
            ${d.payerEmail ? `<strong>Paid with:</strong><br><small>${d.payerEmail}</small>` : ""}
          </div>
        </div>
      `;
      paymentHistory.appendChild(div);

      if (
        d.status === "Paid" ||
        d.status === "Approved" ||
        d.status === "Completed"
      ) {
        total += Number(d.amount) || 0;
      }
    });

    paymentCount.textContent = filteredPayments.length;
    totalPaid.textContent = total.toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    paymentStats.style.display = "block";
  }

  async function sendEmailReceipt(paymentData) {
    try {
      const templateParams = {
        from_name: "Solano Hills Admin",
        to_email: paymentData.payerEmail,
        invoice_id: paymentData.invoiceId,
        amount: paymentData.amount,
        payment_method: paymentData.method,
        transaction_id: paymentData.transactionId,
        payment_date: new Date().toLocaleString(),
        next_due_date: formatDate(currentDueDate),
        months_covered: paymentData.advanceMonths || 1
      };
      await emailjs.send("service_izx63bb", "template_asn4687", templateParams);
      console.log("Email receipt sent successfully");
    } catch (error) {
      console.error("Failed to send email receipt:", error);
    }
  }

  async function setupPayPal() {
    const tenantEmail = await getCurrentUserEmail();
    
    // Setup advance payment UI events
    advancePaymentCheckbox.addEventListener('change', updateAdvancePaymentUI);
    advanceMonths.addEventListener('change', updateAdvancePaymentUI);
    
    // Initial UI update
    updateAdvancePaymentUI();

    paypal.Buttons({
      style: { color: "gold", shape: "rect", label: "pay", height: 40 },
      createOrder: function (data, actions) {
        const invoiceId = "INV-" + Date.now();
        const isAdvance = advancePaymentCheckbox.checked;
        const advanceMonthsCount = parseInt(advanceMonths.value) || 1;
        
        let amount = computedAmount;
        let description = "Monthly Dues Payment";
        
        if (isAdvance) {
          amount = monthlyBaseAmount * advanceMonthsCount;
          description = `Advance Payment (${advanceMonthsCount} month${advanceMonthsCount > 1 ? 's' : ''})`;
        }
        
        return actions.order.create({
          purchase_units: [
            {
              reference_id: invoiceId,
              description: description,
              amount: { currency_code: "PHP", value: amount.toString() }
            }
          ]
        });
      },
      onApprove: async function (data, actions) {
        showLoading();
        try {
          const order = await actions.order.capture();
          const paymentDate = new Date();
          const invoiceId = data.orderID.substring(0, 20);
          const isAdvance = advancePaymentCheckbox.checked;
          const advanceMonthsCount = parseInt(advanceMonths.value) || 1;
          
          let amount = computedAmount;
          if (isAdvance) {
            amount = monthlyBaseAmount * advanceMonthsCount;
          }
          
          // Calculate period for this payment
          const periodStart = new Date(currentDueDate.getFullYear(), currentDueDate.getMonth(), 1);
          let periodEnd = getLastDayOfMonth(currentDueDate);
          
          // If advance payment, add additional months
          if (isAdvance && advanceMonthsCount > 1) {
            for (let i = 1; i < advanceMonthsCount; i++) {
              periodEnd.setMonth(periodEnd.getMonth() + 1);
              periodEnd = getLastDayOfMonth(periodEnd);
            }
          }
          
          const paymentRecord = {
            tenantEmail,
            invoiceId,
            amount: amount,
            method: "PayPal",
            status: "Paid",
            transactionId: order.id,
            payerEmail: order.payer.email_address,
            periodStart: periodStart,
            periodEnd: periodEnd,
            timestamp: serverTimestamp(),
            paymentDate: paymentDate,
            monthlyAmount: monthlyBaseAmount,
            advanceMonths: isAdvance ? advanceMonthsCount : 1
          };

          await addDoc(collection(db, "payments"), paymentRecord);
          
          let message = "‚úÖ Payment successful!";
          if (isAdvance && advanceMonthsCount > 1) {
            message += `<br>You've paid ${advanceMonthsCount} months in advance`;
            message += `<br>Covered until: ${formatDate(periodEnd)}`;
          } else {
            message += `<br>Next due date: end of ${currentDueDate.toLocaleString('default', { month: 'long' })}`;
          }
          
          showPopup(message);
          
          // Reset advance payment UI
          advancePaymentCheckbox.checked = false;
          updateAdvancePaymentUI();
          advanceMonths.value = '1';
          
          // Reload everything
          await loadInvoice();
          await loadAllPayments();
          await sendEmailReceipt(paymentRecord);
          
        } catch (error) {
          console.error("Payment error:", error);
          showPopup("‚ùå Payment failed. Please try again.");
        } finally {
          hideLoading();
        }
      },
      onCancel: async function () {
        showPopup("‚ö†Ô∏è Payment cancelled by user.");
      },
      onError: async function (err) {
        console.error("PayPal error:", err);
        showPopup("‚ùå Payment failed. Please try again later.");
      }
    }).render(paypalContainer);
  }

  historySort.addEventListener("change", applySorting);

  // Initialize everything
  (async () => {
    await loadPricing();
    await loadAllPayments();
    await loadInvoice();
    await setupPayPal();
  })();

  break;
            /* ======================== FEEDBACK ======================== */
        case "feedback":
          loadFeedbackForm();
          hideLoading(); // Hide loading after content is rendered
          break;

        default:
          mainContent.innerHTML = "<p>Section not found.</p>";
          hideLoading();
      }
    };

    /* ======================== FEEDBACK FORM FUNCTION ======================== */
  function loadFeedbackForm() {
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Tenant Feedback</h1>
        <p class="page-subtitle">Share your thoughts so we can improve your experience.</p>
      </div>
    </div>

    <div class="feedback-container">
      <section class="card feedback-card">
        <form id="feedbackForm" class="feedback-form">
          <div class="form-group">
            <label for="rating">1. How satisfied are you with our services?</label>
            <div id="rating" style="font-size: 2rem; margin: 8px 0; user-select:none;">
              <span data-value="1" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="2" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="3" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="4" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="5" style="cursor:pointer;">‚≠êÔ∏è</span>
            </div>
            <input type="hidden" id="ratingValue" name="ratingValue" required />
          </div>

          <div class="form-group">
            <label for="q1">2. How satisfied are you with the overall condition and appearance of the property?</label>
            <select id="q1" name="q1" required>
              <option value="">-- Select --</option>
              <option>Very Satisfied</option>
              <option>Satisfied</option>
              <option>Neutral</option>
              <option>Dissatisfied</option>
              <option>Very Dissatisfied</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q2">3. How satisfied are you with the maintenance services (unit, hallway, garden)?</label>
            <select id="q2" name="q2" required>
              <option value="">-- Select --</option>
              <option>Very Satisfied</option>
              <option>Satisfied</option>
              <option>Neutral</option>
              <option>Dissatisfied</option>
              <option>Very Dissatisfied</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q3">4. How would you rate the professionalism of the property management staff?</label>
            <select id="q3" name="q3" required>
              <option value="">-- Select --</option>
              <option>Excellent</option>
              <option>Good</option>
              <option>Average</option>
              <option>Poor</option>
              <option>Very Poor</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q4">5. Is it easy to pay your monthly dues or rent?</label>
            <select id="q4" name="q4" required>
              <option value="">-- Select --</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q5">6. How would you rate the amenities (gym, pool, clubhouse)?</label>
            <select id="q5" name="q5" required>
              <option value="">-- Select --</option>
              <option>Excellent</option>
              <option>Good</option>
              <option>Average</option>
              <option>Poor</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q6">7. Any additional suggestions?</label>
            <textarea id="q6" name="q6" placeholder="Write your suggestions here..."></textarea>
          </div>

          <button id="sendFeedbackBtn" type="submit" class="btn-primary">Send Feedback</button>
          <p id="statusMessage" class="status-text"></p>
        </form>
        
        <div id="cooldownInfo" style="margin-top: 15px; padding: 10px; background: rgba(141, 108, 57, 0.1); border-radius: 6px; border-left: 3px solid #8d6c39;">
          <p style="margin: 0; color: #4a3728; font-size: 13px;">
            <strong>Note:</strong> You can submit feedback once per minute to prevent spam.
          </p>
        </div>
      </section>
    </div>
  `;

  const form = document.getElementById("feedbackForm");
  const ratingStars = document.querySelectorAll("#rating span");
  const ratingValueInput = document.getElementById("ratingValue");
  const statusMessage = document.getElementById("statusMessage");
  const sendBtn = document.getElementById("sendFeedbackBtn");

  // Star rating functionality
  ratingStars.forEach(star => {
    star.style.opacity = "0.3";
    star.style.transition = "opacity 0.3s ease";
    star.addEventListener("click", () => {
      const val = star.getAttribute("data-value");
      ratingValueInput.value = val;
      ratingStars.forEach(s => {
        s.style.opacity = s.getAttribute("data-value") <= val ? "1" : "0.3";
      });
    });
    
    // Add hover effect
    star.addEventListener("mouseenter", () => {
      if (!star.style.opacity || star.style.opacity === "0.3") {
        star.style.transform = "scale(1.1)";
      }
    });
    
    star.addEventListener("mouseleave", () => {
      star.style.transform = "scale(1)";
    });
  });

  function disableButtonForCooldown() {
    // First reset any loading state
    setButtonLoading(sendBtn, false);
    
    // Then disable the button with cooldown style
    sendBtn.disabled = true;
    sendBtn.style.background = "linear-gradient(135deg, #777, #999)";
    sendBtn.style.cursor = "not-allowed";
    sendBtn.style.opacity = "0.7";
    sendBtn.textContent = "Please wait 1 month to submit feedback again";
    sendBtn.innerHTML = "Please wait 1 month to submit feedback again"; // Use innerHTML to clear any loading spinner
  }

  function enableButton() {
    setButtonLoading(sendBtn, false);
    sendBtn.disabled = false;
    sendBtn.style.background = "";
    sendBtn.style.cursor = "pointer";
    sendBtn.style.opacity = "1";
    sendBtn.textContent = "Send Feedback";
    sendBtn.innerHTML = "Send Feedback";
  }

  // Function to format time in user-friendly way
  function formatTimeRemaining(milliseconds) {
    const minutes = Math.floor(milliseconds / (1000 * 60));
    const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

    if (minutes > 0) {
      return `${minutes} minute${minutes > 1 ? 's' : ''}, ${seconds} second${seconds > 1 ? 's' : ''}`;
    } else {
      return `${seconds} second${seconds > 1 ? 's' : ''}`;
    }
  }

  // Function to format time for countdown display
  function formatCountdownTime(milliseconds) {
    const minutes = Math.floor(milliseconds / (1000 * 60));
    const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

    let parts = [];
    if (minutes > 0) parts.push(`${minutes}m`);
    if (seconds > 0 || parts.length === 0) parts.push(`${seconds}s`);
    
    return parts.join(" ");
  }

  // Check for existing cooldown (1 minute)
  const cooldownEnd = localStorage.getItem("feedbackCooldownEnd");
  if (cooldownEnd && Date.now() < cooldownEnd) {
    disableButtonForCooldown();
    const remainingMs = cooldownEnd - Date.now();
    const formattedTime = formatTimeRemaining(remainingMs);
    
    statusMessage.style.color = "#f39c12";
    statusMessage.textContent = `Feedback submitted. You can send another in ${formattedTime}.`;

    // Start countdown timer
    const countdown = setInterval(() => {
      const timeLeftMs = cooldownEnd - Date.now();
      
      if (timeLeftMs <= 0) {
        clearInterval(countdown);
        enableButton();
        statusMessage.textContent = "";
        statusMessage.style.color = "";
        localStorage.removeItem("feedbackCooldownEnd");
        
        // Show ready message briefly
        statusMessage.style.color = "#27ae60";
        statusMessage.textContent = "Ready to submit feedback!";
        setTimeout(() => {
          statusMessage.textContent = "";
          statusMessage.style.color = "";
        }, 3000);
      } else {
        const countdownText = formatCountdownTime(timeLeftMs);
        statusMessage.style.color = "#f39c12";
        statusMessage.textContent = `Next feedback available in: ${countdownText}`;
      }
    }, 1000);
  }

  onAuthStateChanged(auth, user => {
    if (!user) {
      statusMessage.textContent = "Please log in to send feedback.";
      form.style.display = "none";
    } else {
      form.addEventListener("submit", async e => {
        e.preventDefault();

        if (!ratingValueInput.value) {
          await showPopup("Please select a rating by clicking the stars.");
          return;
        }

        // Validate all required fields
        const requiredFields = ['q1', 'q2', 'q3', 'q4', 'q5'];
        for (const fieldId of requiredFields) {
          const field = document.getElementById(fieldId);
          if (!field.value) {
            await showPopup(`Please answer question ${fieldId.replace('q', '')}.`);
            field.focus();
            return;
          }
        }

        // Show loading on button
        setButtonLoading(sendBtn, true);
        statusMessage.style.color = "#3498db";
        statusMessage.textContent = "Sending your feedback...";

        try {
          await addDoc(collection(db, "feedback"), {
            tenantEmail: user.email,
            rating: Number(ratingValueInput.value),
            q1: form.q1.value,
            q2: form.q2.value,
            q3: form.q3.value,
            q4: form.q4.value,
            q5: form.q5.value,
            q6: form.q6.value.trim(),
            timestamp: serverTimestamp()
          });

          // Success state
          statusMessage.style.color = "#27ae60";
          statusMessage.textContent = "‚úÖ Feedback sent successfully! Thank you for sharing your thoughts.";
          
          // Add success animation
          statusMessage.style.fontWeight = "bold";
          statusMessage.style.padding = "10px";
          statusMessage.style.background = "rgba(39, 174, 96, 0.1)";
          statusMessage.style.borderRadius = "6px";
          statusMessage.style.border = "2px solid #27ae60";

          // Reset form
          form.reset();
          ratingStars.forEach(s => (s.style.opacity = "0.3"));
          ratingValueInput.value = "";

          // Set 1-minute cooldown (60 seconds √ó 1000ms)
          const ONE_MINUTE = 60 * 1000;
          const cooldownTime = Date.now() + ONE_MINUTE;
          localStorage.setItem("feedbackCooldownEnd", cooldownTime);

          // Disable button and show "Please wait 1 minute" message
          // IMPORTANT: First stop loading, then disable for cooldown
          setButtonLoading(sendBtn, false);
          disableButtonForCooldown();

          // Start countdown timer
          let countdown = setInterval(() => {
            const timeLeftMs = cooldownTime - Date.now();
            
            if (timeLeftMs <= 0) {
              clearInterval(countdown);
              enableButton();
              statusMessage.textContent = "";
              statusMessage.style.background = "";
              statusMessage.style.border = "";
              localStorage.removeItem("feedbackCooldownEnd");
              
              // Show ready message
              statusMessage.style.color = "#27ae60";
              statusMessage.textContent = "Ready to submit feedback again!";
              setTimeout(() => {
                statusMessage.textContent = "";
                statusMessage.style.color = "";
              }, 3000);
            } else {
              const countdownText = formatCountdownTime(timeLeftMs);
              statusMessage.style.color = "#f39c12";
              statusMessage.textContent = `Next feedback available in: ${countdownText}`;
            }
          }, 1000);

        } catch (error) {
          console.error("Error sending feedback: ", error);
          statusMessage.style.color = "#e74c3c";
          statusMessage.textContent = "‚ùå Error sending feedback. Please try again.";
          // Reset button from loading state
          setButtonLoading(sendBtn, false);
          enableButton();
          
          // Reset button after 5 seconds
          setTimeout(() => {
            statusMessage.textContent = "";
          }, 5000);
        }
      });
    }
  });
}

    /* ======================== GREETING & POPUP ======================== */
    function updateGreeting() {
      onAuthStateChanged(auth, user => {
        if (user) {
          const greeting =
            document.getElementById("tenantGreeting") ||
            document.getElementById("tenantGreeting1");
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    function showWelcomeBack() {
      onAuthStateChanged(auth, user => {
        if (user) {
          const greeting = document.getElementById("tenantGreeting");
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    showWelcomeBack();

    window.showPopup = function (message) {
      document.getElementById("popupMessage").innerHTML = message;
      document.getElementById("customPopup").classList.remove("hidden");
    };

    window.closePopup = function () {
      document.getElementById("customPopup").classList.add("hidden");
    };

    /* ======================== TAB PERSISTENCE ======================== */
    function setActiveTabOnLoad() {
      const savedTab = localStorage.getItem('activeTab');
      if (savedTab) {
        // Remove active class from all links first
        document.querySelectorAll(".sidebar nav ul li a").forEach(link => {
          link.classList.remove("active");
        });
        
        // Add active class to the saved tab link
        const savedTabLink = document.querySelector(`.sidebar nav ul li a[onclick*="${savedTab}"]`);
        if (savedTabLink) {
          savedTabLink.classList.add("active");
        }
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      setActiveTabOnLoad();
      
      // Check if there's a saved tab in localStorage
      const savedTab = localStorage.getItem('activeTab');
      
      // Load the saved tab if it exists, otherwise load dashboard
      if (savedTab && 
          ['dashboard', 'maintenance', 'billing', 'feedback'].includes(savedTab)) {
        loadContent(null, savedTab);
      } else {
        loadContent(null, "dashboard");
      }
    });
  </script>

  <div id="customPopup" class="popup hidden">
    <div class="popup-content">
      <p id="popupMessage">Your message goes here</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>
</body>
</html>

