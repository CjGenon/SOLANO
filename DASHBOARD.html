<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Owner Dashboard ‚Äì Solano Hills</title>
  <link rel="stylesheet" href="Dashboard.css" />
</head>
<body>

  <!-- ======================== SIDEBAR ======================== -->
  <div class="sidebar">
    <div class="logo">
      <img src="SHR-LOGO-CORE-WHITE-r2s9u89e4bid2abizvtsncwzc48kzhlzz6fuhv7oko.webp" alt="Solano Logo" />
    </div>
    <nav>
      <ul>
        <li><a href="#" onclick="loadContent(event, 'dashboard')">Dashboard</a></li>
        <!-- <li><a href="#" onclick="loadContent(event, 'profile')">My Profile</a></li> -->
        <li><a href="#" onclick="loadContent(event, 'maintenance')">Maintenance</a></li>
        <li><a href="#" onclick="loadContent(event, 'billing')">Billing and Payments</a></li>
        <li><a href="#" onclick="loadContent(event, 'feedback')">Feedback</a></li>
        <li><a href="LogIn.html">Logout</a></li>
      </ul>
    </nav>
  </div>

  <!-- ======================== MAIN CONTENT ======================== -->
  <main class="main-content">
    <div id="mainContent">
      <h1 id="tenantGreeting">Welcome back, Tenant</h1>
      <p>Select a menu option from the left to get started.</p>
    </div>
  </main>

  <!-- ======================== THIRD‚ÄëPARTY SCRIPTS ======================== -->
  <script src="https://www.paypal.com/sdk/js?client-id=ASbUIe1_A3shQqfiUe1_TnYnp7jGyD-_pClj10rYjAG7Fmbu_sPi6s8LoJD2bRv6bT2XkJBo-FpPO5t4&currency=PHP"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("lqyGatNXQhoDJsu2B");
    })();
  </script>

  <!-- ======================== APP SCRIPT (MODULE) ======================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      getDoc,
      limit
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

    /* ======================== FIREBASE INIT ======================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAz8CoOb7k45On36GEQRcFPDxTvtdzU1ss",
      authDomain: "solanodb-a4f65.firebaseapp.com",
      projectId: "solanodb-a4f65",
      storageBucket: "solanodb-a4f65.firebasestorage.app",
      messagingSenderId: "98081894649",
      appId: "1:98081894649:web:67f3e3d0ef8d3b7a013228"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    function getCurrentUserEmail() {
      return new Promise(resolve => {
        const unsubscribe = onAuthStateChanged(auth, user => {
          unsubscribe();
          resolve(user ? user.email : "Unknown Tenant");
        });
      });
    }

    const mainContent = document.getElementById("mainContent");

    /* ======================== MAIN ROUTER ======================== */
    window.loadContent = function (event, section) {
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }

      // remove active class from all sidebar links
      document
        .querySelectorAll(".sidebar nav ul li a")
        .forEach(link => link.classList.remove("active"));

      // add active class to clicked or default link
      if (event && event.target) {
        event.target.classList.add("active");
      } else {
        const selector = `.sidebar nav ul li a[onclick*="${section}"]`;
        const defaultLink = document.querySelector(selector);
        if (defaultLink) defaultLink.classList.add("active");
      }

      switch (section) {
        /* ======================== DASHBOARD ======================== */
       case "dashboard":
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title" id="Greeting1">Dashboard</h1>
        <p class="page-subtitle">Overview of your units, calendar, and community feedback.</p>
      </div>
    </div>

    <div class="dashboard-container">
      <section class="card welcome-slider">
        <div class="slide fade"><img src="1Entertainment room.jpg" alt="Welcome Slide 1" /></div>
        <div class="slide fade"><img src="1Fitness Gym.jpg" alt="Welcome Slide 2" /></div>
        <div class="slide fade"><img src="1Roof Garden.jpg" alt="Welcome Slide 3" /></div>
        <button class="prev" id="sliderPrev">&#10094;</button>
        <button class="next" id="sliderNext">&#10095;</button>
      </section>

      <div class="dashboard-right">
        <section class="card calendar-card">
          <h3 class="section-title">üìÖ Calendar</h3>
          <div id="calendar"></div>
        </section>

        <section class="card inbox-card">
          <h3 class="section-title">My Unit List</h3>
          <p>Unit(s) you own:</p>
          <div id="myUnitList" style="padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); max-width:280px; margin-top:10px;">
            Loading units...
          </div>
        </section>
      </div>
    </div>

    <section class="card community-card">
      <div class="section-header">
        <h2 class="section-title">üèòÔ∏è Community Feedback</h2>
        <div class="section-actions">
          <label for="feedbackSort">Sort by:</label>
          <select id="feedbackSort" class="select-sm">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="rating-desc">Rating (High to Low)</option>
            <option value="rating-asc">Rating (Low to High)</option>
            <option value="random">Random</option>
          </select>
        </div>
      </div>

      <div id="communityStats" class="community-stats">
        <div>
          <strong>Total Feedback:</strong> <span id="totalFeedback">0</span>
        </div>
        <div>
          <strong>Average Rating:</strong> <span id="avgRating">0.0</span>/5
        </div>
        <div>
          <strong>Rating Distribution:</strong>
          <span id="rating5">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
          <span id="rating4">0</span> ‚≠ê‚≠ê‚≠ê‚≠ê |
          <span id="rating3">0</span> ‚≠ê‚≠ê‚≠ê |
          <span id="rating2">0</span> ‚≠ê‚≠ê |
          <span id="rating1">0</span> ‚≠ê
        </div>
      </div>

      <div id="communityFeedback" class="community-grid">
        <p class="community-empty">Loading community feedback...</p>
      </div>

      <div id="expandControls" class="community-expand" style="display:none;">
        <div class="community-expand-inner">
          <p style="margin:0 0 8px;">
            Showing <span id="showingCount">4</span> of <span id="totalCount">0</span> feedback items
          </p>
          <button id="expandAllBtn" class="btn-primary">Show All Feedback</button>
        </div>
      </div>

      <div id="feedbackMessage" class="community-note">
        <strong>Note:</strong> These are anonymous feedback from other unit owners. Your own feedback is not shown here to maintain privacy.
      </div>
    </section>
          `;

          function escapeHtml(text) {
            if (!text) return "";
            return text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }

          let communityFeedbackData = [];
          let showingAllFeedback = false;

          async function populateMyUnits() {
            try {
              const currentUser = auth.currentUser;
              if (!currentUser) return;

              const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
              if (!tenantDocSnap.exists()) {
                document.getElementById("myUnitList").textContent = "No units found.";
                return;
              }

              const units = tenantDocSnap.data().unitNumbers || [];
              if (units.length === 0) {
                document.getElementById("myUnitList").textContent = "No units assigned.";
                return;
              }

              document.getElementById("myUnitList").innerHTML = units
                .map(u => `<div style="padding:5px 0;">${u}</div>`)
                .join("");
            } catch (e) {
              console.error("Error fetching units:", e);
              document.getElementById("myUnitList").textContent = "Failed to load units.";
            }
          }
          populateMyUnits();

          async function loadCommunityFeedback() {
            const communityFeedback = document.getElementById("communityFeedback");
            const currentUserEmail = auth.currentUser ? auth.currentUser.email : null;

            try {
              const snapshot = await getDocs(collection(db, "feedback"));

              if (snapshot.empty) {
                communityFeedback.innerHTML =
                  '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available yet.</p>';
                document.getElementById("feedbackMessage").style.display = "none";
                return;
              }

              communityFeedbackData = [];
              let totalRating = 0;
              const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

              snapshot.forEach(docSnap => {
                const data = docSnap.data();

                if (data.tenantEmail === currentUserEmail) return;

                communityFeedbackData.push({
                  id: docSnap.id,
                  ...data
                });

                const rating = data.rating || 0;
                if (rating >= 1 && rating <= 5) {
                  totalRating += rating;
                  ratingCounts[rating]++;
                }
              });

              if (communityFeedbackData.length === 0) {
                communityFeedback.innerHTML =
                  '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback from other unit owners yet.</p>';
                document.getElementById("feedbackMessage").style.display = "block";
                return;
              }

              document.getElementById("totalFeedback").textContent = communityFeedbackData.length;
              document.getElementById("avgRating").textContent = (
                totalRating / communityFeedbackData.length
              ).toFixed(1);
              document.getElementById("rating5").textContent = ratingCounts[5];
              document.getElementById("rating4").textContent = ratingCounts[4];
              document.getElementById("rating3").textContent = ratingCounts[3];
              document.getElementById("rating2").textContent = ratingCounts[2];
              document.getElementById("rating1").textContent = ratingCounts[1];

              if (communityFeedbackData.length > 4) {
                document.getElementById("expandControls").style.display = "block";
                document.getElementById("totalCount").textContent = communityFeedbackData.length;
              }

              applyFeedbackSorting();
              document.getElementById("feedbackMessage").style.display = "block";
            } catch (error) {
              console.error("Error loading community feedback:", error);
              communityFeedback.innerHTML = `<p style="color: white; text-align: center; grid-column: 1 / -1; color: #ffcccc;">Error loading community feedback: ${error.message}</p>`;
            }
          }

          function applyFeedbackSorting() {
            const sortValue = document.getElementById("feedbackSort").value;
            if (communityFeedbackData.length === 0) return;

            let sortedFeedback = [...communityFeedbackData];

            switch (sortValue) {
              case "date-desc":
                sortedFeedback.sort(
                  (a, b) =>
                    (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0)
                );
                break;
              case "date-asc":
                sortedFeedback.sort(
                  (a, b) =>
                    (a.timestamp?.toDate?.() || 0) - (b.timestamp?.toDate?.() || 0)
                );
                break;
              case "rating-desc":
                sortedFeedback.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                break;
              case "rating-asc":
                sortedFeedback.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                break;
              case "random":
                for (let i = sortedFeedback.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [sortedFeedback[i], sortedFeedback[j]] = [
                    sortedFeedback[j],
                    sortedFeedback[i]
                  ];
                }
                break;
            }

            renderCommunityFeedback(sortedFeedback);
          }

          function renderCommunityFeedback(feedbackArray) {
            const communityFeedback = document.getElementById("communityFeedback");

            if (feedbackArray.length === 0) {
              communityFeedback.innerHTML =
                '<p style="color: white; text-align: center; grid-column: 1 / -1;">No community feedback available.</p>';
              return;
            }

            communityFeedback.innerHTML = "";

            let itemsToShow = feedbackArray;
            if (!showingAllFeedback && feedbackArray.length > 4) {
              itemsToShow = feedbackArray.slice(0, 4);
              document.getElementById("showingCount").textContent = "4";
            } else {
              document.getElementById("showingCount").textContent = feedbackArray.length;
            }

            const expandBtn = document.getElementById("expandAllBtn");
            if (expandBtn) {
              if (showingAllFeedback) {
                expandBtn.textContent = "Show Less (First 4)";
                expandBtn.style.background = "#4a3728";
                expandBtn.style.color = "white";
              } else {
                expandBtn.textContent = `Show All ${feedbackArray.length} Feedback Items`;
                expandBtn.style.background = "white";
                expandBtn.style.color = "#4a3728";
              }
            }

            itemsToShow.forEach(feedback => {
              const timeText = feedback.timestamp?.toDate
                ? feedback.timestamp
                    .toDate()
                    .toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric"
                    })
                : "Recent";

              const stars = "‚≠ê".repeat(feedback.rating || 0);
              const emptyStars = "‚òÜ".repeat(5 - (feedback.rating || 0));

              let bgColor = "#f5f1e8";
              let borderColor = "#d4c9b8";

              if (feedback.rating >= 4) {
                bgColor = "#e8e0d1";
                borderColor = "#c9b89c";
              }
              if (feedback.rating <= 2) {
                bgColor = "#f0e6d6";
                borderColor = "#d9c6a9";
              }

              const card = document.createElement("div");
              card.style.background = bgColor;
              card.style.border = `2px solid ${borderColor}`;
              card.style.borderRadius = "10px";
              card.style.padding = "18px";
              card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
              card.style.transition = "transform 0.2s, box-shadow 0.2s";

              const hasNewSchema =
                feedback.q1 ||
                feedback.q2 ||
                feedback.q3 ||
                feedback.q4 ||
                feedback.q5 ||
                feedback.q6;

              let bodyHtml = "";

              if (hasNewSchema) {
                bodyHtml = `
                  <div style="margin-top: 12px;">
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Overall condition and appearance of the property</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q1 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Maintenance services (unit, hallway, garden)</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q2 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Professionalism of property management staff</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q3 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Ease of paying monthly dues/rent</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q4 || "No answer provided")}
                      </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                      <strong style="color: #4a3728; font-size: 14px;">Amenities (gym, pool, clubhouse)</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #8d6c39;">
                        ${escapeHtml(feedback.q5 || "No answer provided")}
                      </div>
                    </div>
                    <div>
                      <strong style="color: #4a3728; font-size: 14px;">Additional suggestions</strong>
                      <div style="margin-top: 6px; padding: 8px; background: rgba(255,255,255,0.7); border-radius:6px; font-size:14px; color:#5a4738; border-left:3px solid #4a3728;">
                        ${escapeHtml(feedback.q6 || "No suggestions provided")}
                      </div>
                    </div>
                  </div>
                `;
              } else {
                bodyHtml = `
                  <div style="margin-top: 12px;">
                    <div style="margin-bottom: 12px;">
                      <strong style="color: #4a3728; font-size: 14px;">What do you like about our services, unit, and facilities?</strong>
                      <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #8d6c39;">
                        ${escapeHtml(feedback.question2 || "No answer provided")}
                      </div>
                    </div>
                    <div>
                      <strong style="color: #4a3728; font-size: 14px;">What can we improve in our unit, services, or facilities?</strong>
                      <div style="margin-top: 6px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 14px; color: #5a4738; border-left: 3px solid #4a3728;">
                        ${escapeHtml(feedback.question3 || "No answer provided")}
                      </div>
                    </div>
                  </div>
                `;
              }

              card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                  <div style="color: #8d6c39; font-size: 20px;">
                    ${stars}${emptyStars}
                    <span style="color: #4a3728; font-size: 15px; margin-left: 8px;">(${feedback.rating || 0}/5)</span>
                  </div>
                  <div style="color: #8d6c39; font-size: 13px; font-weight: 500;">
                    ${timeText}
                  </div>
                </div>
                ${bodyHtml}
              `;

              card.addEventListener("mouseenter", () => {
                card.style.transform = "translateY(-2px)";
                card.style.boxShadow = "0 5px 15px rgba(74, 55, 40, 0.25)";
              });

              card.addEventListener("mouseleave", () => {
                card.style.transform = "translateY(0)";
                card.style.boxShadow = "0 3px 8px rgba(74, 55, 40, 0.15)";
              });

              communityFeedback.appendChild(card);
            });
          }

          document
            .getElementById("feedbackSort")
            .addEventListener("change", applyFeedbackSorting);

          document.getElementById("expandAllBtn").addEventListener("click", function () {
            showingAllFeedback = !showingAllFeedback;
            applyFeedbackSorting();
            if (showingAllFeedback) {
              document
                .querySelector("#communityFeedback")
                .scrollIntoView({ behavior: "smooth", block: "start" });
            }
          });

          (function () {
            let slideIndexLocal = 1;
            const slides = () => document.querySelectorAll(".welcome-slider .slide");

            function showSlidesLocal(n) {
              const nodeList = slides();
              if (!nodeList || nodeList.length === 0) return;
              if (n > nodeList.length) slideIndexLocal = 1;
              if (n < 1) slideIndexLocal = nodeList.length;
              nodeList.forEach(s => (s.style.display = "none"));
              nodeList[slideIndexLocal - 1].style.display = "block";
            }

            showSlidesLocal(slideIndexLocal);
            document
              .getElementById("sliderPrev")
              .addEventListener("click", () => showSlidesLocal(--slideIndexLocal));
            document
              .getElementById("sliderNext")
              .addEventListener("click", () => showSlidesLocal(++slideIndexLocal));

            const sliderInterval = setInterval(
              () => showSlidesLocal(++slideIndexLocal),
              5000
            );
            const sliderEl = document.querySelector(".welcome-slider");
            if (sliderEl)
              sliderEl.addEventListener("mouseenter", () =>
                clearInterval(sliderInterval)
              );
          })();

          (function () {
            function generateCalendar() {
              const calendar = document.getElementById("calendar");
              if (!calendar) return;

              const today = new Date();
              const monthName = today.toLocaleString("default", { month: "long" });
              const year = today.getFullYear();
              const firstDay = new Date(year, today.getMonth(), 1);
              const lastDay = new Date(year, today.getMonth() + 1, 0);
              const startDay = firstDay.getDay();

              let html = "<table class='cal-table'>";
              html += `<tr><th class='cal-header' colspan='7'>${monthName} ${year}</th></tr>`;
              html +=
                "<tr class='cal-weekdays'><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr><tr>";

              for (let i = 0; i < startDay; i++) html += "<td class='cal-empty'></td>";

              for (let day = 1; day <= lastDay.getDate(); day++) {
                const isToday = day === today.getDate();
                html += `<td${isToday ? " class='today'" : ""}>${day}</td>`;
                if ((day + startDay) % 7 === 0 && day !== lastDay.getDate())
                  html += "</tr><tr>";
              }
              html += "</tr></table>";
              calendar.innerHTML = html;
            }
            generateCalendar();
          })();

          setTimeout(() => {
            loadCommunityFeedback();
          }, 100);

          break;

        /* ======================== MAINTENANCE ======================== */
        case "maintenance":
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Maintenance Request</h1>
        <p class="page-subtitle">Report issues in your unit and chat with maintenance personnel.</p>
      </div>
    </div>

    <div class="maintenance-tab">
      <div class="maintenance-left">
        <section class="card maintenance-form">
          <h2 class="section-title">New Request</h2>
          <p><strong>What issue do you want to report?</strong></p>

          <label for="unitSelect">Select Unit:</label>
          <select id="unitSelect" required>
            <option value="">-- Select Unit --</option>
          </select>

          <label for="problem" style="margin-top:10px;">Select issue type:</label>
          <select id="problem">
            <option value="">-- Select Issue --</option>
            <optgroup label="Handyman Works">
              <option>Drilling Works</option>
              <option>Peephole Installation</option>
              <option>PVC Door</option>
              <option>Vinyl Tiles</option>
              <option>Main Door Lockset</option>
              <option>Window Grills</option>
              <option>Door Repainting</option>
            </optgroup>
            <optgroup label="Electrical Works">
              <option>Chandelier Installation</option>
              <option>Circuit Breaker</option>
              <option>Outlet / Switch</option>
              <option>Electrical Troubleshooting</option>
              <option>Smoke Detector Installation</option>
            </optgroup>
            <optgroup label="Plumbing Works">
              <option>Bidet Installation</option>
              <option>Grease Trap Cleaning</option>
              <option>Shower Valve</option>
              <option>Angle Valve</option>
              <option>P-Trap Replacement</option>
            </optgroup>
            <optgroup label="Aircon / ACU Services">
              <option>ACU Installation</option>
              <option>ACU Re-Opening / Adjustment</option>
              <option>ACU Drain Pipe</option>
              <option>ACU Cleaning (Split Type)</option>
            </optgroup>
            <optgroup label="Other Services">
              <option>Wall Mounted TV Installation</option>
              <option>Sprinkler Installation</option>
              <option>Wall Opening</option>
              <option>Painting / Repainting</option>
            </optgroup>
            <optgroup label="Cleaning">
              <option>Exhaust Fan Cleaning</option>
              <option>Electrical Panel Cleaning</option>
              <option>Sweeping / General Cleaning</option>
            </optgroup>
            <option value="other">Other (Not Listed)</option>
          </select>

          <div id="otherSection" style="display:none; margin-top:15px;">
            <label for="otherComment">Describe the problem:</label>
            <textarea id="otherComment" rows="4" placeholder="Write details here..."></textarea>
          </div>

          <div id="detailsSection" style="display:none; margin-top:10px;">
            <label for="imageUpload" style="display:block;">Upload 1 or 2 JPEG images (optional, required for "Others"):</label>
            <input type="file" id="imageUpload" accept="image/jpeg" multiple>

            <label for="preferredDate" style="margin-top:15px; display:block;">Select preferred maintenance visit date and time:</label>
            <input type="datetime-local" id="preferredDate" />
          </div>

          <button id="submitReport" class="btn-primary" style="margin-top:12px;">Submit</button>
          <p id="statusMessage" class="status-text"></p>
        </section>

        <section class="card">
          <h3 class="section-title">üìå Solano Hills Job Service Rates</h3>
          <div class="service-rates-scroll">
            <h4>Handyman Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Drilling Works</td><td>Php 120.00/set</td><td>Main Door Locket</td><td>Php 250.00</td></tr>
              <tr><td>Peephole (provision)</td><td>Php 120.00/set</td><td>Window Grills</td><td>Php 400.00</td></tr>
              <tr><td>Peephole (w/ provision)</td><td>Php 350.00/set</td><td>Main Door</td><td>Php 560.00</td></tr>
              <tr><td>Vinyl Tiles</td><td>Php 200.00/sqmtr</td><td>Plastering of ACU sides</td><td>Php 560.00</td></tr>
              <tr><td>PVC door</td><td>Php 560.00/set</td><td>Repainting of window grills</td><td>Php 560.00</td></tr>
              <tr><td>Rangehood w/ provision</td><td>Php 650.00/set</td><td>Repainting of ACU sides</td><td>Php 400.00</td></tr>
            </table>

            <h4>Electrical Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Chandelier</td><td>Php 1,800.00/pc</td><td>Bulb / Receptacle</td><td>Php 120.00</td></tr>
              <tr><td>Circuit Breaker</td><td>Php 760.00/pc</td><td>Troubleshooting</td><td>Php 250.00/item</td></tr>
            </table>

            <h4>Plumbing Works</h4>
            <table class="rate-table">
              <tr><th>Installation</th><th>Rate</th><th>Replacement / Repair</th><th>Rate</th></tr>
              <tr><td>Bidet</td><td>Php 395.00/set</td><td>Faucet / Shower Head</td><td>Php 250.00</td></tr>
              <tr><td>Grease Trap</td><td>Php 1,500.00</td><td>Shower Valve</td><td>Php 900.00</td></tr>
            </table>

            <h4>Other Services</h4>
            <table class="rate-table">
              <tr><th>Service</th><th>Rate</th></tr>
              <tr><td>Wall Mounted TV (below 40in)</td><td>Php 460.00/set</td></tr>
              <tr><td>ACU Installation</td><td>Php 1,500.00</td></tr>
              <tr><td>Smoke Detector Cleaning</td><td>Php 120.00</td></tr>
            </table>

            <h4>Cleaning Services</h4>
            <table class="rate-table">
              <tr><th>Service</th><th>Rate</th></tr>
              <tr><td>ACU Cleaning Split Type</td><td>Php 1500.00/pc</td></tr>
              <tr><td>Exhaust Fan Cleaning</td><td>Php 600.00/unit</td></tr>
            </table>
          </div>
        </section>
      </div>

      <aside class="maintenance-right">
        <section class="card maintenance-history-card">
          <h3 class="history-header">Request History</h3>
          <div id="historyList"></div>
        </section>
      </aside>
    </div>
          `;

          // ===================== TENANT REPLY SUPPORT + HISTORY =====================
          function formatDateTimeAMPM(date) {
            if (!(date instanceof Date)) date = date?.toDate ? date.toDate() : null;
            if (!date) return "Invalid date";
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, "0");
            const ampm = hours >= 12 ? "PM" : "AM";
            hours = hours % 12 || 12;
            const day = date.getDate().toString().padStart(2, "0");
            const month = (date.getMonth() + 1).toString().padStart(2, "0");
            const year = date.getFullYear();
            return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
          }

          const preferredDateInput = document.getElementById("preferredDate");
          const nowMaint = new Date();
          nowMaint.setMinutes(Math.ceil(nowMaint.getMinutes() / 15) * 15);
          preferredDateInput.min = nowMaint.toISOString().slice(0, 16);

          const problemSelect = document.getElementById("problem");
          const otherSection = document.getElementById("otherSection");
          const detailsSection = document.getElementById("detailsSection");
          const submitButton = document.getElementById("submitReport");
          const statusMessageMaint = document.getElementById("statusMessage");
          const imageUpload = document.getElementById("imageUpload");
          const otherComment = document.getElementById("otherComment");
          const historyList = document.getElementById("historyList");
          const unitSelect = document.getElementById("unitSelect");

          problemSelect.addEventListener("change", () => {
            otherSection.style.display =
              problemSelect.value === "other" ? "block" : "none";
            detailsSection.style.display =
              problemSelect.value !== "" ? "block" : "none";
            if (problemSelect.value === "") {
              preferredDateInput.value = "";
              imageUpload.value = "";
            }
          });

          async function populateUnits() {
            try {
              const currentUser = auth.currentUser;
              const tenantDocSnap = await getDoc(doc(db, "users", currentUser.uid));
              if (tenantDocSnap.exists()) {
                const units = tenantDocSnap.data().unitNumbers || [];
                unitSelect.innerHTML =
                  `<option value="">-- Select Unit --</option>` +
                  units.map(u => `<option value="${u}">${u}</option>`).join("");
              }
            } catch (e) {
              console.error("Error fetching tenant units:", e);
            }
          }
          populateUnits();

          // helper to write tenant reply into Firestore
          async function sendTenantReply(requestId, message) {
            const user = auth.currentUser;
            if (!user) {
              await showPopup("Please log in before sending a reply.");
              return;
            }
            await addDoc(
              collection(db, "maintenanceRequests", requestId, "responses"),
              {
                sender: "tenant",
                senderEmail: user.email,
                message,
                timestamp: serverTimestamp()
              }
            );
          }

          // Load maintenance request history + responses
          async function loadHistory() {
            historyList.innerHTML = "<p>Loading your requests...</p>";
            try {
              const tenantEmail = await getCurrentUserEmail();
              const qCol = collection(db, "maintenanceRequests");
              const querySnapshot = await getDocs(
                query(
                  qCol,
                  where("tenantEmail", "==", tenantEmail),
                  orderBy("timestamp", "desc"),
                  limit(10)
                )
              );
              if (querySnapshot.empty) {
                historyList.innerHTML = "<p>No maintenance requests found.</p>";
                return;
              }

              historyList.innerHTML = "";
              for (const docSnap of querySnapshot.docs) {
                const data = docSnap.data();
                const docId = docSnap.id;
                const timeStamp = data.timestamp
                  ? formatDateTimeAMPM(data.timestamp)
                  : "N/A";
                const status = data.status || "Pending";
                const responseTime = data.responseTime
                  ? formatDateTimeAMPM(data.responseTime)
                  : "Not yet responded";
                const maintenanceName = data.maintenanceName || "Not assigned";
                const scheduledVisit = data.preferredVisitTime
                  ? formatDateTimeAMPM(data.preferredVisitTime)
                  : "Not scheduled";

                const item = document.createElement("div");
                item.style.borderBottom = "1px solid #ddd";
                item.style.padding = "10px 0";

                const responsesContainer = document.createElement("div");
                responsesContainer.style.marginTop = "8px";
                responsesContainer.style.paddingLeft = "10px";
                responsesContainer.style.borderLeft = "3px solid #8d6c39";
                responsesContainer.style.display = "flex";
                responsesContainer.style.flexDirection = "column";
                responsesContainer.style.gap = "6px";
                responsesContainer.innerHTML = "<em>Loading messages...</em>";

                item.innerHTML = `
                  <strong>Issue:</strong> ${data.problem}<br/>
                  <strong>Unit Number:</strong> ${data.unitNumber || "N/A"}<br/>
                  <strong>Description:</strong> ${data.comment || "-"}<br/>
                  <strong>Scheduled Visit:</strong> ${scheduledVisit}<br/>
                  <strong>Status:</strong> ${status}<br/>
                  <strong>Maintenance Personnel:</strong> ${maintenanceName}<br/>
                  <strong>Response Time:</strong> ${responseTime}<br/>
                  <strong>Submitted:</strong> ${timeStamp}<br/>
                `;

                const imagesContainer = document.createElement("div");
                imagesContainer.style.marginTop = "10px";
                imagesContainer.style.display = "flex";
                imagesContainer.style.flexWrap = "wrap";
                imagesContainer.style.gap = "8px";
                if (data.imageUrls && data.imageUrls.length > 0) {
                  const imagesLabel = document.createElement("strong");
                  imagesLabel.textContent = "Uploaded Images:";
                  imagesContainer.appendChild(imagesLabel);
                  imagesContainer.appendChild(document.createElement("br"));
                  data.imageUrls.forEach(url => {
                    const img = document.createElement("img");
                    img.src = url;
                    img.style.width = "100px";
                    img.style.height = "auto";
                    img.style.borderRadius = "6px";
                    img.style.boxShadow = "0 0 5px rgba(0,0,0,0.3)";
                    img.style.objectFit = "cover";
                    imagesContainer.appendChild(img);
                  });
                } else {
                  imagesContainer.innerHTML = "<em>No images uploaded.</em>";
                }

                item.appendChild(imagesContainer);
                item.appendChild(responsesContainer);
                historyList.appendChild(item);

                // ---- load conversation messages (admin + tenant) ----
                const responsesQuery = query(
                  collection(db, "maintenanceRequests", docId, "responses"),
                  orderBy("timestamp", "asc")   // ASC so conversation is chronological
                );
                const responsesSnapshot = await getDocs(responsesQuery);
                if (responsesSnapshot.empty) {
                  responsesContainer.innerHTML =
                    "<em>No messages yet. You can send a reply below.</em>";
                } else {
                  responsesContainer.innerHTML = "";
                  responsesSnapshot.forEach(respDoc => {
                    const respData = respDoc.data();
                    const time = respData.timestamp
                      ? formatDateTimeAMPM(respData.timestamp)
                      : "No timestamp";
                    const isTenant = respData.sender === "tenant";

                    const senderLabel = isTenant
                      ? "You"
                      : respData.adminEmail ||
                        respData.senderEmail ||
                        "Maintenance";

                    const respDiv = document.createElement("div");
                    respDiv.style.marginBottom = "4px";
                    respDiv.style.padding = "6px 8px";
                    respDiv.style.borderRadius = "6px";
                    respDiv.style.maxWidth = "90%";
                    respDiv.style.background = isTenant
                      ? "rgba(141,108,57,0.2)"
                      : "rgba(255,255,255,0.08)";
                    respDiv.style.alignSelf = isTenant ? "flex-end" : "flex-start";

                    respDiv.innerHTML = `
                      <strong>${senderLabel}</strong> <small>(${time})</small><br/>
                      <span>${respData.message}</span>
                    `;
                    responsesContainer.appendChild(respDiv);
                  });
                }

                // ---- REPLY BOX (TENANT) ----
                const replyContainer = document.createElement("div");
                replyContainer.style.marginTop = "8px";
                replyContainer.style.paddingLeft = "10px";

                replyContainer.innerHTML = `
                  <textarea rows="2" placeholder="Type a reply to maintenance..." 
                    style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; resize:vertical;"></textarea>
                  <button class="tenant-reply-btn" 
                    style="margin-top:6px; padding:6px 12px; background:#8d6c39; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
                    Send Reply
                  </button>
                  <small style="display:block; margin-top:4px; color:#ccc;">Replies are visible to maintenance personnel.</small>
                `;

                const replyTextarea = replyContainer.querySelector("textarea");
                const replyButton = replyContainer.querySelector(".tenant-reply-btn");

                replyButton.addEventListener("click", async () => {
                  const message = replyTextarea.value.trim();
                  if (!message) {
                    await showPopup("Please type a message before sending.");
                    return;
                  }
                  replyButton.disabled = true;
                  replyButton.textContent = "Sending...";
                  try {
                    await sendTenantReply(docId, message);
                    replyTextarea.value = "";
                    await loadHistory(); // simple refresh of history + messages
                  } catch (err) {
                    console.error("Failed to send reply:", err);
                    await showPopup("Failed to send reply. Please try again.");
                  } finally {
                    replyButton.disabled = false;
                    replyButton.textContent = "Send Reply";
                  }
                });

                item.appendChild(replyContainer);
              }
            } catch (error) {
              historyList.innerHTML = `<p style="color:red;">Failed to load history: ${error.message}</p>`;
            }
          }
          loadHistory();

          async function uploadToCloudinary(file) {
            const url = "https://api.cloudinary.com/v1_1/dfklsyjch/upload";
            const preset = "tenant_uploads";
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", preset);
            const response = await fetch(url, { method: "POST", body: formData });
            if (!response.ok) throw new Error("Cloudinary upload failed");
            return (await response.json()).secure_url;
          }

          submitButton.addEventListener("click", async () => {
            const unitNumber = unitSelect.value;
            const problem = problemSelect.value;
            const comment = otherComment.value.trim();
            const preferredVisitTime = preferredDateInput.value;
            const files = imageUpload.files;

            if (!unitNumber) {
              await showPopup("Please select the unit for maintenance.");
              return;
            }
            if (!problem) {
              await showPopup("Please select an issue type");
              return;
            }
            if (!preferredVisitTime) {
              await showPopup("Please select your preferred maintenance visit date and time.");
              return;
            }
            if (new Date(preferredVisitTime) < new Date()) {
              await showPopup("Preferred visit time cannot be in the past.");
              return;
            }
            if (problem === "other") {
              if (!comment) {
                await showPopup('Please describe the problem in "Others".');
                return;
              }
              if (!files || files.length < 2) {
                await showPopup('Please upload at least 2 JPEG images for "Others".');
                return;
              }
            }
            if (files && files.length > 0) {
              for (const file of files) {
                if (file.type !== "image/jpeg") {
                  await showPopup("Only JPEG images are allowed.");
                  return;
                }
              }
            }

            statusMessageMaint.style.color = "gray";
            statusMessageMaint.textContent = "Submitting your request...";

            try {
              const tenantEmail = await getCurrentUserEmail();
              let imageUrls = [];
              if (files && files.length > 0) {
                for (const file of files) {
                  imageUrls.push(await uploadToCloudinary(file));
                }
              }

              await addDoc(collection(db, "maintenanceRequests"), {
                tenantEmail,
                unitNumber,
                problem,
                comment: problem === "other" ? comment : "",
                imageUrls,
                status: "Pending",
                responseTime: "Not yet responded",
                preferredVisitTime: new Date(preferredVisitTime),
                timestamp: serverTimestamp()
              });

              statusMessageMaint.style.color = "green";
              statusMessageMaint.textContent =
                "Maintenance request submitted successfully!";
              problemSelect.value = "";
              otherComment.value = "";
              imageUpload.value = "";
              otherSection.style.display = "none";
              detailsSection.style.display = "none";
              preferredDateInput.value = "";
              unitSelect.value = "";
              loadHistory();
            } catch (error) {
              statusMessageMaint.style.color = "red";
              statusMessageMaint.textContent =
                "Failed to submit request: " + error.message;
              console.error(error);
            }
          });

          break;

        /* ======================== BILLING ======================== */
       case "billing":
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Billing & Payments</h1>
        <p class="page-subtitle">Review your current invoice and payment history.</p>
      </div>
    </div>

    <div class="billing-grid payment-tab">
      <section class="card">
        <h2 class="section-title">Current Invoice</h2>
        <p>Pay your monthly dues securely via PayPal.</p>

        <div id="invoiceSection" style="margin-top:14px;">
          <p id="invoiceDetails">Loading your invoice...</p>
        </div>

        <hr style="margin:22px 0; border-color:rgba(255,255,255,0.12);">

        <h3 class="section-title">Payment Method</h3>
        <p>Payments are processed securely through PayPal.</p>

        <div id="paypal-section" style="margin-top:16px;">
          <div id="paypal-button-container"></div>
        </div>
      </section>

      <section class="card">
        <div class="section-header">
          <h2 class="section-title">Payment History</h2>
          <div class="section-actions">
            <label for="historySort">Sort by:</label>
            <select id="historySort" class="select-sm">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
            </select>
          </div>
        </div>

        <div id="paymentStats" class="payment-stats" style="display:none;">
          <span style="font-weight:bold;">Showing:</span>
          <span id="paymentCount">0</span> payments ¬∑
          <span style="font-weight:bold;">Total Paid:</span> ‚Ç±<span id="totalPaid">0.00</span>
        </div>

        <div id="paymentHistory" class="payment-history-scroll">
          <p>Loading your payment history...</p>
        </div>
      </section>
    </div>
          `;

          const invoiceDetails = document.getElementById("invoiceDetails");
          const paymentHistory = document.getElementById("paymentHistory");
          const paypalContainer = document.getElementById("paypal-button-container");
          const historySort = document.getElementById("historySort");
          const paymentStats = document.getElementById("paymentStats");
          const paymentCount = document.getElementById("paymentCount");
          const totalPaid = document.getElementById("totalPaid");

          const unitPricing = { "1B": 10, "2B": 20 };
          let computedAmount = 0;
          let tenantUnits = [];
          let allPayments = [];
          let filteredPayments = [];

          async function loadInvoice() {
            const tenantEmail = await getCurrentUserEmail();
            const uid = auth.currentUser.uid;
            const userDoc = await getDoc(doc(db, "users", uid));
            tenantUnits = userDoc.data()?.unitNumbers || [];

            computedAmount = tenantUnits.reduce((total, unit) => {
              const type = unit.split("-")[0];
              return total + (unitPricing[type] || 0);
            }, 0);

            invoiceDetails.innerHTML = `
              <strong>Tenant:</strong> ${tenantEmail}<br>
              <strong>Units:</strong> ${tenantUnits.join(", ") || "None"}<br>
              <strong>Amount Due:</strong> ‚Ç±${computedAmount}<br>
              <strong>Due Date:</strong> 25th of this month
            `;
          }

          async function loadAllPayments() {
            const tenantEmail = await getCurrentUserEmail();

            try {
              const qCol = query(
                collection(db, "payments"),
                where("tenantEmail", "==", tenantEmail),
                orderBy("timestamp", "desc")
              );
              const snapshot = await getDocs(qCol);

              if (snapshot.empty) {
                allPayments = [];
                applySorting();
                return;
              }

              allPayments = snapshot.docs.map(docSnap => ({
                id: docSnap.id,
                ...docSnap.data()
              }));

              applySorting();
            } catch (error) {
              console.error("Error loading payments:", error);
              paymentHistory.innerHTML = `<p style="color:red;">Error loading history: ${error.message}</p>`;
            }
          }

          function applySorting() {
            const sortValue = historySort.value;
            filteredPayments = [...allPayments];

            filteredPayments.sort((a, b) => {
              switch (sortValue) {
                case "date-desc":
                  return (
                    (b.timestamp?.toDate?.() || 0) -
                    (a.timestamp?.toDate?.() || 0)
                  );
                case "date-asc":
                  return (
                    (a.timestamp?.toDate?.() || 0) -
                    (b.timestamp?.toDate?.() || 0)
                  );
                default:
                  return 0;
              }
            });

            renderPaymentHistory();
          }

          function renderPaymentHistory() {
            if (filteredPayments.length === 0) {
              paymentHistory.innerHTML = "<p>No payment records found.</p>";
              paymentStats.style.display = "none";
              return;
            }

            paymentHistory.innerHTML = "";

            let total = 0;

            filteredPayments.forEach(payment => {
              const d = payment;
              const time = d.timestamp
                ? d.timestamp.toDate().toLocaleString()
                : "N/A";

              let receipt = "";
              if (d.method === "Cash on Hand" && d.receiptUrl) {
                receipt = `<br><strong>Receipt:</strong><br><img src="${d.receiptUrl}" style="max-width:150px; border-radius:6px;">`;
              }

              let statusColor = "#666";
              if (d.status === "Paid" || d.status === "Approved") statusColor = "#4CAF50";
              if (d.status === "Pending Verification") statusColor = "#FF9800";
              if (d.status === "Rejected") statusColor = "#F44336";

              const div = document.createElement("div");
              div.style.borderBottom = "1px solid #ccc";
              div.style.padding = "12px 0";
              div.style.marginBottom = "10px";
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <strong>Invoice ID:</strong> ${d.invoiceId || "-"}<br>
                    <strong>Amount:</strong> ‚Ç±${d.amount}<br>
                    <strong>Status:</strong> <span style="color:${statusColor};">${d.status}</span><br>
                    <strong>Date:</strong> ${time}<br>
                    <strong>Method:</strong> ${d.method}
                    ${receipt}
                  </div>
                  <div style="min-width: 150px; text-align: right;">
                    ${d.transactionId ? `<strong>Transaction ID:</strong><br><small>${d.transactionId}</small><br>` : ""}
                    ${d.payerEmail ? `<strong>Paid with:</strong><br><small>${d.payerEmail}</small>` : ""}
                  </div>
                </div>
              `;
              paymentHistory.appendChild(div);

              if (
                d.status === "Paid" ||
                d.status === "Approved" ||
                d.status === "Completed"
              ) {
                total += Number(d.amount) || 0;
              }
            });

            paymentCount.textContent = filteredPayments.length;
            totalPaid.textContent = total.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2
            });
            paymentStats.style.display = "block";
          }

          async function sendEmailReceipt(paymentData) {
            try {
              const templateParams = {
                from_name: "Solano Hills Admin",
                to_email: paymentData.payerEmail,
                invoice_id: paymentData.invoiceId,
                amount: paymentData.amount,
                payment_method: paymentData.method,
                transaction_id: paymentData.transactionId,
                payment_date: new Date().toLocaleString()
              };
              await emailjs.send("service_izx63bb", "template_asn4687", templateParams);
              console.log("Email receipt sent successfully");
            } catch (error) {
              console.error("Failed to send email receipt:", error);
            }
          }

          async function setupPayPal() {
            const tenantEmail = await getCurrentUserEmail();
            const invoiceId = "INV-" + Date.now();

            paypal
              .Buttons({
                style: { color: "gold", shape: "rect", label: "pay", height: 40 },
                createOrder: function (data, actions) {
                  return actions.order.create({
                    purchase_units: [
                      {
                        reference_id: invoiceId,
                        description: "Monthly Dues Payment",
                        amount: { currency_code: "PHP", value: computedAmount.toString() }
                      }
                    ]
                  });
                },
                onApprove: async function (data, actions) {
                  const order = await actions.order.capture();

                  const paymentRecord = {
                    tenantEmail,
                    invoiceId,
                    amount: computedAmount,
                    method: "PayPal",
                    status: "Paid",
                    transactionId: order.id,
                    payerEmail: order.payer.email_address,
                    timestamp: serverTimestamp()
                  };

                  await addDoc(collection(db, "payments"), paymentRecord);

                  showPopup("‚úÖ Payment successful!");
                  await loadAllPayments();
                  await sendEmailReceipt(paymentRecord);
                },
                onCancel: async function () {
                  showPopup("‚ö†Ô∏è Payment cancelled by user.");
                },
                onError: async function (err) {
                  console.error("PayPal error:", err);
                  showPopup("‚ùå Payment failed. Please try again later.");
                }
              })
              .render(paypalContainer);
          }

          historySort.addEventListener("change", applySorting);

          (async () => {
            await loadInvoice();
            await loadAllPayments();
            await setupPayPal();
          })();

          break;

        /* ======================== FEEDBACK ======================== */
        case "feedback":
          loadFeedbackForm();
          break;

        default:
          mainContent.innerHTML = "<p>Section not found.</p>";
      }
    };

    /* ======================== FEEDBACK FORM FUNCTION ======================== */
    function loadFeedbackForm() {
  mainContent.innerHTML = `
    <div class="tab-header">
      <div>
        <h1 class="page-title">Tenant Feedback</h1>
        <p class="page-subtitle">Share your thoughts so we can improve your experience.</p>
      </div>
    </div>

    <div class="feedback-container">
      <section class="card feedback-card">
        <form id="feedbackForm" class="feedback-form">
          <div class="form-group">
            <label for="rating">1. How satisfied are you with our services?</label>
            <div id="rating" style="font-size: 2rem; margin: 8px 0; user-select:none;">
              <span data-value="1" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="2" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="3" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="4" style="cursor:pointer;">‚≠êÔ∏è</span>
              <span data-value="5" style="cursor:pointer;">‚≠êÔ∏è</span>
            </div>
            <input type="hidden" id="ratingValue" name="ratingValue" required />
          </div>

          <div class="form-group">
            <label for="q1">2. How satisfied are you with the overall condition and appearance of the property?</label>
            <select id="q1" name="q1" required>
              <option value="">-- Select --</option>
              <option>Very Satisfied</option>
              <option>Satisfied</option>
              <option>Neutral</option>
              <option>Dissatisfied</option>
              <option>Very Dissatisfied</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q2">3. How satisfied are you with the maintenance services (unit, hallway, garden)?</label>
            <select id="q2" name="q2" required>
              <option value="">-- Select --</option>
              <option>Very Satisfied</option>
              <option>Satisfied</option>
              <option>Neutral</option>
              <option>Dissatisfied</option>
              <option>Very Dissatisfied</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q3">4. How would you rate the professionalism of the property management staff?</label>
            <select id="q3" name="q3" required>
              <option value="">-- Select --</option>
              <option>Excellent</option>
              <option>Good</option>
              <option>Average</option>
              <option>Poor</option>
              <option>Very Poor</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q4">5. Is it easy to pay your monthly dues or rent?</label>
            <select id="q4" name="q4" required>
              <option value="">-- Select --</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q5">6. How would you rate the amenities (gym, pool, clubhouse)?</label>
            <select id="q5" name="q5" required>
              <option value="">-- Select --</option>
              <option>Excellent</option>
              <option>Good</option>
              <option>Average</option>
              <option>Poor</option>
            </select>
          </div>

          <div class="form-group">
            <label for="q6">7. Any additional suggestions?</label>
            <textarea id="q6" name="q6" placeholder="Write your suggestions here..."></textarea>
          </div>

          <button id="sendFeedbackBtn" type="submit" class="btn-primary">Send Feedback</button>
          <p id="statusMessage" class="status-text"></p>
        </form>
      </section>
    </div>
  `;

  const form = document.getElementById("feedbackForm");
  const ratingStars = document.querySelectorAll("#rating span");
  const ratingValueInput = document.getElementById("ratingValue");
  const statusMessage = document.getElementById("statusMessage");
  const sendBtn = document.getElementById("sendFeedbackBtn");

  ratingStars.forEach(star => {
    star.style.opacity = "0.3";
    star.addEventListener("click", () => {
      const val = star.getAttribute("data-value");
      ratingValueInput.value = val;
      ratingStars.forEach(s => {
        s.style.opacity =
          s.getAttribute("data-value") <= val ? "1" : "0.3";
      });
    });
  });

  function disableButtonForCooldown() {
    sendBtn.disabled = true;
    sendBtn.style.background = "gray";
    sendBtn.style.cursor = "not-allowed";
  }

  function enableButton() {
    sendBtn.disabled = false;
    sendBtn.style.background = "";
    sendBtn.style.cursor = "pointer";
  }

  const cooldownEnd = localStorage.getItem("feedbackCooldownEnd");
  if (cooldownEnd && Date.now() < cooldownEnd) {
    disableButtonForCooldown();
    const remaining = Math.round((cooldownEnd - Date.now()) / 1000);
    statusMessage.textContent = `You can send feedback again in ${remaining}s`;

    const countdown = setInterval(() => {
      const timeLeft = Math.round((cooldownEnd - Date.now()) / 1000);
      if (timeLeft <= 0) {
        clearInterval(countdown);
        enableButton();
        statusMessage.textContent = "";
        localStorage.removeItem("feedbackCooldownEnd");
      } else {
        statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
      }
    }, 1000);
  }

  onAuthStateChanged(auth, user => {
    if (!user) {
      statusMessage.textContent = "Please log in to send feedback.";
      form.style.display = "none";
    } else {
      form.addEventListener("submit", async e => {
        e.preventDefault();

        if (!ratingValueInput.value) {
          await showPopup("Please select a rating.");
          return;
        }

        disableButtonForCooldown();
        statusMessage.style.color = "gray";
        statusMessage.textContent = "Sending feedback...";

        try {
          await addDoc(collection(db, "feedback"), {
            tenantEmail: user.email,
            rating: Number(ratingValueInput.value),
            q1: form.q1.value,
            q2: form.q2.value,
            q3: form.q3.value,
            q4: form.q4.value,
            q5: form.q5.value,
            q6: form.q6.value.trim(),
            timestamp: serverTimestamp()
          });

          statusMessage.style.color = "green";
          statusMessage.textContent = "Feedback sent successfully!";

          form.reset();
          ratingStars.forEach(s => (s.style.opacity = "0.3"));
          ratingValueInput.value = "";

          const cooldownTime = Date.now() + 60000;
          localStorage.setItem("feedbackCooldownEnd", cooldownTime);

          let countdown = setInterval(() => {
            const timeLeft = Math.round((cooldownTime - Date.now()) / 1000);
            if (timeLeft <= 0) {
              clearInterval(countdown);
              enableButton();
              statusMessage.textContent = "";
              localStorage.removeItem("feedbackCooldownEnd");
            } else {
              statusMessage.textContent = `You can send feedback again in ${timeLeft}s`;
            }
          }, 1000);
        } catch (error) {
          console.error("Error sending feedback: ", error);
          statusMessage.style.color = "red";
          statusMessage.textContent = "Error sending feedback.";
          enableButton();
        }
      });
    }
  });
}
    

    /* ======================== GREETING & POPUP ======================== */
    function updateGreeting() {
      onAuthStateChanged(auth, user => {
        if (user) {
          const greeting =
            document.getElementById("tenantGreeting") ||
            document.getElementById("tenantGreeting1");
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    function showWelcomeBack() {
      onAuthStateChanged(auth, user => {
        if (user) {
          const greeting = document.getElementById("tenantGreeting");
          const nameToShow = user.displayName || user.email;
          if (greeting) {
            greeting.textContent = `Welcome back, ${nameToShow}`;
          }
        }
      });
    }

    showWelcomeBack();

    window.showPopup = function (message) {
      document.getElementById("popupMessage").innerHTML = message;
      document.getElementById("customPopup").classList.remove("hidden");
    };

    window.closePopup = function () {
      document.getElementById("customPopup").classList.add("hidden");
    };

    window.addEventListener("DOMContentLoaded", () => {
      loadContent(null, "dashboard");
    });
  </script>

  <!-- ======================== POPUP ======================== -->
  <div id="customPopup" class="popup hidden">
    <div class="popup-content">
      <p id="popupMessage">Your message goes here</p>
      <button onclick="closePopup()">Close</button>
    </div>
  </div>
</body>
</html>
